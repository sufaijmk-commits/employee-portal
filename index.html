<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eden Perfume - Sales Management System</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üå∏</text></svg>">
    <!-- Tailwind CSS will be configured manually -->
    
    <!-- Firebase SDK with better error handling -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js" onerror="handleFirebaseLoadError('app')"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js" onerror="handleFirebaseLoadError('firestore')"></script>
    
    <style>
        /* Manual Tailwind CSS Configuration */
        /* Reset and Base Styles */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: #374151;
        }
        
        /* Utility Classes */
        .min-h-screen { min-height: 100vh; }
        .bg-gray-50 { background-color: #f9fafb; }
        .bg-white { background-color: #ffffff; }
        .bg-gray-100 { background-color: #f3f4f6; }
        .bg-gray-600 { background-color: #4b5563; }
        .bg-gray-700 { background-color: #374151; }
        .bg-blue-600 { background-color: #2563eb; }
        .bg-blue-700 { background-color: #1d4ed8; }
        .bg-green-600 { background-color: #16a34a; }
        .bg-green-700 { background-color: #15803d; }
        .bg-red-600 { background-color: #dc2626; }
        .bg-red-700 { background-color: #b91c1c; }
        .bg-purple-600 { background-color: #9333ea; }
        .bg-purple-700 { background-color: #7c3aed; }
        .bg-orange-600 { background-color: #ea580c; }
        .bg-orange-700 { background-color: #c2410c; }
        .bg-yellow-600 { background-color: #ca8a04; }
        .bg-yellow-700 { background-color: #a16207; }
        .bg-yellow-50 { background-color: #fefce8; }
        .bg-green-100 { background-color: #dcfce7; }
        .bg-blue-100 { background-color: #dbeafe; }
        .bg-purple-100 { background-color: #f3e8ff; }
        
        .text-white { color: #ffffff; }
        .text-gray-500 { color: #6b7280; }
        .text-gray-600 { color: #4b5563; }
        .text-gray-700 { color: #374151; }
        .text-gray-800 { color: #1f2937; }
        .text-blue-600 { color: #2563eb; }
        .text-blue-800 { color: #1e40af; }
        .text-green-600 { color: #16a34a; }
        .text-green-800 { color: #166534; }
        .text-red-600 { color: #dc2626; }
        .text-red-800 { color: #991b1b; }
        .text-purple-600 { color: #9333ea; }
        .text-yellow-600 { color: #ca8a04; }
        .text-yellow-700 { color: #a16207; }
        .text-yellow-800 { color: #92400e; }
        .text-red-500 { color: #ef4444; }
        
        .p-4 { padding: 1rem; }
        .p-6 { padding: 1.5rem; }
        .p-8 { padding: 2rem; }
        .px-3 { padding-left: 0.75rem; padding-right: 0.75rem; }
        .px-4 { padding-left: 1rem; padding-right: 1rem; }
        .px-6 { padding-left: 1.5rem; padding-right: 1.5rem; }
        .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
        .py-3 { padding-top: 0.75rem; padding-bottom: 0.75rem; }
        .py-4 { padding-top: 1rem; padding-bottom: 1rem; }
        .py-8 { padding-top: 2rem; padding-bottom: 2rem; }
        
        .m-4 { margin: 1rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mb-6 { margin-bottom: 1.5rem; }
        .mb-8 { margin-bottom: 2rem; }
        .mt-1 { margin-top: 0.25rem; }
        .mt-2 { margin-top: 0.5rem; }
        .mt-6 { margin-top: 1.5rem; }
        .mt-8 { margin-top: 2rem; }
        .mr-3 { margin-right: 0.75rem; }
        .ml-2 { margin-left: 0.5rem; }
        .mx-auto { margin-left: auto; margin-right: auto; }
        
        .w-full { width: 100%; }
        .w-10 { width: 2.5rem; }
        .w-12 { width: 3rem; }
        .w-20 { width: 5rem; }
        .max-w-md { max-width: 28rem; }
        .max-w-2xl { max-width: 42rem; }
        .max-h-40 { max-height: 10rem; }
        
        .h-10 { height: 2.5rem; }
        .h-12 { height: 3rem; }
        .h-20 { height: 5rem; }
        
        .flex { display: flex; }
        .flex-1 { flex: 1 1 0%; }
        .flex-wrap { flex-wrap: wrap; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .justify-center { justify-content: center; }
        .space-x-2 > * + * { margin-left: 0.5rem; }
        .space-x-3 > * + * { margin-left: 0.75rem; }
        .space-y-1 > * + * { margin-top: 0.25rem; }
        .space-y-4 > * + * { margin-top: 1rem; }
        .space-y-6 > * + * { margin-top: 1.5rem; }
        
        .grid { display: grid; }
        .grid-cols-1 { grid-template-columns: repeat(1, minmax(0, 1fr)); }
        .grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
        .grid-cols-5 { grid-template-columns: repeat(5, minmax(0, 1fr)); }
        .gap-2 { gap: 0.5rem; }
        .gap-4 { gap: 1rem; }
        .gap-6 { gap: 1.5rem; }
        
        .rounded-lg { border-radius: 0.5rem; }
        .rounded-xl { border-radius: 0.75rem; }
        .rounded-2xl { border-radius: 1rem; }
        .rounded-full { border-radius: 9999px; }
        
        .border { border-width: 1px; }
        .border-b { border-bottom-width: 1px; }
        .border-b-2 { border-bottom-width: 2px; }
        .border-t-2 { border-top-width: 2px; }
        .border-gray-300 { border-color: #d1d5db; }
        .border-gray-400 { border-color: #9ca3af; }
        .border-purple-500 { border-color: #a855f7; }
        .border-transparent { border-color: transparent; }
        .border-yellow-200 { border-color: #fde047; }
        
        .font-medium { font-weight: 500; }
        .font-semibold { font-weight: 600; }
        .font-bold { font-weight: 700; }
        
        .text-xs { font-size: 0.75rem; }
        .text-sm { font-size: 0.875rem; }
        .text-lg { font-size: 1.125rem; }
        .text-xl { font-size: 1.25rem; }
        .text-2xl { font-size: 1.5rem; }
        .text-3xl { font-size: 1.875rem; }
        
        .text-left { text-align: left; }
        .text-center { text-align: center; }
        
        .capitalize { text-transform: capitalize; }
        .whitespace-nowrap { white-space: nowrap; }
        
        .overflow-hidden { overflow: hidden; }
        .overflow-x-auto { overflow-x: auto; }
        .overflow-y-auto { overflow-y: auto; }
        
        .fixed { position: fixed; }
        .inset-0 { top: 0; right: 0; bottom: 0; left: 0; }
        
        .z-50 { z-index: 50; }
        
        .hidden { display: none; }
        .block { display: block; }
        
        .opacity-70 { opacity: 0.7; }
        .opacity-80 { opacity: 0.8; }
        .opacity-90 { opacity: 0.9; }
        .bg-opacity-20 { background-color: rgba(255, 255, 255, 0.2); }
        .bg-opacity-30 { background-color: rgba(255, 255, 255, 0.3); }
        
        .transition { transition-property: color, background-color, border-color, text-decoration-color, fill, stroke, opacity, box-shadow, transform, filter, backdrop-filter; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 150ms; }
        
        .hover\:bg-gray-50:hover { background-color: #f9fafb; }
        .hover\:bg-gray-700:hover { background-color: #374151; }
        .hover\:bg-blue-700:hover { background-color: #1d4ed8; }
        .hover\:bg-green-700:hover { background-color: #15803d; }
        .hover\:bg-red-700:hover { background-color: #b91c1c; }
        .hover\:bg-purple-700:hover { background-color: #7c3aed; }
        .hover\:bg-orange-700:hover { background-color: #c2410c; }
        .hover\:bg-yellow-700:hover { background-color: #a16207; }
        .hover\:bg-red-800:hover { background-color: #991b1b; }
        .hover\:text-blue-800:hover { color: #1e40af; }
        .hover\:text-red-800:hover { color: #991b1b; }
        .hover\:text-green-800:hover { color: #166534; }
        .hover\:border-purple-500:hover { border-color: #a855f7; }
        .hover\:opacity-90:hover { opacity: 0.9; }
        .hover\:opacity-30:hover { opacity: 0.3; }
        
        .focus\:ring-2:focus { box-shadow: 0 0 0 2px rgba(168, 85, 247, 0.5); }
        .focus\:ring-purple-500:focus { box-shadow: 0 0 0 2px rgba(168, 85, 247, 0.5); }
        .focus\:border-transparent:focus { border-color: transparent; }
        
        /* Form Elements */
        input, select, textarea {
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            line-height: 1.25rem;
            width: 100%;
            background-color: #ffffff;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #a855f7;
            box-shadow: 0 0 0 2px rgba(168, 85, 247, 0.2);
        }
        
        button {
            border: none;
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s ease;
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Table Styles */
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            text-align: left;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #e5e7eb;
        }
        
        th {
            background-color: #f9fafb;
            font-weight: 500;
            color: #374151;
        }
        
        tr:hover {
            background-color: #f9fafb;
        }
        
        /* Responsive Design */
        @media (min-width: 768px) {
            .md\:grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
            .md\:grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
            .md\:grid-cols-5 { grid-template-columns: repeat(5, minmax(0, 1fr)); }
        }
        
        @media (min-width: 1024px) {
            .lg\:grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
            .lg\:grid-cols-4 { grid-template-columns: repeat(4, minmax(0, 1fr)); }
        }
        
        /* Custom Component Styles */
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .card-shadow {
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .tab-active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Firebase Configuration Modal -->
    <div id="firebaseConfigModal" class="fixed inset-0 modal-backdrop z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl card-shadow w-full max-w-2xl fade-in">
            <div class="p-6 border-b">
                <h3 class="text-xl font-semibold">üî• Firebase Configuration Required</h3>
                <p class="text-gray-600 mt-2">Please enter your Firebase configuration to connect to your database.</p>
            </div>
            <div class="p-6">
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
                    <h4 class="font-semibold text-yellow-800 mb-2">üìã How to get your Firebase config:</h4>
                    <ol class="text-sm text-yellow-700 space-y-1">
                        <li>1. Go to Firebase Console ‚Üí Project Settings</li>
                        <li>2. Scroll down to "Your apps" section</li>
                        <li>3. Click on your web app or create one</li>
                        <li>4. Copy the config object values</li>
                    </ol>
                </div>
                
                <form id="firebaseConfigForm" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">API Key</label>
                            <input type="text" id="apiKey" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="AIza..." required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Auth Domain</label>
                            <input type="text" id="authDomain" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="your-project.firebaseapp.com" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Project ID</label>
                            <input type="text" id="projectId" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="your-project-id" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Storage Bucket</label>
                            <input type="text" id="storageBucket" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="your-project.appspot.com" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Messaging Sender ID</label>
                            <input type="text" id="messagingSenderId" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="123456789" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">App ID</label>
                            <input type="text" id="appId" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="1:123:web:abc" required>
                        </div>
                    </div>
                    
                    <div class="flex space-x-3 mt-6">
                        <button type="button" onclick="loadDemoConfig()" class="flex-1 bg-gray-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-gray-700 transition">
                            Use Demo Mode (Local Storage)
                        </button>
                        <button type="submit" class="flex-1 gradient-bg text-white px-4 py-2 rounded-lg font-semibold hover:opacity-90 transition">
                            <span id="connectBtnText">Connect to Firebase</span>
                            <div id="connectLoader" class="loading hidden ml-2"></div>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="hidden min-h-screen gradient-bg flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl card-shadow p-8 w-full max-w-md fade-in">
            <div class="text-center mb-8">
                <div class="w-20 h-20 mx-auto mb-4 bg-gradient-to-r from-purple-500 to-pink-500 rounded-full flex items-center justify-center">
                    <svg class="w-10 h-10 text-white" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </div>
                <h1 class="text-3xl font-bold text-gray-800 mb-2">EDEN PERFUME</h1>
                <p class="text-gray-600">Sales Management System</p>
                <div class="mt-2 text-sm" id="dbStatus">
                    <div id="dbMode" class="text-green-600"></div>
                    <div id="syncStatus" class="text-xs mt-1"></div>
                </div>
            </div>
            
            <form id="loginForm" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                    <input type="text" id="username" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Enter username">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                    <input type="password" id="password" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Enter password">
                </div>
                
                <button type="submit" class="w-full gradient-bg text-white py-3 rounded-lg font-semibold hover:opacity-90 transition">
                    <span id="loginBtnText">Sign In</span>
                    <div id="loginLoader" class="loading hidden ml-2"></div>
                </button>
            </form>
            
            <div class="mt-8 p-4 bg-gray-50 rounded-lg">
                <p class="text-sm font-medium text-gray-700 mb-2">Demo Credentials:</p>
                <div class="text-xs text-gray-600 space-y-1">
                    <p><strong>Admin:</strong> admin / admin123</p>
                    <p><strong>Employee:</strong> Create employees first, then use their credentials</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Employee Portal -->
    <div id="employeePortal" class="hidden min-h-screen bg-gray-50">
        <nav class="gradient-bg text-white p-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z"/>
                        </svg>
                    </div>
                    <div>
                        <h2 class="font-semibold" id="employeeName">Employee</h2>
                        <p class="text-sm opacity-80" id="employeeStore">Store</p>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <div class="text-sm opacity-80" id="employeeCurrentDate"></div>
                    <div class="text-xs opacity-70" id="employeeSyncStatus">üì± Local Mode</div>
                    <button onclick="refreshData()" class="bg-blue-600 px-3 py-2 rounded-lg hover:bg-blue-700 transition font-semibold text-sm">
                        üîÑ Refresh
                    </button>
                    <button onclick="quickAddSale()" class="bg-green-600 px-3 py-2 rounded-lg hover:bg-green-700 transition font-semibold text-sm">
                        ‚ûï Quick Sale
                    </button>
                    <button onclick="viewTodaysSummary()" class="bg-purple-600 px-3 py-2 rounded-lg hover:bg-purple-700 transition font-semibold text-sm">
                        üìä Summary
                    </button>
                    <button onclick="logout()" class="bg-white bg-opacity-20 px-3 py-2 rounded-lg hover:bg-opacity-30 transition text-sm">
                        Logout
                    </button>
                </div>
            </div>
        </nav>

        <div class="p-6">
            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white rounded-xl card-shadow p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-600 text-sm">Total Sales Today</p>
                            <p class="text-2xl font-bold text-green-600" id="totalSalesToday">$0</p>
                        </div>
                        <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                            <svg class="w-6 h-6 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10a2 2 0 00-2-2H4zm2 6a2 2 0 012-2h8a2 2 0 012 2v4a2 2 0 01-2 2H8a2 2 0 01-2-2v-4zm6 4a2 2 0 100-4 2 2 0 000 4z"/>
                            </svg>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl card-shadow p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-600 text-sm">Bottles Sold</p>
                            <p class="text-2xl font-bold text-blue-600" id="bottlesSold">0</p>
                        </div>
                        <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                            <svg class="w-6 h-6 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
                            </svg>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl card-shadow p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-600 text-sm">Estimated Salary</p>
                            <p class="text-2xl font-bold text-purple-600" id="estimatedSalary">$0</p>
                        </div>
                        <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center">
                            <svg class="w-6 h-6 text-purple-600" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M8.433 7.418c.155-.103.346-.196.567-.267v1.698a2.305 2.305 0 01-.567-.267C8.07 8.34 8 8.114 8 8c0-.114.07-.34.433-.582zM11 12.849v-1.698c.22.071.412.164.567.267.364.243.433.468.433.582 0 .114-.07.34-.433.582a2.305 2.305 0 01-.567.267z"/>
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-13a1 1 0 10-2 0v.092a4.535 4.535 0 00-1.676.662C6.602 6.234 6 7.009 6 8c0 .99.602 1.765 1.324 2.246.48.32 1.054.545 1.676.662v1.941c-.391-.127-.68-.317-.843-.504a1 1 0 10-1.51 1.31c.562.649 1.413 1.076 2.353 1.253V15a1 1 0 102 0v-.092a4.535 4.535 0 001.676-.662C13.398 13.766 14 12.991 14 12c0-.99-.602-1.765-1.324-2.246A4.535 4.535 0 0011 9.092V7.151c.391.127.68.317.843.504a1 1 0 101.511-1.31c-.563-.649-1.413-1.076-2.354-1.253V5z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Add Sale Form -->
            <div class="bg-white rounded-xl card-shadow p-6 mb-8">
                <h3 class="text-xl font-semibold mb-6">Add New Sale</h3>
                <form id="addSaleForm" class="grid grid-cols-1 md:grid-cols-5 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Date</label>
                        <input type="date" id="saleDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Store</label>
                        <select id="saleStore" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" required>
                            <option value="">Select Store</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Product</label>
                        <select id="saleProduct" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" required>
                            <option value="">Select Product</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Quantity</label>
                        <input type="number" id="saleQuantity" min="1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="1" required>
                    </div>
                    <div class="flex items-end">
                        <button type="submit" class="w-full gradient-bg text-white py-2 rounded-lg font-semibold hover:opacity-90 transition">
                            Add Sale
                        </button>
                    </div>
                </form>
            </div>

            <!-- Today's Sales -->
            <div class="bg-white rounded-xl card-shadow p-6">
                <h3 class="text-xl font-semibold mb-6">Today's Sales</h3>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b">
                                <th class="text-left py-3 px-4">Time</th>
                                <th class="text-left py-3 px-4">Store</th>
                                <th class="text-left py-3 px-4">Product</th>
                                <th class="text-left py-3 px-4">Quantity</th>
                                <th class="text-left py-3 px-4">Amount</th>
                                <th class="text-left py-3 px-4">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="todaysSalesTable">
                            <tr>
                                <td colspan="5" class="text-center py-8 text-gray-500">No sales recorded today</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="dashboard" class="hidden min-h-screen bg-gray-50">
        <nav class="gradient-bg text-white p-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </div>
                    <div>
                        <h2 class="font-semibold">Eden Perfume Admin</h2>
                        <p class="text-sm opacity-80">Management Dashboard</p>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <div class="text-sm opacity-80" id="adminCurrentDate"></div>
                    <div class="text-xs opacity-70" id="adminSyncStatus">üì± Local Mode</div>
                    <button onclick="refreshData()" class="bg-blue-600 px-3 py-2 rounded-lg hover:bg-blue-700 transition font-semibold text-sm">
                        üîÑ Refresh
                    </button>
                    <button onclick="forceSyncNow()" class="bg-orange-600 px-3 py-2 rounded-lg hover:bg-orange-700 transition font-semibold text-sm">
                        üîÑ Sync Now
                    </button>
                    <button onclick="resetFirebaseConfig()" class="bg-red-600 px-3 py-2 rounded-lg hover:bg-red-700 transition font-semibold text-sm">
                        üî• Setup Firebase
                    </button>
                    <button onclick="viewTodaysSummary()" class="bg-purple-600 px-3 py-2 rounded-lg hover:bg-purple-700 transition font-semibold text-sm">
                        üìä Today's Summary
                    </button>
                    <button onclick="backupData()" class="bg-yellow-600 px-3 py-2 rounded-lg hover:bg-yellow-700 transition font-semibold text-sm">
                        üíæ Backup
                    </button>
                    <button onclick="downloadAllMasterData()" class="bg-green-600 px-3 py-2 rounded-lg hover:bg-green-700 transition font-semibold text-sm">
                        üì• Download All
                    </button>
                    <button onclick="logout()" class="bg-white bg-opacity-20 px-3 py-2 rounded-lg hover:bg-opacity-30 transition text-sm">
                        Logout
                    </button>
                </div>
            </div>
        </nav>

        <!-- Tab Navigation -->
        <div class="bg-white border-b">
            <div class="flex space-x-0 overflow-x-auto">
                <button onclick="switchTab('employees')" class="tab-btn px-6 py-4 font-medium whitespace-nowrap border-b-2 border-transparent hover:border-purple-500 transition" data-tab="employees">
                    Employees
                </button>
                <button onclick="switchTab('stores')" class="tab-btn px-6 py-4 font-medium whitespace-nowrap border-b-2 border-transparent hover:border-purple-500 transition" data-tab="stores">
                    Stores
                </button>
                <button onclick="switchTab('products')" class="tab-btn px-6 py-4 font-medium whitespace-nowrap border-b-2 border-transparent hover:border-purple-500 transition" data-tab="products">
                    Products
                </button>
                <button onclick="switchTab('collections')" class="tab-btn px-6 py-4 font-medium whitespace-nowrap border-b-2 border-transparent hover:border-purple-500 transition" data-tab="collections">
                    Collections
                </button>
                <button onclick="switchTab('database')" class="tab-btn px-6 py-4 font-medium whitespace-nowrap border-b-2 border-transparent hover:border-purple-500 transition" data-tab="database">
                    Database Manager
                </button>
                <button onclick="switchTab('sales')" class="tab-btn px-6 py-4 font-medium whitespace-nowrap border-b-2 border-transparent hover:border-purple-500 transition" data-tab="sales">
                    Sales Reports
                </button>
                <button onclick="switchTab('salary')" class="tab-btn px-6 py-4 font-medium whitespace-nowrap border-b-2 border-transparent hover:border-purple-500 transition" data-tab="salary">
                    Salary Reports
                </button>
            </div>
        </div>



        <!-- Tab Content -->
        <div class="p-6">
            <!-- Employees Tab -->
            <div id="employees-tab" class="tab-content">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Employee Management</h2>
                    <div class="flex space-x-2">
                        <button onclick="restoreData()" class="bg-orange-600 text-white px-3 py-2 rounded-lg font-semibold hover:bg-orange-700 transition text-sm">
                            üì§ Restore
                        </button>
                        <button onclick="clearAllData()" class="bg-red-600 text-white px-3 py-2 rounded-lg font-semibold hover:bg-red-700 transition text-sm">
                            üóëÔ∏è Clear All
                        </button>
                        <button onclick="openModal('employee')" class="gradient-bg text-white px-4 py-2 rounded-lg font-semibold hover:opacity-90 transition">
                            ‚ûï Add Employee
                        </button>
                    </div>
                </div>
                <div class="bg-white rounded-xl card-shadow overflow-hidden">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="text-left py-4 px-6">Name</th>
                                <th class="text-left py-4 px-6">Username</th>
                                <th class="text-left py-4 px-6">Store</th>
                                <th class="text-left py-4 px-6">Salary Type</th>
                                <th class="text-left py-4 px-6">Base Salary</th>
                                <th class="text-left py-4 px-6">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="employeesTable">
                            <tr>
                                <td colspan="6" class="text-center py-8 text-gray-500">
                                    No employees found. Click "Add Employee" to create your first employee.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Stores Tab -->
            <div id="stores-tab" class="tab-content hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Store Management</h2>
                    <button onclick="openModal('store')" class="gradient-bg text-white px-4 py-2 rounded-lg font-semibold hover:opacity-90 transition">
                        ‚ûï Add Store
                    </button>
                </div>
                <div class="bg-white rounded-xl card-shadow overflow-hidden">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="text-left py-4 px-6">Store Name</th>
                                <th class="text-left py-4 px-6">Location</th>
                                <th class="text-left py-4 px-6">Manager</th>
                                <th class="text-left py-4 px-6">Phone</th>
                                <th class="text-left py-4 px-6">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="storesTable">
                            <tr>
                                <td colspan="5" class="text-center py-8 text-gray-500">
                                    No stores found. Click "Add Store" to create your first store.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Products Tab -->
            <div id="products-tab" class="tab-content hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Product Management</h2>
                    <button onclick="openModal('product')" class="gradient-bg text-white px-4 py-2 rounded-lg font-semibold hover:opacity-90 transition">
                        ‚ûï Add Product
                    </button>
                </div>
                <div class="bg-white rounded-xl card-shadow overflow-hidden">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="text-left py-4 px-6">Product Name</th>
                                <th class="text-left py-4 px-6">Price</th>
                                <th class="text-left py-4 px-6">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="productsTable">
                            <tr>
                                <td colspan="3" class="text-center py-8 text-gray-500">
                                    No products found. Click "Add Product" to create your first product.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Collections Tab -->
            <div id="collections-tab" class="tab-content hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Collection Management</h2>
                    <button onclick="openModal('collection')" class="gradient-bg text-white px-4 py-2 rounded-lg font-semibold hover:opacity-90 transition">
                        ‚ûï Add Collection
                    </button>
                </div>
                <div class="bg-white rounded-xl card-shadow overflow-hidden">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="text-left py-4 px-6">Collection Name</th>
                                <th class="text-left py-4 px-6">Description</th>
                                <th class="text-left py-4 px-6">Products Count</th>
                                <th class="text-left py-4 px-6">Status</th>
                                <th class="text-left py-4 px-6">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="collectionsTable">
                            <tr>
                                <td colspan="5" class="text-center py-8 text-gray-500">
                                    No collections found. Click "Add Collection" to create your first collection.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Database Manager Tab -->
            <div id="database-tab" class="tab-content hidden">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold mb-4">Database Collection Manager</h2>
                    <p class="text-gray-600 mb-6">Directly manage your database collections. Add, edit, or delete data entries in real-time.</p>
                    
                    <!-- Collection Selector -->
                    <div class="bg-white rounded-xl card-shadow p-6 mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Select Collection</label>
                                <select id="dbCollectionSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" onchange="loadDatabaseCollection()">
                                    <option value="">Choose a collection...</option>
                                    <option value="employees">Employees</option>
                                    <option value="stores">Stores</option>
                                    <option value="products">Products</option>
                                    <option value="collections">Collections</option>
                                    <option value="sales">Sales</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Database Status</label>
                                <div class="px-3 py-2 bg-gray-50 rounded-lg">
                                    <span id="dbConnectionStatus" class="text-sm">üì± Local Mode</span>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Actions</label>
                                <div class="flex space-x-2">
                                    <button onclick="addDatabaseEntry()" class="bg-green-600 text-white px-3 py-2 rounded-lg hover:bg-green-700 transition text-sm">
                                        ‚ûï Add Entry
                                    </button>
                                    <button onclick="refreshDatabaseView()" class="bg-blue-600 text-white px-3 py-2 rounded-lg hover:bg-blue-700 transition text-sm">
                                        üîÑ Refresh
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Database Table View -->
                <div class="bg-white rounded-xl card-shadow overflow-hidden">
                    <div class="p-4 bg-gray-50 border-b">
                        <h3 id="dbTableTitle" class="text-lg font-semibold">Select a collection to view data</h3>
                        <p id="dbTableCount" class="text-sm text-gray-600 mt-1">0 entries</p>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-100">
                                <tr id="dbTableHeader">
                                    <th class="text-left py-3 px-4 text-sm font-medium text-gray-700">Select a collection</th>
                                </tr>
                            </thead>
                            <tbody id="dbTableBody">
                                <tr>
                                    <td class="text-center py-8 text-gray-500">Select a collection from the dropdown above</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Sales Reports Tab -->
            <div id="sales-tab" class="tab-content hidden">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold mb-4">Sales Reports</h2>
                    
                    <!-- Report Controls -->
                    <div class="bg-white rounded-xl card-shadow p-6 mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Start Date</label>
                                <input type="date" id="reportStartDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">End Date</label>
                                <input type="date" id="reportEndDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Report Type</label>
                                <select id="reportType" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                    <option value="all">All Sales</option>
                                    <option value="daily">Daily Report</option>
                                    <option value="monthly">Monthly Report</option>
                                    <option value="store">Store Wise</option>
                                    <option value="staff">Staff Wise</option>
                                    <option value="product">Product Wise</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Filter By</label>
                                <select id="reportFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                    <option value="">All</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="flex flex-wrap gap-2">
                            <button onclick="generateSalesReport()" class="gradient-bg text-white px-4 py-2 rounded-lg font-semibold hover:opacity-90 transition">
                                üìä Generate Report
                            </button>
                            <button onclick="printReport('sales')" class="bg-gray-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-gray-700 transition">
                                üñ®Ô∏è Print
                            </button>
                            <button onclick="downloadExcel('sales')" class="bg-green-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-700 transition">
                                üìä Excel
                            </button>
                            <button onclick="downloadPDF('sales')" class="bg-red-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-red-700 transition">
                                üìÑ PDF
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-xl card-shadow overflow-hidden">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr id="salesReportHeader">
                                <th class="text-left py-4 px-6">Date</th>
                                <th class="text-left py-4 px-6">Employee</th>
                                <th class="text-left py-4 px-6">Store</th>
                                <th class="text-left py-4 px-6">Product</th>
                                <th class="text-left py-4 px-6">Quantity</th>
                                <th class="text-left py-4 px-6">Amount</th>
                            </tr>
                        </thead>
                        <tbody id="salesReportTable">
                            <tr>
                                <td colspan="6" class="text-center py-8 text-gray-500">Select date range and report type to generate report</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Salary Reports Tab -->
            <div id="salary-tab" class="tab-content hidden">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold mb-4">Salary Reports</h2>
                    
                    <!-- Salary Report Controls -->
                    <div class="bg-white rounded-xl card-shadow p-6 mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Start Date</label>
                                <input type="date" id="salaryStartDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">End Date</label>
                                <input type="date" id="salaryEndDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Employee</label>
                                <select id="salaryEmployee" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                    <option value="">All Employees</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="flex flex-wrap gap-2">
                            <button onclick="generateSalaryReport()" class="gradient-bg text-white px-4 py-2 rounded-lg font-semibold hover:opacity-90 transition">
                                üí∞ Generate Report
                            </button>
                            <button onclick="printReport('salary')" class="bg-gray-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-gray-700 transition">
                                üñ®Ô∏è Print
                            </button>
                            <button onclick="downloadExcel('salary')" class="bg-green-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-700 transition">
                                üìä Excel
                            </button>
                            <button onclick="downloadPDF('salary')" class="bg-red-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-red-700 transition">
                                üìÑ PDF
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-xl card-shadow overflow-hidden">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="text-left py-4 px-6">Employee</th>
                                <th class="text-left py-4 px-6">Salary Type</th>
                                <th class="text-left py-4 px-6">Base Salary</th>
                                <th class="text-left py-4 px-6">Bonus/Commission</th>
                                <th class="text-left py-4 px-6">Total Sales</th>
                                <th class="text-left py-4 px-6">Days/Qty</th>
                                <th class="text-left py-4 px-6">Total Salary</th>
                            </tr>
                        </thead>
                        <tbody id="salaryReportTable">
                            <tr>
                                <td colspan="7" class="text-center py-8 text-gray-500">Select date range to generate report</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="modal" class="hidden fixed inset-0 modal-backdrop z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl card-shadow w-full max-w-md fade-in">
            <div class="p-6 border-b">
                <h3 id="modalTitle" class="text-xl font-semibold">Add Item</h3>
            </div>
            <div class="p-6">
                <form id="modalForm">
                    <div id="modalFields" class="space-y-4">
                        <!-- Dynamic fields will be inserted here -->
                    </div>
                    <div class="flex space-x-3 mt-6">
                        <button type="button" onclick="closeModal()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition">
                            Cancel
                        </button>
                        <button type="submit" class="flex-1 gradient-bg text-white px-4 py-2 rounded-lg font-semibold hover:opacity-90 transition">
                            <span id="saveBtnText">Save</span>
                            <div id="saveLoader" class="loading hidden ml-2"></div>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Firebase loading error handler
        function handleFirebaseLoadError(component) {
            console.warn(`Firebase ${component} failed to load - falling back to local mode`);
            window.firebaseLoadError = true;
        }

        // Global Variables
        let db = null;
        let isFirebaseMode = false;
        let currentUser = null;
        let currentUserRole = null;
        let editingItem = null;
        let editingType = null;

        // Local Storage Data (Always used as primary storage)
        let employees = [];
        let stores = [];
        let products = [];
        let collections = [];
        let sales = [];

        // Initialize arrays safely
        function initializeArrays() {
            if (!Array.isArray(employees)) employees = [];
            if (!Array.isArray(stores)) stores = [];
            if (!Array.isArray(products)) products = [];
            if (!Array.isArray(collections)) collections = [];
            if (!Array.isArray(sales)) sales = [];
        }

        // Sync Management
        let syncQueue = [];
        let isSyncing = false;
        let lastSyncTime = null;
        let syncStatus = 'offline';

        // Firebase Configuration
        function initializeFirebase(config) {
            try {
                // Check if Firebase is available and loaded properly
                if (typeof firebase === 'undefined' || window.firebaseLoadError) {
                    console.warn('Firebase SDK not available, falling back to local mode');
                    return false;
                }
                
                // Check if Firebase is already initialized
                if (firebase.apps.length === 0) {
                    firebase.initializeApp(config);
                }
                
                db = firebase.firestore();
                isFirebaseMode = true;
                syncStatus = 'connected';
                updateSyncStatus();
                document.getElementById('dbMode').textContent = 'üî• Firebase Connected';
                
                // Start background sync
                startBackgroundSync();
                return true;
            } catch (error) {
                console.error('Firebase initialization error:', error);
                alert('Failed to connect to Firebase: ' + error.message + '\n\nFalling back to local storage mode.');
                return false;
            }
        }

        // Firebase Configuration Form
        document.getElementById('firebaseConfigForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const connectBtn = document.getElementById('connectBtnText');
            const loader = document.getElementById('connectLoader');
            
            connectBtn.textContent = 'Connecting...';
            loader.classList.remove('hidden');
            
            const config = {
                apiKey: document.getElementById('apiKey').value,
                authDomain: document.getElementById('authDomain').value,
                projectId: document.getElementById('projectId').value,
                storageBucket: document.getElementById('storageBucket').value,
                messagingSenderId: document.getElementById('messagingSenderId').value,
                appId: document.getElementById('appId').value
            };
            
            // Save config to localStorage for future use
            localStorage.setItem('firebaseConfig', JSON.stringify(config));
            
            if (initializeFirebase(config)) {
                document.getElementById('firebaseConfigModal').classList.add('hidden');
                document.getElementById('loginScreen').classList.remove('hidden');
                await loadAllData();
            }
            
            connectBtn.textContent = 'Connect to Firebase';
            loader.classList.add('hidden');
        });

        // Demo Mode
        function loadDemoConfig() {
            isFirebaseMode = false;
            syncStatus = 'offline';
            updateSyncStatus();
            document.getElementById('dbMode').textContent = 'üíæ Local Storage Mode';
            document.getElementById('firebaseConfigModal').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            loadLocalData();
        }

        // Sync Status Management
        function updateSyncStatus() {
            const statusElements = ['syncStatus', 'employeeSyncStatus', 'adminSyncStatus'];
            let statusText = '';
            let statusColor = '';
            
            switch(syncStatus) {
                case 'connected':
                    statusText = 'üîÑ Syncing...';
                    statusColor = 'text-blue-600';
                    break;
                case 'synced':
                    statusText = '‚úÖ Synced';
                    statusColor = 'text-green-600';
                    break;
                case 'pending':
                    statusText = '‚è≥ Pending sync';
                    statusColor = 'text-yellow-600';
                    break;
                case 'error':
                    statusText = '‚ùå Sync error';
                    statusColor = 'text-red-600';
                    break;
                default: // offline
                    statusText = 'üì± Local Mode';
                    statusColor = 'text-gray-600';
            }
            
            statusElements.forEach(elementId => {
                const element = document.getElementById(elementId);
                if (element) {
                    element.textContent = statusText;
                    element.className = `text-xs opacity-70 ${statusColor}`;
                }
            });
            
            // Update last sync time if available
            if (lastSyncTime && syncStatus === 'synced') {
                const timeStr = new Date(lastSyncTime).toLocaleTimeString();
                statusElements.forEach(elementId => {
                    const element = document.getElementById(elementId);
                    if (element) {
                        element.textContent = `‚úÖ Synced ${timeStr}`;
                    }
                });
            }
        }

        // Queue item for sync
        function queueForSync(action, type, data) {
            const syncItem = {
                id: Date.now() + Math.random(),
                action: action, // 'create', 'update', 'delete'
                type: type, // 'employee', 'store', 'product', 'sale'
                data: data,
                timestamp: new Date().toISOString(),
                attempts: 0
            };
            
            syncQueue.push(syncItem);
            localStorage.setItem('eden_sync_queue', JSON.stringify(syncQueue));
            
            if (isFirebaseMode) {
                syncStatus = 'pending';
                updateSyncStatus();
                // Trigger sync after short delay
                setTimeout(processSyncQueue, 1000);
            }
        }

        // Process sync queue
        async function processSyncQueue() {
            if (!isFirebaseMode || isSyncing || syncQueue.length === 0) {
                return;
            }
            
            isSyncing = true;
            syncStatus = 'connected';
            updateSyncStatus();
            
            const itemsToProcess = [...syncQueue];
            const processedItems = [];
            
            for (const item of itemsToProcess) {
                try {
                    await processSyncItem(item);
                    processedItems.push(item);
                } catch (error) {
                    console.error('Sync error for item:', item, error);
                    item.attempts = (item.attempts || 0) + 1;
                    
                    // Remove item if too many attempts
                    if (item.attempts >= 3) {
                        processedItems.push(item);
                        console.error('Removing item after 3 failed attempts:', item);
                    }
                }
            }
            
            // Remove processed items from queue
            syncQueue = syncQueue.filter(item => !processedItems.includes(item));
            localStorage.setItem('eden_sync_queue', JSON.stringify(syncQueue));
            
            isSyncing = false;
            syncStatus = syncQueue.length > 0 ? 'pending' : 'synced';
            lastSyncTime = new Date().toISOString();
            updateSyncStatus();
        }

        // Process individual sync item
        async function processSyncItem(item) {
            const { action, type, data } = item;
            
            switch (action) {
                case 'create':
                    if (data.id && data.id.toString().length <= 10) {
                        // Local ID, need to create new document
                        const docRef = await db.collection(type + 's').add({
                            ...data,
                            localId: data.id,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        
                        // Update local data with Firebase ID
                        const collection = getCollectionByType(type);
                        const localItem = collection.find(item => item.id === data.id);
                        if (localItem) {
                            localItem.firebaseId = docRef.id;
                        }
                        saveLocalData();
                    }
                    break;
                    
                case 'update':
                    const firebaseId = data.firebaseId || data.id;
                    if (firebaseId && firebaseId.toString().length > 10) {
                        await db.collection(type + 's').doc(firebaseId).update({
                            ...data,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                    break;
                    
                case 'delete':
                    const deleteId = data.firebaseId || data.id;
                    if (deleteId && deleteId.toString().length > 10) {
                        await db.collection(type + 's').doc(deleteId).delete();
                    }
                    break;
            }
        }

        // Get collection by type
        function getCollectionByType(type) {
            switch (type) {
                case 'employee': return employees;
                case 'store': return stores;
                case 'product': return products;
                case 'sale': return sales;
                default: return [];
            }
        }

        // Background sync
        function startBackgroundSync() {
            // Load sync queue from localStorage
            const savedQueue = localStorage.getItem('eden_sync_queue');
            if (savedQueue) {
                syncQueue = JSON.parse(savedQueue);
            }
            
            // Process queue immediately
            processSyncQueue();
            
            // Set up periodic sync
            setInterval(() => {
                if (isFirebaseMode && !isSyncing) {
                    processSyncQueue();
                }
            }, 30000); // Sync every 30 seconds
        }

        // Force sync now
        async function forceSyncNow() {
            if (!isFirebaseMode) {
                alert('Firebase is not connected. Click "üî• Setup Firebase" to configure your database connection.');
                return;
            }
            
            syncStatus = 'connected';
            updateSyncStatus();
            
            try {
                await processSyncQueue();
                alert('Sync completed successfully!');
            } catch (error) {
                syncStatus = 'error';
                updateSyncStatus();
                alert('Sync failed: ' + error.message);
            }
        }

        // Reset Firebase Configuration
        function resetFirebaseConfig() {
            if (confirm('This will reset your Firebase configuration. You will need to re-enter your credentials. Continue?')) {
                // Clear saved config
                localStorage.removeItem('firebaseConfig');
                
                // Reset Firebase state
                isFirebaseMode = false;
                db = null;
                syncStatus = 'offline';
                updateSyncStatus();
                
                // Show configuration modal
                document.getElementById('firebaseConfigModal').classList.remove('hidden');
                
                // Clear form fields
                document.getElementById('apiKey').value = '';
                document.getElementById('authDomain').value = '';
                document.getElementById('projectId').value = '';
                document.getElementById('storageBucket').value = '';
                document.getElementById('messagingSenderId').value = '';
                document.getElementById('appId').value = '';
            }
        }

        // Data Loading Functions
        async function loadAllData() {
            // Always load from local storage first
            loadLocalData();
            
            // If Firebase is connected, sync in background
            if (isFirebaseMode) {
                setTimeout(processSyncQueue, 1000);
            }
        }

        function loadLocalData() {
            try {
                employees = JSON.parse(localStorage.getItem('eden_employees') || '[]');
                stores = JSON.parse(localStorage.getItem('eden_stores') || '[]');
                products = JSON.parse(localStorage.getItem('eden_products') || '[]');
                collections = JSON.parse(localStorage.getItem('eden_collections') || '[]');
                sales = JSON.parse(localStorage.getItem('eden_sales') || '[]');
                
                // Ensure arrays are valid
                initializeArrays();
                
                console.log('Local data loaded:', {
                    employees: employees.length,
                    stores: stores.length,
                    products: products.length,
                    collections: collections.length,
                    sales: sales.length
                });
            } catch (error) {
                console.error('Error loading local data:', error);
                // Reset to empty arrays if parsing fails
                employees = [];
                stores = [];
                products = [];
                collections = [];
                sales = [];
            }
        }

        function saveLocalData() {
            try {
                localStorage.setItem('eden_employees', JSON.stringify(employees));
                localStorage.setItem('eden_stores', JSON.stringify(stores));
                localStorage.setItem('eden_products', JSON.stringify(products));
                localStorage.setItem('eden_collections', JSON.stringify(collections));
                localStorage.setItem('eden_sales', JSON.stringify(sales));
                
                console.log('Local data saved:', {
                    employees: employees.length,
                    stores: stores.length,
                    products: products.length,
                    collections: collections.length,
                    sales: sales.length
                });
            } catch (error) {
                console.error('Error saving local data:', error);
            }
        }

        // Firebase Data Loading
        async function loadEmployees() {
            if (!isFirebaseMode) return;
            try {
                const snapshot = await db.collection('employees').get();
                employees = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (error) {
                console.error('Error loading employees:', error);
                employees = [];
            }
        }

        async function loadStores() {
            if (!isFirebaseMode) return;
            try {
                const snapshot = await db.collection('stores').get();
                stores = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (error) {
                console.error('Error loading stores:', error);
                stores = [];
            }
        }

        async function loadProducts() {
            if (!isFirebaseMode) return;
            try {
                const snapshot = await db.collection('products').get();
                products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (error) {
                console.error('Error loading products:', error);
                products = [];
            }
        }

        async function loadSales() {
            if (!isFirebaseMode) return;
            try {
                const snapshot = await db.collection('sales').get();
                sales = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (error) {
                console.error('Error loading sales:', error);
                sales = [];
            }
        }

        // Local-First Data Saving
        async function saveEmployee(employee) {
            // Always save locally first
            const isNew = !employee.id;
            if (isNew) {
                employee.id = Date.now().toString();
            }
            
            const index = employees.findIndex(emp => emp.id === employee.id);
            if (index >= 0) {
                employees[index] = { ...employees[index], ...employee };
            } else {
                employees.push(employee);
            }
            saveLocalData();
            
            // Queue for Firebase sync if connected
            if (isFirebaseMode) {
                queueForSync(isNew ? 'create' : 'update', 'employee', employee);
            }
        }

        async function saveStore(store) {
            // Always save locally first
            const isNew = !store.id;
            if (isNew) {
                store.id = Date.now().toString();
            }
            
            const index = stores.findIndex(s => s.id === store.id);
            if (index >= 0) {
                stores[index] = { ...stores[index], ...store };
            } else {
                stores.push(store);
            }
            saveLocalData();
            
            // Queue for Firebase sync if connected
            if (isFirebaseMode) {
                queueForSync(isNew ? 'create' : 'update', 'store', store);
            }
        }

        async function saveProduct(product) {
            // Always save locally first
            const isNew = !product.id;
            if (isNew) {
                product.id = Date.now().toString();
            }
            
            const index = products.findIndex(p => p.id === product.id);
            if (index >= 0) {
                products[index] = { ...products[index], ...product };
            } else {
                products.push(product);
            }
            saveLocalData();
            
            // Queue for Firebase sync if connected
            if (isFirebaseMode) {
                queueForSync(isNew ? 'create' : 'update', 'product', product);
            }
        }

        async function saveCollection(collection) {
            // Always save locally first
            const isNew = !collection.id;
            if (isNew) {
                collection.id = Date.now().toString();
            }
            
            const index = collections.findIndex(c => c.id === collection.id);
            if (index >= 0) {
                collections[index] = { ...collections[index], ...collection };
            } else {
                collections.push(collection);
            }
            saveLocalData();
            
            // Queue for Firebase sync if connected
            if (isFirebaseMode) {
                queueForSync(isNew ? 'create' : 'update', 'collection', collection);
            }
        }

        async function saveSale(sale) {
            // Always save locally first
            const isNew = !sale.id;
            if (isNew) {
                sale.id = Date.now().toString();
            }
            
            const index = sales.findIndex(s => s.id === sale.id);
            if (index >= 0) {
                sales[index] = { ...sales[index], ...sale };
            } else {
                sales.push(sale);
            }
            saveLocalData();
            
            // Queue for Firebase sync if connected
            if (isFirebaseMode) {
                queueForSync(isNew ? 'create' : 'update', 'sale', sale);
            }
        }

        // Local-First Delete Functions
        async function deleteEmployee(id) {
            // Find the item to get Firebase ID if it exists
            const employee = employees.find(emp => emp.id === id);
            
            // Delete locally first
            employees = employees.filter(emp => emp.id !== id);
            saveLocalData();
            
            // Queue for Firebase sync if connected
            if (isFirebaseMode && employee) {
                queueForSync('delete', 'employee', employee);
            }
        }

        async function deleteStore(id) {
            const store = stores.find(s => s.id === id);
            
            stores = stores.filter(s => s.id !== id);
            saveLocalData();
            
            if (isFirebaseMode && store) {
                queueForSync('delete', 'store', store);
            }
        }

        async function deleteProduct(id) {
            const product = products.find(p => p.id === id);
            
            products = products.filter(p => p.id !== id);
            saveLocalData();
            
            if (isFirebaseMode && product) {
                queueForSync('delete', 'product', product);
            }
        }

        async function deleteCollection(id) {
            const collection = collections.find(c => c.id === id);
            
            collections = collections.filter(c => c.id !== id);
            saveLocalData();
            
            if (isFirebaseMode && collection) {
                queueForSync('delete', 'collection', collection);
            }
        }

        async function deleteSaleRecord(id) {
            const sale = sales.find(s => s.id === id);
            
            sales = sales.filter(s => s.id !== id);
            saveLocalData();
            
            if (isFirebaseMode && sale) {
                queueForSync('delete', 'sale', sale);
            }
        }

        // Utility Functions
        function getStoreName(storeId) {
            try {
                // Check if storeId is valid
                if (!storeId || storeId === null || storeId === undefined || storeId === '') {
                    return 'Unknown Store';
                }
                
                // Check if stores array is valid
                if (!stores || !Array.isArray(stores) || stores.length === 0) {
                    return 'Unknown Store';
                }
                
                // Find the store with comprehensive null checking
                const store = stores.find(s => {
                    return s && 
                           s !== null && 
                           s !== undefined && 
                           s.id && 
                           s.id !== null && 
                           s.id !== undefined && 
                           s.id.toString() === storeId.toString();
                });
                
                // Return store name with null checking
                if (store && store.name && typeof store.name === 'string' && store.name.trim() !== '') {
                    return store.name.trim();
                } else {
                    return 'Unknown Store';
                }
            } catch (error) {
                console.error('Error in getStoreName:', error, 'storeId:', storeId);
                return 'Unknown Store';
            }
        }

        function getProductName(productId) {
            try {
                // Check if productId is valid
                if (!productId || productId === null || productId === undefined || productId === '') {
                    return 'Unknown Product';
                }
                
                // Check if products array is valid
                if (!products || !Array.isArray(products) || products.length === 0) {
                    return 'Unknown Product';
                }
                
                // Find the product with comprehensive null checking
                const product = products.find(p => {
                    return p && 
                           p !== null && 
                           p !== undefined && 
                           p.id && 
                           p.id !== null && 
                           p.id !== undefined && 
                           p.id.toString() === productId.toString();
                });
                
                // Return product name with null checking
                if (product && product.name && typeof product.name === 'string' && product.name.trim() !== '') {
                    return product.name.trim();
                } else {
                    return 'Unknown Product';
                }
            } catch (error) {
                console.error('Error in getProductName:', error, 'productId:', productId);
                return 'Unknown Product';
            }
        }

        function getEmployeeName(employeeId) {
            try {
                // Check if employeeId is valid
                if (!employeeId || employeeId === null || employeeId === undefined || employeeId === '') {
                    return 'Unknown Employee';
                }
                
                // Check if employees array is valid
                if (!employees || !Array.isArray(employees) || employees.length === 0) {
                    return 'Unknown Employee';
                }
                
                // Find the employee with comprehensive null checking
                const employee = employees.find(e => {
                    return e && 
                           e !== null && 
                           e !== undefined && 
                           e.id && 
                           e.id !== null && 
                           e.id !== undefined && 
                           e.id.toString() === employeeId.toString();
                });
                
                // Return employee name with null checking
                if (employee && employee.name && typeof employee.name === 'string' && employee.name.trim() !== '') {
                    return employee.name.trim();
                } else {
                    return 'Unknown Employee';
                }
            } catch (error) {
                console.error('Error in getEmployeeName:', error, 'employeeId:', employeeId);
                return 'Unknown Employee';
            }
        }

        function getProduct(productId) {
            try {
                // Check if productId is valid
                if (!productId || productId === null || productId === undefined || productId === '') {
                    return null;
                }
                
                // Check if products array is valid
                if (!products || !Array.isArray(products) || products.length === 0) {
                    return null;
                }
                
                // Find the product with comprehensive null checking
                const product = products.find(p => {
                    return p && 
                           p !== null && 
                           p !== undefined && 
                           p.id && 
                           p.id !== null && 
                           p.id !== undefined && 
                           p.id.toString() === productId.toString();
                });
                
                // Return the product object or null
                return product || null;
            } catch (error) {
                console.error('Error in getProduct:', error, 'productId:', productId);
                return null;
            }
        }

        // Additional utility function to get store object
        function getStore(storeId) {
            try {
                // Check if storeId is valid
                if (!storeId || storeId === null || storeId === undefined || storeId === '') {
                    return null;
                }
                
                // Check if stores array is valid
                if (!stores || !Array.isArray(stores) || stores.length === 0) {
                    return null;
                }
                
                // Find the store with comprehensive null checking
                const store = stores.find(s => {
                    return s && 
                           s !== null && 
                           s !== undefined && 
                           s.id && 
                           s.id !== null && 
                           s.id !== undefined && 
                           s.id.toString() === storeId.toString();
                });
                
                // Return the store object or null
                return store || null;
            } catch (error) {
                console.error('Error in getStore:', error, 'storeId:', storeId);
                return null;
            }
        }

        // Additional utility function to get employee object
        function getEmployee(employeeId) {
            try {
                // Check if employeeId is valid
                if (!employeeId || employeeId === null || employeeId === undefined || employeeId === '') {
                    return null;
                }
                
                // Check if employees array is valid
                if (!employees || !Array.isArray(employees) || employees.length === 0) {
                    return null;
                }
                
                // Find the employee with comprehensive null checking
                const employee = employees.find(e => {
                    return e && 
                           e !== null && 
                           e !== undefined && 
                           e.id && 
                           e.id !== null && 
                           e.id !== undefined && 
                           e.id.toString() === employeeId.toString();
                });
                
                // Return the employee object or null
                return employee || null;
            } catch (error) {
                console.error('Error in getEmployee:', error, 'employeeId:', employeeId);
                return null;
            }
        }

        function getTodayString() {
            return new Date().toISOString().split('T')[0];
        }

        function getCurrentTime() {
            return new Date().toLocaleTimeString('en-US', { 
                hour12: false, 
                hour: '2-digit', 
                minute: '2-digit' 
            });
        }

        function updateCurrentDate(elementId) {
            const now = new Date();
            const dateString = now.toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            document.getElementById(elementId).textContent = dateString;
        }

        // Login System
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const loginBtn = document.getElementById('loginBtnText');
            const loader = document.getElementById('loginLoader');
            
            loginBtn.textContent = 'Signing in...';
            loader.classList.remove('hidden');
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            // Check admin credentials
            if (username === 'admin' && password === 'admin123') {
                currentUser = { name: 'Administrator', role: 'admin' };
                currentUserRole = 'admin';
                await showDashboard();
                loginBtn.textContent = 'Sign In';
                loader.classList.add('hidden');
                return;
            }
            
            // Check employee credentials
            const employee = employees.find(emp => 
                emp.username === username && emp.password === password
            );
            
            if (employee) {
                currentUser = employee;
                currentUserRole = 'employee';
                await showEmployeePortal();
                loginBtn.textContent = 'Sign In';
                loader.classList.add('hidden');
                return;
            }
            
            alert('Invalid credentials. Please try again.');
            loginBtn.textContent = 'Sign In';
            loader.classList.add('hidden');
        });

        function logout() {
            currentUser = null;
            currentUserRole = null;
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('employeePortal').classList.add('hidden');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }

        // Employee Portal Functions
        async function showEmployeePortal() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('employeePortal').classList.remove('hidden');
            
            // Update employee info
            document.getElementById('employeeName').textContent = currentUser.name;
            document.getElementById('employeeStore').textContent = getStoreName(currentUser.storeId);
            
            // Update current date
            updateCurrentDate('employeeCurrentDate');
            
            // Set today's date in the form
            document.getElementById('saleDate').value = getTodayString();
            
            // Populate dropdowns
            populateProductDropdown();
            populateStoreDropdown();
            
            // Update stats and sales table
            updateEmployeeStats();
            updateTodaysSalesTable();
        }

        function populateProductDropdown() {
            try {
                const select = document.getElementById('saleProduct');
                if (!select) {
                    console.error('Product dropdown element not found');
                    return;
                }
                
                select.innerHTML = '<option value="">Select Product</option>';
                
                if (!products || !Array.isArray(products)) {
                    console.error('Products array is not valid');
                    return;
                }
                
                products.filter(product => product && product.id && product.name).forEach(product => {
                    try {
                        const option = document.createElement('option');
                        option.value = product.id;
                        option.textContent = `${product.name} - $${(product.price || 0).toFixed(2)}`;
                        select.appendChild(option);
                    } catch (error) {
                        console.error('Error creating product option:', error);
                    }
                });
            } catch (error) {
                console.error('Error in populateProductDropdown:', error);
            }
        }

        function populateStoreDropdown() {
            try {
                const select = document.getElementById('saleStore');
                if (!select) {
                    console.log('Store dropdown element not found (this is normal for some views)');
                    return;
                }
                
                select.innerHTML = '<option value="">Select Store</option>';
                
                if (!stores || !Array.isArray(stores)) {
                    console.error('Stores array is not valid');
                    return;
                }
                
                stores.filter(store => store && store.id && store.name).forEach(store => {
                    try {
                        const option = document.createElement('option');
                        option.value = store.id;
                        option.textContent = store.name;
                        select.appendChild(option);
                    } catch (error) {
                        console.error('Error creating store option:', error);
                    }
                });
                
                // Set default store for employee
                if (currentUser && currentUser.storeId) {
                    select.value = currentUser.storeId;
                }
            } catch (error) {
                console.error('Error in populateStoreDropdown:', error);
            }
        }

        function updateEmployeeStats() {
            try {
                if (!currentUser || !currentUser.id) {
                    console.error('No current user found');
                    return;
                }
                
                // Ensure arrays are initialized
                initializeArrays();
                
                const today = getTodayString();
                const todaysSales = sales.filter(sale => 
                    sale && sale.date === today && sale.employeeId === currentUser.id
                );
                
                const totalSales = todaysSales.reduce((sum, sale) => sum + (sale.amount || 0), 0);
                const bottlesSold = todaysSales.reduce((sum, sale) => sum + (sale.quantity || 0), 0);
                
                // Calculate estimated salary based on salary type
                let estimatedSalary = currentUser.baseSalary || 0;
                const monthSales = sales.filter(sale => {
                    if (!sale || !sale.date) return false;
                    try {
                        const saleDate = new Date(sale.date);
                        const currentDate = new Date();
                        return saleDate.getMonth() === currentDate.getMonth() && 
                               saleDate.getFullYear() === currentDate.getFullYear() &&
                               sale.employeeId === currentUser.id;
                    } catch (error) {
                        return false;
                    }
                });
                
                const monthlyQuantity = monthSales.reduce((sum, sale) => sum + (sale.quantity || 0), 0);
                const monthlySalesAmount = monthSales.reduce((sum, sale) => sum + (sale.amount || 0), 0);
                const uniqueDays = [...new Set(monthSales.map(sale => sale.date).filter(date => date))].length;
                
                switch(currentUser.salaryType) {
                    case 'commission':
                        estimatedSalary += monthlySalesAmount * (currentUser.commissionRate || 0.1);
                        break;
                    case 'qty_sold':
                        estimatedSalary += monthlyQuantity * 5; // $5 per item
                        break;
                    case 'days_present':
                        estimatedSalary += uniqueDays * 50; // $50 per day
                        break;
                }
                
                // Safe DOM element updates with null checks
                const totalSalesTodayEl = document.getElementById('totalSalesToday');
                const bottlesSoldEl = document.getElementById('bottlesSold');
                const estimatedSalaryEl = document.getElementById('estimatedSalary');
                
                if (totalSalesTodayEl) {
                    totalSalesTodayEl.textContent = `$${totalSales.toFixed(2)}`;
                }
                if (bottlesSoldEl) {
                    bottlesSoldEl.textContent = bottlesSold.toString();
                }
                if (estimatedSalaryEl) {
                    estimatedSalaryEl.textContent = `$${estimatedSalary.toFixed(2)}`;
                }
            } catch (error) {
                console.error('Error in updateEmployeeStats:', error);
            }
        }

        function updateTodaysSalesTable() {
            try {
                if (!currentUser || !currentUser.id) {
                    console.error('No current user found for sales table update');
                    return;
                }
                
                const today = getTodayString();
                const todaysSales = sales.filter(sale => 
                    sale && sale.date === today && sale.employeeId === currentUser.id
                );
                
                const tbody = document.getElementById('todaysSalesTable');
                if (!tbody) {
                    console.error('Sales table body element not found');
                    return;
                }
                
                if (todaysSales.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-500">No sales recorded today</td></tr>';
                    return;
                }
                
                tbody.innerHTML = todaysSales.filter(sale => sale && sale.id).map(sale => {
                    // Safe property access with fallbacks
                    const saleTime = sale.time || 'N/A';
                    const storeName = getStoreName(sale.storeId);
                    const productName = getProductName(sale.productId);
                    const quantity = sale.quantity || 0;
                    const amount = sale.amount || 0;
                    const saleId = sale.id || '';
                    
                    return `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="py-3 px-4">${saleTime}</td>
                            <td class="py-3 px-4">${storeName}</td>
                            <td class="py-3 px-4">${productName}</td>
                            <td class="py-3 px-4">${quantity}</td>
                            <td class="py-3 px-4">$${amount.toFixed(2)}</td>
                            <td class="py-3 px-4">
                                <button onclick="deleteSale('${saleId}')" class="text-red-600 hover:text-red-800 text-sm">
                                    Delete
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error in updateTodaysSalesTable:', error);
                const tbody = document.getElementById('todaysSalesTable');
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-red-500">Error loading sales data</td></tr>';
                }
            }
        }

        // Add Sale Form
        document.getElementById('addSaleForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Adding...';
            submitBtn.disabled = true;
            
            const date = document.getElementById('saleDate').value;
            const productId = document.getElementById('saleProduct').value;
            const quantity = parseInt(document.getElementById('saleQuantity').value);
            const storeId = document.getElementById('saleStore') ? document.getElementById('saleStore').value : currentUser.storeId;
            
            if (!date || !productId || !quantity || !storeId) {
                alert('Please fill in all fields');
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
                return;
            }
            
            if (quantity <= 0) {
                alert('Quantity must be greater than 0');
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
                return;
            }
            
            const product = getProduct(productId);
            if (!product) {
                alert('Invalid product selected');
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
                return;
            }
            
            const newSale = {
                date: date,
                time: getCurrentTime(),
                employeeId: currentUser.id,
                storeId: storeId,
                productId: productId,
                quantity: quantity,
                amount: product.price * quantity
            };
            
            try {
                await saveSale(newSale);
                
                // Reset form
                document.getElementById('saleQuantity').value = '';
                document.getElementById('saleProduct').value = '';
                if (document.getElementById('saleStore')) {
                    document.getElementById('saleStore').value = currentUser.storeId || '';
                }
                
                // Reload data and update displays
                await loadSales();
                updateEmployeeStats();
                updateTodaysSalesTable();
                
                alert('Sale added successfully!');
            } catch (error) {
                alert('Error adding sale: ' + error.message);
            }
            
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
        });

        async function deleteSale(saleId) {
            if (!saleId) {
                console.error('deleteSale requires valid saleId');
                return;
            }
            
            if (confirm('Are you sure you want to delete this sale?')) {
                try {
                    await deleteSaleRecord(saleId);
                    await loadSales();
                    updateEmployeeStats();
                    updateTodaysSalesTable();
                } catch (error) {
                    console.error('Error in deleteSale:', error);
                    alert('Error deleting sale: ' + error.message);
                }
            }
        }

        // Admin Dashboard Functions
        async function showDashboard() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            
            // Update current date
            updateCurrentDate('adminCurrentDate');
            
            // Show employees tab by default
            await switchTab('employees');
        }

        async function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('tab-active', 'border-purple-500');
                btn.classList.add('border-transparent');
            });
            
            // Show selected tab content
            document.getElementById(tabName + '-tab').classList.remove('hidden');
            
            // Add active class to selected tab button
            const activeBtn = document.querySelector(`[data-tab="${tabName}"]`);
            activeBtn.classList.add('tab-active', 'border-purple-500');
            activeBtn.classList.remove('border-transparent');
            
            // Load data for the selected tab
            switch(tabName) {
                case 'employees':
                    await loadEmployeesTable();
                    break;
                case 'stores':
                    await loadStoresTable();
                    break;
                case 'products':
                    await loadProductsTable();
                    break;
                case 'collections':
                    await loadCollectionsTable();
                    break;
                case 'database':
                    await loadDatabaseManager();
                    break;
                case 'sales':
                    // Initialize filter dropdown
                    document.getElementById('reportType').dispatchEvent(new Event('change'));
                    break;
                case 'salary':
                    populateEmployeeDropdown();
                    break;
            }
        }

        async function loadEmployeesTable() {
            try {
                await loadEmployees();
                const tbody = document.getElementById('employeesTable');
                
                if (!tbody) {
                    console.error('Employees table body element not found');
                    return;
                }
                
                if (!employees || !Array.isArray(employees) || employees.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-500">No employees found. Click "Add Employee" to create your first employee.</td></tr>';
                    return;
                }
                
                tbody.innerHTML = employees.filter(emp => emp && emp.id).map(emp => {
                    // Safe property access with fallbacks
                    const empName = emp.name || 'N/A';
                    const empUsername = emp.username || 'N/A';
                    const storeName = getStoreName(emp.storeId);
                    const salaryType = emp.salaryType || 'fixed';
                    const baseSalary = emp.baseSalary || 0;
                    const empId = emp.id || '';
                    
                    return `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="py-4 px-6">${empName}</td>
                            <td class="py-4 px-6">${empUsername}</td>
                            <td class="py-4 px-6">${storeName}</td>
                            <td class="py-4 px-6 capitalize">${salaryType}</td>
                            <td class="py-4 px-6">$${baseSalary}</td>
                            <td class="py-4 px-6">
                                <button onclick="editItem('employee', '${empId}')" class="text-blue-600 hover:text-blue-800 mr-3">Edit</button>
                                <button onclick="deleteItem('employee', '${empId}')" class="text-red-600 hover:text-red-800">Delete</button>
                            </td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error in loadEmployeesTable:', error);
                const tbody = document.getElementById('employeesTable');
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-red-500">Error loading employees data</td></tr>';
                }
            }
        }

        async function loadStoresTable() {
            await loadStores();
            const tbody = document.getElementById('storesTable');
            
            if (stores.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-gray-500">No stores found. Click "Add Store" to create your first store.</td></tr>';
                return;
            }
            
            tbody.innerHTML = stores.filter(store => store && store.id).map(store => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="py-4 px-6">${store.name || 'N/A'}</td>
                    <td class="py-4 px-6">${store.location || 'N/A'}</td>
                    <td class="py-4 px-6">${store.manager || 'N/A'}</td>
                    <td class="py-4 px-6">${store.phone || 'N/A'}</td>
                    <td class="py-4 px-6">
                        <button onclick="editItem('store', '${store.id}')" class="text-blue-600 hover:text-blue-800 mr-3">Edit</button>
                        <button onclick="deleteItem('store', '${store.id}')" class="text-red-600 hover:text-red-800">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        async function loadProductsTable() {
            await loadProducts();
            const tbody = document.getElementById('productsTable');
            
            if (products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="text-center py-8 text-gray-500">No products found. Click "Add Product" to create your first product.</td></tr>';
                return;
            }
            
            tbody.innerHTML = products.filter(product => product && product.id).map(product => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="py-4 px-6">${product.name || 'N/A'}</td>
                    <td class="py-4 px-6">$${product.price || 0}</td>
                    <td class="py-4 px-6">
                        <button onclick="editItem('product', '${product.id}')" class="text-blue-600 hover:text-blue-800 mr-3">Edit</button>
                        <button onclick="deleteItem('product', '${product.id}')" class="text-red-600 hover:text-red-800">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        async function loadCollectionsTable() {
            const tbody = document.getElementById('collectionsTable');
            
            if (collections.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-gray-500">No collections found. Click "Add Collection" to create your first collection.</td></tr>';
                return;
            }
            
            tbody.innerHTML = collections.filter(collection => collection && collection.id).map(collection => {
                // Count products in this collection
                const productCount = collection.productIds ? collection.productIds.length : 0;
                const status = collection.status || 'active';
                const statusColor = status === 'active' ? 'text-green-600' : 'text-gray-500';
                
                return `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="py-4 px-6">${collection.name || 'N/A'}</td>
                        <td class="py-4 px-6">${collection.description || 'N/A'}</td>
                        <td class="py-4 px-6">${productCount}</td>
                        <td class="py-4 px-6 ${statusColor} capitalize">${status}</td>
                        <td class="py-4 px-6">
                            <button onclick="editItem('collection', '${collection.id}')" class="text-blue-600 hover:text-blue-800 mr-3">Edit</button>
                            <button onclick="deleteItem('collection', '${collection.id}')" class="text-red-600 hover:text-red-800">Delete</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Modal Functions
        function openModal(type, item = null) {
            // Comprehensive null and type checking
            if (!type || typeof type !== 'string' || type.length === 0) {
                console.error('Modal type is required and must be a valid string');
                return;
            }
            
            editingType = type;
            editingItem = item;
            
            const modal = document.getElementById('modal');
            const title = document.getElementById('modalTitle');
            const fields = document.getElementById('modalFields');
            
            if (!modal || !title || !fields) {
                console.error('Modal elements not found');
                return;
            }
            
            // Safe string manipulation with null check
            let typeCapitalized = 'Item';
            try {
                if (type && typeof type === 'string' && type.length > 0) {
                    typeCapitalized = type.charAt(0).toUpperCase() + type.slice(1);
                }
            } catch (error) {
                console.error('Error capitalizing type:', error);
                typeCapitalized = 'Item';
            }
            title.textContent = item ? `Edit ${typeCapitalized}` : `Add ${typeCapitalized}`;
            
            // Generate form fields based on type
            let fieldsHTML = '';
            
            switch(type) {
                case 'employee':
                    fieldsHTML = `
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Name</label>
                            <input type="text" id="empName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" value="${item && item.name ? item.name : ''}" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                            <input type="text" id="empUsername" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" value="${item && item.username ? item.username : ''}" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                            <input type="password" id="empPassword" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" value="${item && item.password ? item.password : ''}" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Store</label>
                            <select id="empStore" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" required>
                                <option value="">Select Store</option>
                                ${stores && Array.isArray(stores) ? stores.map(store => `<option value="${store && store.id ? store.id : ''}" ${item && item.storeId === (store && store.id) ? 'selected' : ''}>${store && store.name ? store.name : 'Unknown Store'}</option>`).join('') : ''}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Salary Type</label>
                            <select id="empSalaryType" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" required>
                                <option value="fixed" ${item && item.salaryType === 'fixed' ? 'selected' : ''}>Fixed</option>
                                <option value="commission" ${item && item.salaryType === 'commission' ? 'selected' : ''}>Commission</option>
                                <option value="qty_sold" ${item && item.salaryType === 'qty_sold' ? 'selected' : ''}>Quantity Sold</option>
                                <option value="days_present" ${item && item.salaryType === 'days_present' ? 'selected' : ''}>Days Present</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Base Salary</label>
                            <input type="number" id="empBaseSalary" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" value="${item && item.baseSalary ? item.baseSalary : ''}" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Commission Rate</label>
                            <input type="number" step="0.01" id="empCommissionRate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" value="${item && item.commissionRate ? item.commissionRate : '0'}">
                        </div>
                    `;
                    break;
                    
                case 'store':
                    fieldsHTML = `
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Store Name</label>
                            <input type="text" id="storeName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" value="${item && item.name ? item.name : ''}" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Location</label>
                            <input type="text" id="storeLocation" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" value="${item && item.location ? item.location : ''}" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Manager</label>
                            <input type="text" id="storeManager" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" value="${item && item.manager ? item.manager : ''}" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Phone</label>
                            <input type="tel" id="storePhone" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" value="${item && item.phone ? item.phone : ''}" required>
                        </div>
                    `;
                    break;
                    
                case 'product':
                    fieldsHTML = `
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Product Name</label>
                            <input type="text" id="productName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" value="${item && item.name ? item.name : ''}" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Price</label>
                            <input type="number" step="0.01" id="productPrice" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" value="${item && item.price ? item.price : ''}" required>
                        </div>
                    `;
                    break;
                    
                case 'collection':
                    const selectedProducts = item && item.productIds ? item.productIds : [];
                    fieldsHTML = `
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Collection Name</label>
                            <input type="text" id="collectionName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" value="${item && item.name ? item.name : ''}" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                            <textarea id="collectionDescription" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" rows="3" placeholder="Enter collection description">${item && item.description ? item.description : ''}</textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                            <select id="collectionStatus" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" required>
                                <option value="active" ${item && item.status === 'active' ? 'selected' : ''}>Active</option>
                                <option value="inactive" ${item && item.status === 'inactive' ? 'selected' : ''}>Inactive</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Products in Collection</label>
                            <div class="border border-gray-300 rounded-lg p-3 max-h-40 overflow-y-auto">
                                ${products.map(product => `
                                    <label class="flex items-center space-x-2 mb-2">
                                        <input type="checkbox" class="collection-product" value="${product.id}" ${selectedProducts.includes(product.id) ? 'checked' : ''}>
                                        <span class="text-sm">${product.name} - $${product.price}</span>
                                    </label>
                                `).join('')}
                                ${products.length === 0 ? '<p class="text-gray-500 text-sm">No products available. Add products first.</p>' : ''}
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'sale':
                    fieldsHTML = `
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Date</label>
                            <input type="date" id="saleDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" value="${item && item.date ? item.date : getTodayString()}" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Time</label>
                            <input type="time" id="saleTime" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" value="${item && item.time ? item.time : getCurrentTime()}" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Employee</label>
                            <select id="saleEmployee" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" required>
                                <option value="">Select Employee</option>
                                ${employees && Array.isArray(employees) ? employees.map(emp => `<option value="${emp && emp.id ? emp.id : ''}" ${item && item.employeeId === (emp && emp.id) ? 'selected' : ''}>${emp && emp.name ? emp.name : 'Unknown Employee'}</option>`).join('') : ''}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Store</label>
                            <select id="saleStoreModal" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" required>
                                <option value="">Select Store</option>
                                ${stores && Array.isArray(stores) ? stores.map(store => `<option value="${store && store.id ? store.id : ''}" ${item && item.storeId === (store && store.id) ? 'selected' : ''}>${store && store.name ? store.name : 'Unknown Store'}</option>`).join('') : ''}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Product</label>
                            <select id="saleProductModal" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" required>
                                <option value="">Select Product</option>
                                ${products && Array.isArray(products) ? products.map(product => `<option value="${product && product.id ? product.id : ''}" ${item && item.productId === (product && product.id) ? 'selected' : ''}>${product && product.name ? product.name : 'Unknown Product'} - $${product && product.price ? product.price : '0'}</option>`).join('') : ''}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Quantity</label>
                            <input type="number" id="saleQuantityModal" min="1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" value="${item && item.quantity ? item.quantity : '1'}" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Amount</label>
                            <input type="number" step="0.01" id="saleAmountModal" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" value="${item && item.amount ? item.amount : ''}" required readonly>
                        </div>
                    `;
                    
                    // Add auto-calculation for amount
                    setTimeout(() => {
                        const productSelect = document.getElementById('saleProductModal');
                        const quantityInput = document.getElementById('saleQuantityModal');
                        const amountInput = document.getElementById('saleAmountModal');
                        
                        function calculateAmount() {
                            const selectedProductId = productSelect.value;
                            const quantity = parseInt(quantityInput.value) || 0;
                            
                            if (selectedProductId && quantity > 0) {
                                const product = products.find(p => p.id === selectedProductId);
                                if (product) {
                                    amountInput.value = (product.price * quantity).toFixed(2);
                                }
                            } else {
                                amountInput.value = '';
                            }
                        }
                        
                        productSelect.addEventListener('change', calculateAmount);
                        quantityInput.addEventListener('input', calculateAmount);
                        
                        // Calculate initial amount if editing
                        if (item) {
                            calculateAmount();
                        }
                    }, 100);
                    break;
            }
            
            fields.innerHTML = fieldsHTML;
            modal.classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('modal').classList.add('hidden');
            editingItem = null;
            editingType = null;
        }

        // Modal Form Submit
        document.getElementById('modalForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const saveBtn = document.getElementById('saveBtnText');
            const loader = document.getElementById('saveLoader');
            
            saveBtn.textContent = 'Saving...';
            loader.classList.remove('hidden');
            
            try {
                let newItem = {};
                
                switch(editingType) {
                    case 'employee':
                        // Validate required fields
                        const empName = document.getElementById('empName').value.trim();
                        const empUsername = document.getElementById('empUsername').value.trim();
                        const empPassword = document.getElementById('empPassword').value;
                        const empStore = document.getElementById('empStore').value;
                        const empBaseSalary = document.getElementById('empBaseSalary').value;
                        
                        if (!empName || !empUsername || !empPassword || !empStore || !empBaseSalary) {
                            throw new Error('Please fill in all required fields');
                        }
                        
                        // Check for duplicate username (only for new employees or different username)
                        const existingEmployee = employees.find(emp => 
                            emp.username === empUsername && 
                            (!editingItem || emp.id !== editingItem.id)
                        );
                        if (existingEmployee) {
                            throw new Error('Username already exists. Please choose a different username.');
                        }
                        
                        newItem = {
                            id: editingItem ? editingItem.id : null,
                            name: empName,
                            username: empUsername,
                            password: empPassword,
                            storeId: empStore,
                            salaryType: document.getElementById('empSalaryType').value,
                            baseSalary: parseFloat(empBaseSalary),
                            commissionRate: parseFloat(document.getElementById('empCommissionRate').value) || 0
                        };
                        
                        await saveEmployee(newItem);
                        await loadEmployeesTable();
                        break;
                        
                    case 'store':
                        const storeName = document.getElementById('storeName').value.trim();
                        const storeLocation = document.getElementById('storeLocation').value.trim();
                        const storeManager = document.getElementById('storeManager').value.trim();
                        const storePhone = document.getElementById('storePhone').value.trim();
                        
                        if (!storeName || !storeLocation || !storeManager || !storePhone) {
                            throw new Error('Please fill in all required fields');
                        }
                        
                        newItem = {
                            id: editingItem ? editingItem.id : null,
                            name: storeName,
                            location: storeLocation,
                            manager: storeManager,
                            phone: storePhone
                        };
                        
                        await saveStore(newItem);
                        await loadStoresTable();
                        break;
                        
                    case 'product':
                        const productName = document.getElementById('productName').value.trim();
                        const productPrice = document.getElementById('productPrice').value;
                        
                        if (!productName || !productPrice || parseFloat(productPrice) <= 0) {
                            throw new Error('Please enter a valid product name and price');
                        }
                        
                        newItem = {
                            id: editingItem ? editingItem.id : null,
                            name: productName,
                            price: parseFloat(productPrice)
                        };
                        
                        await saveProduct(newItem);
                        await loadProductsTable();
                        // Update product dropdown in employee portal if needed
                        if (currentUserRole === 'employee') {
                            populateProductDropdown();
                        }
                        break;
                        
                    case 'collection':
                        const collectionName = document.getElementById('collectionName').value.trim();
                        const collectionDescription = document.getElementById('collectionDescription').value.trim();
                        const collectionStatus = document.getElementById('collectionStatus').value;
                        
                        if (!collectionName) {
                            throw new Error('Please enter a collection name');
                        }
                        
                        // Get selected products
                        const selectedProductIds = Array.from(document.querySelectorAll('.collection-product:checked'))
                            .map(checkbox => checkbox.value);
                        
                        newItem = {
                            id: editingItem ? editingItem.id : null,
                            name: collectionName,
                            description: collectionDescription,
                            status: collectionStatus,
                            productIds: selectedProductIds,
                            createdAt: editingItem ? editingItem.createdAt : new Date().toISOString()
                        };
                        
                        await saveCollection(newItem);
                        await loadCollectionsTable();
                        break;
                        
                    case 'sale':
                        const saleDate = document.getElementById('saleDate').value;
                        const saleTime = document.getElementById('saleTime').value;
                        const saleEmployee = document.getElementById('saleEmployee').value;
                        const saleStore = document.getElementById('saleStoreModal').value;
                        const saleProduct = document.getElementById('saleProductModal').value;
                        const saleQuantity = document.getElementById('saleQuantityModal').value;
                        const saleAmount = document.getElementById('saleAmountModal').value;
                        
                        if (!saleDate || !saleTime || !saleEmployee || !saleStore || !saleProduct || !saleQuantity || !saleAmount) {
                            throw new Error('Please fill in all required fields');
                        }
                        
                        if (parseInt(saleQuantity) <= 0) {
                            throw new Error('Quantity must be greater than 0');
                        }
                        
                        if (parseFloat(saleAmount) <= 0) {
                            throw new Error('Amount must be greater than 0');
                        }
                        
                        newItem = {
                            id: editingItem ? editingItem.id : null,
                            date: saleDate,
                            time: saleTime,
                            employeeId: saleEmployee,
                            storeId: saleStore,
                            productId: saleProduct,
                            quantity: parseInt(saleQuantity),
                            amount: parseFloat(saleAmount)
                        };
                        
                        await saveSale(newItem);
                        
                        // Refresh database view if we're in database manager
                        if (currentDbCollection === 'sales') {
                            await loadDatabaseCollection();
                        }
                        
                        // Also refresh employee portal if needed
                        if (currentUserRole === 'employee') {
                            updateEmployeeStats();
                            updateTodaysSalesTable();
                        }
                        break;
                }
                
                closeModal();
                alert(`${editingType.charAt(0).toUpperCase() + editingType.slice(1)} saved successfully!`);
                
            } catch (error) {
                alert('Error: ' + error.message);
            }
            
            saveBtn.textContent = 'Save';
            loader.classList.add('hidden');
        });

        async function editItem(type, id) {
            if (!type || !id) {
                console.error('editItem requires valid type and id');
                return;
            }
            
            let item;
            
            try {
                switch(type) {
                    case 'employee':
                        if (Array.isArray(employees)) {
                            item = employees.find(emp => emp && emp.id === id);
                        }
                        break;
                    case 'store':
                        if (Array.isArray(stores)) {
                            item = stores.find(store => store && store.id === id);
                        }
                        break;
                    case 'product':
                        if (Array.isArray(products)) {
                            item = products.find(product => product && product.id === id);
                        }
                        break;
                    case 'collection':
                        if (Array.isArray(collections)) {
                            item = collections.find(collection => collection && collection.id === id);
                        }
                        break;
                }
                
                if (item) {
                    openModal(type, item);
                } else {
                    console.error(`Item not found: ${type} with id ${id}`);
                }
            } catch (error) {
                console.error('Error in editItem:', error);
            }
        }

        async function deleteItem(type, id) {
            if (!type || !id) {
                console.error('deleteItem requires valid type and id');
                return;
            }
            
            if (!confirm('Are you sure you want to delete this item?')) {
                return;
            }
            
            try {
                switch(type) {
                    case 'employee':
                        await deleteEmployee(id);
                        await loadEmployeesTable();
                        break;
                    case 'store':
                        await deleteStore(id);
                        await loadStoresTable();
                        break;
                    case 'product':
                        await deleteProduct(id);
                        await loadProductsTable();
                        if (currentUserRole === 'employee') {
                            populateProductDropdown();
                        }
                        break;
                    case 'collection':
                        await deleteCollection(id);
                        await loadCollectionsTable();
                        break;
                }
                alert('Item deleted successfully!');
            } catch (error) {
                console.error('Error in deleteItem:', error);
                alert('Error deleting item: ' + error.message);
            }
        }

        // Reports Functions (keeping the same logic as before)
        async function generateSalesReport() {
            await loadSales();
            
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            const reportType = document.getElementById('reportType').value;
            const filterValue = document.getElementById('reportFilter').value;
            
            if (!startDate || !endDate) {
                alert('Please select both start and end dates');
                return;
            }
            
            if (new Date(startDate) > new Date(endDate)) {
                alert('Start date cannot be later than end date');
                return;
            }
            
            let filteredSales = sales.filter(sale => {
                return sale.date >= startDate && sale.date <= endDate;
            });
            
            // Apply additional filters
            if (filterValue) {
                switch(reportType) {
                    case 'store':
                        filteredSales = filteredSales.filter(sale => sale.storeId == filterValue);
                        break;
                    case 'staff':
                        filteredSales = filteredSales.filter(sale => sale.employeeId == filterValue);
                        break;
                    case 'product':
                        filteredSales = filteredSales.filter(sale => sale.productId == filterValue);
                        break;
                }
            }
            
            const tbody = document.getElementById('salesReportTable');
            const header = document.getElementById('salesReportHeader');
            
            if (filteredSales.length === 0) {
                header.innerHTML = `
                    <th class="text-left py-4 px-6" colspan="6">No Data Found</th>
                `;
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-500">No sales found for the selected criteria</td></tr>';
                return;
            }
            
            let reportData = [];
            
            switch(reportType) {
                case 'daily':
                    reportData = generateDailyReport(filteredSales);
                    header.innerHTML = `
                        <th class="text-left py-4 px-6">Date</th>
                        <th class="text-left py-4 px-6">Total Sales</th>
                        <th class="text-left py-4 px-6">Total Quantity</th>
                        <th class="text-left py-4 px-6">Total Amount</th>
                    `;
                    tbody.innerHTML = reportData.map(item => `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="py-4 px-6">${new Date(item.date).toLocaleDateString()}</td>
                            <td class="py-4 px-6">${item.salesCount}</td>
                            <td class="py-4 px-6">${item.totalQuantity}</td>
                            <td class="py-4 px-6">$${item.totalAmount.toFixed(2)}</td>
                        </tr>
                    `).join('');
                    break;
                    
                case 'monthly':
                    reportData = generateMonthlyReport(filteredSales);
                    header.innerHTML = `
                        <th class="text-left py-4 px-6">Month</th>
                        <th class="text-left py-4 px-6">Total Sales</th>
                        <th class="text-left py-4 px-6">Total Quantity</th>
                        <th class="text-left py-4 px-6">Total Amount</th>
                    `;
                    tbody.innerHTML = reportData.map(item => `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="py-4 px-6">${new Date(item.month + '-01').toLocaleDateString('en-US', { year: 'numeric', month: 'long' })}</td>
                            <td class="py-4 px-6">${item.salesCount}</td>
                            <td class="py-4 px-6">${item.totalQuantity}</td>
                            <td class="py-4 px-6">$${item.totalAmount.toFixed(2)}</td>
                        </tr>
                    `).join('');
                    break;
                    
                case 'store':
                    reportData = generateStoreReport(filteredSales);
                    header.innerHTML = `
                        <th class="text-left py-4 px-6">Store</th>
                        <th class="text-left py-4 px-6">Total Sales</th>
                        <th class="text-left py-4 px-6">Total Quantity</th>
                        <th class="text-left py-4 px-6">Total Amount</th>
                    `;
                    tbody.innerHTML = reportData.map(item => `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="py-4 px-6">${item.store}</td>
                            <td class="py-4 px-6">${item.salesCount}</td>
                            <td class="py-4 px-6">${item.totalQuantity}</td>
                            <td class="py-4 px-6">$${item.totalAmount.toFixed(2)}</td>
                        </tr>
                    `).join('');
                    break;
                    
                case 'staff':
                    reportData = generateStaffReport(filteredSales);
                    header.innerHTML = `
                        <th class="text-left py-4 px-6">Employee</th>
                        <th class="text-left py-4 px-6">Total Sales</th>
                        <th class="text-left py-4 px-6">Total Quantity</th>
                        <th class="text-left py-4 px-6">Total Amount</th>
                    `;
                    tbody.innerHTML = reportData.map(item => `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="py-4 px-6">${item.employee}</td>
                            <td class="py-4 px-6">${item.salesCount}</td>
                            <td class="py-4 px-6">${item.totalQuantity}</td>
                            <td class="py-4 px-6">$${item.totalAmount.toFixed(2)}</td>
                        </tr>
                    `).join('');
                    break;
                    
                case 'product':
                    reportData = generateProductReport(filteredSales);
                    header.innerHTML = `
                        <th class="text-left py-4 px-6">Product</th>
                        <th class="text-left py-4 px-6">Total Sales</th>
                        <th class="text-left py-4 px-6">Total Quantity</th>
                        <th class="text-left py-4 px-6">Total Amount</th>
                    `;
                    tbody.innerHTML = reportData.map(item => `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="py-4 px-6">${item.product}</td>
                            <td class="py-4 px-6">${item.salesCount}</td>
                            <td class="py-4 px-6">${item.totalQuantity}</td>
                            <td class="py-4 px-6">$${item.totalAmount.toFixed(2)}</td>
                        </tr>
                    `).join('');
                    break;
                    
                default: // all
                    header.innerHTML = `
                        <th class="text-left py-4 px-6">Date</th>
                        <th class="text-left py-4 px-6">Employee</th>
                        <th class="text-left py-4 px-6">Store</th>
                        <th class="text-left py-4 px-6">Product</th>
                        <th class="text-left py-4 px-6">Quantity</th>
                        <th class="text-left py-4 px-6">Amount</th>
                    `;
                    tbody.innerHTML = filteredSales.map(sale => `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="py-4 px-6">${new Date(sale.date).toLocaleDateString()}</td>
                            <td class="py-4 px-6">${getEmployeeName(sale.employeeId)}</td>
                            <td class="py-4 px-6">${getStoreName(sale.storeId)}</td>
                            <td class="py-4 px-6">${getProductName(sale.productId)}</td>
                            <td class="py-4 px-6">${sale.quantity}</td>
                            <td class="py-4 px-6">$${sale.amount.toFixed(2)}</td>
                        </tr>
                    `).join('');
            }
            
            // Add summary row for aggregated reports
            if (['daily', 'monthly', 'store', 'staff', 'product'].includes(reportType)) {
                const totalAmount = reportData.reduce((sum, item) => sum + item.totalAmount, 0);
                const totalQuantity = reportData.reduce((sum, item) => sum + item.totalQuantity, 0);
                const totalSales = reportData.reduce((sum, item) => sum + item.salesCount, 0);
                
                tbody.innerHTML += `
                    <tr class="border-t-2 border-gray-400 bg-gray-100 font-bold">
                        <td class="py-4 px-6">TOTAL</td>
                        <td class="py-4 px-6">${totalSales}</td>
                        <td class="py-4 px-6">${totalQuantity}</td>
                        <td class="py-4 px-6">$${totalAmount.toFixed(2)}</td>
                    </tr>
                `;
            }
        }
        
        function generateDailyReport(sales) {
            const dailyData = {};
            sales.forEach(sale => {
                if (!dailyData[sale.date]) {
                    dailyData[sale.date] = { salesCount: 0, totalQuantity: 0, totalAmount: 0 };
                }
                dailyData[sale.date].salesCount++;
                dailyData[sale.date].totalQuantity += sale.quantity;
                dailyData[sale.date].totalAmount += sale.amount;
            });
            
            return Object.keys(dailyData).map(date => ({
                date,
                ...dailyData[date]
            })).sort((a, b) => a.date.localeCompare(b.date));
        }
        
        function generateMonthlyReport(sales) {
            const monthlyData = {};
            sales.forEach(sale => {
                const monthKey = sale.date.substring(0, 7); // YYYY-MM
                if (!monthlyData[monthKey]) {
                    monthlyData[monthKey] = { salesCount: 0, totalQuantity: 0, totalAmount: 0 };
                }
                monthlyData[monthKey].salesCount++;
                monthlyData[monthKey].totalQuantity += sale.quantity;
                monthlyData[monthKey].totalAmount += sale.amount;
            });
            
            return Object.keys(monthlyData).map(month => ({
                month,
                ...monthlyData[month]
            })).sort((a, b) => a.month.localeCompare(b.month));
        }
        
        function generateStoreReport(sales) {
            const storeData = {};
            sales.forEach(sale => {
                const storeName = getStoreName(sale.storeId);
                if (!storeData[storeName]) {
                    storeData[storeName] = { salesCount: 0, totalQuantity: 0, totalAmount: 0 };
                }
                storeData[storeName].salesCount++;
                storeData[storeName].totalQuantity += sale.quantity;
                storeData[storeName].totalAmount += sale.amount;
            });
            
            return Object.keys(storeData).map(store => ({
                store,
                ...storeData[store]
            }));
        }
        
        function generateStaffReport(sales) {
            const staffData = {};
            sales.forEach(sale => {
                const employeeName = getEmployeeName(sale.employeeId);
                if (!staffData[employeeName]) {
                    staffData[employeeName] = { salesCount: 0, totalQuantity: 0, totalAmount: 0 };
                }
                staffData[employeeName].salesCount++;
                staffData[employeeName].totalQuantity += sale.quantity;
                staffData[employeeName].totalAmount += sale.amount;
            });
            
            return Object.keys(staffData).map(employee => ({
                employee,
                ...staffData[employee]
            }));
        }
        
        function generateProductReport(sales) {
            const productData = {};
            sales.forEach(sale => {
                const productName = getProductName(sale.productId);
                if (!productData[productName]) {
                    productData[productName] = { salesCount: 0, totalQuantity: 0, totalAmount: 0 };
                }
                productData[productName].salesCount++;
                productData[productName].totalQuantity += sale.quantity;
                productData[productName].totalAmount += sale.amount;
            });
            
            return Object.keys(productData).map(product => ({
                product,
                ...productData[product]
            }));
        }

        async function generateSalaryReport() {
            await loadEmployees();
            await loadSales();
            
            const startDate = document.getElementById('salaryStartDate').value;
            const endDate = document.getElementById('salaryEndDate').value;
            const selectedEmployee = document.getElementById('salaryEmployee').value;
            
            if (!startDate || !endDate) {
                alert('Please select both start and end dates');
                return;
            }
            
            const tbody = document.getElementById('salaryReportTable');
            
            let employeesToProcess = employees;
            if (selectedEmployee) {
                employeesToProcess = employees.filter(emp => emp.id == selectedEmployee);
            }
            
            const salaryData = employeesToProcess.map(employee => {
                // Filter sales for this employee in the selected date range
                const employeeSales = sales.filter(sale => {
                    return sale.date >= startDate && 
                           sale.date <= endDate &&
                           sale.employeeId === employee.id;
                });
                
                const totalSales = employeeSales.reduce((sum, sale) => sum + sale.amount, 0);
                const totalQuantity = employeeSales.reduce((sum, sale) => sum + sale.quantity, 0);
                
                let bonus = 0;
                let daysOrQty = 0;
                
                switch(employee.salaryType) {
                    case 'commission':
                        // Calculate commission based on sales amount
                        bonus = totalSales * (employee.commissionRate || 0.1);
                        daysOrQty = employeeSales.length;
                        break;
                    case 'qty_sold':
                        // Calculate bonus based on quantity sold
                        bonus = totalQuantity * 5; // $5 per item sold
                        daysOrQty = totalQuantity;
                        break;
                    case 'days_present':
                        // Calculate bonus based on days present (unique dates with sales)
                        const uniqueDates = [...new Set(employeeSales.map(sale => sale.date))];
                        daysOrQty = uniqueDates.length;
                        bonus = daysOrQty * 50; // $50 per day present
                        break;
                    default: // fixed
                        daysOrQty = employeeSales.length;
                        break;
                }
                
                const totalSalary = (employee.baseSalary || 0) + bonus;
                
                return {
                    employee: employee,
                    totalSales: totalSales,
                    bonus: bonus,
                    totalSalary: totalSalary,
                    daysOrQty: daysOrQty
                };
            });
            
            tbody.innerHTML = salaryData.map(data => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="py-4 px-6">${data.employee.name}</td>
                    <td class="py-4 px-6 capitalize">${data.employee.salaryType.replace('_', ' ')}</td>
                    <td class="py-4 px-6">$${(data.employee.baseSalary || 0).toFixed(2)}</td>
                    <td class="py-4 px-6">$${data.bonus.toFixed(2)}</td>
                    <td class="py-4 px-6">$${data.totalSales.toFixed(2)}</td>
                    <td class="py-4 px-6">${data.daysOrQty}</td>
                    <td class="py-4 px-6">$${data.totalSalary.toFixed(2)}</td>
                </tr>
            `).join('');
        }

        // Master Data Download Function
        async function downloadAllMasterData() {
            // Force reload all data to ensure we have the latest
            await loadAllData();
            
            // Ensure arrays are properly initialized
            initializeArrays();
            
            const timestamp = new Date().toISOString().split('T')[0];
            
            // Create a comprehensive CSV with all master data
            let csvContent = "EDEN PERFUME - MASTER DATA EXPORT\n";
            csvContent += `Export Date: ${new Date().toLocaleDateString()}\n`;
            csvContent += `Export Time: ${new Date().toLocaleTimeString()}\n`;
            csvContent += `Database Mode: ${isFirebaseMode ? 'Firebase Connected' : 'Local Storage Mode'}\n`;
            csvContent += `Total Records: ${employees.length + stores.length + products.length + collections.length + sales.length}\n\n`;
            
            // Employees Data
            csvContent += "=== EMPLOYEES DATA ===\n";
            csvContent += "ID,Name,Username,Password,Store ID,Store Name,Salary Type,Base Salary,Commission Rate\n";
            if (employees.length === 0) {
                csvContent += "No employees found\n";
            } else {
                employees.forEach(emp => {
                    const store = stores.find(s => s.id === emp.storeId);
                    csvContent += `"${emp.id || 'N/A'}","${emp.name || 'N/A'}","${emp.username || 'N/A'}","${emp.password || 'N/A'}","${emp.storeId || 'N/A'}","${store ? store.name : 'Unknown Store'}","${emp.salaryType || 'N/A'}","${emp.baseSalary || 0}","${emp.commissionRate || 0}"\n`;
                });
            }
            
            csvContent += "\n=== STORES DATA ===\n";
            csvContent += "ID,Store Name,Location,Manager,Phone\n";
            if (stores.length === 0) {
                csvContent += "No stores found\n";
            } else {
                stores.forEach(store => {
                    csvContent += `"${store.id || 'N/A'}","${store.name || 'N/A'}","${store.location || 'N/A'}","${store.manager || 'N/A'}","${store.phone || 'N/A'}"\n`;
                });
            }
            
            csvContent += "\n=== PRODUCTS DATA ===\n";
            csvContent += "ID,Product Name,Price\n";
            if (products.length === 0) {
                csvContent += "No products found\n";
            } else {
                products.forEach(product => {
                    csvContent += `"${product.id || 'N/A'}","${product.name || 'N/A'}","${product.price || 0}"\n`;
                });
            }
            
            csvContent += "\n=== COLLECTIONS DATA ===\n";
            csvContent += "ID,Collection Name,Description,Status,Product Count,Product IDs\n";
            if (collections.length === 0) {
                csvContent += "No collections found\n";
            } else {
                collections.forEach(collection => {
                    const productIds = collection.productIds || [];
                    csvContent += `"${collection.id || 'N/A'}","${collection.name || 'N/A'}","${collection.description || 'N/A'}","${collection.status || 'N/A'}","${productIds.length}","${productIds.join(';')}"\n`;
                });
            }
            
            csvContent += "\n=== SALES DATA ===\n";
            csvContent += "ID,Date,Time,Employee ID,Employee Name,Store ID,Store Name,Product ID,Product Name,Quantity,Amount\n";
            if (sales.length === 0) {
                csvContent += "No sales found\n";
            } else {
                sales.forEach(sale => {
                    const employee = employees.find(e => e.id === sale.employeeId);
                    const store = stores.find(s => s.id === sale.storeId);
                    const product = products.find(p => p.id === sale.productId);
                    csvContent += `"${sale.id || 'N/A'}","${sale.date || 'N/A'}","${sale.time || 'N/A'}","${sale.employeeId || 'N/A'}","${employee ? employee.name : 'Unknown Employee'}","${sale.storeId || 'N/A'}","${store ? store.name : 'Unknown Store'}","${sale.productId || 'N/A'}","${product ? product.name : 'Unknown Product'}","${sale.quantity || 0}","${sale.amount || 0}"\n`;
                });
            }
            
            csvContent += "\n=== SUMMARY ===\n";
            csvContent += `Total Employees: ${employees.length}\n`;
            csvContent += `Total Stores: ${stores.length}\n`;
            csvContent += `Total Products: ${products.length}\n`;
            csvContent += `Total Collections: ${collections.length}\n`;
            csvContent += `Total Sales: ${sales.length}\n`;
            csvContent += `Total Revenue: $${sales.reduce((sum, sale) => sum + (sale.amount || 0), 0).toFixed(2)}\n`;
            csvContent += `Export completed at: ${new Date().toLocaleString()}\n`;
            
            // Create and download file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `eden_perfume_complete_export_${timestamp}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            alert(`Master data export completed!\n\nExported:\n- ${employees.length} Employees\n- ${stores.length} Stores\n- ${products.length} Products\n- ${collections.length} Collections\n- ${sales.length} Sales Records\n\nFile saved as: eden_perfume_complete_export_${timestamp}.csv`);
        }

        // Download Functions
        function downloadExcel(reportType) {
            const table = document.querySelector(`#${reportType}ReportTable`).closest('table');
            
            if (!table) {
                alert('No report data to download. Please generate a report first.');
                return;
            }
            
            const data = [];
            
            // Get headers
            const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent.trim());
            if (headers.length > 0) {
                data.push(headers);
            }
            
            // Get data rows
            const rows = table.querySelectorAll('tbody tr');
            rows.forEach(row => {
                const cells = Array.from(row.querySelectorAll('td')).map(td => td.textContent.trim());
                if (cells.length > 1 && !cells[0].includes('No sales found') && !cells[0].includes('Select date range')) {
                    data.push(cells);
                }
            });
            
            if (data.length <= 1) {
                alert('No data available to download. Please generate a report first.');
                return;
            }
            
            // Add report metadata
            const reportTitle = `Eden Perfume - ${reportType.charAt(0).toUpperCase() + reportType.slice(1)} Report`;
            const timestamp = new Date().toLocaleDateString();
            
            let csvContent = `${reportTitle}\n`;
            csvContent += `Generated on: ${timestamp}\n`;
            csvContent += `Database Mode: ${isFirebaseMode ? 'Firebase' : 'Local Storage'}\n\n`;
            
            // Convert to CSV format
            csvContent += data.map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
            
            // Create and download file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `${reportType}_report_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert('Report downloaded successfully!');
        }
        
        function downloadPDF(reportType) {
            const table = document.querySelector(`#${reportType}ReportTable`).closest('table');
            
            if (!table) {
                alert('No report data to download. Please generate a report first.');
                return;
            }
            
            const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent.trim());
            const rows = Array.from(table.querySelectorAll('tbody tr'));
            
            let content = `Eden Perfume - ${reportType.charAt(0).toUpperCase() + reportType.slice(1)} Report\n`;
            content += `Generated on: ${new Date().toLocaleDateString()}\n`;
            content += `Generated at: ${new Date().toLocaleTimeString()}\n`;
            content += `Database Mode: ${isFirebaseMode ? 'Firebase' : 'Local Storage'}\n\n`;
            content += headers.join('\t') + '\n';
            content += '-'.repeat(100) + '\n';
            
            let hasData = false;
            rows.forEach(row => {
                const cells = Array.from(row.querySelectorAll('td')).map(td => td.textContent.trim());
                if (cells.length > 1 && !cells[0].includes('No sales found') && !cells[0].includes('Select date range')) {
                    content += cells.join('\t') + '\n';
                    hasData = true;
                }
            });
            
            if (!hasData) {
                alert('No data available to download. Please generate a report first.');
                return;
            }
            
            content += '\n' + '-'.repeat(100) + '\n';
            content += 'Report generated by Eden Perfume Sales Management System\n';
            
            // Create and download as text file (PDF generation would require external library)
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `${reportType}_report_${new Date().toISOString().split('T')[0]}.txt`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert('Report downloaded successfully!');
        }
        
        // Update filter dropdown based on report type
        document.getElementById('reportType').addEventListener('change', function() {
            const reportType = this.value;
            const filterSelect = document.getElementById('reportFilter');
            
            filterSelect.innerHTML = '<option value="">All</option>';
            
            switch(reportType) {
                case 'store':
                    stores.forEach(store => {
                        const option = document.createElement('option');
                        option.value = store.id;
                        option.textContent = store.name;
                        filterSelect.appendChild(option);
                    });
                    break;
                case 'staff':
                    employees.forEach(emp => {
                        const option = document.createElement('option');
                        option.value = emp.id;
                        option.textContent = emp.name;
                        filterSelect.appendChild(option);
                    });
                    break;
                case 'product':
                    products.forEach(product => {
                        const option = document.createElement('option');
                        option.value = product.id;
                        option.textContent = product.name;
                        filterSelect.appendChild(option);
                    });
                    break;
            }
        });
        
        // Populate employee dropdown for salary reports
        function populateEmployeeDropdown() {
            const select = document.getElementById('salaryEmployee');
            select.innerHTML = '<option value="">All Employees</option>';
            
            employees.forEach(emp => {
                const option = document.createElement('option');
                option.value = emp.id;
                option.textContent = emp.name;
                select.appendChild(option);
            });
        }

        // Database Manager Functions
        let currentDbCollection = '';
        let currentDbData = [];

        async function loadDatabaseManager() {
            // Update connection status
            const statusEl = document.getElementById('dbConnectionStatus');
            if (statusEl) {
                statusEl.textContent = isFirebaseMode ? 'üî• Firebase Connected' : 'üì± Local Storage Mode';
                statusEl.className = isFirebaseMode ? 'text-sm text-green-600' : 'text-sm text-blue-600';
            }
            
            // Reset view
            document.getElementById('dbCollectionSelect').value = '';
            document.getElementById('dbTableTitle').textContent = 'Select a collection to view data';
            document.getElementById('dbTableCount').textContent = '0 entries';
            document.getElementById('dbTableHeader').innerHTML = '<th class="text-left py-3 px-4 text-sm font-medium text-gray-700">Select a collection</th>';
            document.getElementById('dbTableBody').innerHTML = '<tr><td class="text-center py-8 text-gray-500">Select a collection from the dropdown above</td></tr>';
        }

        async function loadDatabaseCollection() {
            const selectedCollection = document.getElementById('dbCollectionSelect').value;
            
            if (!selectedCollection) {
                await loadDatabaseManager();
                return;
            }
            
            currentDbCollection = selectedCollection;
            
            // Load fresh data
            await loadAllData();
            
            // Get the data for the selected collection
            switch(selectedCollection) {
                case 'employees':
                    currentDbData = [...employees];
                    break;
                case 'stores':
                    currentDbData = [...stores];
                    break;
                case 'products':
                    currentDbData = [...products];
                    break;
                case 'collections':
                    currentDbData = [...collections];
                    break;
                case 'sales':
                    currentDbData = [...sales];
                    break;
                default:
                    currentDbData = [];
            }
            
            renderDatabaseTable();
        }

        function renderDatabaseTable() {
            const titleEl = document.getElementById('dbTableTitle');
            const countEl = document.getElementById('dbTableCount');
            const headerEl = document.getElementById('dbTableHeader');
            const bodyEl = document.getElementById('dbTableBody');
            
            // Update title and count
            titleEl.textContent = `${currentDbCollection.charAt(0).toUpperCase() + currentDbCollection.slice(1)} Collection`;
            countEl.textContent = `${currentDbData.length} entries`;
            
            if (currentDbData.length === 0) {
                headerEl.innerHTML = '<th class="text-left py-3 px-4 text-sm font-medium text-gray-700">No Data</th>';
                bodyEl.innerHTML = `<tr><td class="text-center py-8 text-gray-500">No ${currentDbCollection} found in database</td></tr>`;
                return;
            }
            
            // Generate table headers based on data structure
            const sampleItem = currentDbData[0];
            const headers = Object.keys(sampleItem).filter(key => key !== 'firebaseId');
            
            headerEl.innerHTML = headers.map(header => 
                `<th class="text-left py-3 px-4 text-sm font-medium text-gray-700">${header.charAt(0).toUpperCase() + header.slice(1)}</th>`
            ).join('') + '<th class="text-left py-3 px-4 text-sm font-medium text-gray-700">Actions</th>';
            
            // Generate table rows
            bodyEl.innerHTML = currentDbData.map(item => {
                const cells = headers.map(header => {
                    let value = item[header];
                    
                    // Format different data types
                    if (value === null || value === undefined) {
                        value = 'N/A';
                    } else if (typeof value === 'boolean') {
                        value = value ? 'Yes' : 'No';
                    } else if (Array.isArray(value)) {
                        value = `[${value.length} items]`;
                    } else if (typeof value === 'object') {
                        value = 'Object';
                    } else if (typeof value === 'number') {
                        // Format currency for price/amount fields
                        if (header.toLowerCase().includes('price') || header.toLowerCase().includes('amount') || header.toLowerCase().includes('salary')) {
                            value = `$${value.toFixed(2)}`;
                        }
                    } else if (typeof value === 'string' && value.length > 50) {
                        value = value.substring(0, 50) + '...';
                    }
                    
                    return `<td class="py-3 px-4 text-sm">${value}</td>`;
                }).join('');
                
                const actions = `
                    <td class="py-3 px-4 text-sm">
                        <button onclick="editDatabaseEntry('${item.id}')" class="text-blue-600 hover:text-blue-800 mr-3 text-xs">Edit</button>
                        <button onclick="deleteDatabaseEntry('${item.id}')" class="text-red-600 hover:text-red-800 mr-3 text-xs">Delete</button>
                        <button onclick="viewDatabaseEntry('${item.id}')" class="text-green-600 hover:text-green-800 text-xs">View</button>
                    </td>
                `;
                
                return `<tr class="border-b hover:bg-gray-50">${cells}${actions}</tr>`;
            }).join('');
        }

        function addDatabaseEntry() {
            if (!currentDbCollection) {
                alert('Please select a collection first');
                return;
            }
            
            // Use existing modal system
            const singularType = currentDbCollection === 'sales' ? 'sale' : currentDbCollection.slice(0, -1);
            openModal(singularType);
        }

        function editDatabaseEntry(id) {
            if (!currentDbCollection || !id) {
                alert('Invalid entry selection');
                return;
            }
            
            const item = currentDbData.find(item => item.id === id);
            if (!item) {
                alert('Entry not found');
                return;
            }
            
            const singularType = currentDbCollection === 'sales' ? 'sale' : currentDbCollection.slice(0, -1);
            editItem(singularType, id);
        }

        async function deleteDatabaseEntry(id) {
            if (!currentDbCollection || !id) {
                alert('Invalid entry selection');
                return;
            }
            
            const item = currentDbData.find(item => item.id === id);
            if (!item) {
                alert('Entry not found');
                return;
            }
            
            if (!confirm(`Are you sure you want to delete this ${currentDbCollection.slice(0, -1)} entry?\n\nThis action cannot be undone.`)) {
                return;
            }
            
            try {
                const singularType = currentDbCollection === 'sales' ? 'sale' : currentDbCollection.slice(0, -1);
                await deleteItem(singularType, id);
                
                // Refresh the database view
                await loadDatabaseCollection();
                
                alert('Entry deleted successfully!');
            } catch (error) {
                alert('Error deleting entry: ' + error.message);
            }
        }

        function viewDatabaseEntry(id) {
            if (!currentDbCollection || !id) {
                alert('Invalid entry selection');
                return;
            }
            
            const item = currentDbData.find(item => item.id === id);
            if (!item) {
                alert('Entry not found');
                return;
            }
            
            // Create a detailed view of the entry
            let details = `${currentDbCollection.charAt(0).toUpperCase() + currentDbCollection.slice(1)} Entry Details:\n\n`;
            
            Object.keys(item).forEach(key => {
                if (key !== 'firebaseId') {
                    let value = item[key];
                    
                    if (value === null || value === undefined) {
                        value = 'N/A';
                    } else if (Array.isArray(value)) {
                        value = value.length > 0 ? value.join(', ') : 'Empty array';
                    } else if (typeof value === 'object') {
                        value = JSON.stringify(value, null, 2);
                    }
                    
                    details += `${key.charAt(0).toUpperCase() + key.slice(1)}: ${value}\n`;
                }
            });
            
            // Add related information
            if (currentDbCollection === 'employees' && item.storeId) {
                const store = stores.find(s => s.id === item.storeId);
                details += `\nStore Details: ${store ? store.name + ' - ' + store.location : 'Store not found'}`;
            }
            
            if (currentDbCollection === 'sales') {
                const employee = employees.find(e => e.id === item.employeeId);
                const store = stores.find(s => s.id === item.storeId);
                const product = products.find(p => p.id === item.productId);
                
                details += `\nEmployee: ${employee ? employee.name : 'Unknown'}`;
                details += `\nStore: ${store ? store.name : 'Unknown'}`;
                details += `\nProduct: ${product ? product.name : 'Unknown'}`;
            }
            
            alert(details);
        }

        async function refreshDatabaseView() {
            if (!currentDbCollection) {
                alert('Please select a collection first');
                return;
            }
            
            try {
                await loadDatabaseCollection();
                alert('Database view refreshed successfully!');
            } catch (error) {
                alert('Error refreshing database view: ' + error.message);
            }
        }

        // Additional Button Functions
        async function refreshData() {
            try {
                await loadAllData();
                
                // Refresh current view
                if (currentUserRole === 'admin') {
                    const activeTab = document.querySelector('.tab-btn.tab-active');
                    if (activeTab) {
                        const tabName = activeTab.getAttribute('data-tab');
                        if (tabName === 'database' && currentDbCollection) {
                            await loadDatabaseCollection();
                        } else {
                            await switchTab(tabName);
                        }
                    }
                } else if (currentUserRole === 'employee') {
                    populateProductDropdown();
                    populateStoreDropdown();
                    updateEmployeeStats();
                    updateTodaysSalesTable();
                }
                
                alert('Data refreshed successfully!');
            } catch (error) {
                alert('Error refreshing data: ' + error.message);
            }
        }

        // Backup and Restore Functions
        function backupData() {
            const backupData = {
                employees: employees,
                stores: stores,
                products: products,
                collections: collections,
                sales: sales,
                timestamp: new Date().toISOString(),
                mode: isFirebaseMode ? 'firebase' : 'local'
            };
            
            const dataStr = JSON.stringify(backupData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `eden_perfume_backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            alert('Backup created successfully!');
        }

        function restoreData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        const backupData = JSON.parse(e.target.result);
                        
                        if (!backupData.employees || !backupData.stores || !backupData.products || !backupData.sales) {
                            throw new Error('Invalid backup file format');
                        }
                        
                        if (confirm('This will replace all current data. Are you sure?')) {
                            employees = backupData.employees;
                            stores = backupData.stores;
                            products = backupData.products;
                            sales = backupData.sales;
                            
                            // Save to current storage
                            if (isFirebaseMode) {
                                // Note: This would require batch operations in a real Firebase implementation
                                alert('Firebase restore requires manual implementation. Data loaded locally for now.');
                            }
                            saveLocalData();
                            
                            // Refresh current view
                            await refreshData();
                            alert('Data restored successfully!');
                        }
                    } catch (error) {
                        alert('Error restoring data: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }

        // Clear all data function
        async function clearAllData() {
            if (!confirm('‚ö†Ô∏è WARNING: This will delete ALL data permanently. Are you absolutely sure?')) {
                return;
            }
            
            if (!confirm('This action cannot be undone. Type "DELETE" to confirm:')) {
                return;
            }
            
            const confirmation = prompt('Type "DELETE ALL DATA" to confirm:');
            if (confirmation !== 'DELETE ALL DATA') {
                alert('Confirmation text did not match. Operation cancelled.');
                return;
            }
            
            try {
                if (isFirebaseMode) {
                    // Clear Firebase collections
                    const collections = ['employees', 'stores', 'products', 'sales'];
                    for (const collection of collections) {
                        const snapshot = await db.collection(collection).get();
                        const batch = db.batch();
                        snapshot.docs.forEach(doc => {
                            batch.delete(doc.ref);
                        });
                        await batch.commit();
                    }
                }
                
                // Clear local arrays
                employees = [];
                stores = [];
                products = [];
                sales = [];
                
                // Clear local storage
                localStorage.removeItem('eden_employees');
                localStorage.removeItem('eden_stores');
                localStorage.removeItem('eden_products');
                localStorage.removeItem('eden_sales');
                
                // Refresh current view
                await refreshData();
                alert('All data cleared successfully!');
                
            } catch (error) {
                alert('Error clearing data: ' + error.message);
            }
        }

        // Print functions
        function printReport(reportType) {
            const table = document.querySelector(`#${reportType}ReportTable`).closest('table');
            if (!table) {
                alert('No report data to print. Please generate a report first.');
                return;
            }
            
            const printWindow = window.open('', '_blank');
            const reportTitle = `Eden Perfume - ${reportType.charAt(0).toUpperCase() + reportType.slice(1)} Report`;
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${reportTitle}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .header { text-align: center; margin-bottom: 30px; }
                        .header h1 { color: #667eea; margin: 0; }
                        .header p { margin: 5px 0; color: #666; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f8f9fa; font-weight: bold; }
                        tr:nth-child(even) { background-color: #f9f9f9; }
                        .footer { margin-top: 30px; text-align: center; font-size: 12px; color: #666; }
                        @media print {
                            body { margin: 0; }
                            .no-print { display: none; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>EDEN PERFUME</h1>
                        <h2>${reportTitle}</h2>
                        <p>Generated on: ${new Date().toLocaleDateString()}</p>
                        <p>Generated at: ${new Date().toLocaleTimeString()}</p>
                    </div>
                    ${table.outerHTML}
                    <div class="footer">
                        <p>Report generated by Eden Perfume Sales Management System</p>
                        <p>Database Mode: ${isFirebaseMode ? 'Firebase Cloud Database' : 'Local Storage Demo'}</p>
                    </div>
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.focus();
            
            // Wait for content to load then print
            setTimeout(() => {
                printWindow.print();
                printWindow.close();
            }, 500);
        }

        // Quick actions
        function quickAddSale() {
            if (currentUserRole !== 'employee') {
                alert('Only employees can add sales');
                return;
            }
            
            // Focus on the add sale form
            document.getElementById('saleProduct').focus();
        }

        function viewTodaysSummary() {
            const today = getTodayString();
            const todaysSales = sales.filter(sale => sale.date === today);
            
            if (todaysSales.length === 0) {
                alert('No sales recorded today');
                return;
            }
            
            const totalAmount = todaysSales.reduce((sum, sale) => sum + sale.amount, 0);
            const totalQuantity = todaysSales.reduce((sum, sale) => sum + sale.quantity, 0);
            const uniqueEmployees = [...new Set(todaysSales.map(sale => sale.employeeId))].length;
            
            alert(`Today's Summary:\n\nTotal Sales: $${totalAmount.toFixed(2)}\nItems Sold: ${totalQuantity}\nActive Employees: ${uniqueEmployees}\nTransactions: ${todaysSales.length}`);
        }



        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                console.log('Initializing Eden Perfume System...');
                
                // Initialize arrays first
                initializeArrays();
                
                // Always load local data first
                loadLocalData();
                
                // Initialize sync status
                updateSyncStatus();
                
                // Wait a moment for Firebase SDK to load
                setTimeout(() => {
                    // Check if Firebase config exists in localStorage
                    const savedConfig = localStorage.getItem('firebaseConfig');
                    
                    if (savedConfig && typeof firebase !== 'undefined' && !window.firebaseLoadError) {
                        try {
                            const firebaseConfig = JSON.parse(savedConfig);
                            
                            // Try to initialize Firebase with saved config
                            if (initializeFirebase(firebaseConfig)) {
                                const configModal = document.getElementById('firebaseConfigModal');
                                const loginScreen = document.getElementById('loginScreen');
                                
                                if (configModal) configModal.classList.add('hidden');
                                if (loginScreen) loginScreen.classList.remove('hidden');
                                
                                // Add sample data if collections are empty (only locally)
                                if (!employees || employees.length === 0) {
                                    initializeSampleDataLocal();
                                }
                            } else {
                                throw new Error('Firebase initialization failed');
                            }
                        } catch (error) {
                            console.error('Error with saved Firebase config:', error);
                            // Fall back to demo mode if saved config fails
                            loadDemoConfig();
                            if (!employees || employees.length === 0) {
                                initializeSampleDataLocal();
                            }
                        }
                    } else {
                        // No saved config or Firebase not available, fall back to demo mode
                        console.log('Firebase not available or no saved config, using local storage mode');
                        loadDemoConfig();
                        if (!employees || employees.length === 0) {
                            initializeSampleDataLocal();
                        }
                    }
                }, 500); // Wait 500ms for Firebase to load
                
                // Set default dates safely
                try {
                    const today = new Date();
                    const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
                    
                    const reportStartDate = document.getElementById('reportStartDate');
                    const reportEndDate = document.getElementById('reportEndDate');
                    const salaryStartDate = document.getElementById('salaryStartDate');
                    const salaryEndDate = document.getElementById('salaryEndDate');
                    
                    if (reportStartDate) reportStartDate.value = firstDay.toISOString().split('T')[0];
                    if (reportEndDate) reportEndDate.value = today.toISOString().split('T')[0];
                    if (salaryStartDate) salaryStartDate.value = firstDay.toISOString().split('T')[0];
                    if (salaryEndDate) salaryEndDate.value = today.toISOString().split('T')[0];
                } catch (error) {
                    console.error('Error setting default dates:', error);
                }
                
                // Add keyboard shortcuts
                document.addEventListener('keydown', function(e) {
                    try {
                        // Ctrl+R for refresh (prevent default browser refresh)
                        if (e.ctrlKey && e.key === 'r') {
                            e.preventDefault();
                            refreshData();
                        }
                        
                        // Escape to close modal
                        if (e.key === 'Escape') {
                            closeModal();
                        }
                        
                        // Ctrl+N for new item (when in admin mode)
                        if (e.ctrlKey && e.key === 'n' && currentUserRole === 'admin') {
                            e.preventDefault();
                            const activeTab = document.querySelector('.tab-btn.tab-active');
                            if (activeTab) {
                                const tabName = activeTab.getAttribute('data-tab');
                                if (tabName && ['employees', 'stores', 'products'].includes(tabName)) {
                                    openModal(tabName.slice(0, -1)); // Remove 's' from plural
                                }
                            }
                        }
                    } catch (error) {
                        console.error('Error in keyboard shortcut handler:', error);
                    }
                });
                
                console.log('Eden Perfume System initialized successfully');
            } catch (error) {
                console.error('Critical error during initialization:', error);
                alert('System initialization failed. Please refresh the page and try again.');
            }
        });

        // Sample Data Initialization
        async function initializeSampleData() {
            // Check if data already exists
            if (stores.length > 0 || products.length > 0 || employees.length > 0) {
                return; // Data already exists, don't overwrite
            }
            
            try {
                console.log('Initializing sample data...');
                
                // Sample Stores
                const sampleStores = [
                    { name: "Eden Mall Branch", location: "Shopping Mall, Downtown", manager: "Sarah Johnson", phone: "+1-555-0101" },
                    { name: "Eden City Center", location: "City Center Plaza", manager: "Mike Wilson", phone: "+1-555-0102" },
                    { name: "Eden Airport", location: "International Airport", manager: "Lisa Chen", phone: "+1-555-0103" }
                ];
                
                for (const store of sampleStores) {
                    await saveStore(store);
                }
                
                // Sample Products
                const sampleProducts = [
                    { name: "Eden Rose Perfume", price: 89.99 },
                    { name: "Eden Lavender Mist", price: 79.99 },
                    { name: "Eden Vanilla Dreams", price: 94.99 },
                    { name: "Eden Citrus Fresh", price: 69.99 },
                    { name: "Eden Midnight Oud", price: 129.99 },
                    { name: "Eden Spring Blossom", price: 84.99 }
                ];
                
                for (const product of sampleProducts) {
                    await saveProduct(product);
                }
                
                // Reload data to get IDs
                await loadAllData();
                
                // Sample Employees
                const sampleEmployees = [
                    { 
                        name: "John Smith", 
                        username: "john.smith", 
                        password: "john123", 
                        storeId: stores[0]?.id, 
                        salaryType: "commission", 
                        baseSalary: 2000, 
                        commissionRate: 0.05 
                    },
                    { 
                        name: "Emma Davis", 
                        username: "emma.davis", 
                        password: "emma123", 
                        storeId: stores[1]?.id, 
                        salaryType: "qty_sold", 
                        baseSalary: 1800, 
                        commissionRate: 0 
                    },
                    { 
                        name: "Alex Rodriguez", 
                        username: "alex.rodriguez", 
                        password: "alex123", 
                        storeId: stores[2]?.id, 
                        salaryType: "fixed", 
                        baseSalary: 2500, 
                        commissionRate: 0 
                    }
                ];
                
                for (const employee of sampleEmployees) {
                    if (employee.storeId) { // Only add if store exists
                        await saveEmployee(employee);
                    }
                }
                
                // Generate sample sales data for the last 30 days
                await generateSampleSales();
                
                // Reload final data
                await loadAllData();
                
                console.log('Sample data initialized successfully');
            } catch (error) {
                console.error('Error initializing sample data:', error);
            }
        }
        
        // Generate sample sales data
        async function generateSampleSales() {
            if (sales.length > 0) return; // Don't overwrite existing sales
            
            const today = new Date();
            for (let i = 0; i < 30; i++) {
                const saleDate = new Date(today);
                saleDate.setDate(today.getDate() - i);
                const dateString = saleDate.toISOString().split('T')[0];
                
                // Generate 1-5 random sales per day
                const salesCount = Math.floor(Math.random() * 5) + 1;
                for (let j = 0; j < salesCount; j++) {
                    if (employees.length > 0 && products.length > 0) {
                        const randomEmployee = employees[Math.floor(Math.random() * employees.length)];
                        const randomProduct = products[Math.floor(Math.random() * products.length)];
                        const quantity = Math.floor(Math.random() * 3) + 1;
                        
                        const sampleSale = {
                            date: dateString,
                            time: `${Math.floor(Math.random() * 12) + 9}:${Math.floor(Math.random() * 60).toString().padStart(2, '0')}`,
                            employeeId: randomEmployee.id,
                            storeId: randomEmployee.storeId,
                            productId: randomProduct.id,
                            quantity: quantity,
                            amount: randomProduct.price * quantity
                        };
                        
                        await saveSale(sampleSale);
                    }
                }
            }
        }
        
        function initializeSampleDataLocal() {
            // Check if data already exists
            if (stores.length > 0 || products.length > 0 || employees.length > 0) {
                return; // Data already exists, don't overwrite
            }
            
            // Sample Stores
            stores = [
                { id: "store1", name: "Eden Mall Branch", location: "Shopping Mall, Downtown", manager: "Sarah Johnson", phone: "+1-555-0101" },
                { id: "store2", name: "Eden City Center", location: "City Center Plaza", manager: "Mike Wilson", phone: "+1-555-0102" },
                { id: "store3", name: "Eden Airport", location: "International Airport", manager: "Lisa Chen", phone: "+1-555-0103" }
            ];
            
            // Sample Products
            products = [
                { id: "product1", name: "Eden Rose Perfume", price: 89.99 },
                { id: "product2", name: "Eden Lavender Mist", price: 79.99 },
                { id: "product3", name: "Eden Vanilla Dreams", price: 94.99 },
                { id: "product4", name: "Eden Citrus Fresh", price: 69.99 },
                { id: "product5", name: "Eden Midnight Oud", price: 129.99 },
                { id: "product6", name: "Eden Spring Blossom", price: 84.99 }
            ];
            
            // Sample Employees
            employees = [
                { 
                    id: "emp1",
                    name: "John Smith", 
                    username: "john.smith", 
                    password: "john123", 
                    storeId: "store1", 
                    salaryType: "commission", 
                    baseSalary: 2000, 
                    commissionRate: 0.05 
                },
                { 
                    id: "emp2",
                    name: "Emma Davis", 
                    username: "emma.davis", 
                    password: "emma123", 
                    storeId: "store2", 
                    salaryType: "qty_sold", 
                    baseSalary: 1800, 
                    commissionRate: 0 
                },
                { 
                    id: "emp3",
                    name: "Alex Rodriguez", 
                    username: "alex.rodriguez", 
                    password: "alex123", 
                    storeId: "store3", 
                    salaryType: "fixed", 
                    baseSalary: 2500, 
                    commissionRate: 0 
                }
            ];
            
            // Sample Sales Data (last 30 days)
            sales = [];
            const today = new Date();
            for (let i = 0; i < 30; i++) {
                const saleDate = new Date(today);
                saleDate.setDate(today.getDate() - i);
                const dateString = saleDate.toISOString().split('T')[0];
                
                // Generate 1-5 random sales per day
                const salesCount = Math.floor(Math.random() * 5) + 1;
                for (let j = 0; j < salesCount; j++) {
                    const randomEmployee = employees[Math.floor(Math.random() * employees.length)];
                    const randomProduct = products[Math.floor(Math.random() * products.length)];
                    const quantity = Math.floor(Math.random() * 3) + 1;
                    
                    sales.push({
                        id: `sale_${i}_${j}`,
                        date: dateString,
                        time: `${Math.floor(Math.random() * 12) + 9}:${Math.floor(Math.random() * 60).toString().padStart(2, '0')}`,
                        employeeId: randomEmployee.id,
                        storeId: randomEmployee.storeId,
                        productId: randomProduct.id,
                        quantity: quantity,
                        amount: randomProduct.price * quantity
                    });
                }
            }
            
            saveLocalData();
            console.log('Sample data initialized locally');
        }

        // Close modal when clicking outside
        document.getElementById('modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        // Add click outside to close Firebase config modal
        document.getElementById('firebaseConfigModal').addEventListener('click', function(e) {
            if (e.target === this) {
                // Don't allow closing config modal by clicking outside
                // User must either configure Firebase or choose demo mode
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96a6708007fef9ec',t:'MTc1NDM5ODQyOC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
