<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eden Perfume - Sales Management System</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üå∏</text></svg>">
    
    <!-- Firebase SDK with better error handling -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js" onerror="handleFirebaseLoadError('app')"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js" onerror="handleFirebaseLoadError('firestore')"></script>
    
    <style>
        /* Manual Tailwind CSS Configuration */
        /* Reset and Base Styles */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: #374151;
        }
        
        /* Utility Classes */
        .min-h-screen { min-height: 100vh; }
        .bg-gray-50 { background-color: #f9fafb; }
        .bg-white { background-color: #ffffff; }
        .bg-gray-100 { background-color: #f3f4f6; }
        .bg-gray-600 { background-color: #4b5563; }
        .bg-gray-700 { background-color: #374151; }
        .bg-blue-600 { background-color: #2563eb; }
        .bg-blue-700 { background-color: #1d4ed8; }
        .bg-green-600 { background-color: #16a34a; }
        .bg-green-700 { background-color: #15803d; }
        .bg-red-600 { background-color: #dc2626; }
        .bg-red-700 { background-color: #b91c1c; }
        .bg-purple-600 { background-color: #9333ea; }
        .bg-purple-700 { background-color: #7c3aed; }
        .bg-orange-600 { background-color: #ea580c; }
        .bg-orange-700 { background-color: #c2410c; }
        .bg-yellow-600 { background-color: #ca8a04; }
        .bg-yellow-700 { background-color: #a16207; }
        .bg-yellow-50 { background-color: #fefce8; }
        .bg-green-100 { background-color: #dcfce7; }
        .bg-blue-100 { background-color: #dbeafe; }
        .bg-purple-100 { background-color: #f3e8ff; }
        
        .text-white { color: #ffffff; }
        .text-gray-500 { color: #6b7280; }
        .text-gray-600 { color: #4b5563; }
        .text-gray-700 { color: #374151; }
        .text-gray-800 { color: #1f2937; }
        .text-blue-600 { color: #2563eb; }
        .text-blue-800 { color: #1e40af; }
        .text-green-600 { color: #16a34a; }
        .text-green-800 { color: #166534; }
        .text-red-600 { color: #dc2626; }
        .text-red-800 { color: #991b1b; }
        .text-purple-600 { color: #9333ea; }
        .text-yellow-600 { color: #ca8a04; }
        .text-yellow-700 { color: #a16207; }
        .text-yellow-800 { color: #92400e; }
        .text-red-500 { color: #ef4444; }
        
        .p-4 { padding: 1rem; }
        .p-6 { padding: 1.5rem; }
        .p-8 { padding: 2rem; }
        .px-3 { padding-left: 0.75rem; padding-right: 0.75rem; }
        .px-4 { padding-left: 1rem; padding-right: 1rem; }
        .px-6 { padding-left: 1.5rem; padding-right: 1.5rem; }
        .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
        .py-3 { padding-top: 0.75rem; padding-bottom: 0.75rem; }
        .py-4 { padding-top: 1rem; padding-bottom: 1rem; }
        .py-8 { padding-top: 2rem; padding-bottom: 2rem; }
        
        .m-4 { margin: 1rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mb-6 { margin-bottom: 1.5rem; }
        .mb-8 { margin-bottom: 2rem; }
        .mt-1 { margin-top: 0.25rem; }
        .mt-2 { margin-top: 0.5rem; }
        .mt-6 { margin-top: 1.5rem; }
        .mt-8 { margin-top: 2rem; }
        .mr-3 { margin-right: 0.75rem; }
        .ml-2 { margin-left: 0.5rem; }
        .mx-auto { margin-left: auto; margin-right: auto; }
        
        .w-full { width: 100%; }
        .w-10 { width: 2.5rem; }
        .w-12 { width: 3rem; }
        .w-20 { width: 5rem; }
        .max-w-md { max-width: 28rem; }
        .max-w-2xl { max-width: 42rem; }
        .max-h-40 { max-height: 10rem; }
        
        .h-10 { height: 2.5rem; }
        .h-12 { height: 3rem; }
        .h-20 { height: 5rem; }
        
        .flex { display: flex; }
        .flex-1 { flex: 1 1 0%; }
        .flex-wrap { flex-wrap: wrap; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .justify-center { justify-content: center; }
        .space-x-2 > * + * { margin-left: 0.5rem; }
        .space-x-3 > * + * { margin-left: 0.75rem; }
        .space-y-1 > * + * { margin-top: 0.25rem; }
        .space-y-4 > * + * { margin-top: 1rem; }
        .space-y-6 > * + * { margin-top: 1.5rem; }
        
        .grid { display: grid; }
        .grid-cols-1 { grid-template-columns: repeat(1, minmax(0, 1fr)); }
        .grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
        .grid-cols-5 { grid-template-columns: repeat(5, minmax(0, 1fr)); }
        .gap-2 { gap: 0.5rem; }
        .gap-4 { gap: 1rem; }
        .gap-6 { gap: 1.5rem; }
        
        .rounded-lg { border-radius: 0.5rem; }
        .rounded-xl { border-radius: 0.75rem; }
        .rounded-2xl { border-radius: 1rem; }
        .rounded-full { border-radius: 9999px; }
        
        .border { border-width: 1px; }
        .border-b { border-bottom-width: 1px; }
        .border-b-2 { border-bottom-width: 2px; }
        .border-t-2 { border-top-width: 2px; }
        .border-gray-300 { border-color: #d1d5db; }
        .border-gray-400 { border-color: #9ca3af; }
        .border-purple-500 { border-color: #a855f7; }
        .border-transparent { border-color: transparent; }
        .border-yellow-200 { border-color: #fde047; }
        
        .font-medium { font-weight: 500; }
        .font-semibold { font-weight: 600; }
        .font-bold { font-weight: 700; }
        
        .text-xs { font-size: 0.75rem; }
        .text-sm { font-size: 0.875rem; }
        .text-lg { font-size: 1.125rem; }
        .text-xl { font-size: 1.25rem; }
        .text-2xl { font-size: 1.5rem; }
        .text-3xl { font-size: 1.875rem; }
        
        .text-left { text-align: left; }
        .text-center { text-align: center; }
        
        .capitalize { text-transform: capitalize; }
        .whitespace-nowrap { white-space: nowrap; }
        
        .overflow-hidden { overflow: hidden; }
        .overflow-x-auto { overflow-x: auto; }
        .overflow-y-auto { overflow-y: auto; }
        
        .fixed { position: fixed; }
        .inset-0 { top: 0; right: 0; bottom: 0; left: 0; }
        
        .z-50 { z-index: 50; }
        
        .hidden { display: none; }
        .block { display: block; }
        
        .opacity-70 { opacity: 0.7; }
        .opacity-80 { opacity: 0.8; }
        .opacity-90 { opacity: 0.9; }
        .bg-opacity-20 { background-color: rgba(255, 255, 255, 0.2); }
        .bg-opacity-30 { background-color: rgba(255, 255, 255, 0.3); }
        
        .transition { transition-property: color, background-color, border-color, text-decoration-color, fill, stroke, opacity, box-shadow, transform, filter, backdrop-filter; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 150ms; }
        
        .hover\:bg-gray-50:hover { background-color: #f9fafb; }
        .hover\:bg-gray-700:hover { background-color: #374151; }
        .hover\:bg-blue-700:hover { background-color: #1d4ed8; }
        .hover\:bg-green-700:hover { background-color: #15803d; }
        .hover\:bg-red-700:hover { background-color: #b91c1c; }
        .hover\:bg-purple-700:hover { background-color: #7c3aed; }
        .hover\:bg-orange-700:hover { background-color: #c2410c; }
        .hover\:bg-yellow-700:hover { background-color: #a16207; }
        .hover\:bg-red-800:hover { background-color: #991b1b; }
        .hover\:text-blue-800:hover { color: #1e40af; }
        .hover\:text-red-800:hover { color: #991b1b; }
        .hover\:text-green-800:hover { color: #166534; }
        .hover\:border-purple-500:hover { border-color: #a855f7; }
        .hover\:opacity-90:hover { opacity: 0.9; }
        .hover\:opacity-30:hover { opacity: 0.3; }
        
        .focus\:ring-2:focus { box-shadow: 0 0 0 2px rgba(168, 85, 247, 0.5); }
        .focus\:ring-purple-500:focus { box-shadow: 0 0 0 2px rgba(168, 85, 247, 0.5); }
        .focus\:border-transparent:focus { border-color: transparent; }
        
        /* Form Elements */
        input, select, textarea {
            border: 2px solid #d1d5db;
            border-radius: 0.5rem;
            padding: 0.75rem;
            font-size: 1rem;
            line-height: 1.25rem;
            width: 100%;
            background-color: #ffffff;
            min-height: 44px; /* iOS touch target minimum */
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #a855f7;
            box-shadow: 0 0 0 3px rgba(168, 85, 247, 0.1);
        }
        
        /* Mobile form adjustments */
        @media (max-width: 640px) {
            input, select, textarea {
                font-size: 16px; /* Prevents zoom on iOS */
                padding: 0.875rem;
            }
        }
        
        button {
            border: none;
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s ease;
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Table Styles */
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            text-align: left;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #e5e7eb;
        }
        
        th {
            background-color: #f9fafb;
            font-weight: 500;
            color: #374151;
        }
        
        tr:hover {
            background-color: #f9fafb;
        }
        
        /* Mobile-First Responsive Design */
        
        /* Mobile Base Styles */
        .mobile-container {
            padding: 0.75rem;
        }
        
        .mobile-card {
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 1rem;
        }
        
        .mobile-button {
            min-height: 44px; /* iOS touch target minimum */
            padding: 0.75rem 1rem;
            font-size: 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
        }
        
        .mobile-input {
            min-height: 44px;
            padding: 0.75rem;
            font-size: 1rem;
            border-radius: 0.5rem;
            border: 2px solid #d1d5db;
        }
        
        .mobile-input:focus {
            border-color: #a855f7;
            box-shadow: 0 0 0 3px rgba(168, 85, 247, 0.1);
        }
        
        .mobile-nav {
            position: sticky;
            top: 0;
            z-index: 40;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .mobile-tab-scroll {
            overflow-x: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        
        .mobile-tab-scroll::-webkit-scrollbar {
            display: none;
        }
        
        .mobile-table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .mobile-table {
            min-width: 600px;
        }
        
        .mobile-stats-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
        }
        
        .mobile-form-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
        }
        
        .mobile-action-buttons {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .mobile-modal {
            margin: 1rem;
            max-height: calc(100vh - 2rem);
            overflow-y: auto;
        }
        
        /* Touch-friendly spacing */
        .touch-target {
            min-height: 44px;
            min-width: 44px;
        }
        
        /* Tablet Styles */
        @media (min-width: 640px) {
            .sm\:grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
            .sm\:grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
            .sm\:flex-row { flex-direction: row; }
            .sm\:space-x-2 > * + * { margin-left: 0.5rem; margin-top: 0; }
            .sm\:space-y-0 > * + * { margin-top: 0; }
            
            .mobile-container {
                padding: 1rem;
            }
            
            .mobile-stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .mobile-form-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .mobile-action-buttons {
                flex-direction: row;
                flex-wrap: wrap;
            }
        }
        
        @media (min-width: 768px) {
            .md\:grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
            .md\:grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
            .md\:grid-cols-4 { grid-template-columns: repeat(4, minmax(0, 1fr)); }
            .md\:grid-cols-5 { grid-template-columns: repeat(5, minmax(0, 1fr)); }
            .md\:flex-row { flex-direction: row; }
            .md\:space-x-3 > * + * { margin-left: 0.75rem; margin-top: 0; }
            .md\:space-y-0 > * + * { margin-top: 0; }
            
            .mobile-container {
                padding: 1.5rem;
            }
            
            .mobile-stats-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .mobile-form-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .mobile-modal {
                margin: 2rem auto;
                max-width: 28rem;
            }
        }
        
        @media (min-width: 1024px) {
            .lg\:grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
            .lg\:grid-cols-4 { grid-template-columns: repeat(4, minmax(0, 1fr)); }
            .lg\:grid-cols-5 { grid-template-columns: repeat(5, minmax(0, 1fr)); }
            
            .mobile-container {
                padding: 2rem;
            }
            
            .mobile-form-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        
        /* Mobile-specific utilities */
        .hide-mobile { display: block; }
        .show-mobile { display: none; }
        
        @media (max-width: 640px) {
            .hide-mobile { display: none; }
            .show-mobile { display: block; }
            
            /* Compact mobile styles */
            .text-xs-mobile { font-size: 0.75rem; }
            .text-sm-mobile { font-size: 0.875rem; }
            .p-2-mobile { padding: 0.5rem; }
            .px-2-mobile { padding-left: 0.5rem; padding-right: 0.5rem; }
            .py-1-mobile { padding-top: 0.25rem; padding-bottom: 0.25rem; }
        }
        
        /* Custom Component Styles */
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .card-shadow {
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .tab-active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Firebase Configuration Modal -->
    <div id="firebaseConfigModal" class="fixed inset-0 modal-backdrop z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl card-shadow w-full max-w-2xl fade-in">
            <div class="p-6 border-b">
                <h3 class="text-xl font-semibold">üî• Firebase Configuration Required</h3>
                <p class="text-gray-600 mt-2">Please enter your Firebase configuration to connect to your database.</p>
            </div>
            <div class="p-6">
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
                    <h4 class="font-semibold text-yellow-800 mb-2">üìã How to set up Firebase for Eden Perfume:</h4>
                    <ol class="text-sm text-yellow-700 space-y-1">
                        <li><strong>1. Create Firebase Project:</strong> Go to <a href="https://console.firebase.google.com" target="_blank" class="text-blue-600 underline">Firebase Console</a> ‚Üí Create Project</li>
                        <li><strong>2. Enable Firestore:</strong> Go to Firestore Database ‚Üí Create database ‚Üí Start in test mode</li>
                        <li><strong>3. Get Web App Config:</strong> Project Settings ‚Üí Your apps ‚Üí Add web app ‚Üí Copy config values</li>
                        <li><strong>4. Set Security Rules:</strong> Firestore ‚Üí Rules ‚Üí Use: <code class="bg-gray-200 px-1 rounded">allow read, write: if true;</code></li>
                        <li><strong>5. Enter Config Below:</strong> Paste the values from your Firebase config object</li>
                    </ol>
                    <div class="mt-3 p-2 bg-blue-50 rounded text-xs">
                        <strong>üí° Tip:</strong> For production, update Firestore security rules to restrict access appropriately.
                    </div>
                </div>
                
                <form id="firebaseConfigForm" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">API Key</label>
                            <input type="text" id="apiKey" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="AIza..." required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Auth Domain</label>
                            <input type="text" id="authDomain" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="your-project.firebaseapp.com" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Project ID</label>
                            <input type="text" id="projectId" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="your-project-id" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Storage Bucket</label>
                            <input type="text" id="storageBucket" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="your-project.appspot.com" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Messaging Sender ID</label>
                            <input type="text" id="messagingSenderId" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="123456789" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">App ID</label>
                            <input type="text" id="appId" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="1:123:web:abc" required>
                        </div>
                    </div>
                    
                    <div class="flex space-x-3 mt-6">
                        <button type="button" onclick="loadDemoConfig()" class="flex-1 bg-gray-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-gray-700 transition">
                            Use Demo Mode (Local Storage)
                        </button>
                        <button type="submit" class="flex-1 gradient-bg text-white px-4 py-2 rounded-lg font-semibold hover:opacity-90 transition">
                            <span id="connectBtnText">Connect to Firebase</span>
                            <div id="connectLoader" class="loading hidden ml-2"></div>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="hidden min-h-screen gradient-bg flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl card-shadow p-8 w-full max-w-md fade-in">
            <div class="text-center mb-8">
                <div class="w-20 h-20 mx-auto mb-4 bg-gradient-to-r from-purple-500 to-pink-500 rounded-full flex items-center justify-center">
                    <svg class="w-10 h-10 text-white" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </div>
                <h1 class="text-3xl font-bold text-gray-800 mb-2">EDEN PERFUME</h1>
                <p class="text-gray-600">Sales Management System</p>
                <div class="mt-2 text-sm" id="dbStatus">
                    <div id="dbMode" class="text-green-600"></div>
                    <div id="syncStatus" class="text-xs mt-1"></div>
                </div>
            </div>
            
            <form id="loginForm" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                    <input type="text" id="username" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Enter username">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                    <input type="password" id="password" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Enter password">
                </div>
                
                <button type="submit" class="w-full gradient-bg text-white py-3 rounded-lg font-semibold hover:opacity-90 transition">
                    <span id="loginBtnText">Sign In</span>
                </button>
            </form>
            
            <div class="mt-8 p-4 bg-gray-50 rounded-lg text-center">
                <p class="text-xs text-gray-500">Developed by <strong class="text-purple-600">Sufaij</strong></p>
            </div>
        </div>
    </div>

    <!-- Employee Portal -->
    <div id="employeePortal" class="hidden min-h-screen bg-gray-50">
        <nav class="mobile-nav gradient-bg text-white">
            <!-- Mobile Header -->
            <div class="mobile-container">
                <div class="flex justify-between items-center mb-3">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z"/>
                            </svg>
                        </div>
                        <div>
                            <h2 class="font-semibold text-lg" id="employeeName">Employee</h2>
                            <p class="text-sm opacity-80" id="employeeStore">Store</p>
                        </div>
                    </div>
                    <button onclick="logout()" class="bg-white bg-opacity-20 mobile-button text-sm touch-target">
                        Logout
                    </button>
                </div>
                
                <!-- Mobile Status Bar -->
                <div class="flex justify-between items-center text-sm mb-3">
                    <div class="opacity-80" id="employeeCurrentDate"></div>
                    <div class="text-xs opacity-70" id="employeeSyncStatus">üì± Local Mode</div>
                </div>
                
                <!-- Simple Status Bar -->
                <div class="text-center text-sm opacity-80">
                    Ready to record sales
                </div>
            </div>
        </nav>

        <div class="mobile-container">
            <!-- Compact Horizontal Stats -->
            <div class="bg-white mobile-card p-3 mb-4">
                <div class="grid grid-cols-3 gap-2 text-center">
                    <!-- Total Sales -->
                    <div class="bg-green-50 rounded-lg p-2">
                        <div class="flex items-center justify-center mb-1">
                            <div class="w-6 h-6 bg-green-100 rounded-full flex items-center justify-center mr-1">
                                <span class="text-green-600 text-xs">üí∞</span>
                            </div>
                            <span class="text-xs font-medium text-green-800">SALES</span>
                        </div>
                        <div class="text-lg font-bold text-green-600" id="totalSalesToday">0.00 DH</div>
                        <p class="text-xs text-green-600">Revenue</p>
                    </div>

                    <!-- Quantity Sold -->
                    <div class="bg-blue-50 rounded-lg p-2">
                        <div class="flex items-center justify-center mb-1">
                            <div class="w-6 h-6 bg-blue-100 rounded-full flex items-center justify-center mr-1">
                                <span class="text-blue-600 text-xs">üß¥</span>
                            </div>
                            <span class="text-xs font-medium text-blue-800">QTY</span>
                        </div>
                        <div class="text-lg font-bold text-blue-600" id="bottlesSold">0</div>
                        <p class="text-xs text-blue-600">Bottles</p>
                    </div>

                    <!-- Today's Salary -->
                    <div class="bg-purple-50 rounded-lg p-2">
                        <div class="flex items-center justify-center mb-1">
                            <div class="w-6 h-6 bg-purple-100 rounded-full flex items-center justify-center mr-1">
                                <span class="text-purple-600 text-xs">üíµ</span>
                            </div>
                            <span class="text-xs font-medium text-purple-800">SALARY</span>
                        </div>
                        <div class="text-lg font-bold text-purple-600" id="estimatedSalary">0.00 DH</div>
                        <p class="text-xs text-purple-600">Today</p>
                    </div>
                </div>
            </div>

            <!-- Premium Sale Entry -->
            <div class="bg-white mobile-card p-6 mb-6 border border-gray-100 shadow-lg">
                <div class="text-center mb-6">
                    <div class="w-16 h-16 mx-auto mb-3 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center">
                        <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
                        </svg>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800">Record New Sale</h3>
                    <p class="text-sm text-gray-500">Complete the form below to record a new sale transaction</p>
                </div>
                
                <form id="addSaleForm" class="space-y-6">
                    <!-- Store Selection -->
                    <div class="space-y-2">
                        <label class="flex items-center text-sm font-semibold text-gray-700">
                            <div class="w-6 h-6 bg-blue-100 rounded-full flex items-center justify-center mr-2">
                                <span class="text-blue-600 text-xs">üè™</span>
                            </div>
                            Store Location
                        </label>
                        <select id="saleStore" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:ring-0 transition-colors bg-gray-50 hover:bg-white" required style="min-height: 52px;">
                            <option value="">Select your store location</option>
                        </select>
                    </div>
                    
                    <!-- Product Selection -->
                    <div class="space-y-2">
                        <label class="flex items-center text-sm font-semibold text-gray-700">
                            <div class="w-6 h-6 bg-purple-100 rounded-full flex items-center justify-center mr-2">
                                <span class="text-purple-600 text-xs">üß¥</span>
                            </div>
                            Product Selection
                        </label>
                        <select id="saleProduct" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:ring-0 transition-colors bg-gray-50 hover:bg-white" required style="min-height: 52px;">
                            <option value="">Choose a product to sell</option>
                        </select>
                    </div>
                    
                    <!-- Quantity Input -->
                    <div class="space-y-2">
                        <label class="flex items-center text-sm font-semibold text-gray-700">
                            <div class="w-6 h-6 bg-green-100 rounded-full flex items-center justify-center mr-2">
                                <span class="text-green-600 text-xs">üì¶</span>
                            </div>
                            Quantity
                        </label>
                        <div class="flex items-center space-x-3 bg-gray-50 p-2 rounded-xl border-2 border-gray-200">
                            <button type="button" onclick="adjustQuantity(-1)" class="w-12 h-12 bg-gradient-to-r from-red-500 to-red-600 text-white rounded-lg text-xl font-bold hover:from-red-600 hover:to-red-700 transition-all shadow-md hover:shadow-lg transform hover:scale-105">-</button>
                            <input type="number" id="saleQuantity" min="1" value="1" class="flex-1 text-center text-2xl font-bold bg-white border-2 border-gray-200 rounded-lg py-3 focus:border-green-500 focus:ring-0 transition-colors" required style="min-height: 52px;">
                            <button type="button" onclick="adjustQuantity(1)" class="w-12 h-12 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-lg text-xl font-bold hover:from-green-600 hover:to-green-700 transition-all shadow-md hover:shadow-lg transform hover:scale-105">+</button>
                        </div>
                    </div>
                    
                    <!-- Total Display -->
                    <div class="bg-gradient-to-r from-blue-50 to-purple-50 border-2 border-blue-200 rounded-xl p-6 text-center">
                        <div class="flex items-center justify-center mb-2">
                            <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center mr-2">
                                <span class="text-white text-sm">üí∞</span>
                            </div>
                            <p class="text-sm font-semibold text-gray-600">Total Amount</p>
                        </div>
                        <p class="text-3xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent" id="totalAmount">0.00 DH</p>
                    </div>
                    
                    <!-- Save Button -->
                    <button type="submit" class="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white text-lg font-bold py-4 rounded-xl hover:from-blue-700 hover:to-purple-700 transition-all shadow-lg hover:shadow-xl transform hover:scale-[1.02] flex items-center justify-center space-x-2" style="min-height: 60px;">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M7.707 10.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V6a1 1 0 10-2 0v5.586l-1.293-1.293z"/>
                            <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"/>
                        </svg>
                        <span>Record Sale Transaction</span>
                    </button>
                </form>
            </div>

            <!-- Today's Sales -->
            <div class="bg-white mobile-card p-4">
                <h3 class="text-lg font-semibold mb-4 text-center">üìä Today's Sales - <span id="currentDate"></span></h3>
                <div class="mobile-table-container">
                    <table class="mobile-table w-full">
                        <thead>
                            <tr class="border-b">
                                <th class="text-left py-2 px-2 text-sm">Time</th>
                                <th class="text-left py-2 px-2 text-sm hide-mobile">Store</th>
                                <th class="text-left py-2 px-2 text-sm">Product</th>
                                <th class="text-left py-2 px-2 text-sm">Qty</th>
                                <th class="text-left py-2 px-2 text-sm">Amount</th>
                                <th class="text-left py-2 px-2 text-sm">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="todaysSalesTable">
                            <tr>
                                <td colspan="6" class="text-center py-8 text-gray-500 text-sm">No sales recorded today</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="dashboard" class="hidden min-h-screen bg-gray-50">
        <nav class="mobile-nav gradient-bg text-white">
            <div class="mobile-container">
                <!-- Mobile Header -->
                <div class="flex justify-between items-center mb-3">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </div>
                        <div>
                            <h2 class="font-semibold text-lg">Eden Perfume Admin</h2>
                            <p class="text-sm opacity-80">Management Dashboard</p>
                        </div>
                    </div>
                    <button onclick="logout()" class="bg-white bg-opacity-20 mobile-button text-sm touch-target">
                        Logout
                    </button>
                </div>
                
                <!-- Mobile Status Bar -->
                <div class="flex justify-between items-center text-sm mb-3">
                    <div class="opacity-80" id="adminCurrentDate"></div>
                    <div class="text-xs opacity-70" id="adminSyncStatus">üì± Local Mode</div>
                </div>
                
                <!-- Mobile Action Buttons - Scrollable -->
                <div class="mobile-tab-scroll">
                    <div class="flex space-x-2 pb-2" style="min-width: max-content;">
                        <button onclick="refreshData()" class="bg-blue-600 mobile-button hover:bg-blue-700 transition text-sm whitespace-nowrap">
                            üîÑ Refresh
                        </button>
                        <button onclick="forceSyncNow()" class="bg-orange-600 mobile-button hover:bg-orange-700 transition text-sm whitespace-nowrap">
                            üîÑ Sync
                        </button>
                        <button onclick="resetFirebaseConfig()" class="bg-red-600 mobile-button hover:bg-red-700 transition text-sm whitespace-nowrap">
                            üî• Firebase
                        </button>
                        <button onclick="viewTodaysSummary()" class="bg-purple-600 mobile-button hover:bg-purple-700 transition text-sm whitespace-nowrap">
                            üìä Summary
                        </button>
                        <button onclick="backupData()" class="bg-yellow-600 mobile-button hover:bg-yellow-700 transition text-sm whitespace-nowrap">
                            üíæ Backup
                        </button>
                        <button onclick="downloadAllMasterData()" class="bg-green-600 mobile-button hover:bg-green-700 transition text-sm whitespace-nowrap">
                            üì• Download
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Tab Navigation -->
        <div class="bg-white border-b">
            <div class="mobile-tab-scroll">
                <div class="flex space-x-0" style="min-width: max-content;">
                    <button onclick="switchTab('employees')" class="tab-btn px-4 py-3 font-medium whitespace-nowrap border-b-2 border-transparent hover:border-purple-500 transition text-sm touch-target" data-tab="employees">
                        üë• Employees
                    </button>
                    <button onclick="switchTab('stores')" class="tab-btn px-4 py-3 font-medium whitespace-nowrap border-b-2 border-transparent hover:border-purple-500 transition text-sm touch-target" data-tab="stores">
                        üè™ Stores
                    </button>
                    <button onclick="switchTab('products')" class="tab-btn px-4 py-3 font-medium whitespace-nowrap border-b-2 border-transparent hover:border-purple-500 transition text-sm touch-target" data-tab="products">
                        üß¥ Products
                    </button>
                    <button onclick="switchTab('collections')" class="tab-btn px-4 py-3 font-medium whitespace-nowrap border-b-2 border-transparent hover:border-purple-500 transition text-sm touch-target" data-tab="collections">
                        üì¶ Collections
                    </button>
                    <button onclick="switchTab('database')" class="tab-btn px-4 py-3 font-medium whitespace-nowrap border-b-2 border-transparent hover:border-purple-500 transition text-sm touch-target" data-tab="database">
                        üóÑÔ∏è Database
                    </button>
                    <button onclick="switchTab('sales')" class="tab-btn px-4 py-3 font-medium whitespace-nowrap border-b-2 border-transparent hover:border-purple-500 transition text-sm touch-target" data-tab="sales">
                        üìä Sales
                    </button>
                    <button onclick="switchTab('salary')" class="tab-btn px-4 py-3 font-medium whitespace-nowrap border-b-2 border-transparent hover:border-purple-500 transition text-sm touch-target" data-tab="salary">
                        üí∞ Salary
                    </button>
                </div>
            </div>
        </div>

        <!-- Tab Content -->
        <div class="mobile-container">
            <!-- Employees Tab -->
            <div id="employees-tab" class="tab-content">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-3">
                    <h2 class="text-xl font-bold">Employee Management</h2>
                    <div class="mobile-action-buttons sm:flex-row sm:space-x-2 sm:space-y-0 w-full sm:w-auto">
                        <button onclick="restoreFromBackup()" class="bg-orange-600 text-white mobile-button hover:bg-orange-700 transition text-sm">
                            üì§ Restore
                        </button>
                        <button onclick="clearAllData()" class="bg-red-600 text-white mobile-button hover:bg-red-700 transition text-sm">
                            üóëÔ∏è Clear All
                        </button>
                        <button onclick="openModal('employee')" class="gradient-bg text-white mobile-button hover:opacity-90 transition">
                            ‚ûï Add Employee
                        </button>
                    </div>
                </div>
                <div class="bg-white mobile-card overflow-hidden">
                    <div class="mobile-table-container">
                        <table class="mobile-table w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="text-left py-3 px-3 text-sm">Name</th>
                                    <th class="text-left py-3 px-3 text-sm hide-mobile">Username</th>
                                    <th class="text-left py-3 px-3 text-sm">Store</th>
                                    <th class="text-left py-3 px-3 text-sm hide-mobile">Salary Type</th>
                                    <th class="text-left py-3 px-3 text-sm">Salary</th>
                                    <th class="text-left py-3 px-3 text-sm">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="employeesTable">
                                <tr>
                                    <td colspan="6" class="text-center py-8 text-gray-500 text-sm">
                                        No employees found. Click "Add Employee" to create your first employee.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Stores Tab -->
            <div id="stores-tab" class="tab-content hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Store Management</h2>
                    <button onclick="openModal('store')" class="gradient-bg text-white px-4 py-2 rounded-lg font-semibold hover:opacity-90 transition">
                        ‚ûï Add Store
                    </button>
                </div>
                <div class="bg-white rounded-xl card-shadow overflow-hidden">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="text-left py-4 px-6">Store Name</th>
                                <th class="text-left py-4 px-6">Location</th>
                                <th class="text-left py-4 px-6">Manager</th>
                                <th class="text-left py-4 px-6">Phone</th>
                                <th class="text-left py-4 px-6">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="storesTable">
                            <tr>
                                <td colspan="5" class="text-center py-8 text-gray-500">
                                    No stores found. Click "Add Store" to create your first store.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Products Tab -->
            <div id="products-tab" class="tab-content hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Product Management</h2>
                    <button onclick="openModal('product')" class="gradient-bg text-white px-4 py-2 rounded-lg font-semibold hover:opacity-90 transition">
                        ‚ûï Add Product
                    </button>
                </div>
                <div class="bg-white rounded-xl card-shadow overflow-hidden">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="text-left py-4 px-6">Product Name</th>
                                <th class="text-left py-4 px-6">Price</th>
                                <th class="text-left py-4 px-6">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="productsTable">
                            <tr>
                                <td colspan="3" class="text-center py-8 text-gray-500">
                                    No products found. Click "Add Product" to create your first product.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Collections Tab -->
            <div id="collections-tab" class="tab-content hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Collection Management</h2>
                    <button onclick="openModal('collection')" class="gradient-bg text-white px-4 py-2 rounded-lg font-semibold hover:opacity-90 transition">
                        ‚ûï Add Collection
                    </button>
                </div>
                <div class="bg-white rounded-xl card-shadow overflow-hidden">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="text-left py-4 px-6">Collection Name</th>
                                <th class="text-left py-4 px-6">Description</th>
                                <th class="text-left py-4 px-6">Products Count</th>
                                <th class="text-left py-4 px-6">Status</th>
                                <th class="text-left py-4 px-6">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="collectionsTable">
                            <tr>
                                <td colspan="5" class="text-center py-8 text-gray-500">
                                    No collections found. Click "Add Collection" to create your first collection.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Database Manager Tab -->
            <div id="database-tab" class="tab-content hidden">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold mb-4">Database Collection Manager</h2>
                    <p class="text-gray-600 mb-6">Directly manage your database collections. Add, edit, or delete data entries in real-time.</p>
                    
                    <!-- Collection Selector -->
                    <div class="bg-white rounded-xl card-shadow p-6 mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Select Collection</label>
                                <select id="dbCollectionSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" onchange="loadDatabaseCollection()">
                                    <option value="">Choose a collection...</option>
                                    <option value="employees">Employees</option>
                                    <option value="stores">Stores</option>
                                    <option value="products">Products</option>
                                    <option value="collections">Collections</option>
                                    <option value="sales">Sales</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Database Status</label>
                                <div class="px-3 py-2 bg-gray-50 rounded-lg">
                                    <span id="dbConnectionStatus" class="text-sm">üì± Local Mode</span>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Actions</label>
                                <div class="flex space-x-2">
                                    <button onclick="addDatabaseEntry()" class="bg-green-600 text-white px-3 py-2 rounded-lg hover:bg-green-700 transition text-sm">
                                        ‚ûï Add Entry
                                    </button>
                                    <button onclick="refreshDatabaseView()" class="bg-blue-600 text-white px-3 py-2 rounded-lg hover:bg-blue-700 transition text-sm">
                                        üîÑ Refresh
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Database Table View -->
                <div class="bg-white rounded-xl card-shadow overflow-hidden">
                    <div class="p-4 bg-gray-50 border-b">
                        <h3 id="dbTableTitle" class="text-lg font-semibold">Select a collection to view data</h3>
                        <p id="dbTableCount" class="text-sm text-gray-600 mt-1">0 entries</p>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-100">
                                <tr id="dbTableHeader">
                                    <th class="text-left py-3 px-4 text-sm font-medium text-gray-700">Select a collection</th>
                                </tr>
                            </thead>
                            <tbody id="dbTableBody">
                                <tr>
                                    <td class="text-center py-8 text-gray-500">Select a collection from the dropdown above</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Sales Reports Tab -->
            <div id="sales-tab" class="tab-content hidden">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold mb-4">Sales Reports</h2>
                    
                    <!-- Report Controls -->
                    <div class="bg-white rounded-xl card-shadow p-6 mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Start Date</label>
                                <input type="date" id="reportStartDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">End Date</label>
                                <input type="date" id="reportEndDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Report Type</label>
                                <select id="reportType" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                    <option value="all">All Sales</option>
                                    <option value="daily">Daily Report</option>
                                    <option value="monthly">Monthly Report</option>
                                    <option value="store">Store Wise</option>
                                    <option value="staff">Staff Wise</option>
                                    <option value="product">Product Wise</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Filter By</label>
                                <select id="reportFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                    <option value="">All</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="flex flex-wrap gap-2">
                            <button onclick="generateSalesReport()" class="gradient-bg text-white px-4 py-2 rounded-lg font-semibold hover:opacity-90 transition">
                                üìä Generate Report
                            </button>
                            <button onclick="printReport('sales')" class="bg-gray-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-gray-700 transition">
                                üñ®Ô∏è Print
                            </button>
                            <button onclick="downloadExcel('sales')" class="bg-green-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-700 transition">
                                üìä Excel
                            </button>
                            <button onclick="downloadPDF('sales')" class="bg-red-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-red-700 transition">
                                üìÑ PDF
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-xl card-shadow overflow-hidden">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr id="salesReportHeader">
                                <th class="text-left py-4 px-6">Date</th>
                                <th class="text-left py-4 px-6">Employee</th>
                                <th class="text-left py-4 px-6">Store</th>
                                <th class="text-left py-4 px-6">Product</th>
                                <th class="text-left py-4 px-6">Quantity</th>
                                <th class="text-left py-4 px-6">Amount</th>
                            </tr>
                        </thead>
                        <tbody id="salesReportTable">
                            <tr>
                                <td colspan="6" class="text-center py-8 text-gray-500">Select date range and report type to generate report</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Salary Reports Tab -->
            <div id="salary-tab" class="tab-content hidden">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold mb-4">Salary Reports</h2>
                    
                    <!-- Salary Report Controls -->
                    <div class="bg-white rounded-xl card-shadow p-6 mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Start Date</label>
                                <input type="date" id="salaryStartDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">End Date</label>
                                <input type="date" id="salaryEndDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Employee</label>
                                <select id="salaryEmployee" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                    <option value="">All Employees</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="flex flex-wrap gap-2">
                            <button onclick="generateSalaryReport()" class="gradient-bg text-white px-4 py-2 rounded-lg font-semibold hover:opacity-90 transition">
                                üí∞ Generate Report
                            </button>
                            <button onclick="printReport('salary')" class="bg-gray-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-gray-700 transition">
                                üñ®Ô∏è Print
                            </button>
                            <button onclick="downloadExcel('salary')" class="bg-green-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-700 transition">
                                üìä Excel
                            </button>
                            <button onclick="downloadPDF('salary')" class="bg-red-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-red-700 transition">
                                üìÑ PDF
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-xl card-shadow overflow-hidden">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="text-left py-4 px-6">Employee</th>
                                <th class="text-left py-4 px-6">Salary Type</th>
                                <th class="text-left py-4 px-6">Base Salary</th>
                                <th class="text-left py-4 px-6">Bonus/Commission</th>
                                <th class="text-left py-4 px-6">Total Sales</th>
                                <th class="text-left py-4 px-6">Days/Qty</th>
                                <th class="text-left py-4 px-6">Total Salary</th>
                            </tr>
                        </thead>
                        <tbody id="salaryReportTable">
                            <tr>
                                <td colspan="7" class="text-center py-8 text-gray-500">Select date range to generate report</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="modal" class="hidden fixed inset-0 modal-backdrop z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl card-shadow mobile-modal w-full fade-in">
            <div class="p-4 border-b">
                <h3 id="modalTitle" class="text-lg font-semibold">Add Item</h3>
            </div>
            <div class="p-4">
                <form id="modalForm">
                    <div id="modalFields" class="space-y-4">
                        <!-- Dynamic fields will be inserted here -->
                    </div>
                    <div class="mobile-action-buttons sm:flex-row sm:space-x-3 sm:space-y-0 mt-6">
                        <button type="button" onclick="closeModal()" class="flex-1 mobile-button border border-gray-300 hover:bg-gray-50 transition bg-white text-gray-700">
                            Cancel
                        </button>
                        <button type="submit" class="flex-1 gradient-bg text-white mobile-button hover:opacity-90 transition">
                            <span id="saveBtnText">Save</span>
                            <div id="saveLoader" class="loading hidden ml-2"></div>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Firebase loading error handler
        function handleFirebaseLoadError(component) {
            console.warn(`Firebase ${component} failed to load - falling back to local mode`);
            window.firebaseLoadError = true;
        }

        // Global Variables
        let db = null;
        let isFirebaseMode = false;
        let currentUser = null;
        let currentUserRole = null;
        let editingItem = null;
        let editingType = null;

        // Local Storage Data (Always used as primary storage)
        let employees = [];
        let stores = [];
        let products = [];
        let collections = [];
        let sales = [];

        // Initialize arrays safely
        function initializeArrays() {
            if (!Array.isArray(employees)) employees = [];
            if (!Array.isArray(stores)) stores = [];
            if (!Array.isArray(products)) products = [];
            if (!Array.isArray(collections)) collections = [];
            if (!Array.isArray(sales)) sales = [];
        }

        // Sync Management
        let syncQueue = [];
        let isSyncing = false;
        let lastSyncTime = null;
        let syncStatus = 'offline';

        // Firebase Configuration
        async function initializeFirebase(config) {
            try {
                console.log('üî• Initializing Firebase with config:', {
                    projectId: config.projectId,
                    authDomain: config.authDomain
                });
                
                // Check if Firebase is available and loaded properly
                if (typeof firebase === 'undefined' || window.firebaseLoadError) {
                    console.warn('Firebase SDK not available, falling back to local mode');
                    throw new Error('Firebase SDK not loaded. Please check your internet connection and try again.');
                }
                
                // Validate config object
                if (!config || typeof config !== 'object') {
                    throw new Error('Invalid Firebase configuration');
                }
                
                // Validate required fields
                const requiredFields = ['apiKey', 'authDomain', 'projectId', 'storageBucket', 'messagingSenderId', 'appId'];
                const missingFields = requiredFields.filter(field => !config[field]);
                if (missingFields.length > 0) {
                    throw new Error(`Missing required fields: ${missingFields.join(', ')}`);
                }
                
                // Check if Firebase is already initialized
                if (firebase.apps.length > 0) {
                    console.log('üîÑ Reinitializing Firebase app...');
                    await firebase.app().delete();
                }
                
                // Initialize Firebase with new config
                console.log('üöÄ Creating Firebase app...');
                const app = firebase.initializeApp(config);
                db = firebase.firestore();
                
                console.log('üîó Testing Firestore connection...');
                
                // Test the connection by trying to access Firestore
                await db.enableNetwork();
                
                // Create a test document to verify write permissions
                try {
                    const testRef = db.collection('_connection_test').doc('test');
                    await testRef.set({
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        test: true
                    });
                    console.log('‚úÖ Firestore write test successful');
                    
                    // Clean up test document
                    await testRef.delete();
                    console.log('üßπ Test document cleaned up');
                } catch (testError) {
                    console.warn('‚ö†Ô∏è Firestore write test failed:', testError.message);
                    // Continue anyway - read-only access might still work
                }
                
                isFirebaseMode = true;
                syncStatus = 'connected';
                updateSyncStatus();
                
                const dbModeEl = document.getElementById('dbMode');
                if (dbModeEl) {
                    dbModeEl.textContent = 'üî• Firebase Connected';
                }
                
                console.log('üéâ Firebase initialization successful!');
                
                // Start background sync
                startBackgroundSync();
                return true;
            } catch (error) {
                console.error('‚ùå Firebase initialization error:', error);
                isFirebaseMode = false;
                db = null;
                syncStatus = 'offline';
                updateSyncStatus();
                
                // Provide more specific error messages
                let errorMessage = 'Failed to connect to Firebase: ';
                if (error.code === 'auth/invalid-api-key') {
                    errorMessage += 'Invalid API key. Please check your Firebase configuration.';
                } else if (error.code === 'auth/project-not-found') {
                    errorMessage += 'Project not found. Please check your Project ID.';
                } else if (error.code === 'permission-denied') {
                    errorMessage += 'Permission denied. Please check your Firestore security rules.';
                } else if (error.message.includes('network') || error.message.includes('fetch')) {
                    errorMessage += 'Network error. Please check your internet connection.';
                } else {
                    errorMessage += error.message;
                }
                
                throw new Error(errorMessage);
            }
        }

        // Firebase Configuration Form
        document.getElementById('firebaseConfigForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const connectBtn = document.getElementById('connectBtnText');
            const loader = document.getElementById('connectLoader');
            
            connectBtn.textContent = 'Connecting...';
            loader.classList.remove('hidden');
            
            const config = {
                apiKey: document.getElementById('apiKey').value.trim(),
                authDomain: document.getElementById('authDomain').value.trim(),
                projectId: document.getElementById('projectId').value.trim(),
                storageBucket: document.getElementById('storageBucket').value.trim(),
                messagingSenderId: document.getElementById('messagingSenderId').value.trim(),
                appId: document.getElementById('appId').value.trim()
            };
            
            // Validate all fields are filled
            const requiredFields = ['apiKey', 'authDomain', 'projectId', 'storageBucket', 'messagingSenderId', 'appId'];
            const missingFields = requiredFields.filter(field => !config[field]);
            
            if (missingFields.length > 0) {
                alert('Please fill in all required fields: ' + missingFields.join(', '));
                connectBtn.textContent = 'Connect to Firebase';
                loader.classList.add('hidden');
                return;
            }
            
            try {
                // Save config to localStorage for future use
                localStorage.setItem('firebaseConfig', JSON.stringify(config));
                
                if (await initializeFirebase(config)) {
                    document.getElementById('firebaseConfigModal').classList.add('hidden');
                    document.getElementById('loginScreen').classList.remove('hidden');
                    await loadAllData();
                    alert('Successfully connected to Firebase!');
                } else {
                    throw new Error('Firebase initialization failed');
                }
            } catch (error) {
                console.error('Firebase connection error:', error);
                alert('Failed to connect to Firebase: ' + error.message + '\n\nPlease check your configuration and try again.');
            }
            
            connectBtn.textContent = 'Connect to Firebase';
            loader.classList.add('hidden');
        });

        // Demo Mode
        function loadDemoConfig() {
            isFirebaseMode = false;
            syncStatus = 'offline';
            updateSyncStatus();
            document.getElementById('dbMode').textContent = 'üíæ Local Storage Mode';
            document.getElementById('firebaseConfigModal').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            loadLocalData();
        }

        // Enhanced Sync Status Management
        function updateSyncStatus() {
            const statusElements = ['syncStatus', 'employeeSyncStatus', 'adminSyncStatus'];
            let statusText = '';
            let statusColor = '';
            
            switch(syncStatus) {
                case 'connected':
                    statusText = 'üîÑ Syncing...';
                    statusColor = 'text-blue-600';
                    break;
                case 'synced':
                    statusText = '‚úÖ Real-time Sync';
                    statusColor = 'text-green-600';
                    break;
                case 'pending':
                    statusText = '‚è≥ Pending sync';
                    statusColor = 'text-yellow-600';
                    break;
                case 'error':
                    statusText = '‚ùå Sync error';
                    statusColor = 'text-red-600';
                    break;
                default: // offline
                    statusText = 'üì± Local Mode';
                    statusColor = 'text-gray-600';
            }
            
            statusElements.forEach(elementId => {
                const element = document.getElementById(elementId);
                if (element) {
                    element.textContent = statusText;
                    element.className = `text-xs opacity-70 ${statusColor}`;
                }
            });
            
            // Update last sync time if available and show real-time indicator
            if (lastSyncTime && syncStatus === 'synced' && isFirebaseMode) {
                const timeStr = new Date(lastSyncTime).toLocaleTimeString();
                statusElements.forEach(elementId => {
                    const element = document.getElementById(elementId);
                    if (element) {
                        element.innerHTML = `<span class="text-green-600">üîÑ Live</span> <span class="text-xs">${timeStr}</span>`;
                    }
                });
            }
        }
        
        // Show immediate sync feedback
        function showSyncFeedback(type, action) {
            const statusElements = ['syncStatus', 'employeeSyncStatus', 'adminSyncStatus'];
            const feedbackText = `‚ö° ${action} ${type}...`;
            
            statusElements.forEach(elementId => {
                const element = document.getElementById(elementId);
                if (element) {
                    const originalContent = element.innerHTML;
                    element.innerHTML = `<span class="text-blue-600">${feedbackText}</span>`;
                    
                    // Restore original status after 2 seconds
                    setTimeout(() => {
                        if (element.innerHTML.includes(feedbackText)) {
                            element.innerHTML = originalContent;
                        }
                    }, 2000);
                }
            });
        }

        // Queue item for sync
        function queueForSync(action, type, data) {
            const syncItem = {
                id: Date.now() + Math.random(),
                action: action, // 'create', 'update', 'delete'
                type: type, // 'employee', 'store', 'product', 'sale'
                data: data,
                timestamp: new Date().toISOString(),
                attempts: 0
            };
            
            console.log('Queuing item for sync:', syncItem);
            
            syncQueue.push(syncItem);
            localStorage.setItem('eden_sync_queue', JSON.stringify(syncQueue));
            
            console.log('Current sync queue length:', syncQueue.length);
            console.log('Firebase mode:', isFirebaseMode);
            
            if (isFirebaseMode) {
                syncStatus = 'pending';
                updateSyncStatus();
                console.log('Triggering sync in 1 second...');
                // Trigger sync after short delay
                setTimeout(processSyncQueue, 1000);
            } else {
                console.log('Firebase mode disabled, item will remain in queue');
            }
        }

        // Process sync queue
        async function processSyncQueue() {
            if (!isFirebaseMode || isSyncing || syncQueue.length === 0) {
                console.log('Sync skipped:', { isFirebaseMode, isSyncing, queueLength: syncQueue.length });
                return;
            }
            
            console.log('üîÑ Starting sync process with', syncQueue.length, 'items');
            console.log('Firebase connection status:', db ? 'Connected' : 'Not connected');
            
            isSyncing = true;
            syncStatus = 'connected';
            updateSyncStatus();
            
            const itemsToProcess = [...syncQueue];
            const processedItems = [];
            let successCount = 0;
            let errorCount = 0;
            
            for (const item of itemsToProcess) {
                try {
                    console.log('üì§ Processing sync item:', {
                        type: item.type,
                        action: item.action,
                        id: item.data?.id,
                        attempts: item.attempts || 0
                    });
                    
                    await processSyncItem(item);
                    processedItems.push(item);
                    successCount++;
                    
                    console.log('‚úÖ Successfully synced:', item.type, item.action);
                } catch (error) {
                    console.error('‚ùå Sync error for item:', {
                        type: item.type,
                        action: item.action,
                        error: error.message,
                        attempts: item.attempts || 0
                    });
                    
                    item.attempts = (item.attempts || 0) + 1;
                    errorCount++;
                    
                    // Remove item if too many attempts
                    if (item.attempts >= 3) {
                        processedItems.push(item);
                        console.error('üóëÔ∏è Removing item after 3 failed attempts:', item.type, item.action);
                    }
                }
            }
            
            // Remove processed items from queue
            syncQueue = syncQueue.filter(item => !processedItems.includes(item));
            localStorage.setItem('eden_sync_queue', JSON.stringify(syncQueue));
            
            console.log('üèÅ Sync completed:', {
                processed: processedItems.length,
                successful: successCount,
                errors: errorCount,
                remaining: syncQueue.length
            });
            
            isSyncing = false;
            syncStatus = syncQueue.length > 0 ? 'pending' : 'synced';
            lastSyncTime = new Date().toISOString();
            updateSyncStatus();
        }

        // Process individual sync item
        async function processSyncItem(item) {
            const { action, type, data } = item;
            
            try {
                switch (action) {
                    case 'create':
                        console.log(`Creating ${type} in Firebase:`, data);
                        
                        // Create document in Firebase with the data
                        const docRef = await db.collection(type + 's').add({
                            ...data,
                            localId: data.id,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        
                        console.log(`${type} created in Firebase with ID:`, docRef.id);
                        
                        // Update local data with Firebase ID
                        const collection = getCollectionByType(type);
                        const localItem = collection.find(item => item.id === data.id);
                        if (localItem) {
                            localItem.firebaseId = docRef.id;
                            saveLocalData();
                        }
                        break;
                        
                    case 'update':
                        console.log(`Updating ${type} in Firebase:`, data);
                        
                        const firebaseId = data.firebaseId;
                        if (firebaseId) {
                            await db.collection(type + 's').doc(firebaseId).update({
                                ...data,
                                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            console.log(`${type} updated in Firebase`);
                        } else {
                            // If no Firebase ID, treat as create
                            console.log(`No Firebase ID found for ${type}, creating new document`);
                            const docRef = await db.collection(type + 's').add({
                                ...data,
                                localId: data.id,
                                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            
                            // Update local data with Firebase ID
                            const collection = getCollectionByType(type);
                            const localItem = collection.find(item => item.id === data.id);
                            if (localItem) {
                                localItem.firebaseId = docRef.id;
                                saveLocalData();
                            }
                        }
                        break;
                        
                    case 'delete':
                        console.log(`Deleting ${type} from Firebase:`, data);
                        
                        const deleteId = data.firebaseId;
                        if (deleteId) {
                            await db.collection(type + 's').doc(deleteId).delete();
                            console.log(`${type} deleted from Firebase`);
                        } else {
                            console.warn(`No Firebase ID found for ${type} deletion:`, data);
                        }
                        break;
                }
            } catch (error) {
                console.error(`Error processing ${action} for ${type}:`, error);
                throw error;
            }
        }

        // Get collection by type
        function getCollectionByType(type) {
            switch (type) {
                case 'employee': return employees;
                case 'store': return stores;
                case 'product': return products;
                case 'sale': return sales;
                default: return [];
            }
        }

        // Background sync with real-time listeners
        function startBackgroundSync() {
            // Load sync queue from localStorage
            const savedQueue = localStorage.getItem('eden_sync_queue');
            if (savedQueue) {
                syncQueue = JSON.parse(savedQueue);
            }
            
            // Process queue immediately
            processSyncQueue();
            
            // Set up periodic sync
            setInterval(() => {
                if (isFirebaseMode && !isSyncing) {
                    processSyncQueue();
                }
            }, 30000); // Sync every 30 seconds
            
            // Set up real-time listeners for Firebase data changes
            if (isFirebaseMode) {
                setupRealtimeListeners();
            }
        }
        
        // Real-time Firebase listeners
        function setupRealtimeListeners() {
            if (!db) return;
            
            try {
                // Listen for employees changes
                db.collection('employees').onSnapshot((snapshot) => {
                    console.log('Employees collection changed');
                    syncFromFirebase('employees', snapshot);
                }, (error) => {
                    console.error('Error listening to employees:', error);
                });
                
                // Listen for stores changes
                db.collection('stores').onSnapshot((snapshot) => {
                    console.log('Stores collection changed');
                    syncFromFirebase('stores', snapshot);
                }, (error) => {
                    console.error('Error listening to stores:', error);
                });
                
                // Listen for products changes
                db.collection('products').onSnapshot((snapshot) => {
                    console.log('Products collection changed');
                    syncFromFirebase('products', snapshot);
                }, (error) => {
                    console.error('Error listening to products:', error);
                });
                
                // Listen for collections changes
                db.collection('collections').onSnapshot((snapshot) => {
                    console.log('Collections collection changed');
                    syncFromFirebase('collections', snapshot);
                }, (error) => {
                    console.error('Error listening to collections:', error);
                });
                
                // Listen for sales changes
                db.collection('sales').onSnapshot((snapshot) => {
                    console.log('Sales collection changed');
                    syncFromFirebase('sales', snapshot);
                }, (error) => {
                    console.error('Error listening to sales:', error);
                });
                
                console.log('Real-time listeners set up successfully');
            } catch (error) {
                console.error('Error setting up real-time listeners:', error);
            }
        }
        
        // Sync data from Firebase to local storage
        function syncFromFirebase(collectionName, snapshot) {
            try {
                const firebaseData = [];
                
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    // Use localId if available, otherwise use Firebase doc ID
                    const localId = data.localId || doc.id;
                    
                    firebaseData.push({
                        ...data,
                        id: localId,
                        firebaseId: doc.id,
                        // Convert Firestore timestamps to ISO strings
                        createdAt: data.createdAt ? data.createdAt.toDate().toISOString() : new Date().toISOString(),
                        updatedAt: data.updatedAt ? data.updatedAt.toDate().toISOString() : new Date().toISOString()
                    });
                });
                
                // Update local data based on collection type
                switch(collectionName) {
                    case 'employees':
                        employees = mergeWithLocal(employees, firebaseData);
                        break;
                    case 'stores':
                        stores = mergeWithLocal(stores, firebaseData);
                        break;
                    case 'products':
                        products = mergeWithLocal(products, firebaseData);
                        break;
                    case 'collections':
                        collections = mergeWithLocal(collections, firebaseData);
                        break;
                    case 'sales':
                        sales = mergeWithLocal(sales, firebaseData);
                        break;
                }
                
                // Save updated data to localStorage
                saveLocalData();
                
                // Update UI if currently viewing the affected data
                updateUIAfterSync(collectionName);
                
                // Update sync status
                syncStatus = 'synced';
                lastSyncTime = new Date().toISOString();
                updateSyncStatus();
                
                console.log(`Synced ${firebaseData.length} items from ${collectionName}`);
                
            } catch (error) {
                console.error(`Error syncing ${collectionName} from Firebase:`, error);
                syncStatus = 'error';
                updateSyncStatus();
            }
        }
        
        // Merge Firebase data with local data, preserving local changes
        function mergeWithLocal(localArray, firebaseArray) {
            const merged = [...localArray];
            
            firebaseArray.forEach(firebaseItem => {
                const localIndex = merged.findIndex(localItem => 
                    localItem.id === firebaseItem.id || 
                    localItem.firebaseId === firebaseItem.firebaseId
                );
                
                if (localIndex >= 0) {
                    // Update existing item, but preserve local changes if they're newer
                    const localItem = merged[localIndex];
                    const localUpdated = new Date(localItem.updatedAt || localItem.createdAt || 0);
                    const firebaseUpdated = new Date(firebaseItem.updatedAt || firebaseItem.createdAt || 0);
                    
                    // Only update if Firebase version is newer
                    if (firebaseUpdated > localUpdated) {
                        merged[localIndex] = { ...localItem, ...firebaseItem };
                    } else {
                        // Keep local version but update Firebase ID if missing
                        if (!localItem.firebaseId && firebaseItem.firebaseId) {
                            merged[localIndex].firebaseId = firebaseItem.firebaseId;
                        }
                    }
                } else {
                    // Add new item from Firebase
                    merged.push(firebaseItem);
                }
            });
            
            return merged;
        }
        
        // Update UI after sync based on current view
        function updateUIAfterSync(collectionName) {
            try {
                // Update tables if currently viewing admin dashboard
                if (currentUserRole === 'admin' && !document.getElementById('dashboard').classList.contains('hidden')) {
                    switch(collectionName) {
                        case 'employees':
                            if (!document.getElementById('employees-tab').classList.contains('hidden')) {
                                loadEmployeesTable();
                            }
                            break;
                        case 'stores':
                            if (!document.getElementById('stores-tab').classList.contains('hidden')) {
                                loadStoresTable();
                            }
                            break;
                        case 'products':
                            if (!document.getElementById('products-tab').classList.contains('hidden')) {
                                loadProductsTable();
                            }
                            break;
                        case 'collections':
                            if (!document.getElementById('collections-tab').classList.contains('hidden')) {
                                loadCollectionsTable();
                            }
                            break;
                        case 'sales':
                            // Refresh sales report if currently viewing
                            if (!document.getElementById('sales-tab').classList.contains('hidden')) {
                                // Auto-refresh current report if one is displayed
                                const reportTable = document.getElementById('salesReportTable');
                                if (reportTable && reportTable.children.length > 0 && 
                                    !reportTable.innerHTML.includes('Select date range')) {
                                    generateSalesReport();
                                }
                            }
                            break;
                    }
                }
                
                // Update employee portal if currently viewing
                if (currentUserRole === 'employee' && !document.getElementById('employeePortal').classList.contains('hidden')) {
                    if (collectionName === 'sales') {
                        updateEmployeeStats();
                        updateTodaysSalesTable();
                    } else if (collectionName === 'products' || collectionName === 'stores') {
                        populateProductDropdown();
                        populateStoreDropdown();
                    }
                }
                
                // Update dropdowns in forms
                if (collectionName === 'stores') {
                    populateStoreDropdown();
                }
                if (collectionName === 'products') {
                    populateProductDropdown();
                }
                if (collectionName === 'employees') {
                    populateEmployeeDropdown();
                }
                
            } catch (error) {
                console.error('Error updating UI after sync:', error);
            }
        }
        
        // Enhanced sync status with real-time indicator
        function updateSyncStatusWithRealtime() {
            updateSyncStatus();
            
            // Add real-time indicator if Firebase is connected
            if (isFirebaseMode && syncStatus === 'synced') {
                const statusElements = ['syncStatus', 'employeeSyncStatus', 'adminSyncStatus'];
                statusElements.forEach(elementId => {
                    const element = document.getElementById(elementId);
                    if (element) {
                        element.innerHTML = 'üîÑ <span style="color: #10b981;">Real-time Sync</span>';
                    }
                });
            }
        }

        // Force sync now
        async function forceSyncNow() {
            if (!isFirebaseMode) {
                alert('Firebase is not connected. Click "üî• Setup Firebase" to configure your database connection.');
                return;
            }
            
            syncStatus = 'connected';
            updateSyncStatus();
            
            try {
                await processSyncQueue();
                alert('Sync completed successfully!');
            } catch (error) {
                syncStatus = 'error';
                updateSyncStatus();
                alert('Sync failed: ' + error.message);
            }
        }

        // Reset Firebase Configuration
        function resetFirebaseConfig() {
            if (confirm('This will reset your Firebase configuration. You will need to re-enter your credentials. Continue?')) {
                // Clear saved config
                localStorage.removeItem('firebaseConfig');
                
                // Reset Firebase state
                isFirebaseMode = false;
                db = null;
                syncStatus = 'offline';
                updateSyncStatus();
                
                // Show configuration modal
                document.getElementById('firebaseConfigModal').classList.remove('hidden');
                
                // Clear form fields
                document.getElementById('apiKey').value = '';
                document.getElementById('authDomain').value = '';
                document.getElementById('projectId').value = '';
                document.getElementById('storageBucket').value = '';
                document.getElementById('messagingSenderId').value = '';
                document.getElementById('appId').value = '';
            }
        }

        // Data Loading Functions
        async function loadAllData() {
            // Always load from local storage first
            loadLocalData();
            
            // If Firebase is connected, sync in background
            if (isFirebaseMode) {
                setTimeout(processSyncQueue, 1000);
            }
        }

        function loadLocalData() {
            try {
                employees = JSON.parse(localStorage.getItem('eden_employees') || '[]');
                stores = JSON.parse(localStorage.getItem('eden_stores') || '[]');
                products = JSON.parse(localStorage.getItem('eden_products') || '[]');
                collections = JSON.parse(localStorage.getItem('eden_collections') || '[]');
                sales = JSON.parse(localStorage.getItem('eden_sales') || '[]');
                
                // Ensure arrays are valid
                initializeArrays();
                
                console.log('Local data loaded:', {
                    employees: employees.length,
                    stores: stores.length,
                    products: products.length,
                    collections: collections.length,
                    sales: sales.length
                });
            } catch (error) {
                console.error('Error loading local data:', error);
                // Reset to empty arrays if parsing fails
                employees = [];
                stores = [];
                products = [];
                collections = [];
                sales = [];
            }
        }

        function saveLocalData() {
            try {
                localStorage.setItem('eden_employees', JSON.stringify(employees));
                localStorage.setItem('eden_stores', JSON.stringify(stores));
                localStorage.setItem('eden_products', JSON.stringify(products));
                localStorage.setItem('eden_collections', JSON.stringify(collections));
                localStorage.setItem('eden_sales', JSON.stringify(sales));
                
                console.log('Local data saved:', {
                    employees: employees.length,
                    stores: stores.length,
                    products: products.length,
                    collections: collections.length,
                    sales: sales.length
                });
            } catch (error) {
                console.error('Error saving local data:', error);
            }
        }

        // Modal Form Submission
        document.getElementById('modalForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const saveBtnText = document.getElementById('saveBtnText');
            const saveLoader = document.getElementById('saveLoader');
            const originalText = saveBtnText.textContent;
            
            saveBtnText.textContent = 'Saving...';
            saveLoader.classList.remove('hidden');
            
            try {
                let itemData = {};
                
                switch(editingType) {
                    case 'employee':
                        itemData = {
                            name: document.getElementById('modalName').value.trim(),
                            username: document.getElementById('modalUsername').value.trim(),
                            storeId: document.getElementById('modalStoreId').value,
                            salaryType: document.getElementById('modalSalaryType').value,
                            baseSalary: parseFloat(document.getElementById('modalBaseSalary').value) || 0,
                            commissionRate: document.getElementById('modalCommissionRate') ? parseFloat(document.getElementById('modalCommissionRate').value) || 0.1 : 0.1
                        };
                        
                        // Handle password
                        const password = document.getElementById('modalPassword').value;
                        if (password || !editingItem) {
                            itemData.password = password;
                        }
                        
                        // If editing, preserve existing ID
                        if (editingItem) {
                            itemData.id = editingItem.id;
                            if (!password) {
                                itemData.password = editingItem.password; // Keep existing password
                            }
                        }
                        
                        await saveEmployee(itemData);
                        await loadEmployeesTable();
                        break;
                        
                    case 'store':
                        itemData = {
                            name: document.getElementById('modalName').value.trim(),
                            location: document.getElementById('modalLocation').value.trim(),
                            manager: document.getElementById('modalManager').value.trim(),
                            phone: document.getElementById('modalPhone').value.trim()
                        };
                        
                        if (editingItem) {
                            itemData.id = editingItem.id;
                        }
                        
                        await saveStore(itemData);
                        await loadStoresTable();
                        break;
                        
                    case 'product':
                        itemData = {
                            name: document.getElementById('modalName').value.trim(),
                            price: parseFloat(document.getElementById('modalPrice').value) || 0,
                            description: document.getElementById('modalDescription').value.trim()
                        };
                        
                        if (editingItem) {
                            itemData.id = editingItem.id;
                        }
                        
                        await saveProduct(itemData);
                        await loadProductsTable();
                        break;
                        
                    case 'collection':
                        // Get selected product IDs
                        const selectedProducts = Array.from(document.querySelectorAll('.product-checkbox:checked')).map(cb => cb.value);
                        
                        itemData = {
                            name: document.getElementById('modalName').value.trim(),
                            description: document.getElementById('modalDescription').value.trim(),
                            status: document.getElementById('modalStatus').value,
                            productIds: selectedProducts
                        };
                        
                        if (editingItem) {
                            itemData.id = editingItem.id;
                        }
                        
                        await saveCollection(itemData);
                        await loadCollectionsTable();
                        break;
                }
                
                closeModal();
                
                // Safe string handling for alert message
                const itemTypeName = editingType ? editingType.charAt(0).toUpperCase() + editingType.slice(1) : 'Item';
                const actionText = editingItem ? 'updated' : 'created';
                alert(`${itemTypeName} ${actionText} successfully!`);
                
                // Update dropdowns if needed
                if (editingType === 'store' || editingType === 'product') {
                    populateStoreDropdown();
                    populateProductDropdown();
                }
                
            } catch (error) {
                console.error('Error saving item:', error);
                alert('Error saving item: ' + error.message);
            }
            
            saveBtnText.textContent = originalText;
            saveLoader.classList.add('hidden');
        });

        // Firebase configuration will be provided by user through the setup modal

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async function() {
            // Always show Firebase config modal first - no default config
            console.log('Starting application - checking for saved Firebase configuration...');
            
            // Check for saved custom config
            const savedConfig = localStorage.getItem('firebaseConfig');
            if (savedConfig) {
                try {
                    const config = JSON.parse(savedConfig);
                    console.log('Attempting to connect with saved Firebase configuration...');
                    
                    if (await initializeFirebase(config)) {
                        document.getElementById('firebaseConfigModal').classList.add('hidden');
                        document.getElementById('loginScreen').classList.remove('hidden');
                        await loadAllData();
                        return;
                    }
                } catch (error) {
                    console.error('Error loading saved Firebase config:', error);
                    localStorage.removeItem('firebaseConfig');
                }
            }
            
            // Show Firebase configuration modal
            console.log('No valid Firebase configuration found - showing setup modal');
            document.getElementById('firebaseConfigModal').classList.remove('hidden');
        });

        // Placeholder functions for missing functionality
        function refreshData() {
            loadAllData();
            if (currentUserRole === 'employee') {
                updateEmployeeStats();
                updateTodaysSalesTable();
            }
        }

        function quickAddSale() {
            alert('Quick Add Sale feature coming soon!');
        }

        function viewTodaysSummary() {
            try {
                const today = getTodayString();
                const todaysSales = sales.filter(sale => sale && sale.date === today);
                
                if (todaysSales.length === 0) {
                    alert('No sales recorded today.');
                    return;
                }
                
                // Calculate summary statistics
                const totalRevenue = todaysSales.reduce((sum, sale) => sum + (sale.amount || 0), 0);
                const totalQuantity = todaysSales.reduce((sum, sale) => sum + (sale.quantity || 0), 0);
                const totalTransactions = todaysSales.length;
                const averageTransaction = totalRevenue / totalTransactions;
                
                // Store-wise breakdown
                const storeBreakdown = {};
                todaysSales.forEach(sale => {
                    const storeId = sale.storeId;
                    const storeName = getStoreName(storeId);
                    
                    if (!storeBreakdown[storeId]) {
                        storeBreakdown[storeId] = {
                            name: storeName,
                            revenue: 0,
                            quantity: 0,
                            transactions: 0
                        };
                    }
                    
                    storeBreakdown[storeId].revenue += sale.amount || 0;
                    storeBreakdown[storeId].quantity += sale.quantity || 0;
                    storeBreakdown[storeId].transactions += 1;
                });
                
                // Employee-wise breakdown
                const employeeBreakdown = {};
                todaysSales.forEach(sale => {
                    const employeeId = sale.employeeId;
                    const employeeName = getEmployeeName(employeeId);
                    
                    if (!employeeBreakdown[employeeId]) {
                        employeeBreakdown[employeeId] = {
                            name: employeeName,
                            revenue: 0,
                            quantity: 0,
                            transactions: 0
                        };
                    }
                    
                    employeeBreakdown[employeeId].revenue += sale.amount || 0;
                    employeeBreakdown[employeeId].quantity += sale.quantity || 0;
                    employeeBreakdown[employeeId].transactions += 1;
                });
                
                // Product-wise breakdown
                const productBreakdown = {};
                todaysSales.forEach(sale => {
                    const productId = sale.productId;
                    const productName = getProductName(productId);
                    
                    if (!productBreakdown[productId]) {
                        productBreakdown[productId] = {
                            name: productName,
                            quantity: 0,
                            revenue: 0,
                            transactions: 0
                        };
                    }
                    
                    productBreakdown[productId].quantity += sale.quantity || 0;
                    productBreakdown[productId].revenue += sale.amount || 0;
                    productBreakdown[productId].transactions += 1;
                });
                
                // Create summary modal
                showTodaysSummaryModal({
                    date: new Date(today).toLocaleDateString('en-US', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    }),
                    totalRevenue,
                    totalQuantity,
                    totalTransactions,
                    averageTransaction,
                    storeBreakdown: Object.values(storeBreakdown),
                    employeeBreakdown: Object.values(employeeBreakdown),
                    productBreakdown: Object.values(productBreakdown)
                });
                
            } catch (error) {
                console.error('Error generating today\'s summary:', error);
                alert('Error generating summary: ' + error.message);
            }
        }
        
        function showTodaysSummaryModal(summaryData) {
            // Create modal HTML
            const modalHTML = `
                <div id="summaryModal" class="fixed inset-0 modal-backdrop z-50 flex items-center justify-center p-4">
                    <div class="bg-white rounded-xl card-shadow w-full max-w-4xl max-h-screen overflow-y-auto fade-in">
                        <div class="p-6 border-b bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-t-xl">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h3 class="text-2xl font-bold">üìä Today's Sales Summary</h3>
                                    <p class="text-purple-100 mt-1">${summaryData.date}</p>
                                </div>
                                <button onclick="closeSummaryModal()" class="text-white hover:text-gray-200 text-2xl">‚úï</button>
                            </div>
                        </div>
                        
                        <div class="p-6">
                            <!-- Overall Stats -->
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                                <div class="bg-green-50 p-4 rounded-lg text-center">
                                    <div class="text-2xl font-bold text-green-600">$${summaryData.totalRevenue.toFixed(2)}</div>
                                    <div class="text-sm text-green-800">Total Revenue</div>
                                </div>
                                <div class="bg-blue-50 p-4 rounded-lg text-center">
                                    <div class="text-2xl font-bold text-blue-600">${summaryData.totalQuantity}</div>
                                    <div class="text-sm text-blue-800">Items Sold</div>
                                </div>
                                <div class="bg-purple-50 p-4 rounded-lg text-center">
                                    <div class="text-2xl font-bold text-purple-600">${summaryData.totalTransactions}</div>
                                    <div class="text-sm text-purple-800">Transactions</div>
                                </div>
                                <div class="bg-orange-50 p-4 rounded-lg text-center">
                                    <div class="text-2xl font-bold text-orange-600">$${summaryData.averageTransaction.toFixed(2)}</div>
                                    <div class="text-sm text-orange-800">Avg Transaction</div>
                                </div>
                            </div>
                            
                            <!-- Store Breakdown -->
                            <div class="mb-8">
                                <h4 class="text-lg font-semibold mb-4">üè™ Store Performance</h4>
                                <div class="bg-gray-50 rounded-lg overflow-hidden">
                                    <table class="w-full">
                                        <thead class="bg-gray-100">
                                            <tr>
                                                <th class="text-left py-3 px-4 font-medium">Store</th>
                                                <th class="text-left py-3 px-4 font-medium">Revenue</th>
                                                <th class="text-left py-3 px-4 font-medium">Items</th>
                                                <th class="text-left py-3 px-4 font-medium">Transactions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${summaryData.storeBreakdown.map(store => `
                                                <tr class="border-t">
                                                    <td class="py-3 px-4">${store.name}</td>
                                                    <td class="py-3 px-4 font-semibold text-green-600">$${store.revenue.toFixed(2)}</td>
                                                    <td class="py-3 px-4">${store.quantity}</td>
                                                    <td class="py-3 px-4">${store.transactions}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <!-- Employee Breakdown -->
                            <div class="mb-8">
                                <h4 class="text-lg font-semibold mb-4">üë• Employee Performance</h4>
                                <div class="bg-gray-50 rounded-lg overflow-hidden">
                                    <table class="w-full">
                                        <thead class="bg-gray-100">
                                            <tr>
                                                <th class="text-left py-3 px-4 font-medium">Employee</th>
                                                <th class="text-left py-3 px-4 font-medium">Revenue</th>
                                                <th class="text-left py-3 px-4 font-medium">Items</th>
                                                <th class="text-left py-3 px-4 font-medium">Transactions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${summaryData.employeeBreakdown.sort((a, b) => b.revenue - a.revenue).map(emp => `
                                                <tr class="border-t">
                                                    <td class="py-3 px-4">${emp.name}</td>
                                                    <td class="py-3 px-4 font-semibold text-green-600">$${emp.revenue.toFixed(2)}</td>
                                                    <td class="py-3 px-4">${emp.quantity}</td>
                                                    <td class="py-3 px-4">${emp.transactions}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <!-- Product Breakdown -->
                            <div class="mb-6">
                                <h4 class="text-lg font-semibold mb-4">üß¥ Top Products</h4>
                                <div class="bg-gray-50 rounded-lg overflow-hidden">
                                    <table class="w-full">
                                        <thead class="bg-gray-100">
                                            <tr>
                                                <th class="text-left py-3 px-4 font-medium">Product</th>
                                                <th class="text-left py-3 px-4 font-medium">Quantity Sold</th>
                                                <th class="text-left py-3 px-4 font-medium">Revenue</th>
                                                <th class="text-left py-3 px-4 font-medium">Transactions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${summaryData.productBreakdown.sort((a, b) => b.quantity - a.quantity).map(product => `
                                                <tr class="border-t">
                                                    <td class="py-3 px-4">${product.name}</td>
                                                    <td class="py-3 px-4 font-semibold text-blue-600">${product.quantity}</td>
                                                    <td class="py-3 px-4 font-semibold text-green-600">$${product.revenue.toFixed(2)}</td>
                                                    <td class="py-3 px-4">${product.transactions}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <!-- Action Buttons -->
                            <div class="flex flex-wrap gap-3 justify-center">
                                <button onclick="printSummary()" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition">
                                    üñ®Ô∏è Print Summary
                                </button>
                                <button onclick="downloadSummaryCSV()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition">
                                    üìä Download CSV
                                </button>
                                <button onclick="closeSummaryModal()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition">
                                    ‚úÖ Close
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Store summary data for export functions
            window.currentSummaryData = summaryData;
        }
        
        function closeSummaryModal() {
            const modal = document.getElementById('summaryModal');
            if (modal) {
                modal.remove();
            }
        }
        
        function printSummary() {
            try {
                const summaryData = window.currentSummaryData;
                if (!summaryData) {
                    alert('No summary data available');
                    return;
                }
                
                const printWindow = window.open('', '_blank');
                const printContent = generateSummaryPrintContent(summaryData);
                
                printWindow.document.write(printContent);
                printWindow.document.close();
                printWindow.focus();
                printWindow.print();
                printWindow.close();
            } catch (error) {
                console.error('Print summary error:', error);
                alert('Error printing summary: ' + error.message);
            }
        }
        
        function downloadSummaryCSV() {
            try {
                const summaryData = window.currentSummaryData;
                if (!summaryData) {
                    alert('No summary data available');
                    return;
                }
                
                let csvContent = `Eden Perfume - Daily Sales Summary\n`;
                csvContent += `Date: ${summaryData.date}\n\n`;
                
                csvContent += `OVERALL SUMMARY\n`;
                csvContent += `Total Revenue,$${summaryData.totalRevenue.toFixed(2)}\n`;
                csvContent += `Total Items Sold,${summaryData.totalQuantity}\n`;
                csvContent += `Total Transactions,${summaryData.totalTransactions}\n`;
                csvContent += `Average Transaction,$${summaryData.averageTransaction.toFixed(2)}\n\n`;
                
                csvContent += `STORE PERFORMANCE\n`;
                csvContent += `Store,Revenue,Items,Transactions\n`;
                summaryData.storeBreakdown.forEach(store => {
                    csvContent += `"${store.name}",$${store.revenue.toFixed(2)},${store.quantity},${store.transactions}\n`;
                });
                
                csvContent += `\nEMPLOYEE PERFORMANCE\n`;
                csvContent += `Employee,Revenue,Items,Transactions\n`;
                summaryData.employeeBreakdown.sort((a, b) => b.revenue - a.revenue).forEach(emp => {
                    csvContent += `"${emp.name}",$${emp.revenue.toFixed(2)},${emp.quantity},${emp.transactions}\n`;
                });
                
                csvContent += `\nPRODUCT PERFORMANCE\n`;
                csvContent += `Product,Quantity Sold,Revenue,Transactions\n`;
                summaryData.productBreakdown.sort((a, b) => b.quantity - a.quantity).forEach(product => {
                    csvContent += `"${product.name}",${product.quantity},$${product.revenue.toFixed(2)},${product.transactions}\n`;
                });
                
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                link.setAttribute('href', url);
                link.setAttribute('download', `daily_summary_${getTodayString()}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
            } catch (error) {
                console.error('Download summary CSV error:', error);
                alert('Error downloading CSV: ' + error.message);
            }
        }
        
        function generateSummaryPrintContent(summaryData) {
            return `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Daily Sales Summary</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .header { text-align: center; margin-bottom: 30px; }
                        .header h1 { color: #333; margin-bottom: 5px; }
                        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
                        .stat-card { background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center; }
                        .stat-value { font-size: 24px; font-weight: bold; color: #333; }
                        .stat-label { font-size: 12px; color: #666; margin-top: 5px; }
                        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; font-weight: bold; }
                        .section-title { font-size: 18px; font-weight: bold; margin: 30px 0 10px 0; color: #333; }
                        @media print { body { margin: 0; } }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>Eden Perfume - Daily Sales Summary</h1>
                        <p>${summaryData.date}</p>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">$${summaryData.totalRevenue.toFixed(2)}</div>
                            <div class="stat-label">Total Revenue</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${summaryData.totalQuantity}</div>
                            <div class="stat-label">Items Sold</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${summaryData.totalTransactions}</div>
                            <div class="stat-label">Transactions</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">$${summaryData.averageTransaction.toFixed(2)}</div>
                            <div class="stat-label">Avg Transaction</div>
                        </div>
                    </div>
                    
                    <div class="section-title">Store Performance</div>
                    <table>
                        <thead>
                            <tr><th>Store</th><th>Revenue</th><th>Items</th><th>Transactions</th></tr>
                        </thead>
                        <tbody>
                            ${summaryData.storeBreakdown.map(store => `
                                <tr>
                                    <td>${store.name}</td>
                                    <td>$${store.revenue.toFixed(2)}</td>
                                    <td>${store.quantity}</td>
                                    <td>${store.transactions}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    <div class="section-title">Employee Performance</div>
                    <table>
                        <thead>
                            <tr><th>Employee</th><th>Revenue</th><th>Items</th><th>Transactions</th></tr>
                        </thead>
                        <tbody>
                            ${summaryData.employeeBreakdown.sort((a, b) => b.revenue - a.revenue).map(emp => `
                                <tr>
                                    <td>${emp.name}</td>
                                    <td>$${emp.revenue.toFixed(2)}</td>
                                    <td>${emp.quantity}</td>
                                    <td>${emp.transactions}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    <div class="section-title">Product Performance</div>
                    <table>
                        <thead>
                            <tr><th>Product</th><th>Quantity</th><th>Revenue</th><th>Transactions</th></tr>
                        </thead>
                        <tbody>
                            ${summaryData.productBreakdown.sort((a, b) => b.quantity - a.quantity).map(product => `
                                <tr>
                                    <td>${product.name}</td>
                                    <td>${product.quantity}</td>
                                    <td>$${product.revenue.toFixed(2)}</td>
                                    <td>${product.transactions}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </body>
                </html>
            `;
        }

        function backupData() {
            try {
                const backupData = {
                    timestamp: new Date().toISOString(),
                    version: '1.0',
                    data: {
                        employees: employees,
                        stores: stores,
                        products: products,
                        collections: collections,
                        sales: sales
                    },
                    metadata: {
                        totalEmployees: employees.length,
                        totalStores: stores.length,
                        totalProducts: products.length,
                        totalCollections: collections.length,
                        totalSales: sales.length,
                        syncMode: isFirebaseMode ? 'Firebase' : 'Local',
                        lastSyncTime: lastSyncTime
                    }
                };
                
                const backupJson = JSON.stringify(backupData, null, 2);
                const blob = new Blob([backupJson], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `eden_perfume_backup_${new Date().toISOString().split('T')[0]}.json`;
                link.style.display = 'none';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                URL.revokeObjectURL(url);
                
                alert(`Backup created successfully!\n\nBackup includes:\n- ${employees.length} employees\n- ${stores.length} stores\n- ${products.length} products\n- ${collections.length} collections\n- ${sales.length} sales records`);
                
            } catch (error) {
                console.error('Backup error:', error);
                alert('Error creating backup: ' + error.message);
            }
        }

        function downloadAllMasterData() {
            try {
                // Create comprehensive Excel-like CSV with multiple sheets
                let csvContent = '';
                
                // Employees sheet
                csvContent += 'EMPLOYEES\n';
                csvContent += 'Name,Username,Password,Store,Salary Type,Base Salary (DH),Commission Rate\n';
                employees.forEach(emp => {
                    const storeName = emp && emp.storeId ? (stores.find(s => s && s.id === emp.storeId)?.name || 'Unknown Store') : 'No Store';
                    csvContent += `"${emp.name || ''}","${emp.username || ''}","${emp.password || ''}","${storeName}","${emp.salaryType || ''}","${emp.baseSalary || 0}","${emp.commissionRate || 0}"\n`;
                });
                
                csvContent += '\n\nSTORES\n';
                csvContent += 'Name,Location,Manager,Phone\n';
                stores.forEach(store => {
                    csvContent += `"${store.name || ''}","${store.location || ''}","${store.manager || ''}","${store.phone || ''}"\n`;
                });
                
                csvContent += '\n\nPRODUCTS\n';
                csvContent += 'Name,Price (DH),Description\n';
                products.forEach(product => {
                    csvContent += `"${product.name || ''}","${product.price || 0}","${product.description || ''}"\n`;
                });
                
                csvContent += '\n\nCOLLECTIONS\n';
                csvContent += 'Name,Description,Status,Product Count\n';
                collections.forEach(collection => {
                    const productCount = collection.productIds ? collection.productIds.length : 0;
                    csvContent += `"${collection.name || ''}","${collection.description || ''}","${collection.status || ''}","${productCount}"\n`;
                });
                
                csvContent += '\n\nSALES\n';
                csvContent += 'Date,Time,Employee,Store,Product,Quantity,Amount (DH)\n';
                sales.forEach(sale => {
                    const employeeName = sale && sale.employeeId ? (employees.find(e => e && e.id === sale.employeeId)?.name || 'Unknown Employee') : 'No Employee';
                    const storeName = sale && sale.storeId ? (stores.find(s => s && s.id === sale.storeId)?.name || 'Unknown Store') : 'No Store';
                    const productName = sale && sale.productId ? (products.find(p => p && p.id === sale.productId)?.name || 'Unknown Product') : 'No Product';
                    csvContent += `"${sale.date || ''}","${sale.time || ''}","${employeeName}","${storeName}","${productName}","${sale.quantity || 0}","${sale.amount || 0}"\n`;
                });
                
                // Add summary
                csvContent += '\n\nSUMMARY\n';
                csvContent += 'Category,Count\n';
                csvContent += `"Total Employees","${employees.length}"\n`;
                csvContent += `"Total Stores","${stores.length}"\n`;
                csvContent += `"Total Products","${products.length}"\n`;
                csvContent += `"Total Collections","${collections.length}"\n`;
                csvContent += `"Total Sales","${sales.length}"\n`;
                csvContent += `"Export Date","${new Date().toLocaleDateString()}"\n`;
                csvContent += `"Export Time","${new Date().toLocaleTimeString()}"\n`;
                
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `eden_perfume_master_data_${new Date().toISOString().split('T')[0]}.csv`;
                link.style.display = 'none';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                URL.revokeObjectURL(url);
                
                alert('Master data exported successfully!\n\nThe file contains all employees, stores, products, collections, and sales data in CSV format.');
                
            } catch (error) {
                console.error('Export error:', error);
                alert('Error exporting data: ' + error.message);
            }
        }

        function restoreFromBackup() {
            if (!confirm('This will replace ALL current data with the backup data. Are you sure you want to continue?\n\nCurrent data will be lost!')) {
                return;
            }
            
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.style.display = 'none';
            
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const backupData = JSON.parse(e.target.result);
                        
                        // Validate backup structure
                        if (!backupData.data || !backupData.timestamp) {
                            throw new Error('Invalid backup file format');
                        }
                        
                        // Restore data
                        employees = backupData.data.employees || [];
                        stores = backupData.data.stores || [];
                        products = backupData.data.products || [];
                        collections = backupData.data.collections || [];
                        sales = backupData.data.sales || [];
                        
                        // Ensure arrays are valid
                        initializeArrays();
                        
                        // Save to localStorage
                        saveLocalData();
                        
                        // If Firebase is connected, sync the restored data
                        if (isFirebaseMode) {
                            // Queue all items for sync
                            employees.forEach(emp => queueForSync('create', 'employee', emp));
                            stores.forEach(store => queueForSync('create', 'store', store));
                            products.forEach(product => queueForSync('create', 'product', product));
                            collections.forEach(collection => queueForSync('create', 'collection', collection));
                            sales.forEach(sale => queueForSync('create', 'sale', sale));
                        }
                        
                        // Refresh current view
                        if (currentUserRole === 'admin') {
                            switchTab('employees'); // Refresh to employees tab
                        } else if (currentUserRole === 'employee') {
                            updateEmployeeStats();
                            updateTodaysSalesTable();
                        }
                        
                        const metadata = backupData.metadata || {};
                        alert(`Data restored successfully!\n\nRestored:\n- ${metadata.totalEmployees || employees.length} employees\n- ${metadata.totalStores || stores.length} stores\n- ${metadata.totalProducts || products.length} products\n- ${metadata.totalCollections || collections.length} collections\n- ${metadata.totalSales || sales.length} sales records\n\nBackup created: ${new Date(backupData.timestamp).toLocaleString()}`);
                        
                    } catch (error) {
                        console.error('Restore error:', error);
                        alert('Error restoring backup: ' + error.message + '\n\nPlease ensure you selected a valid Eden Perfume backup file.');
                    }
                };
                
                reader.readAsText(file);
            };
            
            document.body.appendChild(input);
            input.click();
            document.body.removeChild(input);
        }

        function clearAllData() {
            if (confirm('This will delete ALL data. Are you sure?')) {
                employees = [];
                stores = [];
                products = [];
                collections = [];
                sales = [];
                saveLocalData();
                alert('All data cleared!');
                location.reload();
            }
        }

        function openModal(type, item = null) {
            editingType = type;
            editingItem = item;
            
            const modal = document.getElementById('modal');
            const modalTitle = document.getElementById('modalTitle');
            const modalFields = document.getElementById('modalFields');
            const saveBtnText = document.getElementById('saveBtnText');
            
            // Set modal title
            const isEditing = item !== null;
            modalTitle.textContent = isEditing ? `Edit ${type.charAt(0).toUpperCase() + type.slice(1)}` : `Add ${type.charAt(0).toUpperCase() + type.slice(1)}`;
            saveBtnText.textContent = isEditing ? 'Update' : 'Save';
            
            // Generate form fields based on type
            let fieldsHTML = '';
            
            switch(type) {
                case 'employee':
                    fieldsHTML = `
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Full Name</label>
                            <input type="text" id="modalName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="Enter full name" required value="${item ? item.name || '' : ''}">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                            <input type="text" id="modalUsername" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="Enter username" required value="${item ? item.username || '' : ''}">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                            <input type="password" id="modalPassword" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="Enter password" ${!isEditing ? 'required' : ''} value="">
                            ${isEditing ? '<p class="text-xs text-gray-500 mt-1">Leave blank to keep current password</p>' : ''}
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Store</label>
                            <select id="modalStoreId" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" required>
                                <option value="">Select Store</option>
                                ${stores.map(store => `<option value="${store.id}" ${item && item.storeId === store.id ? 'selected' : ''}>${store.name}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Salary Type</label>
                            <select id="modalSalaryType" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" required onchange="updateSalaryFields()">
                                <option value="fixed" ${item && item.salaryType === 'fixed' ? 'selected' : ''}>Fixed Salary</option>
                                <option value="commission" ${item && item.salaryType === 'commission' ? 'selected' : ''}>Commission Based</option>
                                <option value="qty_sold" ${item && item.salaryType === 'qty_sold' ? 'selected' : ''}>Quantity Sold</option>
                                <option value="days_present" ${item && item.salaryType === 'days_present' ? 'selected' : ''}>Days Present</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Base Salary (DH)</label>
                            <input type="number" id="modalBaseSalary" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="Enter base salary" min="0" step="0.01" required value="${item ? item.baseSalary || '' : ''}">
                        </div>
                        <div id="commissionRateField" class="hidden">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Commission Rate (0.1 = 10%)</label>
                            <input type="number" id="modalCommissionRate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="0.1" min="0" max="1" step="0.01" value="${item ? item.commissionRate || '0.1' : '0.1'}">
                        </div>
                    `;
                    break;
                    
                case 'store':
                    fieldsHTML = `
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Store Name</label>
                            <input type="text" id="modalName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="Enter store name" required value="${item ? item.name || '' : ''}">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Location</label>
                            <input type="text" id="modalLocation" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="Enter location" required value="${item ? item.location || '' : ''}">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Manager Name</label>
                            <input type="text" id="modalManager" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="Enter manager name" required value="${item ? item.manager || '' : ''}">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Phone Number</label>
                            <input type="tel" id="modalPhone" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="Enter phone number" required value="${item ? item.phone || '' : ''}">
                        </div>
                    `;
                    break;
                    
                case 'product':
                    fieldsHTML = `
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Product Name</label>
                            <input type="text" id="modalName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="Enter product name" required value="${item ? item.name || '' : ''}">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Price (DH)</label>
                            <input type="number" id="modalPrice" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="Enter price" min="0" step="0.01" required value="${item ? item.price || '' : ''}">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Description (Optional)</label>
                            <textarea id="modalDescription" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="Enter product description" rows="3">${item ? item.description || '' : ''}</textarea>
                        </div>
                    `;
                    break;
                    
                case 'collection':
                    fieldsHTML = `
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Collection Name</label>
                            <input type="text" id="modalName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="Enter collection name" required value="${item ? item.name || '' : ''}">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                            <textarea id="modalDescription" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="Enter collection description" rows="3" required>${item ? item.description || '' : ''}</textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                            <select id="modalStatus" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" required>
                                <option value="active" ${item && item.status === 'active' ? 'selected' : ''}>Active</option>
                                <option value="inactive" ${item && item.status === 'inactive' ? 'selected' : ''}>Inactive</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Products in Collection</label>
                            <div class="border border-gray-300 rounded-lg p-3 max-h-40 overflow-y-auto">
                                ${products.map(product => `
                                    <label class="flex items-center space-x-2 mb-2">
                                        <input type="checkbox" class="product-checkbox" value="${product.id}" ${item && item.productIds && item.productIds.includes(product.id) ? 'checked' : ''}>
                                        <span class="text-sm">${product.name} - $${product.price}</span>
                                    </label>
                                `).join('')}
                            </div>
                        </div>
                    `;
                    break;
            }
            
            modalFields.innerHTML = fieldsHTML;
            
            // Show commission rate field if commission type is selected
            if (type === 'employee') {
                updateSalaryFields();
            }
            
            modal.classList.remove('hidden');
        }

        function updateSalaryFields() {
            const salaryType = document.getElementById('modalSalaryType').value;
            const commissionField = document.getElementById('commissionRateField');
            
            if (salaryType === 'commission') {
                commissionField.classList.remove('hidden');
            } else {
                commissionField.classList.add('hidden');
            }
        }

        function closeModal() {
            document.getElementById('modal').classList.add('hidden');
            editingItem = null;
            editingType = null;
        }

        function editItem(type, id) {
            let item = null;
            
            switch(type) {
                case 'employee':
                    item = employees.find(emp => emp.id === id);
                    break;
                case 'store':
                    item = stores.find(store => store.id === id);
                    break;
                case 'product':
                    item = products.find(product => product.id === id);
                    break;
                case 'collection':
                    item = collections.find(collection => collection.id === id);
                    break;
            }
            
            if (item) {
                openModal(type, item);
            } else {
                alert('Item not found!');
            }
        }

        async function deleteItem(type, id) {
            if (confirm('Are you sure you want to delete this item?')) {
                try {
                    switch(type) {
                        case 'employee':
                            await deleteEmployee(id);
                            await loadEmployeesTable();
                            break;
                        case 'store':
                            await deleteStore(id);
                            await loadStoresTable();
                            break;
                        case 'product':
                            await deleteProduct(id);
                            await loadProductsTable();
                            break;
                        case 'collection':
                            await deleteCollection(id);
                            await loadCollectionsTable();
                            break;
                    }
                    alert('Item deleted successfully!');
                } catch (error) {
                    alert('Error deleting item: ' + error.message);
                }
            }
        }

        function loadDatabaseManager() {
            alert('Database Manager coming soon!');
        }

        function generateSalesReport() {
            try {
                const startDate = document.getElementById('reportStartDate').value;
                const endDate = document.getElementById('reportEndDate').value;
                const reportType = document.getElementById('reportType').value;
                const filterValue = document.getElementById('reportFilter').value;
                
                if (!startDate || !endDate) {
                    alert('Please select both start and end dates');
                    return;
                }
                
                if (new Date(startDate) > new Date(endDate)) {
                    alert('Start date cannot be after end date');
                    return;
                }
                
                // Filter sales by date range
                let filteredSales = sales.filter(sale => {
                    if (!sale || !sale.date) return false;
                    const saleDate = new Date(sale.date);
                    const start = new Date(startDate);
                    const end = new Date(endDate);
                    return saleDate >= start && saleDate <= end;
                });
                
                // Apply additional filters based on report type
                if (filterValue) {
                    switch(reportType) {
                        case 'store':
                            filteredSales = filteredSales.filter(sale => sale.storeId === filterValue);
                            break;
                        case 'staff':
                            filteredSales = filteredSales.filter(sale => sale.employeeId === filterValue);
                            break;
                        case 'product':
                            filteredSales = filteredSales.filter(sale => sale.productId === filterValue);
                            break;
                    }
                }
                
                // Generate report based on type
                let reportData = [];
                
                switch(reportType) {
                    case 'daily':
                        reportData = generateDailyReport(filteredSales);
                        break;
                    case 'monthly':
                        reportData = generateMonthlyReport(filteredSales);
                        break;
                    case 'store':
                        reportData = generateStoreWiseReport(filteredSales);
                        break;
                    case 'staff':
                        reportData = generateStaffWiseReport(filteredSales);
                        break;
                    case 'product':
                        reportData = generateProductWiseReport(filteredSales);
                        break;
                    default: // 'all'
                        reportData = filteredSales.map(sale => ({
                            date: sale.date,
                            time: sale.time || '',
                            employee: getEmployeeName(sale.employeeId),
                            store: getStoreName(sale.storeId),
                            product: getProductName(sale.productId),
                            quantity: sale.quantity || 0,
                            amount: sale.amount || 0
                        }));
                }
                
                displaySalesReport(reportData, reportType);
                
            } catch (error) {
                console.error('Error generating sales report:', error);
                alert('Error generating report: ' + error.message);
            }
        }
        
        function generateDailyReport(sales) {
            const dailyData = {};
            
            sales.forEach(sale => {
                const date = sale.date;
                if (!dailyData[date]) {
                    dailyData[date] = {
                        date: date,
                        totalSales: 0,
                        totalQuantity: 0,
                        totalAmount: 0,
                        transactions: 0
                    };
                }
                
                dailyData[date].totalSales += 1;
                dailyData[date].totalQuantity += sale.quantity || 0;
                dailyData[date].totalAmount += sale.amount || 0;
                dailyData[date].transactions += 1;
            });
            
            return Object.values(dailyData).sort((a, b) => new Date(a.date) - new Date(b.date));
        }
        
        function generateMonthlyReport(sales) {
            const monthlyData = {};
            
            sales.forEach(sale => {
                const date = new Date(sale.date);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                const monthName = date.toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
                
                if (!monthlyData[monthKey]) {
                    monthlyData[monthKey] = {
                        month: monthName,
                        totalSales: 0,
                        totalQuantity: 0,
                        totalAmount: 0,
                        transactions: 0
                    };
                }
                
                monthlyData[monthKey].totalSales += 1;
                monthlyData[monthKey].totalQuantity += sale.quantity || 0;
                monthlyData[monthKey].totalAmount += sale.amount || 0;
                monthlyData[monthKey].transactions += 1;
            });
            
            return Object.values(monthlyData).sort((a, b) => a.month.localeCompare(b.month));
        }
        
        function generateStoreWiseReport(sales) {
            const storeData = {};
            
            sales.forEach(sale => {
                const storeId = sale.storeId;
                const storeName = getStoreName(storeId);
                
                if (!storeData[storeId]) {
                    storeData[storeId] = {
                        store: storeName,
                        totalSales: 0,
                        totalQuantity: 0,
                        totalAmount: 0,
                        transactions: 0
                    };
                }
                
                storeData[storeId].totalSales += 1;
                storeData[storeId].totalQuantity += sale.quantity || 0;
                storeData[storeId].totalAmount += sale.amount || 0;
                storeData[storeId].transactions += 1;
            });
            
            return Object.values(storeData).sort((a, b) => b.totalAmount - a.totalAmount);
        }
        
        function generateStaffWiseReport(sales) {
            const staffData = {};
            
            sales.forEach(sale => {
                const employeeId = sale.employeeId;
                const employeeName = getEmployeeName(employeeId);
                
                if (!staffData[employeeId]) {
                    staffData[employeeId] = {
                        employee: employeeName,
                        store: getStoreName(sale.storeId),
                        totalSales: 0,
                        totalQuantity: 0,
                        totalAmount: 0,
                        transactions: 0
                    };
                }
                
                staffData[employeeId].totalSales += 1;
                staffData[employeeId].totalQuantity += sale.quantity || 0;
                staffData[employeeId].totalAmount += sale.amount || 0;
                staffData[employeeId].transactions += 1;
            });
            
            return Object.values(staffData).sort((a, b) => b.totalAmount - a.totalAmount);
        }
        
        function generateProductWiseReport(sales) {
            const productData = {};
            
            sales.forEach(sale => {
                const productId = sale.productId;
                const productName = getProductName(productId);
                const product = getProduct(productId);
                
                if (!productData[productId]) {
                    productData[productId] = {
                        product: productName,
                        price: product ? product.price : 0,
                        totalQuantity: 0,
                        totalAmount: 0,
                        transactions: 0
                    };
                }
                
                productData[productId].totalQuantity += sale.quantity || 0;
                productData[productId].totalAmount += sale.amount || 0;
                productData[productId].transactions += 1;
            });
            
            return Object.values(productData).sort((a, b) => b.totalAmount - a.totalAmount);
        }
        
        function displaySalesReport(reportData, reportType) {
            const tbody = document.getElementById('salesReportTable');
            const header = document.getElementById('salesReportHeader');
            
            if (reportData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-500">No sales data found for the selected criteria</td></tr>';
                return;
            }
            
            // Update header based on report type
            let headerHTML = '';
            let bodyHTML = '';
            
            switch(reportType) {
                case 'daily':
                    headerHTML = `
                        <th class="text-left py-4 px-6">Date</th>
                        <th class="text-left py-4 px-6">Transactions</th>
                        <th class="text-left py-4 px-6">Total Quantity</th>
                        <th class="text-left py-4 px-6">Total Amount</th>
                        <th class="text-left py-4 px-6">Avg per Transaction</th>
                    `;
                    bodyHTML = reportData.map(row => `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="py-4 px-6">${new Date(row.date).toLocaleDateString()}</td>
                            <td class="py-4 px-6">${row.transactions}</td>
                            <td class="py-4 px-6">${row.totalQuantity}</td>
                            <td class="py-4 px-6">$${row.totalAmount.toFixed(2)}</td>
                            <td class="py-4 px-6">$${(row.totalAmount / row.transactions).toFixed(2)}</td>
                        </tr>
                    `).join('');
                    break;
                    
                case 'monthly':
                    headerHTML = `
                        <th class="text-left py-4 px-6">Month</th>
                        <th class="text-left py-4 px-6">Transactions</th>
                        <th class="text-left py-4 px-6">Total Quantity</th>
                        <th class="text-left py-4 px-6">Total Amount</th>
                        <th class="text-left py-4 px-6">Avg per Transaction</th>
                    `;
                    bodyHTML = reportData.map(row => `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="py-4 px-6">${row.month}</td>
                            <td class="py-4 px-6">${row.transactions}</td>
                            <td class="py-4 px-6">${row.totalQuantity}</td>
                            <td class="py-4 px-6">$${row.totalAmount.toFixed(2)}</td>
                            <td class="py-4 px-6">$${(row.totalAmount / row.transactions).toFixed(2)}</td>
                        </tr>
                    `).join('');
                    break;
                    
                case 'store':
                    headerHTML = `
                        <th class="text-left py-4 px-6">Store</th>
                        <th class="text-left py-4 px-6">Transactions</th>
                        <th class="text-left py-4 px-6">Total Quantity</th>
                        <th class="text-left py-4 px-6">Total Amount</th>
                        <th class="text-left py-4 px-6">Avg per Transaction</th>
                    `;
                    bodyHTML = reportData.map(row => `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="py-4 px-6">${row.store}</td>
                            <td class="py-4 px-6">${row.transactions}</td>
                            <td class="py-4 px-6">${row.totalQuantity}</td>
                            <td class="py-4 px-6">$${row.totalAmount.toFixed(2)}</td>
                            <td class="py-4 px-6">$${(row.totalAmount / row.transactions).toFixed(2)}</td>
                        </tr>
                    `).join('');
                    break;
                    
                case 'staff':
                    headerHTML = `
                        <th class="text-left py-4 px-6">Employee</th>
                        <th class="text-left py-4 px-6">Store</th>
                        <th class="text-left py-4 px-6">Transactions</th>
                        <th class="text-left py-4 px-6">Total Quantity</th>
                        <th class="text-left py-4 px-6">Total Amount</th>
                    `;
                    bodyHTML = reportData.map(row => `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="py-4 px-6">${row.employee}</td>
                            <td class="py-4 px-6">${row.store}</td>
                            <td class="py-4 px-6">${row.transactions}</td>
                            <td class="py-4 px-6">${row.totalQuantity}</td>
                            <td class="py-4 px-6">$${row.totalAmount.toFixed(2)}</td>
                        </tr>
                    `).join('');
                    break;
                    
                case 'product':
                    headerHTML = `
                        <th class="text-left py-4 px-6">Product</th>
                        <th class="text-left py-4 px-6">Unit Price</th>
                        <th class="text-left py-4 px-6">Quantity Sold</th>
                        <th class="text-left py-4 px-6">Total Amount</th>
                        <th class="text-left py-4 px-6">Transactions</th>
                    `;
                    bodyHTML = reportData.map(row => `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="py-4 px-6">${row.product}</td>
                            <td class="py-4 px-6">$${row.price.toFixed(2)}</td>
                            <td class="py-4 px-6">${row.totalQuantity}</td>
                            <td class="py-4 px-6">$${row.totalAmount.toFixed(2)}</td>
                            <td class="py-4 px-6">${row.transactions}</td>
                        </tr>
                    `).join('');
                    break;
                    
                default: // 'all'
                    headerHTML = `
                        <th class="text-left py-4 px-6">Date</th>
                        <th class="text-left py-4 px-6">Time</th>
                        <th class="text-left py-4 px-6">Employee</th>
                        <th class="text-left py-4 px-6">Store</th>
                        <th class="text-left py-4 px-6">Product</th>
                        <th class="text-left py-4 px-6">Quantity</th>
                        <th class="text-left py-4 px-6">Amount</th>
                    `;
                    bodyHTML = reportData.map(row => `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="py-4 px-6">${new Date(row.date).toLocaleDateString()}</td>
                            <td class="py-4 px-6">${row.time}</td>
                            <td class="py-4 px-6">${row.employee}</td>
                            <td class="py-4 px-6">${row.store}</td>
                            <td class="py-4 px-6">${row.product}</td>
                            <td class="py-4 px-6">${row.quantity}</td>
                            <td class="py-4 px-6">$${row.amount.toFixed(2)}</td>
                        </tr>
                    `).join('');
            }
            
            header.innerHTML = headerHTML;
            tbody.innerHTML = bodyHTML;
            
            // Store report data for export functions
            window.currentReportData = reportData;
            window.currentReportType = reportType;
        }

        function generateSalaryReport() {
            try {
                const startDate = document.getElementById('salaryStartDate').value;
                const endDate = document.getElementById('salaryEndDate').value;
                const selectedEmployee = document.getElementById('salaryEmployee').value;
                
                if (!startDate || !endDate) {
                    alert('Please select both start and end dates');
                    return;
                }
                
                if (new Date(startDate) > new Date(endDate)) {
                    alert('Start date cannot be after end date');
                    return;
                }
                
                // Filter sales by date range
                let filteredSales = sales.filter(sale => {
                    if (!sale || !sale.date) return false;
                    const saleDate = new Date(sale.date);
                    const start = new Date(startDate);
                    const end = new Date(endDate);
                    return saleDate >= start && saleDate <= end;
                });
                
                // Filter by employee if selected
                if (selectedEmployee) {
                    filteredSales = filteredSales.filter(sale => sale.employeeId === selectedEmployee);
                }
                
                // Calculate salary data for each employee
                const salaryData = {};
                const dateRange = Math.ceil((new Date(endDate) - new Date(startDate)) / (1000 * 60 * 60 * 24)) + 1;
                
                // Initialize salary data for all employees (or selected employee)
                const employeesToProcess = selectedEmployee ? 
                    employees.filter(emp => emp.id === selectedEmployee) : 
                    employees;
                
                employeesToProcess.forEach(employee => {
                    if (!employee || !employee.id) return;
                    
                    const employeeSales = filteredSales.filter(sale => sale.employeeId === employee.id);
                    const totalSales = employeeSales.reduce((sum, sale) => sum + (sale.amount || 0), 0);
                    const totalQuantity = employeeSales.reduce((sum, sale) => sum + (sale.quantity || 0), 0);
                    const workingDays = getWorkingDays(employee.id, startDate, endDate);
                    
                    let baseSalary = employee.baseSalary || 0;
                    let bonus = 0;
                    let totalSalary = 0;
                    
                    switch(employee.salaryType) {
                        case 'fixed':
                            // Calculate daily rate and multiply by date range
                            const dailyRate = baseSalary / 30;
                            totalSalary = dailyRate * dateRange;
                            bonus = 0;
                            break;
                            
                        case 'commission':
                            const commissionRate = employee.commissionRate || 0.1;
                            bonus = totalSales * commissionRate;
                            totalSalary = baseSalary + bonus;
                            break;
                            
                        case 'qty_sold':
                            const perBottleRate = 5; // $5 per bottle
                            bonus = totalQuantity * perBottleRate;
                            totalSalary = baseSalary + bonus;
                            break;
                            
                        case 'days_present':
                            const perDayRate = 50; // $50 per day
                            bonus = workingDays * perDayRate;
                            totalSalary = baseSalary + bonus;
                            break;
                            
                        default:
                            totalSalary = baseSalary;
                    }
                    
                    salaryData[employee.id] = {
                        employee: employee.name || 'Unknown',
                        salaryType: employee.salaryType || 'fixed',
                        baseSalary: baseSalary,
                        bonus: bonus,
                        totalSales: totalSales,
                        workingDays: workingDays,
                        totalQuantity: totalQuantity,
                        totalSalary: totalSalary,
                        store: getStoreName(employee.storeId)
                    };
                });
                
                displaySalaryReport(Object.values(salaryData));
                
            } catch (error) {
                console.error('Error generating salary report:', error);
                alert('Error generating salary report: ' + error.message);
            }
        }
        
        function getWorkingDays(employeeId, startDate, endDate) {
            // Count unique days when employee made sales
            const employeeSales = sales.filter(sale => 
                sale && 
                sale.employeeId === employeeId && 
                sale.date >= startDate && 
                sale.date <= endDate
            );
            
            const uniqueDates = [...new Set(employeeSales.map(sale => sale.date))];
            return uniqueDates.length;
        }
        
        function displaySalaryReport(salaryData) {
            const tbody = document.getElementById('salaryReportTable');
            
            if (salaryData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center py-8 text-gray-500">No salary data found for the selected criteria</td></tr>';
                return;
            }
            
            // Sort by total salary descending
            salaryData.sort((a, b) => b.totalSalary - a.totalSalary);
            
            tbody.innerHTML = salaryData.map(row => {
                const salaryTypeDisplay = row.salaryType.replace('_', ' ').toUpperCase();
                const daysOrQty = row.salaryType === 'qty_sold' ? row.totalQuantity : row.workingDays;
                
                return `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="py-4 px-6">${row.employee}</td>
                        <td class="py-4 px-6">${salaryTypeDisplay}</td>
                        <td class="py-4 px-6">$${row.baseSalary.toFixed(2)}</td>
                        <td class="py-4 px-6">$${row.bonus.toFixed(2)}</td>
                        <td class="py-4 px-6">$${row.totalSales.toFixed(2)}</td>
                        <td class="py-4 px-6">${daysOrQty}</td>
                        <td class="py-4 px-6 font-bold text-green-600">$${row.totalSalary.toFixed(2)}</td>
                    </tr>
                `;
            }).join('');
            
            // Store salary data for export functions
            window.currentSalaryData = salaryData;
        }

        function printReport(type) {
            try {
                let reportData, reportType;
                
                if (type === 'salary') {
                    reportData = window.currentSalaryData;
                    reportType = 'salary';
                } else {
                    reportData = window.currentReportData;
                    reportType = window.currentReportType;
                }
                
                if (!reportData || reportData.length === 0) {
                    alert('No data to print. Please generate a report first.');
                    return;
                }
                
                // Create a new window for printing
                const printWindow = window.open('', '_blank');
                const printContent = generatePrintContent(reportData, reportType, type);
                
                printWindow.document.write(printContent);
                printWindow.document.close();
                printWindow.focus();
                printWindow.print();
                printWindow.close();
            } catch (error) {
                console.error('Print error:', error);
                alert('Error printing report: ' + error.message);
            }
        }

        function downloadExcel(type) {
            try {
                let reportData, reportType;
                
                if (type === 'salary') {
                    reportData = window.currentSalaryData;
                    reportType = 'salary';
                } else {
                    reportData = window.currentReportData;
                    reportType = window.currentReportType;
                }
                
                if (!reportData || reportData.length === 0) {
                    alert('No data to download. Please generate a report first.');
                    return;
                }
                
                const csvContent = generateCSVContent(reportData, reportType, type);
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                
                if (link.download !== undefined) {
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', `${type}_report_${new Date().toISOString().split('T')[0]}.csv`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                } else {
                    alert('Your browser does not support file downloads. Please copy the data manually.');
                }
            } catch (error) {
                console.error('Excel download error:', error);
                alert('Error downloading Excel file: ' + error.message);
            }
        }

        function downloadPDF(type) {
            try {
                let reportData, reportType;
                
                if (type === 'salary') {
                    reportData = window.currentSalaryData;
                    reportType = 'salary';
                } else {
                    reportData = window.currentReportData;
                    reportType = window.currentReportType;
                }
                
                if (!reportData || reportData.length === 0) {
                    alert('No data to download. Please generate a report first.');
                    return;
                }
                
                // For PDF, we'll create a formatted text version that can be saved
                const pdfContent = generatePDFContent(reportData, reportType, type);
                const blob = new Blob([pdfContent], { type: 'text/plain;charset=utf-8;' });
                const link = document.createElement('a');
                
                if (link.download !== undefined) {
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', `${type}_report_${new Date().toISOString().split('T')[0]}.txt`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                } else {
                    alert('Your browser does not support file downloads. Please copy the data manually.');
                }
            } catch (error) {
                console.error('PDF download error:', error);
                alert('Error downloading PDF file: ' + error.message);
            }
        }
        
        function generatePrintContent(reportData, reportType, type) {
            const title = type === 'sales' ? 'Sales Report' : 'Salary Report';
            const date = new Date().toLocaleDateString();
            
            let tableHeaders = '';
            let tableRows = '';
            
            if (type === 'sales') {
                switch(reportType) {
                    case 'daily':
                        tableHeaders = '<th>Date</th><th>Transactions</th><th>Total Quantity</th><th>Total Amount</th><th>Avg per Transaction</th>';
                        tableRows = reportData.map(row => `
                            <tr>
                                <td>${new Date(row.date).toLocaleDateString()}</td>
                                <td>${row.transactions}</td>
                                <td>${row.totalQuantity}</td>
                                <td>$${row.totalAmount.toFixed(2)}</td>
                                <td>$${(row.totalAmount / row.transactions).toFixed(2)}</td>
                            </tr>
                        `).join('');
                        break;
                    case 'monthly':
                        tableHeaders = '<th>Month</th><th>Transactions</th><th>Total Quantity</th><th>Total Amount</th><th>Avg per Transaction</th>';
                        tableRows = reportData.map(row => `
                            <tr>
                                <td>${row.month}</td>
                                <td>${row.transactions}</td>
                                <td>${row.totalQuantity}</td>
                                <td>$${row.totalAmount.toFixed(2)}</td>
                                <td>$${(row.totalAmount / row.transactions).toFixed(2)}</td>
                            </tr>
                        `).join('');
                        break;
                    case 'store':
                        tableHeaders = '<th>Store</th><th>Transactions</th><th>Total Quantity</th><th>Total Amount</th><th>Avg per Transaction</th>';
                        tableRows = reportData.map(row => `
                            <tr>
                                <td>${row.store}</td>
                                <td>${row.transactions}</td>
                                <td>${row.totalQuantity}</td>
                                <td>$${row.totalAmount.toFixed(2)}</td>
                                <td>$${(row.totalAmount / row.transactions).toFixed(2)}</td>
                            </tr>
                        `).join('');
                        break;
                    case 'staff':
                        tableHeaders = '<th>Employee</th><th>Store</th><th>Transactions</th><th>Total Quantity</th><th>Total Amount</th>';
                        tableRows = reportData.map(row => `
                            <tr>
                                <td>${row.employee}</td>
                                <td>${row.store}</td>
                                <td>${row.transactions}</td>
                                <td>${row.totalQuantity}</td>
                                <td>$${row.totalAmount.toFixed(2)}</td>
                            </tr>
                        `).join('');
                        break;
                    case 'product':
                        tableHeaders = '<th>Product</th><th>Unit Price</th><th>Quantity Sold</th><th>Total Amount</th><th>Transactions</th>';
                        tableRows = reportData.map(row => `
                            <tr>
                                <td>${row.product}</td>
                                <td>$${row.price.toFixed(2)}</td>
                                <td>${row.totalQuantity}</td>
                                <td>$${row.totalAmount.toFixed(2)}</td>
                                <td>${row.transactions}</td>
                            </tr>
                        `).join('');
                        break;
                    default:
                        tableHeaders = '<th>Date</th><th>Time</th><th>Employee</th><th>Store</th><th>Product</th><th>Quantity</th><th>Amount</th>';
                        tableRows = reportData.map(row => `
                            <tr>
                                <td>${new Date(row.date).toLocaleDateString()}</td>
                                <td>${row.time}</td>
                                <td>${row.employee}</td>
                                <td>${row.store}</td>
                                <td>${row.product}</td>
                                <td>${row.quantity}</td>
                                <td>$${row.amount.toFixed(2)}</td>
                            </tr>
                        `).join('');
                }
            }
            
            return `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${title}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .header { text-align: center; margin-bottom: 30px; }
                        .header h1 { color: #333; margin-bottom: 5px; }
                        .header p { color: #666; margin: 0; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; font-weight: bold; }
                        tr:nth-child(even) { background-color: #f9f9f9; }
                        .footer { margin-top: 30px; text-align: center; color: #666; font-size: 12px; }
                        @media print {
                            body { margin: 0; }
                            .no-print { display: none; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>Eden Perfume - ${title}</h1>
                        <p>Generated on ${date}</p>
                        <p>Report Type: ${reportType.charAt(0).toUpperCase() + reportType.slice(1)}</p>
                    </div>
                    <table>
                        <thead>
                            <tr>${tableHeaders}</tr>
                        </thead>
                        <tbody>
                            ${tableRows}
                        </tbody>
                    </table>
                    <div class="footer">
                        <p>Eden Perfume Sales Management System</p>
                    </div>
                </body>
                </html>
            `;
        }
        
        function generateCSVContent(reportData, reportType, type) {
            let headers = [];
            let rows = [];
            
            if (type === 'sales') {
                switch(reportType) {
                    case 'daily':
                        headers = ['Date', 'Transactions', 'Total Quantity', 'Total Amount', 'Avg per Transaction'];
                        rows = reportData.map(row => [
                            new Date(row.date).toLocaleDateString(),
                            row.transactions,
                            row.totalQuantity,
                            row.totalAmount.toFixed(2),
                            (row.totalAmount / row.transactions).toFixed(2)
                        ]);
                        break;
                    case 'monthly':
                        headers = ['Month', 'Transactions', 'Total Quantity', 'Total Amount', 'Avg per Transaction'];
                        rows = reportData.map(row => [
                            row.month,
                            row.transactions,
                            row.totalQuantity,
                            row.totalAmount.toFixed(2),
                            (row.totalAmount / row.transactions).toFixed(2)
                        ]);
                        break;
                    case 'store':
                        headers = ['Store', 'Transactions', 'Total Quantity', 'Total Amount', 'Avg per Transaction'];
                        rows = reportData.map(row => [
                            row.store,
                            row.transactions,
                            row.totalQuantity,
                            row.totalAmount.toFixed(2),
                            (row.totalAmount / row.transactions).toFixed(2)
                        ]);
                        break;
                    case 'staff':
                        headers = ['Employee', 'Store', 'Transactions', 'Total Quantity', 'Total Amount'];
                        rows = reportData.map(row => [
                            row.employee,
                            row.store,
                            row.transactions,
                            row.totalQuantity,
                            row.totalAmount.toFixed(2)
                        ]);
                        break;
                    case 'product':
                        headers = ['Product', 'Unit Price', 'Quantity Sold', 'Total Amount', 'Transactions'];
                        rows = reportData.map(row => [
                            row.product,
                            row.price.toFixed(2),
                            row.totalQuantity,
                            row.totalAmount.toFixed(2),
                            row.transactions
                        ]);
                        break;
                    default:
                        headers = ['Date', 'Time', 'Employee', 'Store', 'Product', 'Quantity', 'Amount'];
                        rows = reportData.map(row => [
                            new Date(row.date).toLocaleDateString(),
                            row.time,
                            row.employee,
                            row.store,
                            row.product,
                            row.quantity,
                            row.amount.toFixed(2)
                        ]);
                }
            } else if (type === 'salary') {
                headers = ['Employee', 'Salary Type', 'Base Salary', 'Bonus/Commission', 'Total Sales', 'Days/Qty', 'Total Salary'];
                rows = reportData.map(row => [
                    row.employee,
                    row.salaryType.replace('_', ' ').toUpperCase(),
                    row.baseSalary.toFixed(2),
                    row.bonus.toFixed(2),
                    row.totalSales.toFixed(2),
                    row.salaryType === 'qty_sold' ? row.totalQuantity : row.workingDays,
                    row.totalSalary.toFixed(2)
                ]);
            }
            
            // Create CSV content
            const csvRows = [headers.join(',')];
            rows.forEach(row => {
                const escapedRow = row.map(field => {
                    // Escape fields that contain commas or quotes
                    if (typeof field === 'string' && (field.includes(',') || field.includes('"'))) {
                        return `"${field.replace(/"/g, '""')}"`;
                    }
                    return field;
                });
                csvRows.push(escapedRow.join(','));
            });
            
            return csvRows.join('\n');
        }
        
        function generatePDFContent(reportData, reportType, type) {
            const title = type === 'sales' ? 'Sales Report' : 'Salary Report';
            const date = new Date().toLocaleDateString();
            
            let content = `EDEN PERFUME - ${title.toUpperCase()}\n`;
            content += `Generated on: ${date}\n`;
            content += `Report Type: ${reportType.charAt(0).toUpperCase() + reportType.slice(1)}\n`;
            content += `${'='.repeat(60)}\n\n`;
            
            if (type === 'sales') {
                switch(reportType) {
                    case 'daily':
                        content += 'Date\t\tTransactions\tQuantity\tAmount\t\tAvg/Trans\n';
                        content += '-'.repeat(60) + '\n';
                        reportData.forEach(row => {
                            content += `${new Date(row.date).toLocaleDateString()}\t${row.transactions}\t\t${row.totalQuantity}\t$${row.totalAmount.toFixed(2)}\t\t$${(row.totalAmount / row.transactions).toFixed(2)}\n`;
                        });
                        break;
                    case 'monthly':
                        content += 'Month\t\t\tTransactions\tQuantity\tAmount\t\tAvg/Trans\n';
                        content += '-'.repeat(60) + '\n';
                        reportData.forEach(row => {
                            content += `${row.month}\t${row.transactions}\t\t${row.totalQuantity}\t$${row.totalAmount.toFixed(2)}\t\t$${(row.totalAmount / row.transactions).toFixed(2)}\n`;
                        });
                        break;
                    case 'store':
                        content += 'Store\t\t\tTransactions\tQuantity\tAmount\t\tAvg/Trans\n';
                        content += '-'.repeat(60) + '\n';
                        reportData.forEach(row => {
                            content += `${row.store}\t\t${row.transactions}\t\t${row.totalQuantity}\t$${row.totalAmount.toFixed(2)}\t\t$${(row.totalAmount / row.transactions).toFixed(2)}\n`;
                        });
                        break;
                    case 'staff':
                        content += 'Employee\t\tStore\t\tTransactions\tQuantity\tAmount\n';
                        content += '-'.repeat(60) + '\n';
                        reportData.forEach(row => {
                            content += `${row.employee}\t\t${row.store}\t\t${row.transactions}\t\t${row.totalQuantity}\t$${row.totalAmount.toFixed(2)}\n`;
                        });
                        break;
                    case 'product':
                        content += 'Product\t\t\tPrice\tQuantity\tAmount\t\tTransactions\n';
                        content += '-'.repeat(60) + '\n';
                        reportData.forEach(row => {
                            content += `${row.product}\t\t$${row.price.toFixed(2)}\t${row.totalQuantity}\t\t$${row.totalAmount.toFixed(2)}\t\t${row.transactions}\n`;
                        });
                        break;
                    default:
                        content += 'Date\t\tTime\tEmployee\tStore\t\tProduct\t\tQty\tAmount\n';
                        content += '-'.repeat(80) + '\n';
                        reportData.forEach(row => {
                            content += `${new Date(row.date).toLocaleDateString()}\t${row.time}\t${row.employee}\t${row.store}\t\t${row.product}\t\t${row.quantity}\t$${row.amount.toFixed(2)}\n`;
                        });
                }
            }
            
            content += '\n' + '='.repeat(60) + '\n';
            content += 'Eden Perfume Sales Management System\n';
            
            return content;
        }

        function populateEmployeeDropdown() {
            const select = document.getElementById('salaryEmployee');
            if (select) {
                select.innerHTML = '<option value="">All Employees</option>';
                employees.forEach(emp => {
                    const option = document.createElement('option');
                    option.value = emp.id;
                    option.textContent = emp.name;
                    select.appendChild(option);
                });
            }
        }
        
        function updateReportFilter() {
            const reportType = document.getElementById('reportType').value;
            const filterSelect = document.getElementById('reportFilter');
            
            filterSelect.innerHTML = '<option value="">All</option>';
            
            switch(reportType) {
                case 'store':
                    stores.forEach(store => {
                        const option = document.createElement('option');
                        option.value = store.id;
                        option.textContent = store.name;
                        filterSelect.appendChild(option);
                    });
                    break;
                case 'staff':
                    employees.forEach(emp => {
                        const option = document.createElement('option');
                        option.value = emp.id;
                        option.textContent = emp.name;
                        filterSelect.appendChild(option);
                    });
                    break;
                case 'product':
                    products.forEach(product => {
                        const option = document.createElement('option');
                        option.value = product.id;
                        option.textContent = product.name;
                        filterSelect.appendChild(option);
                    });
                    break;
                default:
                    // For daily, monthly, and all reports, no additional filter needed
                    filterSelect.innerHTML = '<option value="">All</option>';
            }
        }
        
        // Add event listener for report type change
        document.addEventListener('DOMContentLoaded', function() {
            const reportTypeSelect = document.getElementById('reportType');
            if (reportTypeSelect) {
                reportTypeSelect.addEventListener('change', updateReportFilter);
            }
        });

        // Login System
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const loginBtn = document.getElementById('loginBtnText');
            
            loginBtn.textContent = 'Signing in...';
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            // Check admin credentials (case insensitive)
            if (username.toLowerCase() === 'admin' && password === 'admin123') {
                currentUser = { name: 'Administrator', role: 'admin' };
                currentUserRole = 'admin';
                await showDashboard();
                loginBtn.textContent = 'Sign In';
                return;
            }
            
            // Check employee credentials (case insensitive)
            const employee = employees.find(emp => 
                emp.username && emp.username.toLowerCase() === username.toLowerCase() && emp.password === password
            );
            
            if (employee) {
                currentUser = employee;
                currentUserRole = 'employee';
                await showEmployeePortal();
                loginBtn.textContent = 'Sign In';
                return;
            }
            
            alert('Invalid credentials. Please try again.');
            loginBtn.textContent = 'Sign In';
        });

        function logout() {
            currentUser = null;
            currentUserRole = null;
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('employeePortal').classList.add('hidden');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }

        // Employee Portal Functions
        async function showEmployeePortal() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('employeePortal').classList.remove('hidden');
            
            // Update employee info
            document.getElementById('employeeName').textContent = currentUser.name;
            document.getElementById('employeeStore').textContent = getStoreName(currentUser.storeId);
            
            // Update current date
            updateCurrentDate('employeeCurrentDate');
            updateCurrentDate('currentDate');
            
            // Populate dropdowns
            populateProductDropdown();
            populateStoreDropdown();
            
            // Add quantity input event listener
            const quantityInput = document.getElementById('saleQuantity');
            if (quantityInput) {
                quantityInput.addEventListener('input', updateSaleSummary);
            }
            
            // Update stats and sales table
            updateEmployeeStats();
            updateTodaysSalesTable();
        }

        function populateProductDropdown() {
            try {
                const select = document.getElementById('saleProduct');
                if (!select) {
                    console.error('Product dropdown element not found');
                    return;
                }
                
                select.innerHTML = '<option value="">Choose a product...</option>';
                
                if (!products || !Array.isArray(products)) {
                    console.error('Products array is not valid');
                    return;
                }
                
                products.filter(product => product && product.id && product.name).forEach(product => {
                    try {
                        const option = document.createElement('option');
                        option.value = product.id;
                        option.textContent = `${product.name} - ${(product.price || 0).toFixed(2)} DH`;
                        select.appendChild(option);
                    } catch (error) {
                        console.error('Error creating product option:', error);
                    }
                });
                
                // Add event listener for product selection
                select.addEventListener('change', updateSaleSummary);
            } catch (error) {
                console.error('Error in populateProductDropdown:', error);
            }
        }

        // Quantity adjustment functions
        function adjustQuantity(change) {
            const quantityInput = document.getElementById('saleQuantity');
            const currentQuantity = parseInt(quantityInput.value) || 1;
            const newQuantity = Math.max(1, currentQuantity + change);
            quantityInput.value = newQuantity;
            updateSaleSummary();
        }

        // Update sale summary display
        function updateSaleSummary() {
            try {
                const productSelect = document.getElementById('saleProduct');
                const quantityInput = document.getElementById('saleQuantity');
                const productPriceEl = document.getElementById('productPrice');
                const displayQuantityEl = document.getElementById('displayQuantity');
                const totalAmountEl = document.getElementById('totalAmount');
                
                const selectedProductId = productSelect.value;
                const quantity = parseInt(quantityInput.value) || 1;
                
                if (selectedProductId) {
                    const product = getProduct(selectedProductId);
                    if (product) {
                        const price = product.price || 0;
                        const total = price * quantity;
                        
                        productPriceEl.textContent = `${price.toFixed(2)} DH`;
                        displayQuantityEl.textContent = quantity.toString();
                        totalAmountEl.textContent = `${total.toFixed(2)} DH`;
                        return;
                    }
                }
                
                // Reset if no product selected
                productPriceEl.textContent = '0.00 DH';
                displayQuantityEl.textContent = quantity.toString();
                totalAmountEl.textContent = '0.00 DH';
                
            } catch (error) {
                console.error('Error updating sale summary:', error);
            }
        }

        // Update current date and time
        function updateCurrentDateTime() {
            const now = new Date();
            const dateTimeString = now.toLocaleString('en-US', {
                weekday: 'short',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            const element = document.getElementById('currentDateTime');
            if (element) {
                element.textContent = dateTimeString;
            }
        }

        function populateStoreDropdown() {
            try {
                const select = document.getElementById('saleStore');
                if (!select) {
                    console.log('Store dropdown element not found (this is normal for some views)');
                    return;
                }
                
                select.innerHTML = '<option value="">Select Store</option>';
                
                if (!stores || !Array.isArray(stores)) {
                    console.error('Stores array is not valid');
                    return;
                }
                
                stores.filter(store => store && store.id && store.name).forEach(store => {
                    try {
                        const option = document.createElement('option');
                        option.value = store.id;
                        option.textContent = store.name;
                        select.appendChild(option);
                    } catch (error) {
                        console.error('Error creating store option:', error);
                    }
                });
                
                // Set default store for employee
                if (currentUser && currentUser.storeId) {
                    select.value = currentUser.storeId;
                }
            } catch (error) {
                console.error('Error in populateStoreDropdown:', error);
            }
        }

        function updateEmployeeStats() {
            try {
                if (!currentUser || !currentUser.id) {
                    console.error('No current user found');
                    return;
                }
                
                // Ensure arrays are initialized
                initializeArrays();
                
                const today = getTodayString();
                const todaysSales = sales.filter(sale => 
                    sale && sale.date === today && sale.employeeId === currentUser.id
                );
                
                const totalSales = todaysSales.reduce((sum, sale) => sum + (sale.amount || 0), 0);
                const bottlesSold = todaysSales.reduce((sum, sale) => sum + (sale.quantity || 0), 0);
                
                // Calculate today's salary based on salary type
                let todaySalary = 0;
                
                switch(currentUser.salaryType) {
                    case 'fixed':
                        // Daily portion of monthly salary
                        todaySalary = (currentUser.baseSalary || 0) / 30;
                        break;
                    case 'commission':
                        todaySalary = totalSales * (currentUser.commissionRate || 0.1);
                        break;
                    case 'qty_sold':
                        todaySalary = bottlesSold * 5; // $5 per bottle
                        break;
                    case 'days_present':
                        todaySalary = todaysSales.length > 0 ? 50 : 0; // $50 if worked today
                        break;
                    default:
                        todaySalary = (currentUser.baseSalary || 0) / 30;
                }
                
                // Safe DOM element updates with null checks
                const totalSalesTodayEl = document.getElementById('totalSalesToday');
                const bottlesSoldEl = document.getElementById('bottlesSold');
                const estimatedSalaryEl = document.getElementById('estimatedSalary');
                
                if (totalSalesTodayEl) {
                    totalSalesTodayEl.textContent = `${totalSales.toFixed(2)} DH`;
                }
                if (bottlesSoldEl) {
                    bottlesSoldEl.textContent = bottlesSold.toString();
                }
                if (estimatedSalaryEl) {
                    estimatedSalaryEl.textContent = `${todaySalary.toFixed(2)} DH`;
                }
            } catch (error) {
                console.error('Error in updateEmployeeStats:', error);
            }
        }

        function updateTodaysSalesTable() {
            try {
                if (!currentUser || !currentUser.id) {
                    console.error('No current user found for sales table update');
                    return;
                }
                
                const today = getTodayString();
                const todaysSales = sales.filter(sale => 
                    sale && sale.date === today && sale.employeeId === currentUser.id
                );
                
                const tbody = document.getElementById('todaysSalesTable');
                if (!tbody) {
                    console.error('Sales table body element not found');
                    return;
                }
                
                if (todaysSales.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-500">No sales recorded today</td></tr>';
                    return;
                }
                
                tbody.innerHTML = todaysSales.filter(sale => sale && sale.id).map(sale => {
                    // Safe property access with fallbacks
                    const saleTime = sale.time || 'N/A';
                    const storeName = getStoreName(sale.storeId);
                    const productName = getProductName(sale.productId);
                    const quantity = sale.quantity || 0;
                    const amount = sale.amount || 0;
                    const saleId = sale.id || '';
                    
                    return `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="py-2 px-2 text-sm">${saleTime}</td>
                            <td class="py-2 px-2 text-sm hide-mobile">${storeName}</td>
                            <td class="py-2 px-2 text-sm">${productName}</td>
                            <td class="py-2 px-2 text-sm">${quantity}</td>
                            <td class="py-2 px-2 text-sm">${amount.toFixed(2)} DH</td>
                            <td class="py-2 px-2 text-sm">
                                <button onclick="deleteSale('${saleId}')" class="text-red-600 hover:text-red-800 text-xs mobile-button p-1">
                                    üóëÔ∏è
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error in updateTodaysSalesTable:', error);
                const tbody = document.getElementById('todaysSalesTable');
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-red-500">Error loading sales data</td></tr>';
                }
            }
        }

        // Add Sale Form
        document.getElementById('addSaleForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = '‚è≥ Recording...';
            submitBtn.disabled = true;
            
            const productId = document.getElementById('saleProduct').value;
            const quantity = parseInt(document.getElementById('saleQuantity').value);
            const storeId = document.getElementById('saleStore').value;
            
            if (!storeId) {
                alert('Please select a store');
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
                return;
            }
            
            if (!productId) {
                alert('Please select a product');
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
                return;
            }
            
            if (!quantity || quantity <= 0) {
                alert('Please enter a valid quantity');
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
                return;
            }
            
            const product = getProduct(productId);
            if (!product) {
                alert('Invalid product selected');
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
                return;
            }
            
            const newSale = {
                date: getTodayString(),
                time: getCurrentTime(),
                employeeId: currentUser.id,
                storeId: storeId,
                productId: productId,
                quantity: quantity,
                amount: product.price * quantity
            };
            
            try {
                await saveSale(newSale);
                
                // Reset form to default state
                document.getElementById('saleQuantity').value = '1';
                document.getElementById('saleProduct').value = '';
                document.getElementById('saleStore').value = '';
                updateSaleSummary();
                
                // Reload data and update displays
                updateEmployeeStats();
                updateTodaysSalesTable();
                
                // Show success message
                submitBtn.textContent = '‚úÖ Success!';
                submitBtn.style.backgroundColor = '#10b981';
                
                setTimeout(() => {
                    submitBtn.textContent = originalText;
                    submitBtn.style.backgroundColor = '';
                    submitBtn.disabled = false;
                }, 2000);
                
            } catch (error) {
                alert('Error recording sale: ' + error.message);
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        });

        async function deleteSale(saleId) {
            if (!saleId) {
                console.error('deleteSale requires valid saleId');
                return;
            }
            
            if (confirm('Are you sure you want to delete this sale?')) {
                try {
                    await deleteSaleRecord(saleId);
                    updateEmployeeStats();
                    updateTodaysSalesTable();
                } catch (error) {
                    console.error('Error in deleteSale:', error);
                    alert('Error deleting sale: ' + error.message);
                }
            }
        }

        // Admin Dashboard Functions
        async function showDashboard() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            
            // Update current date
            updateCurrentDate('adminCurrentDate');
            
            // Show employees tab by default
            await switchTab('employees');
        }

        async function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('tab-active', 'border-purple-500');
                btn.classList.add('border-transparent');
            });
            
            // Show selected tab content
            document.getElementById(tabName + '-tab').classList.remove('hidden');
            
            // Add active class to selected tab button
            const activeBtn = document.querySelector(`[data-tab="${tabName}"]`);
            activeBtn.classList.add('tab-active', 'border-purple-500');
            activeBtn.classList.remove('border-transparent');
            
            // Load data for the selected tab
            switch(tabName) {
                case 'employees':
                    await loadEmployeesTable();
                    break;
                case 'stores':
                    await loadStoresTable();
                    break;
                case 'products':
                    await loadProductsTable();
                    break;
                case 'collections':
                    await loadCollectionsTable();
                    break;
                case 'database':
                    await loadDatabaseManager();
                    break;
                case 'sales':
                    // Initialize filter dropdown
                    updateReportFilter();
                    // Set default dates
                    const today = new Date();
                    const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, today.getDate());
                    document.getElementById('reportStartDate').value = lastMonth.toISOString().split('T')[0];
                    document.getElementById('reportEndDate').value = today.toISOString().split('T')[0];
                    break;
                case 'salary':
                    populateEmployeeDropdown();
                    break;
            }
        }

        async function loadEmployeesTable() {
            try {
                const tbody = document.getElementById('employeesTable');
                
                if (!tbody) {
                    console.error('Employees table body element not found');
                    return;
                }
                
                if (!employees || !Array.isArray(employees) || employees.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-500">No employees found. Click "Add Employee" to create your first employee.</td></tr>';
                    return;
                }
                
                tbody.innerHTML = employees.filter(emp => emp && emp.id).map(emp => {
                    // Safe property access with fallbacks
                    const empName = emp.name || 'N/A';
                    const empUsername = emp.username || 'N/A';
                    const storeName = getStoreName(emp.storeId);
                    const salaryType = emp.salaryType || 'fixed';
                    const baseSalary = emp.baseSalary || 0;
                    const empId = emp.id || '';
                    
                    return `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="py-3 px-3 text-sm">${empName}</td>
                            <td class="py-3 px-3 text-sm hide-mobile">${empUsername}</td>
                            <td class="py-3 px-3 text-sm">${storeName}</td>
                            <td class="py-3 px-3 text-sm capitalize hide-mobile">${salaryType}</td>
                            <td class="py-3 px-3 text-sm">${baseSalary} DH</td>
                            <td class="py-3 px-3 text-sm">
                                <div class="flex space-x-1">
                                    <button onclick="editItem('employee', '${empId}')" class="text-blue-600 hover:text-blue-800 text-xs mobile-button p-1">‚úèÔ∏è</button>
                                    <button onclick="deleteItem('employee', '${empId}')" class="text-red-600 hover:text-red-800 text-xs mobile-button p-1">üóëÔ∏è</button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error in loadEmployeesTable:', error);
                const tbody = document.getElementById('employeesTable');
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-red-500">Error loading employees data</td></tr>';
                }
            }
        }

        async function loadStoresTable() {
            const tbody = document.getElementById('storesTable');
            
            if (stores.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-gray-500">No stores found. Click "Add Store" to create your first store.</td></tr>';
                return;
            }
            
            tbody.innerHTML = stores.filter(store => store && store.id).map(store => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="py-4 px-6">${store.name || 'N/A'}</td>
                    <td class="py-4 px-6">${store.location || 'N/A'}</td>
                    <td class="py-4 px-6">${store.manager || 'N/A'}</td>
                    <td class="py-4 px-6">${store.phone || 'N/A'}</td>
                    <td class="py-4 px-6">
                        <button onclick="editItem('store', '${store.id}')" class="text-blue-600 hover:text-blue-800 mr-3">Edit</button>
                        <button onclick="deleteItem('store', '${store.id}')" class="text-red-600 hover:text-red-800">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        async function loadProductsTable() {
            const tbody = document.getElementById('productsTable');
            
            if (products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="text-center py-8 text-gray-500">No products found. Click "Add Product" to create your first product.</td></tr>';
                return;
            }
            
            tbody.innerHTML = products.filter(product => product && product.id).map(product => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="py-4 px-6">${product.name || 'N/A'}</td>
                    <td class="py-4 px-6">${product.price || 0} DH</td>
                    <td class="py-4 px-6">
                        <button onclick="editItem('product', '${product.id}')" class="text-blue-600 hover:text-blue-800 mr-3">Edit</button>
                        <button onclick="deleteItem('product', '${product.id}')" class="text-red-600 hover:text-red-800">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        async function loadCollectionsTable() {
            const tbody = document.getElementById('collectionsTable');
            
            if (collections.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-gray-500">No collections found. Click "Add Collection" to create your first collection.</td></tr>';
                return;
            }
            
            tbody.innerHTML = collections.filter(collection => collection && collection.id).map(collection => {
                // Count products in this collection
                const productCount = collection.productIds ? collection.productIds.length : 0;
                const status = collection.status || 'active';
                const statusColor = status === 'active' ? 'text-green-600' : 'text-gray-500';
                
                return `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="py-4 px-6">${collection.name || 'N/A'}</td>
                        <td class="py-4 px-6">${collection.description || 'N/A'}</td>
                        <td class="py-4 px-6">${productCount}</td>
                        <td class="py-4 px-6 ${statusColor} capitalize">${status}</td>
                        <td class="py-4 px-6">
                            <button onclick="editItem('collection', '${collection.id}')" class="text-blue-600 hover:text-blue-800 mr-3">Edit</button>
                            <button onclick="deleteItem('collection', '${collection.id}')" class="text-red-600 hover:text-red-800">Delete</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Local-First Data Saving with Immediate Sync
        async function saveEmployee(employee) {
            // Always save locally first
            const isNew = !employee.id;
            if (isNew) {
                employee.id = Date.now().toString();
                employee.createdAt = new Date().toISOString();
            }
            employee.updatedAt = new Date().toISOString();
            
            const index = employees.findIndex(emp => emp.id === employee.id);
            if (index >= 0) {
                employees[index] = { ...employees[index], ...employee };
            } else {
                employees.push(employee);
            }
            saveLocalData();
            
            // Immediate Firebase sync if connected
            if (isFirebaseMode) {
                try {
                    showSyncFeedback('employee', isNew ? 'Creating' : 'Updating');
                    console.log('Immediately syncing employee to Firebase:', employee);
                    await syncEmployeeToFirebase(employee, isNew);
                    console.log('Employee synced successfully to Firebase');
                    
                    // Update sync status
                    syncStatus = 'synced';
                    lastSyncTime = new Date().toISOString();
                    updateSyncStatus();
                } catch (error) {
                    console.error('Immediate sync failed, queuing for retry:', error);
                    syncStatus = 'error';
                    updateSyncStatus();
                    queueForSync(isNew ? 'create' : 'update', 'employee', employee);
                }
            }
        }
        
        // Immediate Firebase sync function for employees
        async function syncEmployeeToFirebase(employee, isNew) {
            if (!db) throw new Error('Firebase not connected');
            
            const employeeData = {
                ...employee,
                localId: employee.id,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            if (isNew) {
                employeeData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
            }
            
            if (employee.firebaseId && !isNew) {
                // Update existing document
                await db.collection('employees').doc(employee.firebaseId).update(employeeData);
            } else {
                // Create new document
                const docRef = await db.collection('employees').add(employeeData);
                
                // Update local data with Firebase ID
                const localEmployee = employees.find(emp => emp.id === employee.id);
                if (localEmployee) {
                    localEmployee.firebaseId = docRef.id;
                    saveLocalData();
                }
            }
        }

        async function saveStore(store) {
            // Always save locally first
            const isNew = !store.id;
            if (isNew) {
                store.id = Date.now().toString();
                store.createdAt = new Date().toISOString();
            }
            store.updatedAt = new Date().toISOString();
            
            const index = stores.findIndex(s => s.id === store.id);
            if (index >= 0) {
                stores[index] = { ...stores[index], ...store };
            } else {
                stores.push(store);
            }
            saveLocalData();
            
            // Immediate Firebase sync if connected
            if (isFirebaseMode) {
                try {
                    showSyncFeedback('store', isNew ? 'Creating' : 'Updating');
                    await syncItemToFirebase('stores', store, isNew);
                } catch (error) {
                    console.error('Immediate sync failed, queuing for retry:', error);
                    syncStatus = 'error';
                    updateSyncStatus();
                    queueForSync(isNew ? 'create' : 'update', 'store', store);
                }
            }
        }

        async function saveProduct(product) {
            // Always save locally first
            const isNew = !product.id;
            if (isNew) {
                product.id = Date.now().toString();
                product.createdAt = new Date().toISOString();
            }
            product.updatedAt = new Date().toISOString();
            
            const index = products.findIndex(p => p.id === product.id);
            if (index >= 0) {
                products[index] = { ...products[index], ...product };
            } else {
                products.push(product);
            }
            saveLocalData();
            
            // Immediate Firebase sync if connected
            if (isFirebaseMode) {
                try {
                    showSyncFeedback('product', isNew ? 'Creating' : 'Updating');
                    await syncItemToFirebase('products', product, isNew);
                } catch (error) {
                    console.error('Immediate sync failed, queuing for retry:', error);
                    syncStatus = 'error';
                    updateSyncStatus();
                    queueForSync(isNew ? 'create' : 'update', 'product', product);
                }
            }
        }

        async function saveCollection(collection) {
            // Always save locally first
            const isNew = !collection.id;
            if (isNew) {
                collection.id = Date.now().toString();
                collection.createdAt = new Date().toISOString();
            }
            collection.updatedAt = new Date().toISOString();
            
            const index = collections.findIndex(c => c.id === collection.id);
            if (index >= 0) {
                collections[index] = { ...collections[index], ...collection };
            } else {
                collections.push(collection);
            }
            saveLocalData();
            
            // Immediate Firebase sync if connected
            if (isFirebaseMode) {
                try {
                    showSyncFeedback('collection', isNew ? 'Creating' : 'Updating');
                    await syncItemToFirebase('collections', collection, isNew);
                } catch (error) {
                    console.error('Immediate sync failed, queuing for retry:', error);
                    syncStatus = 'error';
                    updateSyncStatus();
                    queueForSync(isNew ? 'create' : 'update', 'collection', collection);
                }
            }
        }

        async function saveSale(sale) {
            // Always save locally first
            const isNew = !sale.id;
            if (isNew) {
                sale.id = Date.now().toString();
                sale.createdAt = new Date().toISOString();
            }
            sale.updatedAt = new Date().toISOString();
            
            const index = sales.findIndex(s => s.id === sale.id);
            if (index >= 0) {
                sales[index] = { ...sales[index], ...sale };
            } else {
                sales.push(sale);
            }
            saveLocalData();
            
            // Immediate Firebase sync if connected
            if (isFirebaseMode) {
                try {
                    showSyncFeedback('sale', isNew ? 'Recording' : 'Updating');
                    await syncItemToFirebase('sales', sale, isNew);
                } catch (error) {
                    console.error('Immediate sync failed, queuing for retry:', error);
                    syncStatus = 'error';
                    updateSyncStatus();
                    queueForSync(isNew ? 'create' : 'update', 'sale', sale);
                }
            }
        }
        
        // Generic immediate sync function for all data types
        async function syncItemToFirebase(collectionName, item, isNew) {
            if (!db) throw new Error('Firebase not connected');
            
            const itemData = {
                ...item,
                localId: item.id,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            if (isNew) {
                itemData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
            }
            
            if (item.firebaseId && !isNew) {
                // Update existing document
                await db.collection(collectionName).doc(item.firebaseId).update(itemData);
            } else {
                // Create new document
                const docRef = await db.collection(collectionName).add(itemData);
                
                // Update local data with Firebase ID
                const localArray = getCollectionByName(collectionName);
                const localItem = localArray.find(i => i.id === item.id);
                if (localItem) {
                    localItem.firebaseId = docRef.id;
                    saveLocalData();
                }
            }
            
            // Update sync status after successful sync
            syncStatus = 'synced';
            lastSyncTime = new Date().toISOString();
            updateSyncStatus();
        }
        
        // Helper function to get collection array by name
        function getCollectionByName(collectionName) {
            switch (collectionName) {
                case 'employees': return employees;
                case 'stores': return stores;
                case 'products': return products;
                case 'collections': return collections;
                case 'sales': return sales;
                default: return [];
            }
        }

        // Local-First Delete Functions
        async function deleteEmployee(id) {
            // Find the item to get Firebase ID if it exists
            const employee = employees.find(emp => emp.id === id);
            
            // Delete locally first
            employees = employees.filter(emp => emp.id !== id);
            saveLocalData();
            
            // Queue for Firebase sync if connected
            if (isFirebaseMode && employee) {
                queueForSync('delete', 'employee', employee);
            }
        }

        async function deleteStore(id) {
            const store = stores.find(s => s.id === id);
            
            stores = stores.filter(s => s.id !== id);
            saveLocalData();
            
            if (isFirebaseMode && store) {
                queueForSync('delete', 'store', store);
            }
        }

        async function deleteProduct(id) {
            const product = products.find(p => p.id === id);
            
            products = products.filter(p => p.id !== id);
            saveLocalData();
            
            if (isFirebaseMode && product) {
                queueForSync('delete', 'product', product);
            }
        }

        async function deleteCollection(id) {
            const collection = collections.find(c => c.id === id);
            
            collections = collections.filter(c => c.id !== id);
            saveLocalData();
            
            if (isFirebaseMode && collection) {
                queueForSync('delete', 'collection', collection);
            }
        }

        async function deleteSaleRecord(id) {
            const sale = sales.find(s => s.id === id);
            
            sales = sales.filter(s => s.id !== id);
            saveLocalData();
            
            if (isFirebaseMode && sale) {
                queueForSync('delete', 'sale', sale);
            }
        }

        // Utility Functions
        function getStoreName(storeId) {
            try {
                // Check if storeId is valid
                if (!storeId || storeId === null || storeId === undefined || storeId === '') {
                    return 'Unknown Store';
                }
                
                // Check if stores array is valid
                if (!stores || !Array.isArray(stores) || stores.length === 0) {
                    return 'Unknown Store';
                }
                
                // Find the store with comprehensive null checking
                const store = stores.find(s => {
                    return s && 
                           s !== null && 
                           s !== undefined && 
                           s.id && 
                           s.id !== null && 
                           s.id !== undefined && 
                           s.id.toString() === storeId.toString();
                });
                
                // Return store name with null checking
                if (store && store.name && typeof store.name === 'string' && store.name.trim() !== '') {
                    return store.name.trim();
                } else {
                    return 'Unknown Store';
                }
            } catch (error) {
                console.error('Error in getStoreName:', error, 'storeId:', storeId);
                return 'Unknown Store';
            }
        }

        function getProductName(productId) {
            try {
                // Check if productId is valid
                if (!productId || productId === null || productId === undefined || productId === '') {
                    return 'Unknown Product';
                }
                
                // Check if products array is valid
                if (!products || !Array.isArray(products) || products.length === 0) {
                    return 'Unknown Product';
                }
                
                // Find the product with comprehensive null checking
                const product = products.find(p => {
                    return p && 
                           p !== null && 
                           p !== undefined && 
                           p.id && 
                           p.id !== null && 
                           p.id !== undefined && 
                           p.id.toString() === productId.toString();
                });
                
                // Return product name with null checking
                if (product && product.name && typeof product.name === 'string' && product.name.trim() !== '') {
                    return product.name.trim();
                } else {
                    return 'Unknown Product';
                }
            } catch (error) {
                console.error('Error in getProductName:', error, 'productId:', productId);
                return 'Unknown Product';
            }
        }

        function getEmployeeName(employeeId) {
            try {
                // Check if employeeId is valid
                if (!employeeId || employeeId === null || employeeId === undefined || employeeId === '') {
                    return 'Unknown Employee';
                }
                
                // Check if employees array is valid
                if (!employees || !Array.isArray(employees) || employees.length === 0) {
                    return 'Unknown Employee';
                }
                
                // Find the employee with comprehensive null checking
                const employee = employees.find(e => {
                    return e && 
                           e !== null && 
                           e !== undefined && 
                           e.id && 
                           e.id !== null && 
                           e.id !== undefined && 
                           e.id.toString() === employeeId.toString();
                });
                
                // Return employee name with null checking
                if (employee && employee.name && typeof employee.name === 'string' && employee.name.trim() !== '') {
                    return employee.name.trim();
                } else {
                    return 'Unknown Employee';
                }
            } catch (error) {
                console.error('Error in getEmployeeName:', error, 'employeeId:', employeeId);
                return 'Unknown Employee';
            }
        }

        function getProduct(productId) {
            try {
                // Check if productId is valid
                if (!productId || productId === null || productId === undefined || productId === '') {
                    return null;
                }
                
                // Check if products array is valid
                if (!products || !Array.isArray(products) || products.length === 0) {
                    return null;
                }
                
                // Find the product with comprehensive null checking
                const product = products.find(p => {
                    return p && 
                           p !== null && 
                           p !== undefined && 
                           p.id && 
                           p.id !== null && 
                           p.id !== undefined && 
                           p.id.toString() === productId.toString();
                });
                
                // Return the product object or null
                return product || null;
            } catch (error) {
                console.error('Error in getProduct:', error, 'productId:', productId);
                return null;
            }
        }

        // Additional utility function to get store object
        function getStore(storeId) {
            try {
                // Check if storeId is valid
                if (!storeId || storeId === null || storeId === undefined || storeId === '') {
                    return null;
                }
                
                // Check if stores array is valid
                if (!stores || !Array.isArray(stores) || stores.length === 0) {
                    return null;
                }
                
                // Find the store with comprehensive null checking
                const store = stores.find(s => {
                    return s && 
                           s !== null && 
                           s !== undefined && 
                           s.id && 
                           s.id !== null && 
                           s.id !== undefined && 
                           s.id.toString() === storeId.toString();
                });
                
                // Return the store object or null
                return store || null;
            } catch (error) {
                console.error('Error in getStore:', error, 'storeId:', storeId);
                return null;
            }
        }

        // Additional utility function to get employee object
        function getEmployee(employeeId) {
            try {
                // Check if employeeId is valid
                if (!employeeId || employeeId === null || employeeId === undefined || employeeId === '') {
                    return null;
                }
                
                // Check if employees array is valid
                if (!employees || !Array.isArray(employees) || employees.length === 0) {
                    return null;
                }
                
                // Find the employee with comprehensive null checking
                const employee = employees.find(e => {
                    return e && 
                           e !== null && 
                           e !== undefined && 
                           e.id && 
                           e.id !== null && 
                           e.id !== undefined && 
                           e.id.toString() === employeeId.toString();
                });
                
                // Return the employee object or null
                return employee || null;
            } catch (error) {
                console.error('Error in getEmployee:', error, 'employeeId:', employeeId);
                return null;
            }
        }

        function getTodayString() {
            return new Date().toISOString().split('T')[0];
        }

        function getCurrentTime() {
            return new Date().toLocaleTimeString('en-US', { 
                hour12: false, 
                hour: '2-digit', 
                minute: '2-digit' 
            });
        }

        function updateCurrentDate(elementId) {
            const now = new Date();
            const dateString = now.toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            document.getElementById(elementId).textContent = dateString;
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96a7e87f5428f9ee',t:'MTc1NDQxMzgyOS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
