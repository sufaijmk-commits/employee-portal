<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eden Perfume - Sales Management System</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🌸</text></svg>">
    
    <!-- Firebase SDK with better error handling -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js" onerror="handleFirebaseLoadError('app')"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js" onerror="handleFirebaseLoadError('firestore')"></script>
    
    <style>
        /* Manual Tailwind CSS Configuration */
        /* Reset and Base Styles */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: #374151;
        }
        
        /* Utility Classes */
        .min-h-screen { min-height: 100vh; }
        .bg-gray-50 { background-color: #f9fafb; }
        .bg-white { background-color: #ffffff; }
        .bg-gray-100 { background-color: #f3f4f6; }
        .bg-gray-600 { background-color: #4b5563; }
        .bg-gray-700 { background-color: #374151; }
        .bg-blue-600 { background-color: #2563eb; }
        .bg-blue-700 { background-color: #1d4ed8; }
        .bg-green-600 { background-color: #16a34a; }
        .bg-green-700 { background-color: #15803d; }
        .bg-red-600 { background-color: #dc2626; }
        .bg-red-700 { background-color: #b91c1c; }
        .bg-purple-600 { background-color: #9333ea; }
        .bg-purple-700 { background-color: #7c3aed; }
        .bg-orange-600 { background-color: #ea580c; }
        .bg-orange-700 { background-color: #c2410c; }
        .bg-yellow-600 { background-color: #ca8a04; }
        .bg-yellow-700 { background-color: #a16207; }
        .bg-yellow-50 { background-color: #fefce8; }
        .bg-green-100 { background-color: #dcfce7; }
        .bg-blue-100 { background-color: #dbeafe; }
        .bg-purple-100 { background-color: #f3e8ff; }
        
        .text-white { color: #ffffff; }
        .text-gray-500 { color: #6b7280; }
        .text-gray-600 { color: #4b5563; }
        .text-gray-700 { color: #374151; }
        .text-gray-800 { color: #1f2937; }
        .text-blue-600 { color: #2563eb; }
        .text-blue-800 { color: #1e40af; }
        .text-green-600 { color: #16a34a; }
        .text-green-800 { color: #166534; }
        .text-red-600 { color: #dc2626; }
        .text-red-800 { color: #991b1b; }
        .text-purple-600 { color: #9333ea; }
        .text-yellow-600 { color: #ca8a04; }
        .text-yellow-700 { color: #a16207; }
        .text-yellow-800 { color: #92400e; }
        .text-red-500 { color: #ef4444; }
        
        .p-4 { padding: 1rem; }
        .p-6 { padding: 1.5rem; }
        .p-8 { padding: 2rem; }
        .px-3 { padding-left: 0.75rem; padding-right: 0.75rem; }
        .px-4 { padding-left: 1rem; padding-right: 1rem; }
        .px-6 { padding-left: 1.5rem; padding-right: 1.5rem; }
        .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
        .py-3 { padding-top: 0.75rem; padding-bottom: 0.75rem; }
        .py-4 { padding-top: 1rem; padding-bottom: 1rem; }
        .py-8 { padding-top: 2rem; padding-bottom: 2rem; }
        
        .m-4 { margin: 1rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mb-6 { margin-bottom: 1.5rem; }
        .mb-8 { margin-bottom: 2rem; }
        .mt-1 { margin-top: 0.25rem; }
        .mt-2 { margin-top: 0.5rem; }
        .mt-6 { margin-top: 1.5rem; }
        .mt-8 { margin-top: 2rem; }
        .mr-3 { margin-right: 0.75rem; }
        .ml-2 { margin-left: 0.5rem; }
        .mx-auto { margin-left: auto; margin-right: auto; }
        
        .w-full { width: 100%; }
        .w-10 { width: 2.5rem; }
        .w-12 { width: 3rem; }
        .w-20 { width: 5rem; }
        .max-w-md { max-width: 28rem; }
        .max-w-2xl { max-width: 42rem; }
        .max-h-40 { max-height: 10rem; }
        
        .h-10 { height: 2.5rem; }
        .h-12 { height: 3rem; }
        .h-20 { height: 5rem; }
        
        .flex { display: flex; }
        .flex-1 { flex: 1 1 0%; }
        .flex-wrap { flex-wrap: wrap; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .justify-center { justify-content: center; }
        .space-x-2 > * + * { margin-left: 0.5rem; }
        .space-x-3 > * + * { margin-left: 0.75rem; }
        .space-y-1 > * + * { margin-top: 0.25rem; }
        .space-y-4 > * + * { margin-top: 1rem; }
        .space-y-6 > * + * { margin-top: 1.5rem; }
        
        .grid { display: grid; }
        .grid-cols-1 { grid-template-columns: repeat(1, minmax(0, 1fr)); }
        .grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
        .grid-cols-5 { grid-template-columns: repeat(5, minmax(0, 1fr)); }
        .gap-2 { gap: 0.5rem; }
        .gap-4 { gap: 1rem; }
        .gap-6 { gap: 1.5rem; }
        
        .rounded-lg { border-radius: 0.5rem; }
        .rounded-xl { border-radius: 0.75rem; }
        .rounded-2xl { border-radius: 1rem; }
        .rounded-full { border-radius: 9999px; }
        
        .border { border-width: 1px; }
        .border-b { border-bottom-width: 1px; }
        .border-b-2 { border-bottom-width: 2px; }
        .border-t-2 { border-top-width: 2px; }
        .border-gray-300 { border-color: #d1d5db; }
        .border-gray-400 { border-color: #9ca3af; }
        .border-purple-500 { border-color: #a855f7; }
        .border-transparent { border-color: transparent; }
        .border-yellow-200 { border-color: #fde047; }
        
        .font-medium { font-weight: 500; }
        .font-semibold { font-weight: 600; }
        .font-bold { font-weight: 700; }
        
        .text-xs { font-size: 0.75rem; }
        .text-sm { font-size: 0.875rem; }
        .text-lg { font-size: 1.125rem; }
        .text-xl { font-size: 1.25rem; }
        .text-2xl { font-size: 1.5rem; }
        .text-3xl { font-size: 1.875rem; }
        
        .text-left { text-align: left; }
        .text-center { text-align: center; }
        
        .capitalize { text-transform: capitalize; }
        .whitespace-nowrap { white-space: nowrap; }
        
        .overflow-hidden { overflow: hidden; }
        .overflow-x-auto { overflow-x: auto; }
        .overflow-y-auto { overflow-y: auto; }
        
        .fixed { position: fixed; }
        .inset-0 { top: 0; right: 0; bottom: 0; left: 0; }
        
        .z-50 { z-index: 50; }
        
        .hidden { display: none; }
        .block { display: block; }
        
        .opacity-70 { opacity: 0.7; }
        .opacity-80 { opacity: 0.8; }
        .opacity-90 { opacity: 0.9; }
        .bg-opacity-20 { background-color: rgba(255, 255, 255, 0.2); }
        .bg-opacity-30 { background-color: rgba(255, 255, 255, 0.3); }
        
        .transition { transition-property: color, background-color, border-color, text-decoration-color, fill, stroke, opacity, box-shadow, transform, filter, backdrop-filter; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 150ms; }
        
        .hover\:bg-gray-50:hover { background-color: #f9fafb; }
        .hover\:bg-gray-700:hover { background-color: #374151; }
        .hover\:bg-blue-700:hover { background-color: #1d4ed8; }
        .hover\:bg-green-700:hover { background-color: #15803d; }
        .hover\:bg-red-700:hover { background-color: #b91c1c; }
        .hover\:bg-purple-700:hover { background-color: #7c3aed; }
        .hover\:bg-orange-700:hover { background-color: #c2410c; }
        .hover\:bg-yellow-700:hover { background-color: #a16207; }
        .hover\:bg-red-800:hover { background-color: #991b1b; }
        .hover\:text-blue-800:hover { color: #1e40af; }
        .hover\:text-red-800:hover { color: #991b1b; }
        .hover\:text-green-800:hover { color: #166534; }
        .hover\:border-purple-500:hover { border-color: #a855f7; }
        .hover\:opacity-90:hover { opacity: 0.9; }
        .hover\:opacity-30:hover { opacity: 0.3; }
        
        .focus\:ring-2:focus { box-shadow: 0 0 0 2px rgba(168, 85, 247, 0.5); }
        .focus\:ring-purple-500:focus { box-shadow: 0 0 0 2px rgba(168, 85, 247, 0.5); }
        .focus\:border-transparent:focus { border-color: transparent; }
        
        /* Form Elements */
        input, select, textarea {
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            line-height: 1.25rem;
            width: 100%;
            background-color: #ffffff;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #a855f7;
            box-shadow: 0 0 0 2px rgba(168, 85, 247, 0.2);
        }
        
        button {
            border: none;
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s ease;
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Table Styles */
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            text-align: left;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #e5e7eb;
        }
        
        th {
            background-color: #f9fafb;
            font-weight: 500;
            color: #374151;
        }
        
        tr:hover {
            background-color: #f9fafb;
        }
        
        /* Responsive Design */
        @media (min-width: 768px) {
            .md\:grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
            .md\:grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
            .md\:grid-cols-5 { grid-template-columns: repeat(5, minmax(0, 1fr)); }
        }
        
        @media (min-width: 1024px) {
            .lg\:grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
            .lg\:grid-cols-4 { grid-template-columns: repeat(4, minmax(0, 1fr)); }
        }
        
        /* Custom Component Styles */
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .card-shadow {
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .tab-active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Firebase Configuration Modal -->
    <div id="firebaseConfigModal" class="fixed inset-0 modal-backdrop z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl card-shadow w-full max-w-2xl fade-in">
            <div class="p-6 border-b">
                <h3 class="text-xl font-semibold">🔥 Firebase Configuration Required</h3>
                <p class="text-gray-600 mt-2">Please enter your Firebase configuration to connect to your database.</p>
            </div>
            <div class="p-6">
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
                    <h4 class="font-semibold text-yellow-800 mb-2">📋 How to get your Firebase config:</h4>
                    <ol class="text-sm text-yellow-700 space-y-1">
                        <li>1. Go to Firebase Console → Project Settings</li>
                        <li>2. Scroll down to "Your apps" section</li>
                        <li>3. Click on your web app or create one</li>
                        <li>4. Copy the config object values</li>
                    </ol>
                </div>
                
                <form id="firebaseConfigForm" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">API Key</label>
                            <input type="text" id="apiKey" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="AIza..." required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Auth Domain</label>
                            <input type="text" id="authDomain" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="your-project.firebaseapp.com" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Project ID</label>
                            <input type="text" id="projectId" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="your-project-id" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Storage Bucket</label>
                            <input type="text" id="storageBucket" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="your-project.appspot.com" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Messaging Sender ID</label>
                            <input type="text" id="messagingSenderId" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="123456789" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">App ID</label>
                            <input type="text" id="appId" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="1:123:web:abc" required>
                        </div>
                    </div>
                    
                    <div class="flex space-x-3 mt-6">
                        <button type="button" onclick="loadDemoConfig()" class="flex-1 bg-gray-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-gray-700 transition">
                            Use Demo Mode (Local Storage)
                        </button>
                        <button type="submit" class="flex-1 gradient-bg text-white px-4 py-2 rounded-lg font-semibold hover:opacity-90 transition">
                            <span id="connectBtnText">Connect to Firebase</span>
                            <div id="connectLoader" class="loading hidden ml-2"></div>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="hidden min-h-screen gradient-bg flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl card-shadow p-8 w-full max-w-md fade-in">
            <div class="text-center mb-8">
                <div class="w-20 h-20 mx-auto mb-4 bg-gradient-to-r from-purple-500 to-pink-500 rounded-full flex items-center justify-center">
                    <svg class="w-10 h-10 text-white" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </div>
                <h1 class="text-3xl font-bold text-gray-800 mb-2">EDEN PERFUME</h1>
                <p class="text-gray-600">Sales Management System</p>
                <div class="mt-2 text-sm" id="dbStatus">
                    <div id="dbMode" class="text-green-600"></div>
                    <div id="syncStatus" class="text-xs mt-1"></div>
                </div>
            </div>
            
            <form id="loginForm" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                    <input type="text" id="username" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Enter username">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                    <input type="password" id="password" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Enter password">
                </div>
                
                <button type="submit" class="w-full gradient-bg text-white py-3 rounded-lg font-semibold hover:opacity-90 transition">
                    <span id="loginBtnText">Sign In</span>
                    <div id="loginLoader" class="loading hidden ml-2"></div>
                </button>
            </form>
            
            <div class="mt-8 p-4 bg-gray-50 rounded-lg">
                <p class="text-sm font-medium text-gray-700 mb-2">Demo Credentials:</p>
                <div class="text-xs text-gray-600 space-y-1">
                    <p><strong>Admin:</strong> admin / admin123</p>
                    <p><strong>Employee:</strong> Create employees first, then use their credentials</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Employee Portal -->
    <div id="employeePortal" class="hidden min-h-screen bg-gray-50">
        <nav class="gradient-bg text-white p-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z"/>
                        </svg>
                    </div>
                    <div>
                        <h2 class="font-semibold" id="employeeName">Employee</h2>
                        <p class="text-sm opacity-80" id="employeeStore">Store</p>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <div class="text-sm opacity-80" id="employeeCurrentDate"></div>
                    <div class="text-xs opacity-70" id="employeeSyncStatus">📱 Local Mode</div>
                    <button onclick="refreshData()" class="bg-blue-600 px-3 py-2 rounded-lg hover:bg-blue-700 transition font-semibold text-sm">
                        🔄 Refresh
                    </button>
                    <button onclick="quickAddSale()" class="bg-green-600 px-3 py-2 rounded-lg hover:bg-green-700 transition font-semibold text-sm">
                        ➕ Quick Sale
                    </button>
                    <button onclick="viewTodaysSummary()" class="bg-purple-600 px-3 py-2 rounded-lg hover:bg-purple-700 transition font-semibold text-sm">
                        📊 Summary
                    </button>
                    <button onclick="logout()" class="bg-white bg-opacity-20 px-3 py-2 rounded-lg hover:bg-opacity-30 transition text-sm">
                        Logout
                    </button>
                </div>
            </div>
        </nav>

        <div class="p-6">
            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white rounded-xl card-shadow p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-600 text-sm">Total Sales Today</p>
                            <p class="text-2xl font-bold text-green-600" id="totalSalesToday">$0</p>
                        </div>
                        <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                            <svg class="w-6 h-6 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10a2 2 0 00-2-2H4zm2 6a2 2 0 012-2h8a2 2 0 012 2v4a2 2 0 01-2 2H8a2 2 0 01-2-2v-4zm6 4a2 2 0 100-4 2 2 0 000 4z"/>
                            </svg>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl card-shadow p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-600 text-sm">Bottles Sold</p>
                            <p class="text-2xl font-bold text-blue-600" id="bottlesSold">0</p>
                        </div>
                        <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                            <svg class="w-6 h-6 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
                            </svg>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl card-shadow p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-600 text-sm">Estimated Salary</p>
                            <p class="text-2xl font-bold text-purple-600" id="estimatedSalary">$0</p>
                        </div>
                        <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center">
                            <svg class="w-6 h-6 text-purple-600" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M8.433 7.418c.155-.103.346-.196.567-.267v1.698a2.305 2.305 0 01-.567-.267C8.07 8.34 8 8.114 8 8c0-.114.07-.34.433-.582zM11 12.849v-1.698c.22.071.412.164.567.267.364.243.433.468.433.582 0 .114-.07.34-.433.582a2.305 2.305 0 01-.567.267z"/>
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-13a1 1 0 10-2 0v.092a4.535 4.535 0 00-1.676.662C6.602 6.234 6 7.009 6 8c0 .99.602 1.765 1.324 2.246.48.32 1.054.545 1.676.662v1.941c-.391-.127-.68-.317-.843-.504a1 1 0 10-1.51 1.31c.562.649 1.413 1.076 2.353 1.253V15a1 1 0 102 0v-.092a4.535 4.535 0 001.676-.662C13.398 13.766 14 12.991 14 12c0-.99-.602-1.765-1.324-2.246A4.535 4.535 0 0011 9.092V7.151c.391.127.68.317.843.504a1 1 0 101.511-1.31c-.563-.649-1.413-1.076-2.354-1.253V5z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Add Sale Form -->
            <div class="bg-white rounded-xl card-shadow p-6 mb-8">
                <h3 class="text-xl font-semibold mb-6">Add New Sale</h3>
                <form id="addSaleForm" class="grid grid-cols-1 md:grid-cols-5 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Date</label>
                        <input type="date" id="saleDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Store</label>
                        <select id="saleStore" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" required>
                            <option value="">Select Store</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Product</label>
                        <select id="saleProduct" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" required>
                            <option value="">Select Product</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Quantity</label>
                        <input type="number" id="saleQuantity" min="1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="1" required>
                    </div>
                    <div class="flex items-end">
                        <button type="submit" class="w-full gradient-bg text-white py-2 rounded-lg font-semibold hover:opacity-90 transition">
                            Add Sale
                        </button>
                    </div>
                </form>
            </div>

            <!-- Today's Sales -->
            <div class="bg-white rounded-xl card-shadow p-6">
                <h3 class="text-xl font-semibold mb-6">Today's Sales</h3>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b">
                                <th class="text-left py-3 px-4">Time</th>
                                <th class="text-left py-3 px-4">Store</th>
                                <th class="text-left py-3 px-4">Product</th>
                                <th class="text-left py-3 px-4">Quantity</th>
                                <th class="text-left py-3 px-4">Amount</th>
                                <th class="text-left py-3 px-4">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="todaysSalesTable">
                            <tr>
                                <td colspan="5" class="text-center py-8 text-gray-500">No sales recorded today</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="dashboard" class="hidden min-h-screen bg-gray-50">
        <nav class="gradient-bg text-white p-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </div>
                    <div>
                        <h2 class="font-semibold">Eden Perfume Admin</h2>
                        <p class="text-sm opacity-80">Management Dashboard</p>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <div class="text-sm opacity-80" id="adminCurrentDate"></div>
                    <div class="text-xs opacity-70" id="adminSyncStatus">📱 Local Mode</div>
                    <button onclick="refreshData()" class="bg-blue-600 px-3 py-2 rounded-lg hover:bg-blue-700 transition font-semibold text-sm">
                        🔄 Refresh
                    </button>
                    <button onclick="forceSyncNow()" class="bg-orange-600 px-3 py-2 rounded-lg hover:bg-orange-700 transition font-semibold text-sm">
                        🔄 Sync Now
                    </button>
                    <button onclick="resetFirebaseConfig()" class="bg-red-600 px-3 py-2 rounded-lg hover:bg-red-700 transition font-semibold text-sm">
                        🔥 Setup Firebase
                    </button>
                    <button onclick="viewTodaysSummary()" class="bg-purple-600 px-3 py-2 rounded-lg hover:bg-purple-700 transition font-semibold text-sm">
                        📊 Today's Summary
                    </button>
                    <button onclick="backupData()" class="bg-yellow-600 px-3 py-2 rounded-lg hover:bg-yellow-700 transition font-semibold text-sm">
                        💾 Backup
                    </button>
                    <button onclick="downloadAllMasterData()" class="bg-green-600 px-3 py-2 rounded-lg hover:bg-green-700 transition font-semibold text-sm">
                        📥 Download All
                    </button>
                    <button onclick="logout()" class="bg-white bg-opacity-20 px-3 py-2 rounded-lg hover:bg-opacity-30 transition text-sm">
                        Logout
                    </button>
                </div>
            </div>
        </nav>

        <!-- Tab Navigation -->
        <div class="bg-white border-b">
            <div class="flex space-x-0 overflow-x-auto">
                <button onclick="switchTab('employees')" class="tab-btn px-6 py-4 font-medium whitespace-nowrap border-b-2 border-transparent hover:border-purple-500 transition" data-tab="employees">
                    Employees
                </button>
                <button onclick="switchTab('stores')" class="tab-btn px-6 py-4 font-medium whitespace-nowrap border-b-2 border-transparent hover:border-purple-500 transition" data-tab="stores">
                    Stores
                </button>
                <button onclick="switchTab('products')" class="tab-btn px-6 py-4 font-medium whitespace-nowrap border-b-2 border-transparent hover:border-purple-500 transition" data-tab="products">
                    Products
                </button>
                <button onclick="switchTab('collections')" class="tab-btn px-6 py-4 font-medium whitespace-nowrap border-b-2 border-transparent hover:border-purple-500 transition" data-tab="collections">
                    Collections
                </button>
                <button onclick="switchTab('database')" class="tab-btn px-6 py-4 font-medium whitespace-nowrap border-b-2 border-transparent hover:border-purple-500 transition" data-tab="database">
                    Database Manager
                </button>
                <button onclick="switchTab('sales')" class="tab-btn px-6 py-4 font-medium whitespace-nowrap border-b-2 border-transparent hover:border-purple-500 transition" data-tab="sales">
                    Sales Reports
                </button>
                <button onclick="switchTab('salary')" class="tab-btn px-6 py-4 font-medium whitespace-nowrap border-b-2 border-transparent hover:border-purple-500 transition" data-tab="salary">
                    Salary Reports
                </button>
            </div>
        </div>

        <!-- Tab Content -->
        <div class="p-6">
            <!-- Employees Tab -->
            <div id="employees-tab" class="tab-content">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Employee Management</h2>
                    <div class="flex space-x-2">
                        <button onclick="restoreData()" class="bg-orange-600 text-white px-3 py-2 rounded-lg font-semibold hover:bg-orange-700 transition text-sm">
                            📤 Restore
                        </button>
                        <button onclick="clearAllData()" class="bg-red-600 text-white px-3 py-2 rounded-lg font-semibold hover:bg-red-700 transition text-sm">
                            🗑️ Clear All
                        </button>
                        <button onclick="openModal('employee')" class="gradient-bg text-white px-4 py-2 rounded-lg font-semibold hover:opacity-90 transition">
                            ➕ Add Employee
                        </button>
                    </div>
                </div>
                <div class="bg-white rounded-xl card-shadow overflow-hidden">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="text-left py-4 px-6">Name</th>
                                <th class="text-left py-4 px-6">Username</th>
                                <th class="text-left py-4 px-6">Store</th>
                                <th class="text-left py-4 px-6">Salary Type</th>
                                <th class="text-left py-4 px-6">Base Salary</th>
                                <th class="text-left py-4 px-6">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="employeesTable">
                            <tr>
                                <td colspan="6" class="text-center py-8 text-gray-500">
                                    No employees found. Click "Add Employee" to create your first employee.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Stores Tab -->
            <div id="stores-tab" class="tab-content hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Store Management</h2>
                    <button onclick="openModal('store')" class="gradient-bg text-white px-4 py-2 rounded-lg font-semibold hover:opacity-90 transition">
                        ➕ Add Store
                    </button>
                </div>
                <div class="bg-white rounded-xl card-shadow overflow-hidden">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="text-left py-4 px-6">Store Name</th>
                                <th class="text-left py-4 px-6">Location</th>
                                <th class="text-left py-4 px-6">Manager</th>
                                <th class="text-left py-4 px-6">Phone</th>
                                <th class="text-left py-4 px-6">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="storesTable">
                            <tr>
                                <td colspan="5" class="text-center py-8 text-gray-500">
                                    No stores found. Click "Add Store" to create your first store.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Products Tab -->
            <div id="products-tab" class="tab-content hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Product Management</h2>
                    <button onclick="openModal('product')" class="gradient-bg text-white px-4 py-2 rounded-lg font-semibold hover:opacity-90 transition">
                        ➕ Add Product
                    </button>
                </div>
                <div class="bg-white rounded-xl card-shadow overflow-hidden">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="text-left py-4 px-6">Product Name</th>
                                <th class="text-left py-4 px-6">Price</th>
                                <th class="text-left py-4 px-6">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="productsTable">
                            <tr>
                                <td colspan="3" class="text-center py-8 text-gray-500">
                                    No products found. Click "Add Product" to create your first product.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Collections Tab -->
            <div id="collections-tab" class="tab-content hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Collection Management</h2>
                    <button onclick="openModal('collection')" class="gradient-bg text-white px-4 py-2 rounded-lg font-semibold hover:opacity-90 transition">
                        ➕ Add Collection
                    </button>
                </div>
                <div class="bg-white rounded-xl card-shadow overflow-hidden">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="text-left py-4 px-6">Collection Name</th>
                                <th class="text-left py-4 px-6">Description</th>
                                <th class="text-left py-4 px-6">Products Count</th>
                                <th class="text-left py-4 px-6">Status</th>
                                <th class="text-left py-4 px-6">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="collectionsTable">
                            <tr>
                                <td colspan="5" class="text-center py-8 text-gray-500">
                                    No collections found. Click "Add Collection" to create your first collection.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Database Manager Tab -->
            <div id="database-tab" class="tab-content hidden">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold mb-4">Database Collection Manager</h2>
                    <p class="text-gray-600 mb-6">Directly manage your database collections. Add, edit, or delete data entries in real-time.</p>
                    
                    <!-- Collection Selector -->
                    <div class="bg-white rounded-xl card-shadow p-6 mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Select Collection</label>
                                <select id="dbCollectionSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" onchange="loadDatabaseCollection()">
                                    <option value="">Choose a collection...</option>
                                    <option value="employees">Employees</option>
                                    <option value="stores">Stores</option>
                                    <option value="products">Products</option>
                                    <option value="collections">Collections</option>
                                    <option value="sales">Sales</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Database Status</label>
                                <div class="px-3 py-2 bg-gray-50 rounded-lg">
                                    <span id="dbConnectionStatus" class="text-sm">📱 Local Mode</span>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Actions</label>
                                <div class="flex space-x-2">
                                    <button onclick="addDatabaseEntry()" class="bg-green-600 text-white px-3 py-2 rounded-lg hover:bg-green-700 transition text-sm">
                                        ➕ Add Entry
                                    </button>
                                    <button onclick="refreshDatabaseView()" class="bg-blue-600 text-white px-3 py-2 rounded-lg hover:bg-blue-700 transition text-sm">
                                        🔄 Refresh
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Database Table View -->
                <div class="bg-white rounded-xl card-shadow overflow-hidden">
                    <div class="p-4 bg-gray-50 border-b">
                        <h3 id="dbTableTitle" class="text-lg font-semibold">Select a collection to view data</h3>
                        <p id="dbTableCount" class="text-sm text-gray-600 mt-1">0 entries</p>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-100">
                                <tr id="dbTableHeader">
                                    <th class="text-left py-3 px-4 text-sm font-medium text-gray-700">Select a collection</th>
                                </tr>
                            </thead>
                            <tbody id="dbTableBody">
                                <tr>
                                    <td class="text-center py-8 text-gray-500">Select a collection from the dropdown above</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Sales Reports Tab -->
            <div id="sales-tab" class="tab-content hidden">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold mb-4">Sales Reports</h2>
                    
                    <!-- Report Controls -->
                    <div class="bg-white rounded-xl card-shadow p-6 mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Start Date</label>
                                <input type="date" id="reportStartDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">End Date</label>
                                <input type="date" id="reportEndDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Report Type</label>
                                <select id="reportType" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                    <option value="all">All Sales</option>
                                    <option value="daily">Daily Report</option>
                                    <option value="monthly">Monthly Report</option>
                                    <option value="store">Store Wise</option>
                                    <option value="staff">Staff Wise</option>
                                    <option value="product">Product Wise</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Filter By</label>
                                <select id="reportFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                    <option value="">All</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="flex flex-wrap gap-2">
                            <button onclick="generateSalesReport()" class="gradient-bg text-white px-4 py-2 rounded-lg font-semibold hover:opacity-90 transition">
                                📊 Generate Report
                            </button>
                            <button onclick="printReport('sales')" class="bg-gray-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-gray-700 transition">
                                🖨️ Print
                            </button>
                            <button onclick="downloadExcel('sales')" class="bg-green-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-700 transition">
                                📊 Excel
                            </button>
                            <button onclick="downloadPDF('sales')" class="bg-red-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-red-700 transition">
                                📄 PDF
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-xl card-shadow overflow-hidden">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr id="salesReportHeader">
                                <th class="text-left py-4 px-6">Date</th>
                                <th class="text-left py-4 px-6">Employee</th>
                                <th class="text-left py-4 px-6">Store</th>
                                <th class="text-left py-4 px-6">Product</th>
                                <th class="text-left py-4 px-6">Quantity</th>
                                <th class="text-left py-4 px-6">Amount</th>
                            </tr>
                        </thead>
                        <tbody id="salesReportTable">
                            <tr>
                                <td colspan="6" class="text-center py-8 text-gray-500">Select date range and report type to generate report</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Salary Reports Tab -->
            <div id="salary-tab" class="tab-content hidden">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold mb-4">Salary Reports</h2>
                    
                    <!-- Salary Report Controls -->
                    <div class="bg-white rounded-xl card-shadow p-6 mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Start Date</label>
                                <input type="date" id="salaryStartDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">End Date</label>
                                <input type="date" id="salaryEndDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Employee</label>
                                <select id="salaryEmployee" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                    <option value="">All Employees</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="flex flex-wrap gap-2">
                            <button onclick="generateSalaryReport()" class="gradient-bg text-white px-4 py-2 rounded-lg font-semibold hover:opacity-90 transition">
                                💰 Generate Report
                            </button>
                            <button onclick="printReport('salary')" class="bg-gray-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-gray-700 transition">
                                🖨️ Print
                            </button>
                            <button onclick="downloadExcel('salary')" class="bg-green-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-700 transition">
                                📊 Excel
                            </button>
                            <button onclick="downloadPDF('salary')" class="bg-red-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-red-700 transition">
                                📄 PDF
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-xl card-shadow overflow-hidden">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="text-left py-4 px-6">Employee</th>
                                <th class="text-left py-4 px-6">Salary Type</th>
                                <th class="text-left py-4 px-6">Base Salary</th>
                                <th class="text-left py-4 px-6">Bonus/Commission</th>
                                <th class="text-left py-4 px-6">Total Sales</th>
                                <th class="text-left py-4 px-6">Days/Qty</th>
                                <th class="text-left py-4 px-6">Total Salary</th>
                            </tr>
                        </thead>
                        <tbody id="salaryReportTable">
                            <tr>
                                <td colspan="7" class="text-center py-8 text-gray-500">Select date range to generate report</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="modal" class="hidden fixed inset-0 modal-backdrop z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl card-shadow w-full max-w-md fade-in">
            <div class="p-6 border-b">
                <h3 id="modalTitle" class="text-xl font-semibold">Add Item</h3>
            </div>
            <div class="p-6">
                <form id="modalForm">
                    <div id="modalFields" class="space-y-4">
                        <!-- Dynamic fields will be inserted here -->
                    </div>
                    <div class="flex space-x-3 mt-6">
                        <button type="button" onclick="closeModal()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition">
                            Cancel
                        </button>
                        <button type="submit" class="flex-1 gradient-bg text-white px-4 py-2 rounded-lg font-semibold hover:opacity-90 transition">
                            <span id="saveBtnText">Save</span>
                            <div id="saveLoader" class="loading hidden ml-2"></div>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Firebase loading error handler
        function handleFirebaseLoadError(component) {
            console.warn(`Firebase ${component} failed to load - falling back to local mode`);
            window.firebaseLoadError = true;
        }

        // Global Variables
        let db = null;
        let isFirebaseMode = false;
        let currentUser = null;
        let currentUserRole = null;
        let editingItem = null;
        let editingType = null;

        // Local Storage Data (Always used as primary storage)
        let employees = [];
        let stores = [];
        let products = [];
        let collections = [];
        let sales = [];

        // Initialize arrays safely
        function initializeArrays() {
            if (!Array.isArray(employees)) employees = [];
            if (!Array.isArray(stores)) stores = [];
            if (!Array.isArray(products)) products = [];
            if (!Array.isArray(collections)) collections = [];
            if (!Array.isArray(sales)) sales = [];
        }

        // Sync Management
        let syncQueue = [];
        let isSyncing = false;
        let lastSyncTime = null;
        let syncStatus = 'offline';

        // Firebase Configuration
        async function initializeFirebase(config) {
            try {
                // Check if Firebase is available and loaded properly
                if (typeof firebase === 'undefined' || window.firebaseLoadError) {
                    console.warn('Firebase SDK not available, falling back to local mode');
                    throw new Error('Firebase SDK not loaded. Please check your internet connection and try again.');
                }
                
                // Validate config object
                if (!config || typeof config !== 'object') {
                    throw new Error('Invalid Firebase configuration');
                }
                
                // Check if Firebase is already initialized
                if (firebase.apps.length > 0) {
                    // Delete existing app to reinitialize with new config
                    await firebase.app().delete();
                }
                
                // Initialize Firebase with new config
                const app = firebase.initializeApp(config);
                db = firebase.firestore();
                
                // Test the connection by trying to access Firestore
                await db.enableNetwork();
                
                // Try to read from a test collection to verify connection
                try {
                    await db.collection('test').limit(1).get();
                } catch (testError) {
                    console.warn('Firestore test read failed, but connection established:', testError.message);
                }
                
                isFirebaseMode = true;
                syncStatus = 'connected';
                updateSyncStatus();
                document.getElementById('dbMode').textContent = '🔥 Firebase Connected';
                
                // Start background sync
                startBackgroundSync();
                return true;
            } catch (error) {
                console.error('Firebase initialization error:', error);
                isFirebaseMode = false;
                db = null;
                syncStatus = 'offline';
                updateSyncStatus();
                
                // Provide more specific error messages
                let errorMessage = 'Failed to connect to Firebase: ';
                if (error.code === 'auth/invalid-api-key') {
                    errorMessage += 'Invalid API key. Please check your Firebase configuration.';
                } else if (error.code === 'auth/project-not-found') {
                    errorMessage += 'Project not found. Please check your Project ID.';
                } else if (error.message.includes('network')) {
                    errorMessage += 'Network error. Please check your internet connection.';
                } else {
                    errorMessage += error.message;
                }
                
                throw new Error(errorMessage);
            }
        }

        // Firebase Configuration Form
        document.getElementById('firebaseConfigForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const connectBtn = document.getElementById('connectBtnText');
            const loader = document.getElementById('connectLoader');
            
            connectBtn.textContent = 'Connecting...';
            loader.classList.remove('hidden');
            
            const config = {
                apiKey: document.getElementById('apiKey').value.trim(),
                authDomain: document.getElementById('authDomain').value.trim(),
                projectId: document.getElementById('projectId').value.trim(),
                storageBucket: document.getElementById('storageBucket').value.trim(),
                messagingSenderId: document.getElementById('messagingSenderId').value.trim(),
                appId: document.getElementById('appId').value.trim()
            };
            
            // Validate all fields are filled
            const requiredFields = ['apiKey', 'authDomain', 'projectId', 'storageBucket', 'messagingSenderId', 'appId'];
            const missingFields = requiredFields.filter(field => !config[field]);
            
            if (missingFields.length > 0) {
                alert('Please fill in all required fields: ' + missingFields.join(', '));
                connectBtn.textContent = 'Connect to Firebase';
                loader.classList.add('hidden');
                return;
            }
            
            try {
                // Save config to localStorage for future use
                localStorage.setItem('firebaseConfig', JSON.stringify(config));
                
                if (await initializeFirebase(config)) {
                    document.getElementById('firebaseConfigModal').classList.add('hidden');
                    document.getElementById('loginScreen').classList.remove('hidden');
                    await loadAllData();
                    alert('Successfully connected to Firebase!');
                } else {
                    throw new Error('Firebase initialization failed');
                }
            } catch (error) {
                console.error('Firebase connection error:', error);
                alert('Failed to connect to Firebase: ' + error.message + '\n\nPlease check your configuration and try again.');
            }
            
            connectBtn.textContent = 'Connect to Firebase';
            loader.classList.add('hidden');
        });

        // Demo Mode
        function loadDemoConfig() {
            isFirebaseMode = false;
            syncStatus = 'offline';
            updateSyncStatus();
            document.getElementById('dbMode').textContent = '💾 Local Storage Mode';
            document.getElementById('firebaseConfigModal').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            loadLocalData();
        }

        // Sync Status Management
        function updateSyncStatus() {
            const statusElements = ['syncStatus', 'employeeSyncStatus', 'adminSyncStatus'];
            let statusText = '';
            let statusColor = '';
            
            switch(syncStatus) {
                case 'connected':
                    statusText = '🔄 Syncing...';
                    statusColor = 'text-blue-600';
                    break;
                case 'synced':
                    statusText = '✅ Synced';
                    statusColor = 'text-green-600';
                    break;
                case 'pending':
                    statusText = '⏳ Pending sync';
                    statusColor = 'text-yellow-600';
                    break;
                case 'error':
                    statusText = '❌ Sync error';
                    statusColor = 'text-red-600';
                    break;
                default: // offline
                    statusText = '📱 Local Mode';
                    statusColor = 'text-gray-600';
            }
            
            statusElements.forEach(elementId => {
                const element = document.getElementById(elementId);
                if (element) {
                    element.textContent = statusText;
                    element.className = `text-xs opacity-70 ${statusColor}`;
                }
            });
            
            // Update last sync time if available
            if (lastSyncTime && syncStatus === 'synced') {
                const timeStr = new Date(lastSyncTime).toLocaleTimeString();
                statusElements.forEach(elementId => {
                    const element = document.getElementById(elementId);
                    if (element) {
                        element.textContent = `✅ Synced ${timeStr}`;
                    }
                });
            }
        }

        // Queue item for sync
        function queueForSync(action, type, data) {
            const syncItem = {
                id: Date.now() + Math.random(),
                action: action, // 'create', 'update', 'delete'
                type: type, // 'employee', 'store', 'product', 'sale'
                data: data,
                timestamp: new Date().toISOString(),
                attempts: 0
            };
            
            console.log('Queuing item for sync:', syncItem);
            
            syncQueue.push(syncItem);
            localStorage.setItem('eden_sync_queue', JSON.stringify(syncQueue));
            
            console.log('Current sync queue length:', syncQueue.length);
            console.log('Firebase mode:', isFirebaseMode);
            
            if (isFirebaseMode) {
                syncStatus = 'pending';
                updateSyncStatus();
                console.log('Triggering sync in 1 second...');
                // Trigger sync after short delay
                setTimeout(processSyncQueue, 1000);
            } else {
                console.log('Firebase mode disabled, item will remain in queue');
            }
        }

        // Process sync queue
        async function processSyncQueue() {
            if (!isFirebaseMode || isSyncing || syncQueue.length === 0) {
                console.log('Sync skipped:', { isFirebaseMode, isSyncing, queueLength: syncQueue.length });
                return;
            }
            
            console.log('Starting sync process with', syncQueue.length, 'items');
            
            isSyncing = true;
            syncStatus = 'connected';
            updateSyncStatus();
            
            const itemsToProcess = [...syncQueue];
            const processedItems = [];
            
            for (const item of itemsToProcess) {
                try {
                    console.log('Processing sync item:', item);
                    await processSyncItem(item);
                    processedItems.push(item);
                    console.log('Successfully processed sync item:', item.type, item.action);
                } catch (error) {
                    console.error('Sync error for item:', item, error);
                    item.attempts = (item.attempts || 0) + 1;
                    
                    // Remove item if too many attempts
                    if (item.attempts >= 3) {
                        processedItems.push(item);
                        console.error('Removing item after 3 failed attempts:', item);
                    }
                }
            }
            
            // Remove processed items from queue
            syncQueue = syncQueue.filter(item => !processedItems.includes(item));
            localStorage.setItem('eden_sync_queue', JSON.stringify(syncQueue));
            
            console.log('Sync completed. Remaining queue items:', syncQueue.length);
            
            isSyncing = false;
            syncStatus = syncQueue.length > 0 ? 'pending' : 'synced';
            lastSyncTime = new Date().toISOString();
            updateSyncStatus();
        }

        // Process individual sync item
        async function processSyncItem(item) {
            const { action, type, data } = item;
            
            try {
                switch (action) {
                    case 'create':
                        console.log(`Creating ${type} in Firebase:`, data);
                        
                        // Create document in Firebase with the data
                        const docRef = await db.collection(type + 's').add({
                            ...data,
                            localId: data.id,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        
                        console.log(`${type} created in Firebase with ID:`, docRef.id);
                        
                        // Update local data with Firebase ID
                        const collection = getCollectionByType(type);
                        const localItem = collection.find(item => item.id === data.id);
                        if (localItem) {
                            localItem.firebaseId = docRef.id;
                            saveLocalData();
                        }
                        break;
                        
                    case 'update':
                        console.log(`Updating ${type} in Firebase:`, data);
                        
                        const firebaseId = data.firebaseId;
                        if (firebaseId) {
                            await db.collection(type + 's').doc(firebaseId).update({
                                ...data,
                                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            console.log(`${type} updated in Firebase`);
                        } else {
                            // If no Firebase ID, treat as create
                            console.log(`No Firebase ID found for ${type}, creating new document`);
                            const docRef = await db.collection(type + 's').add({
                                ...data,
                                localId: data.id,
                                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            
                            // Update local data with Firebase ID
                            const collection = getCollectionByType(type);
                            const localItem = collection.find(item => item.id === data.id);
                            if (localItem) {
                                localItem.firebaseId = docRef.id;
                                saveLocalData();
                            }
                        }
                        break;
                        
                    case 'delete':
                        console.log(`Deleting ${type} from Firebase:`, data);
                        
                        const deleteId = data.firebaseId;
                        if (deleteId) {
                            await db.collection(type + 's').doc(deleteId).delete();
                            console.log(`${type} deleted from Firebase`);
                        } else {
                            console.warn(`No Firebase ID found for ${type} deletion:`, data);
                        }
                        break;
                }
            } catch (error) {
                console.error(`Error processing ${action} for ${type}:`, error);
                throw error;
            }
        }

        // Get collection by type
        function getCollectionByType(type) {
            switch (type) {
                case 'employee': return employees;
                case 'store': return stores;
                case 'product': return products;
                case 'sale': return sales;
                default: return [];
            }
        }

        // Background sync
        function startBackgroundSync() {
            // Load sync queue from localStorage
            const savedQueue = localStorage.getItem('eden_sync_queue');
            if (savedQueue) {
                syncQueue = JSON.parse(savedQueue);
            }
            
            // Process queue immediately
            processSyncQueue();
            
            // Set up periodic sync
            setInterval(() => {
                if (isFirebaseMode && !isSyncing) {
                    processSyncQueue();
                }
            }, 30000); // Sync every 30 seconds
        }

        // Force sync now
        async function forceSyncNow() {
            if (!isFirebaseMode) {
                alert('Firebase is not connected. Click "🔥 Setup Firebase" to configure your database connection.');
                return;
            }
            
            syncStatus = 'connected';
            updateSyncStatus();
            
            try {
                await processSyncQueue();
                alert('Sync completed successfully!');
            } catch (error) {
                syncStatus = 'error';
                updateSyncStatus();
                alert('Sync failed: ' + error.message);
            }
        }

        // Reset Firebase Configuration
        function resetFirebaseConfig() {
            if (confirm('This will reset your Firebase configuration. You will need to re-enter your credentials. Continue?')) {
                // Clear saved config
                localStorage.removeItem('firebaseConfig');
                
                // Reset Firebase state
                isFirebaseMode = false;
                db = null;
                syncStatus = 'offline';
                updateSyncStatus();
                
                // Show configuration modal
                document.getElementById('firebaseConfigModal').classList.remove('hidden');
                
                // Clear form fields
                document.getElementById('apiKey').value = '';
                document.getElementById('authDomain').value = '';
                document.getElementById('projectId').value = '';
                document.getElementById('storageBucket').value = '';
                document.getElementById('messagingSenderId').value = '';
                document.getElementById('appId').value = '';
            }
        }

        // Data Loading Functions
        async function loadAllData() {
            // Always load from local storage first
            loadLocalData();
            
            // If Firebase is connected, sync in background
            if (isFirebaseMode) {
                setTimeout(processSyncQueue, 1000);
            }
        }

        function loadLocalData() {
            try {
                employees = JSON.parse(localStorage.getItem('eden_employees') || '[]');
                stores = JSON.parse(localStorage.getItem('eden_stores') || '[]');
                products = JSON.parse(localStorage.getItem('eden_products') || '[]');
                collections = JSON.parse(localStorage.getItem('eden_collections') || '[]');
                sales = JSON.parse(localStorage.getItem('eden_sales') || '[]');
                
                // Ensure arrays are valid
                initializeArrays();
                
                console.log('Local data loaded:', {
                    employees: employees.length,
                    stores: stores.length,
                    products: products.length,
                    collections: collections.length,
                    sales: sales.length
                });
            } catch (error) {
                console.error('Error loading local data:', error);
                // Reset to empty arrays if parsing fails
                employees = [];
                stores = [];
                products = [];
                collections = [];
                sales = [];
            }
        }

        function saveLocalData() {
            try {
                localStorage.setItem('eden_employees', JSON.stringify(employees));
                localStorage.setItem('eden_stores', JSON.stringify(stores));
                localStorage.setItem('eden_products', JSON.stringify(products));
                localStorage.setItem('eden_collections', JSON.stringify(collections));
                localStorage.setItem('eden_sales', JSON.stringify(sales));
                
                console.log('Local data saved:', {
                    employees: employees.length,
                    stores: stores.length,
                    products: products.length,
                    collections: collections.length,
                    sales: sales.length
                });
            } catch (error) {
                console.error('Error saving local data:', error);
            }
        }

        // Modal Form Submission
        document.getElementById('modalForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const saveBtnText = document.getElementById('saveBtnText');
            const saveLoader = document.getElementById('saveLoader');
            const originalText = saveBtnText.textContent;
            
            saveBtnText.textContent = 'Saving...';
            saveLoader.classList.remove('hidden');
            
            try {
                let itemData = {};
                
                switch(editingType) {
                    case 'employee':
                        itemData = {
                            name: document.getElementById('modalName').value.trim(),
                            username: document.getElementById('modalUsername').value.trim(),
                            storeId: document.getElementById('modalStoreId').value,
                            salaryType: document.getElementById('modalSalaryType').value,
                            baseSalary: parseFloat(document.getElementById('modalBaseSalary').value) || 0,
                            commissionRate: document.getElementById('modalCommissionRate') ? parseFloat(document.getElementById('modalCommissionRate').value) || 0.1 : 0.1
                        };
                        
                        // Handle password
                        const password = document.getElementById('modalPassword').value;
                        if (password || !editingItem) {
                            itemData.password = password;
                        }
                        
                        // If editing, preserve existing ID
                        if (editingItem) {
                            itemData.id = editingItem.id;
                            if (!password) {
                                itemData.password = editingItem.password; // Keep existing password
                            }
                        }
                        
                        await saveEmployee(itemData);
                        await loadEmployeesTable();
                        break;
                        
                    case 'store':
                        itemData = {
                            name: document.getElementById('modalName').value.trim(),
                            location: document.getElementById('modalLocation').value.trim(),
                            manager: document.getElementById('modalManager').value.trim(),
                            phone: document.getElementById('modalPhone').value.trim()
                        };
                        
                        if (editingItem) {
                            itemData.id = editingItem.id;
                        }
                        
                        await saveStore(itemData);
                        await loadStoresTable();
                        break;
                        
                    case 'product':
                        itemData = {
                            name: document.getElementById('modalName').value.trim(),
                            price: parseFloat(document.getElementById('modalPrice').value) || 0,
                            description: document.getElementById('modalDescription').value.trim()
                        };
                        
                        if (editingItem) {
                            itemData.id = editingItem.id;
                        }
                        
                        await saveProduct(itemData);
                        await loadProductsTable();
                        break;
                        
                    case 'collection':
                        // Get selected product IDs
                        const selectedProducts = Array.from(document.querySelectorAll('.product-checkbox:checked')).map(cb => cb.value);
                        
                        itemData = {
                            name: document.getElementById('modalName').value.trim(),
                            description: document.getElementById('modalDescription').value.trim(),
                            status: document.getElementById('modalStatus').value,
                            productIds: selectedProducts
                        };
                        
                        if (editingItem) {
                            itemData.id = editingItem.id;
                        }
                        
                        await saveCollection(itemData);
                        await loadCollectionsTable();
                        break;
                }
                
                closeModal();
                
                // Safe string handling for alert message
                const itemTypeName = editingType ? editingType.charAt(0).toUpperCase() + editingType.slice(1) : 'Item';
                const actionText = editingItem ? 'updated' : 'created';
                alert(`${itemTypeName} ${actionText} successfully!`);
                
                // Update dropdowns if needed
                if (editingType === 'store' || editingType === 'product') {
                    populateStoreDropdown();
                    populateProductDropdown();
                }
                
            } catch (error) {
                console.error('Error saving item:', error);
                alert('Error saving item: ' + error.message);
            }
            
            saveBtnText.textContent = originalText;
            saveLoader.classList.add('hidden');
        });

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async function() {
            // Check if Firebase config exists
            const savedConfig = localStorage.getItem('firebaseConfig');
            if (savedConfig) {
                try {
                    const config = JSON.parse(savedConfig);
                    
                    // Pre-fill the form with saved config
                    document.getElementById('apiKey').value = config.apiKey || '';
                    document.getElementById('authDomain').value = config.authDomain || '';
                    document.getElementById('projectId').value = config.projectId || '';
                    document.getElementById('storageBucket').value = config.storageBucket || '';
                    document.getElementById('messagingSenderId').value = config.messagingSenderId || '';
                    document.getElementById('appId').value = config.appId || '';
                    
                    // Try to auto-connect
                    if (await initializeFirebase(config)) {
                        document.getElementById('firebaseConfigModal').classList.add('hidden');
                        document.getElementById('loginScreen').classList.remove('hidden');
                        await loadAllData();
                        return;
                    }
                } catch (error) {
                    console.error('Error loading saved Firebase config:', error);
                    // Clear invalid config
                    localStorage.removeItem('firebaseConfig');
                }
            }
            
            // Show Firebase config modal if no saved config or connection failed
            document.getElementById('firebaseConfigModal').classList.remove('hidden');
        });

        // Placeholder functions for missing functionality
        function refreshData() {
            loadAllData();
            if (currentUserRole === 'employee') {
                updateEmployeeStats();
                updateTodaysSalesTable();
            }
        }

        function quickAddSale() {
            alert('Quick Add Sale feature coming soon!');
        }

        function viewTodaysSummary() {
            alert('Today\'s Summary feature coming soon!');
        }

        function backupData() {
            alert('Backup feature coming soon!');
        }

        function downloadAllMasterData() {
            alert('Download All feature coming soon!');
        }

        function restoreData() {
            alert('Restore feature coming soon!');
        }

        function clearAllData() {
            if (confirm('This will delete ALL data. Are you sure?')) {
                employees = [];
                stores = [];
                products = [];
                collections = [];
                sales = [];
                saveLocalData();
                alert('All data cleared!');
                location.reload();
            }
        }

        function openModal(type, item = null) {
            editingType = type;
            editingItem = item;
            
            const modal = document.getElementById('modal');
            const modalTitle = document.getElementById('modalTitle');
            const modalFields = document.getElementById('modalFields');
            const saveBtnText = document.getElementById('saveBtnText');
            
            // Set modal title
            const isEditing = item !== null;
            modalTitle.textContent = isEditing ? `Edit ${type.charAt(0).toUpperCase() + type.slice(1)}` : `Add ${type.charAt(0).toUpperCase() + type.slice(1)}`;
            saveBtnText.textContent = isEditing ? 'Update' : 'Save';
            
            // Generate form fields based on type
            let fieldsHTML = '';
            
            switch(type) {
                case 'employee':
                    fieldsHTML = `
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Full Name</label>
                            <input type="text" id="modalName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="Enter full name" required value="${item ? item.name || '' : ''}">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                            <input type="text" id="modalUsername" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="Enter username" required value="${item ? item.username || '' : ''}">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                            <input type="password" id="modalPassword" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="Enter password" ${!isEditing ? 'required' : ''} value="">
                            ${isEditing ? '<p class="text-xs text-gray-500 mt-1">Leave blank to keep current password</p>' : ''}
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Store</label>
                            <select id="modalStoreId" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" required>
                                <option value="">Select Store</option>
                                ${stores.map(store => `<option value="${store.id}" ${item && item.storeId === store.id ? 'selected' : ''}>${store.name}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Salary Type</label>
                            <select id="modalSalaryType" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" required onchange="updateSalaryFields()">
                                <option value="fixed" ${item && item.salaryType === 'fixed' ? 'selected' : ''}>Fixed Salary</option>
                                <option value="commission" ${item && item.salaryType === 'commission' ? 'selected' : ''}>Commission Based</option>
                                <option value="qty_sold" ${item && item.salaryType === 'qty_sold' ? 'selected' : ''}>Quantity Sold</option>
                                <option value="days_present" ${item && item.salaryType === 'days_present' ? 'selected' : ''}>Days Present</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Base Salary ($)</label>
                            <input type="number" id="modalBaseSalary" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="Enter base salary" min="0" step="0.01" required value="${item ? item.baseSalary || '' : ''}">
                        </div>
                        <div id="commissionRateField" class="hidden">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Commission Rate (0.1 = 10%)</label>
                            <input type="number" id="modalCommissionRate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="0.1" min="0" max="1" step="0.01" value="${item ? item.commissionRate || '0.1' : '0.1'}">
                        </div>
                    `;
                    break;
                    
                case 'store':
                    fieldsHTML = `
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Store Name</label>
                            <input type="text" id="modalName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="Enter store name" required value="${item ? item.name || '' : ''}">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Location</label>
                            <input type="text" id="modalLocation" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="Enter location" required value="${item ? item.location || '' : ''}">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Manager Name</label>
                            <input type="text" id="modalManager" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="Enter manager name" required value="${item ? item.manager || '' : ''}">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Phone Number</label>
                            <input type="tel" id="modalPhone" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="Enter phone number" required value="${item ? item.phone || '' : ''}">
                        </div>
                    `;
                    break;
                    
                case 'product':
                    fieldsHTML = `
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Product Name</label>
                            <input type="text" id="modalName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="Enter product name" required value="${item ? item.name || '' : ''}">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Price ($)</label>
                            <input type="number" id="modalPrice" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="Enter price" min="0" step="0.01" required value="${item ? item.price || '' : ''}">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Description (Optional)</label>
                            <textarea id="modalDescription" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="Enter product description" rows="3">${item ? item.description || '' : ''}</textarea>
                        </div>
                    `;
                    break;
                    
                case 'collection':
                    fieldsHTML = `
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Collection Name</label>
                            <input type="text" id="modalName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="Enter collection name" required value="${item ? item.name || '' : ''}">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                            <textarea id="modalDescription" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="Enter collection description" rows="3" required>${item ? item.description || '' : ''}</textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                            <select id="modalStatus" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" required>
                                <option value="active" ${item && item.status === 'active' ? 'selected' : ''}>Active</option>
                                <option value="inactive" ${item && item.status === 'inactive' ? 'selected' : ''}>Inactive</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Products in Collection</label>
                            <div class="border border-gray-300 rounded-lg p-3 max-h-40 overflow-y-auto">
                                ${products.map(product => `
                                    <label class="flex items-center space-x-2 mb-2">
                                        <input type="checkbox" class="product-checkbox" value="${product.id}" ${item && item.productIds && item.productIds.includes(product.id) ? 'checked' : ''}>
                                        <span class="text-sm">${product.name} - $${product.price}</span>
                                    </label>
                                `).join('')}
                            </div>
                        </div>
                    `;
                    break;
            }
            
            modalFields.innerHTML = fieldsHTML;
            
            // Show commission rate field if commission type is selected
            if (type === 'employee') {
                updateSalaryFields();
            }
            
            modal.classList.remove('hidden');
        }

        function updateSalaryFields() {
            const salaryType = document.getElementById('modalSalaryType').value;
            const commissionField = document.getElementById('commissionRateField');
            
            if (salaryType === 'commission') {
                commissionField.classList.remove('hidden');
            } else {
                commissionField.classList.add('hidden');
            }
        }

        function closeModal() {
            document.getElementById('modal').classList.add('hidden');
            editingItem = null;
            editingType = null;
        }

        function editItem(type, id) {
            let item = null;
            
            switch(type) {
                case 'employee':
                    item = employees.find(emp => emp.id === id);
                    break;
                case 'store':
                    item = stores.find(store => store.id === id);
                    break;
                case 'product':
                    item = products.find(product => product.id === id);
                    break;
                case 'collection':
                    item = collections.find(collection => collection.id === id);
                    break;
            }
            
            if (item) {
                openModal(type, item);
            } else {
                alert('Item not found!');
            }
        }

        async function deleteItem(type, id) {
            if (confirm('Are you sure you want to delete this item?')) {
                try {
                    switch(type) {
                        case 'employee':
                            await deleteEmployee(id);
                            await loadEmployeesTable();
                            break;
                        case 'store':
                            await deleteStore(id);
                            await loadStoresTable();
                            break;
                        case 'product':
                            await deleteProduct(id);
                            await loadProductsTable();
                            break;
                        case 'collection':
                            await deleteCollection(id);
                            await loadCollectionsTable();
                            break;
                    }
                    alert('Item deleted successfully!');
                } catch (error) {
                    alert('Error deleting item: ' + error.message);
                }
            }
        }

        function loadDatabaseManager() {
            alert('Database Manager coming soon!');
        }

        function generateSalesReport() {
            try {
                const startDate = document.getElementById('reportStartDate').value;
                const endDate = document.getElementById('reportEndDate').value;
                const reportType = document.getElementById('reportType').value;
                const filterValue = document.getElementById('reportFilter').value;
                
                if (!startDate || !endDate) {
                    alert('Please select both start and end dates');
                    return;
                }
                
                if (new Date(startDate) > new Date(endDate)) {
                    alert('Start date cannot be after end date');
                    return;
                }
                
                // Filter sales by date range
                let filteredSales = sales.filter(sale => {
                    if (!sale || !sale.date) return false;
                    const saleDate = new Date(sale.date);
                    const start = new Date(startDate);
                    const end = new Date(endDate);
                    return saleDate >= start && saleDate <= end;
                });
                
                // Apply additional filters based on report type
                if (filterValue) {
                    switch(reportType) {
                        case 'store':
                            filteredSales = filteredSales.filter(sale => sale.storeId === filterValue);
                            break;
                        case 'staff':
                            filteredSales = filteredSales.filter(sale => sale.employeeId === filterValue);
                            break;
                        case 'product':
                            filteredSales = filteredSales.filter(sale => sale.productId === filterValue);
                            break;
                    }
                }
                
                // Generate report based on type
                let reportData = [];
                
                switch(reportType) {
                    case 'daily':
                        reportData = generateDailyReport(filteredSales);
                        break;
                    case 'monthly':
                        reportData = generateMonthlyReport(filteredSales);
                        break;
                    case 'store':
                        reportData = generateStoreWiseReport(filteredSales);
                        break;
                    case 'staff':
                        reportData = generateStaffWiseReport(filteredSales);
                        break;
                    case 'product':
                        reportData = generateProductWiseReport(filteredSales);
                        break;
                    default: // 'all'
                        reportData = filteredSales.map(sale => ({
                            date: sale.date,
                            time: sale.time || '',
                            employee: getEmployeeName(sale.employeeId),
                            store: getStoreName(sale.storeId),
                            product: getProductName(sale.productId),
                            quantity: sale.quantity || 0,
                            amount: sale.amount || 0
                        }));
                }
                
                displaySalesReport(reportData, reportType);
                
            } catch (error) {
                console.error('Error generating sales report:', error);
                alert('Error generating report: ' + error.message);
            }
        }
        
        function generateDailyReport(sales) {
            const dailyData = {};
            
            sales.forEach(sale => {
                const date = sale.date;
                if (!dailyData[date]) {
                    dailyData[date] = {
                        date: date,
                        totalSales: 0,
                        totalQuantity: 0,
                        totalAmount: 0,
                        transactions: 0
                    };
                }
                
                dailyData[date].totalSales += 1;
                dailyData[date].totalQuantity += sale.quantity || 0;
                dailyData[date].totalAmount += sale.amount || 0;
                dailyData[date].transactions += 1;
            });
            
            return Object.values(dailyData).sort((a, b) => new Date(a.date) - new Date(b.date));
        }
        
        function generateMonthlyReport(sales) {
            const monthlyData = {};
            
            sales.forEach(sale => {
                const date = new Date(sale.date);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                const monthName = date.toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
                
                if (!monthlyData[monthKey]) {
                    monthlyData[monthKey] = {
                        month: monthName,
                        totalSales: 0,
                        totalQuantity: 0,
                        totalAmount: 0,
                        transactions: 0
                    };
                }
                
                monthlyData[monthKey].totalSales += 1;
                monthlyData[monthKey].totalQuantity += sale.quantity || 0;
                monthlyData[monthKey].totalAmount += sale.amount || 0;
                monthlyData[monthKey].transactions += 1;
            });
            
            return Object.values(monthlyData).sort((a, b) => a.month.localeCompare(b.month));
        }
        
        function generateStoreWiseReport(sales) {
            const storeData = {};
            
            sales.forEach(sale => {
                const storeId = sale.storeId;
                const storeName = getStoreName(storeId);
                
                if (!storeData[storeId]) {
                    storeData[storeId] = {
                        store: storeName,
                        totalSales: 0,
                        totalQuantity: 0,
                        totalAmount: 0,
                        transactions: 0
                    };
                }
                
                storeData[storeId].totalSales += 1;
                storeData[storeId].totalQuantity += sale.quantity || 0;
                storeData[storeId].totalAmount += sale.amount || 0;
                storeData[storeId].transactions += 1;
            });
            
            return Object.values(storeData).sort((a, b) => b.totalAmount - a.totalAmount);
        }
        
        function generateStaffWiseReport(sales) {
            const staffData = {};
            
            sales.forEach(sale => {
                const employeeId = sale.employeeId;
                const employeeName = getEmployeeName(employeeId);
                
                if (!staffData[employeeId]) {
                    staffData[employeeId] = {
                        employee: employeeName,
                        store: getStoreName(sale.storeId),
                        totalSales: 0,
                        totalQuantity: 0,
                        totalAmount: 0,
                        transactions: 0
                    };
                }
                
                staffData[employeeId].totalSales += 1;
                staffData[employeeId].totalQuantity += sale.quantity || 0;
                staffData[employeeId].totalAmount += sale.amount || 0;
                staffData[employeeId].transactions += 1;
            });
            
            return Object.values(staffData).sort((a, b) => b.totalAmount - a.totalAmount);
        }
        
        function generateProductWiseReport(sales) {
            const productData = {};
            
            sales.forEach(sale => {
                const productId = sale.productId;
                const productName = getProductName(productId);
                const product = getProduct(productId);
                
                if (!productData[productId]) {
                    productData[productId] = {
                        product: productName,
                        price: product ? product.price : 0,
                        totalQuantity: 0,
                        totalAmount: 0,
                        transactions: 0
                    };
                }
                
                productData[productId].totalQuantity += sale.quantity || 0;
                productData[productId].totalAmount += sale.amount || 0;
                productData[productId].transactions += 1;
            });
            
            return Object.values(productData).sort((a, b) => b.totalAmount - a.totalAmount);
        }
        
        function displaySalesReport(reportData, reportType) {
            const tbody = document.getElementById('salesReportTable');
            const header = document.getElementById('salesReportHeader');
            
            if (reportData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-500">No sales data found for the selected criteria</td></tr>';
                return;
            }
            
            // Update header based on report type
            let headerHTML = '';
            let bodyHTML = '';
            
            switch(reportType) {
                case 'daily':
                    headerHTML = `
                        <th class="text-left py-4 px-6">Date</th>
                        <th class="text-left py-4 px-6">Transactions</th>
                        <th class="text-left py-4 px-6">Total Quantity</th>
                        <th class="text-left py-4 px-6">Total Amount</th>
                        <th class="text-left py-4 px-6">Avg per Transaction</th>
                    `;
                    bodyHTML = reportData.map(row => `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="py-4 px-6">${new Date(row.date).toLocaleDateString()}</td>
                            <td class="py-4 px-6">${row.transactions}</td>
                            <td class="py-4 px-6">${row.totalQuantity}</td>
                            <td class="py-4 px-6">$${row.totalAmount.toFixed(2)}</td>
                            <td class="py-4 px-6">$${(row.totalAmount / row.transactions).toFixed(2)}</td>
                        </tr>
                    `).join('');
                    break;
                    
                case 'monthly':
                    headerHTML = `
                        <th class="text-left py-4 px-6">Month</th>
                        <th class="text-left py-4 px-6">Transactions</th>
                        <th class="text-left py-4 px-6">Total Quantity</th>
                        <th class="text-left py-4 px-6">Total Amount</th>
                        <th class="text-left py-4 px-6">Avg per Transaction</th>
                    `;
                    bodyHTML = reportData.map(row => `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="py-4 px-6">${row.month}</td>
                            <td class="py-4 px-6">${row.transactions}</td>
                            <td class="py-4 px-6">${row.totalQuantity}</td>
                            <td class="py-4 px-6">$${row.totalAmount.toFixed(2)}</td>
                            <td class="py-4 px-6">$${(row.totalAmount / row.transactions).toFixed(2)}</td>
                        </tr>
                    `).join('');
                    break;
                    
                case 'store':
                    headerHTML = `
                        <th class="text-left py-4 px-6">Store</th>
                        <th class="text-left py-4 px-6">Transactions</th>
                        <th class="text-left py-4 px-6">Total Quantity</th>
                        <th class="text-left py-4 px-6">Total Amount</th>
                        <th class="text-left py-4 px-6">Avg per Transaction</th>
                    `;
                    bodyHTML = reportData.map(row => `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="py-4 px-6">${row.store}</td>
                            <td class="py-4 px-6">${row.transactions}</td>
                            <td class="py-4 px-6">${row.totalQuantity}</td>
                            <td class="py-4 px-6">$${row.totalAmount.toFixed(2)}</td>
                            <td class="py-4 px-6">$${(row.totalAmount / row.transactions).toFixed(2)}</td>
                        </tr>
                    `).join('');
                    break;
                    
                case 'staff':
                    headerHTML = `
                        <th class="text-left py-4 px-6">Employee</th>
                        <th class="text-left py-4 px-6">Store</th>
                        <th class="text-left py-4 px-6">Transactions</th>
                        <th class="text-left py-4 px-6">Total Quantity</th>
                        <th class="text-left py-4 px-6">Total Amount</th>
                    `;
                    bodyHTML = reportData.map(row => `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="py-4 px-6">${row.employee}</td>
                            <td class="py-4 px-6">${row.store}</td>
                            <td class="py-4 px-6">${row.transactions}</td>
                            <td class="py-4 px-6">${row.totalQuantity}</td>
                            <td class="py-4 px-6">$${row.totalAmount.toFixed(2)}</td>
                        </tr>
                    `).join('');
                    break;
                    
                case 'product':
                    headerHTML = `
                        <th class="text-left py-4 px-6">Product</th>
                        <th class="text-left py-4 px-6">Unit Price</th>
                        <th class="text-left py-4 px-6">Quantity Sold</th>
                        <th class="text-left py-4 px-6">Total Amount</th>
                        <th class="text-left py-4 px-6">Transactions</th>
                    `;
                    bodyHTML = reportData.map(row => `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="py-4 px-6">${row.product}</td>
                            <td class="py-4 px-6">$${row.price.toFixed(2)}</td>
                            <td class="py-4 px-6">${row.totalQuantity}</td>
                            <td class="py-4 px-6">$${row.totalAmount.toFixed(2)}</td>
                            <td class="py-4 px-6">${row.transactions}</td>
                        </tr>
                    `).join('');
                    break;
                    
                default: // 'all'
                    headerHTML = `
                        <th class="text-left py-4 px-6">Date</th>
                        <th class="text-left py-4 px-6">Time</th>
                        <th class="text-left py-4 px-6">Employee</th>
                        <th class="text-left py-4 px-6">Store</th>
                        <th class="text-left py-4 px-6">Product</th>
                        <th class="text-left py-4 px-6">Quantity</th>
                        <th class="text-left py-4 px-6">Amount</th>
                    `;
                    bodyHTML = reportData.map(row => `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="py-4 px-6">${new Date(row.date).toLocaleDateString()}</td>
                            <td class="py-4 px-6">${row.time}</td>
                            <td class="py-4 px-6">${row.employee}</td>
                            <td class="py-4 px-6">${row.store}</td>
                            <td class="py-4 px-6">${row.product}</td>
                            <td class="py-4 px-6">${row.quantity}</td>
                            <td class="py-4 px-6">$${row.amount.toFixed(2)}</td>
                        </tr>
                    `).join('');
            }
            
            header.innerHTML = headerHTML;
            tbody.innerHTML = bodyHTML;
            
            // Store report data for export functions
            window.currentReportData = reportData;
            window.currentReportType = reportType;
        }

        function generateSalaryReport() {
            alert('Salary Report generation coming soon!');
        }

        function printReport(type) {
            alert('Print functionality coming soon!');
        }

        function downloadExcel(type) {
            alert('Excel download coming soon!');
        }

        function downloadPDF(type) {
            alert('PDF download coming soon!');
        }

        function populateEmployeeDropdown() {
            const select = document.getElementById('salaryEmployee');
            if (select) {
                select.innerHTML = '<option value="">All Employees</option>';
                employees.forEach(emp => {
                    const option = document.createElement('option');
                    option.value = emp.id;
                    option.textContent = emp.name;
                    select.appendChild(option);
                });
            }
        }
        
        function updateReportFilter() {
            const reportType = document.getElementById('reportType').value;
            const filterSelect = document.getElementById('reportFilter');
            
            filterSelect.innerHTML = '<option value="">All</option>';
            
            switch(reportType) {
                case 'store':
                    stores.forEach(store => {
                        const option = document.createElement('option');
                        option.value = store.id;
                        option.textContent = store.name;
                        filterSelect.appendChild(option);
                    });
                    break;
                case 'staff':
                    employees.forEach(emp => {
                        const option = document.createElement('option');
                        option.value = emp.id;
                        option.textContent = emp.name;
                        filterSelect.appendChild(option);
                    });
                    break;
                case 'product':
                    products.forEach(product => {
                        const option = document.createElement('option');
                        option.value = product.id;
                        option.textContent = product.name;
                        filterSelect.appendChild(option);
                    });
                    break;
                default:
                    // For daily, monthly, and all reports, no additional filter needed
                    filterSelect.innerHTML = '<option value="">All</option>';
            }
        }
        
        // Add event listener for report type change
        document.addEventListener('DOMContentLoaded', function() {
            const reportTypeSelect = document.getElementById('reportType');
            if (reportTypeSelect) {
                reportTypeSelect.addEventListener('change', updateReportFilter);
            }
        });

        // Login System
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const loginBtn = document.getElementById('loginBtnText');
            const loader = document.getElementById('loginLoader');
            
            loginBtn.textContent = 'Signing in...';
            loader.classList.remove('hidden');
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            // Check admin credentials
            if (username === 'admin' && password === 'admin123') {
                currentUser = { name: 'Administrator', role: 'admin' };
                currentUserRole = 'admin';
                await showDashboard();
                loginBtn.textContent = 'Sign In';
                loader.classList.add('hidden');
                return;
            }
            
            // Check employee credentials
            const employee = employees.find(emp => 
                emp.username === username && emp.password === password
            );
            
            if (employee) {
                currentUser = employee;
                currentUserRole = 'employee';
                await showEmployeePortal();
                loginBtn.textContent = 'Sign In';
                loader.classList.add('hidden');
                return;
            }
            
            alert('Invalid credentials. Please try again.');
            loginBtn.textContent = 'Sign In';
            loader.classList.add('hidden');
        });

        function logout() {
            currentUser = null;
            currentUserRole = null;
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('employeePortal').classList.add('hidden');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }

        // Employee Portal Functions
        async function showEmployeePortal() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('employeePortal').classList.remove('hidden');
            
            // Update employee info
            document.getElementById('employeeName').textContent = currentUser.name;
            document.getElementById('employeeStore').textContent = getStoreName(currentUser.storeId);
            
            // Update current date
            updateCurrentDate('employeeCurrentDate');
            
            // Set today's date in the form
            document.getElementById('saleDate').value = getTodayString();
            
            // Populate dropdowns
            populateProductDropdown();
            populateStoreDropdown();
            
            // Update stats and sales table
            updateEmployeeStats();
            updateTodaysSalesTable();
        }

        function populateProductDropdown() {
            try {
                const select = document.getElementById('saleProduct');
                if (!select) {
                    console.error('Product dropdown element not found');
                    return;
                }
                
                select.innerHTML = '<option value="">Select Product</option>';
                
                if (!products || !Array.isArray(products)) {
                    console.error('Products array is not valid');
                    return;
                }
                
                products.filter(product => product && product.id && product.name).forEach(product => {
                    try {
                        const option = document.createElement('option');
                        option.value = product.id;
                        option.textContent = `${product.name} - $${(product.price || 0).toFixed(2)}`;
                        select.appendChild(option);
                    } catch (error) {
                        console.error('Error creating product option:', error);
                    }
                });
            } catch (error) {
                console.error('Error in populateProductDropdown:', error);
            }
        }

        function populateStoreDropdown() {
            try {
                const select = document.getElementById('saleStore');
                if (!select) {
                    console.log('Store dropdown element not found (this is normal for some views)');
                    return;
                }
                
                select.innerHTML = '<option value="">Select Store</option>';
                
                if (!stores || !Array.isArray(stores)) {
                    console.error('Stores array is not valid');
                    return;
                }
                
                stores.filter(store => store && store.id && store.name).forEach(store => {
                    try {
                        const option = document.createElement('option');
                        option.value = store.id;
                        option.textContent = store.name;
                        select.appendChild(option);
                    } catch (error) {
                        console.error('Error creating store option:', error);
                    }
                });
                
                // Set default store for employee
                if (currentUser && currentUser.storeId) {
                    select.value = currentUser.storeId;
                }
            } catch (error) {
                console.error('Error in populateStoreDropdown:', error);
            }
        }

        function updateEmployeeStats() {
            try {
                if (!currentUser || !currentUser.id) {
                    console.error('No current user found');
                    return;
                }
                
                // Ensure arrays are initialized
                initializeArrays();
                
                const today = getTodayString();
                const todaysSales = sales.filter(sale => 
                    sale && sale.date === today && sale.employeeId === currentUser.id
                );
                
                const totalSales = todaysSales.reduce((sum, sale) => sum + (sale.amount || 0), 0);
                const bottlesSold = todaysSales.reduce((sum, sale) => sum + (sale.quantity || 0), 0);
                
                // Calculate estimated salary based on salary type
                let estimatedSalary = currentUser.baseSalary || 0;
                const monthSales = sales.filter(sale => {
                    if (!sale || !sale.date) return false;
                    try {
                        const saleDate = new Date(sale.date);
                        const currentDate = new Date();
                        return saleDate.getMonth() === currentDate.getMonth() && 
                               saleDate.getFullYear() === currentDate.getFullYear() &&
                               sale.employeeId === currentUser.id;
                    } catch (error) {
                        return false;
                    }
                });
                
                const monthlyQuantity = monthSales.reduce((sum, sale) => sum + (sale.quantity || 0), 0);
                const monthlySalesAmount = monthSales.reduce((sum, sale) => sum + (sale.amount || 0), 0);
                const uniqueDays = [...new Set(monthSales.map(sale => sale.date).filter(date => date))].length;
                
                switch(currentUser.salaryType) {
                    case 'commission':
                        estimatedSalary += monthlySalesAmount * (currentUser.commissionRate || 0.1);
                        break;
                    case 'qty_sold':
                        estimatedSalary += monthlyQuantity * 5; // $5 per item
                        break;
                    case 'days_present':
                        estimatedSalary += uniqueDays * 50; // $50 per day
                        break;
                }
                
                // Safe DOM element updates with null checks
                const totalSalesTodayEl = document.getElementById('totalSalesToday');
                const bottlesSoldEl = document.getElementById('bottlesSold');
                const estimatedSalaryEl = document.getElementById('estimatedSalary');
                
                if (totalSalesTodayEl) {
                    totalSalesTodayEl.textContent = `$${totalSales.toFixed(2)}`;
                }
                if (bottlesSoldEl) {
                    bottlesSoldEl.textContent = bottlesSold.toString();
                }
                if (estimatedSalaryEl) {
                    estimatedSalaryEl.textContent = `$${estimatedSalary.toFixed(2)}`;
                }
            } catch (error) {
                console.error('Error in updateEmployeeStats:', error);
            }
        }

        function updateTodaysSalesTable() {
            try {
                if (!currentUser || !currentUser.id) {
                    console.error('No current user found for sales table update');
                    return;
                }
                
                const today = getTodayString();
                const todaysSales = sales.filter(sale => 
                    sale && sale.date === today && sale.employeeId === currentUser.id
                );
                
                const tbody = document.getElementById('todaysSalesTable');
                if (!tbody) {
                    console.error('Sales table body element not found');
                    return;
                }
                
                if (todaysSales.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-500">No sales recorded today</td></tr>';
                    return;
                }
                
                tbody.innerHTML = todaysSales.filter(sale => sale && sale.id).map(sale => {
                    // Safe property access with fallbacks
                    const saleTime = sale.time || 'N/A';
                    const storeName = getStoreName(sale.storeId);
                    const productName = getProductName(sale.productId);
                    const quantity = sale.quantity || 0;
                    const amount = sale.amount || 0;
                    const saleId = sale.id || '';
                    
                    return `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="py-3 px-4">${saleTime}</td>
                            <td class="py-3 px-4">${storeName}</td>
                            <td class="py-3 px-4">${productName}</td>
                            <td class="py-3 px-4">${quantity}</td>
                            <td class="py-3 px-4">$${amount.toFixed(2)}</td>
                            <td class="py-3 px-4">
                                <button onclick="deleteSale('${saleId}')" class="text-red-600 hover:text-red-800 text-sm">
                                    Delete
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error in updateTodaysSalesTable:', error);
                const tbody = document.getElementById('todaysSalesTable');
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-red-500">Error loading sales data</td></tr>';
                }
            }
        }

        // Add Sale Form
        document.getElementById('addSaleForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Adding...';
            submitBtn.disabled = true;
            
            const date = document.getElementById('saleDate').value;
            const productId = document.getElementById('saleProduct').value;
            const quantity = parseInt(document.getElementById('saleQuantity').value);
            const storeId = document.getElementById('saleStore') ? document.getElementById('saleStore').value : currentUser.storeId;
            
            if (!date || !productId || !quantity || !storeId) {
                alert('Please fill in all fields');
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
                return;
            }
            
            if (quantity <= 0) {
                alert('Quantity must be greater than 0');
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
                return;
            }
            
            const product = getProduct(productId);
            if (!product) {
                alert('Invalid product selected');
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
                return;
            }
            
            const newSale = {
                date: date,
                time: getCurrentTime(),
                employeeId: currentUser.id,
                storeId: storeId,
                productId: productId,
                quantity: quantity,
                amount: product.price * quantity
            };
            
            try {
                await saveSale(newSale);
                
                // Reset form
                document.getElementById('saleQuantity').value = '';
                document.getElementById('saleProduct').value = '';
                if (document.getElementById('saleStore')) {
                    document.getElementById('saleStore').value = currentUser.storeId || '';
                }
                
                // Reload data and update displays
                updateEmployeeStats();
                updateTodaysSalesTable();
                
                alert('Sale added successfully!');
            } catch (error) {
                alert('Error adding sale: ' + error.message);
            }
            
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
        });

        async function deleteSale(saleId) {
            if (!saleId) {
                console.error('deleteSale requires valid saleId');
                return;
            }
            
            if (confirm('Are you sure you want to delete this sale?')) {
                try {
                    await deleteSaleRecord(saleId);
                    updateEmployeeStats();
                    updateTodaysSalesTable();
                } catch (error) {
                    console.error('Error in deleteSale:', error);
                    alert('Error deleting sale: ' + error.message);
                }
            }
        }

        // Admin Dashboard Functions
        async function showDashboard() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            
            // Update current date
            updateCurrentDate('adminCurrentDate');
            
            // Show employees tab by default
            await switchTab('employees');
        }

        async function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('tab-active', 'border-purple-500');
                btn.classList.add('border-transparent');
            });
            
            // Show selected tab content
            document.getElementById(tabName + '-tab').classList.remove('hidden');
            
            // Add active class to selected tab button
            const activeBtn = document.querySelector(`[data-tab="${tabName}"]`);
            activeBtn.classList.add('tab-active', 'border-purple-500');
            activeBtn.classList.remove('border-transparent');
            
            // Load data for the selected tab
            switch(tabName) {
                case 'employees':
                    await loadEmployeesTable();
                    break;
                case 'stores':
                    await loadStoresTable();
                    break;
                case 'products':
                    await loadProductsTable();
                    break;
                case 'collections':
                    await loadCollectionsTable();
                    break;
                case 'database':
                    await loadDatabaseManager();
                    break;
                case 'sales':
                    // Initialize filter dropdown
                    updateReportFilter();
                    // Set default dates
                    const today = new Date();
                    const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, today.getDate());
                    document.getElementById('reportStartDate').value = lastMonth.toISOString().split('T')[0];
                    document.getElementById('reportEndDate').value = today.toISOString().split('T')[0];
                    break;
                case 'salary':
                    populateEmployeeDropdown();
                    break;
            }
        }

        async function loadEmployeesTable() {
            try {
                const tbody = document.getElementById('employeesTable');
                
                if (!tbody) {
                    console.error('Employees table body element not found');
                    return;
                }
                
                if (!employees || !Array.isArray(employees) || employees.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-500">No employees found. Click "Add Employee" to create your first employee.</td></tr>';
                    return;
                }
                
                tbody.innerHTML = employees.filter(emp => emp && emp.id).map(emp => {
                    // Safe property access with fallbacks
                    const empName = emp.name || 'N/A';
                    const empUsername = emp.username || 'N/A';
                    const storeName = getStoreName(emp.storeId);
                    const salaryType = emp.salaryType || 'fixed';
                    const baseSalary = emp.baseSalary || 0;
                    const empId = emp.id || '';
                    
                    return `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="py-4 px-6">${empName}</td>
                            <td class="py-4 px-6">${empUsername}</td>
                            <td class="py-4 px-6">${storeName}</td>
                            <td class="py-4 px-6 capitalize">${salaryType}</td>
                            <td class="py-4 px-6">$${baseSalary}</td>
                            <td class="py-4 px-6">
                                <button onclick="editItem('employee', '${empId}')" class="text-blue-600 hover:text-blue-800 mr-3">Edit</button>
                                <button onclick="deleteItem('employee', '${empId}')" class="text-red-600 hover:text-red-800">Delete</button>
                            </td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error in loadEmployeesTable:', error);
                const tbody = document.getElementById('employeesTable');
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-red-500">Error loading employees data</td></tr>';
                }
            }
        }

        async function loadStoresTable() {
            const tbody = document.getElementById('storesTable');
            
            if (stores.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-gray-500">No stores found. Click "Add Store" to create your first store.</td></tr>';
                return;
            }
            
            tbody.innerHTML = stores.filter(store => store && store.id).map(store => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="py-4 px-6">${store.name || 'N/A'}</td>
                    <td class="py-4 px-6">${store.location || 'N/A'}</td>
                    <td class="py-4 px-6">${store.manager || 'N/A'}</td>
                    <td class="py-4 px-6">${store.phone || 'N/A'}</td>
                    <td class="py-4 px-6">
                        <button onclick="editItem('store', '${store.id}')" class="text-blue-600 hover:text-blue-800 mr-3">Edit</button>
                        <button onclick="deleteItem('store', '${store.id}')" class="text-red-600 hover:text-red-800">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        async function loadProductsTable() {
            const tbody = document.getElementById('productsTable');
            
            if (products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="text-center py-8 text-gray-500">No products found. Click "Add Product" to create your first product.</td></tr>';
                return;
            }
            
            tbody.innerHTML = products.filter(product => product && product.id).map(product => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="py-4 px-6">${product.name || 'N/A'}</td>
                    <td class="py-4 px-6">$${product.price || 0}</td>
                    <td class="py-4 px-6">
                        <button onclick="editItem('product', '${product.id}')" class="text-blue-600 hover:text-blue-800 mr-3">Edit</button>
                        <button onclick="deleteItem('product', '${product.id}')" class="text-red-600 hover:text-red-800">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        async function loadCollectionsTable() {
            const tbody = document.getElementById('collectionsTable');
            
            if (collections.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-gray-500">No collections found. Click "Add Collection" to create your first collection.</td></tr>';
                return;
            }
            
            tbody.innerHTML = collections.filter(collection => collection && collection.id).map(collection => {
                // Count products in this collection
                const productCount = collection.productIds ? collection.productIds.length : 0;
                const status = collection.status || 'active';
                const statusColor = status === 'active' ? 'text-green-600' : 'text-gray-500';
                
                return `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="py-4 px-6">${collection.name || 'N/A'}</td>
                        <td class="py-4 px-6">${collection.description || 'N/A'}</td>
                        <td class="py-4 px-6">${productCount}</td>
                        <td class="py-4 px-6 ${statusColor} capitalize">${status}</td>
                        <td class="py-4 px-6">
                            <button onclick="editItem('collection', '${collection.id}')" class="text-blue-600 hover:text-blue-800 mr-3">Edit</button>
                            <button onclick="deleteItem('collection', '${collection.id}')" class="text-red-600 hover:text-red-800">Delete</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Local-First Data Saving
        async function saveEmployee(employee) {
            // Always save locally first
            const isNew = !employee.id;
            if (isNew) {
                employee.id = Date.now().toString();
            }
            
            const index = employees.findIndex(emp => emp.id === employee.id);
            if (index >= 0) {
                employees[index] = { ...employees[index], ...employee };
            } else {
                employees.push(employee);
            }
            saveLocalData();
            
            // Queue for Firebase sync if connected
            if (isFirebaseMode) {
                queueForSync(isNew ? 'create' : 'update', 'employee', employee);
            }
        }

        async function saveStore(store) {
            // Always save locally first
            const isNew = !store.id;
            if (isNew) {
                store.id = Date.now().toString();
            }
            
            const index = stores.findIndex(s => s.id === store.id);
            if (index >= 0) {
                stores[index] = { ...stores[index], ...store };
            } else {
                stores.push(store);
            }
            saveLocalData();
            
            // Queue for Firebase sync if connected
            if (isFirebaseMode) {
                queueForSync(isNew ? 'create' : 'update', 'store', store);
            }
        }

        async function saveProduct(product) {
            // Always save locally first
            const isNew = !product.id;
            if (isNew) {
                product.id = Date.now().toString();
            }
            
            const index = products.findIndex(p => p.id === product.id);
            if (index >= 0) {
                products[index] = { ...products[index], ...product };
            } else {
                products.push(product);
            }
            saveLocalData();
            
            // Queue for Firebase sync if connected
            if (isFirebaseMode) {
                queueForSync(isNew ? 'create' : 'update', 'product', product);
            }
        }

        async function saveCollection(collection) {
            // Always save locally first
            const isNew = !collection.id;
            if (isNew) {
                collection.id = Date.now().toString();
            }
            
            const index = collections.findIndex(c => c.id === collection.id);
            if (index >= 0) {
                collections[index] = { ...collections[index], ...collection };
            } else {
                collections.push(collection);
            }
            saveLocalData();
            
            // Queue for Firebase sync if connected
            if (isFirebaseMode) {
                queueForSync(isNew ? 'create' : 'update', 'collection', collection);
            }
        }

        async function saveSale(sale) {
            // Always save locally first
            const isNew = !sale.id;
            if (isNew) {
                sale.id = Date.now().toString();
            }
            
            const index = sales.findIndex(s => s.id === sale.id);
            if (index >= 0) {
                sales[index] = { ...sales[index], ...sale };
            } else {
                sales.push(sale);
            }
            saveLocalData();
            
            // Queue for Firebase sync if connected
            if (isFirebaseMode) {
                queueForSync(isNew ? 'create' : 'update', 'sale', sale);
            }
        }

        // Local-First Delete Functions
        async function deleteEmployee(id) {
            // Find the item to get Firebase ID if it exists
            const employee = employees.find(emp => emp.id === id);
            
            // Delete locally first
            employees = employees.filter(emp => emp.id !== id);
            saveLocalData();
            
            // Queue for Firebase sync if connected
            if (isFirebaseMode && employee) {
                queueForSync('delete', 'employee', employee);
            }
        }

        async function deleteStore(id) {
            const store = stores.find(s => s.id === id);
            
            stores = stores.filter(s => s.id !== id);
            saveLocalData();
            
            if (isFirebaseMode && store) {
                queueForSync('delete', 'store', store);
            }
        }

        async function deleteProduct(id) {
            const product = products.find(p => p.id === id);
            
            products = products.filter(p => p.id !== id);
            saveLocalData();
            
            if (isFirebaseMode && product) {
                queueForSync('delete', 'product', product);
            }
        }

        async function deleteCollection(id) {
            const collection = collections.find(c => c.id === id);
            
            collections = collections.filter(c => c.id !== id);
            saveLocalData();
            
            if (isFirebaseMode && collection) {
                queueForSync('delete', 'collection', collection);
            }
        }

        async function deleteSaleRecord(id) {
            const sale = sales.find(s => s.id === id);
            
            sales = sales.filter(s => s.id !== id);
            saveLocalData();
            
            if (isFirebaseMode && sale) {
                queueForSync('delete', 'sale', sale);
            }
        }

        // Utility Functions
        function getStoreName(storeId) {
            try {
                // Check if storeId is valid
                if (!storeId || storeId === null || storeId === undefined || storeId === '') {
                    return 'Unknown Store';
                }
                
                // Check if stores array is valid
                if (!stores || !Array.isArray(stores) || stores.length === 0) {
                    return 'Unknown Store';
                }
                
                // Find the store with comprehensive null checking
                const store = stores.find(s => {
                    return s && 
                           s !== null && 
                           s !== undefined && 
                           s.id && 
                           s.id !== null && 
                           s.id !== undefined && 
                           s.id.toString() === storeId.toString();
                });
                
                // Return store name with null checking
                if (store && store.name && typeof store.name === 'string' && store.name.trim() !== '') {
                    return store.name.trim();
                } else {
                    return 'Unknown Store';
                }
            } catch (error) {
                console.error('Error in getStoreName:', error, 'storeId:', storeId);
                return 'Unknown Store';
            }
        }

        function getProductName(productId) {
            try {
                // Check if productId is valid
                if (!productId || productId === null || productId === undefined || productId === '') {
                    return 'Unknown Product';
                }
                
                // Check if products array is valid
                if (!products || !Array.isArray(products) || products.length === 0) {
                    return 'Unknown Product';
                }
                
                // Find the product with comprehensive null checking
                const product = products.find(p => {
                    return p && 
                           p !== null && 
                           p !== undefined && 
                           p.id && 
                           p.id !== null && 
                           p.id !== undefined && 
                           p.id.toString() === productId.toString();
                });
                
                // Return product name with null checking
                if (product && product.name && typeof product.name === 'string' && product.name.trim() !== '') {
                    return product.name.trim();
                } else {
                    return 'Unknown Product';
                }
            } catch (error) {
                console.error('Error in getProductName:', error, 'productId:', productId);
                return 'Unknown Product';
            }
        }

        function getEmployeeName(employeeId) {
            try {
                // Check if employeeId is valid
                if (!employeeId || employeeId === null || employeeId === undefined || employeeId === '') {
                    return 'Unknown Employee';
                }
                
                // Check if employees array is valid
                if (!employees || !Array.isArray(employees) || employees.length === 0) {
                    return 'Unknown Employee';
                }
                
                // Find the employee with comprehensive null checking
                const employee = employees.find(e => {
                    return e && 
                           e !== null && 
                           e !== undefined && 
                           e.id && 
                           e.id !== null && 
                           e.id !== undefined && 
                           e.id.toString() === employeeId.toString();
                });
                
                // Return employee name with null checking
                if (employee && employee.name && typeof employee.name === 'string' && employee.name.trim() !== '') {
                    return employee.name.trim();
                } else {
                    return 'Unknown Employee';
                }
            } catch (error) {
                console.error('Error in getEmployeeName:', error, 'employeeId:', employeeId);
                return 'Unknown Employee';
            }
        }

        function getProduct(productId) {
            try {
                // Check if productId is valid
                if (!productId || productId === null || productId === undefined || productId === '') {
                    return null;
                }
                
                // Check if products array is valid
                if (!products || !Array.isArray(products) || products.length === 0) {
                    return null;
                }
                
                // Find the product with comprehensive null checking
                const product = products.find(p => {
                    return p && 
                           p !== null && 
                           p !== undefined && 
                           p.id && 
                           p.id !== null && 
                           p.id !== undefined && 
                           p.id.toString() === productId.toString();
                });
                
                // Return the product object or null
                return product || null;
            } catch (error) {
                console.error('Error in getProduct:', error, 'productId:', productId);
                return null;
            }
        }

        // Additional utility function to get store object
        function getStore(storeId) {
            try {
                // Check if storeId is valid
                if (!storeId || storeId === null || storeId === undefined || storeId === '') {
                    return null;
                }
                
                // Check if stores array is valid
                if (!stores || !Array.isArray(stores) || stores.length === 0) {
                    return null;
                }
                
                // Find the store with comprehensive null checking
                const store = stores.find(s => {
                    return s && 
                           s !== null && 
                           s !== undefined && 
                           s.id && 
                           s.id !== null && 
                           s.id !== undefined && 
                           s.id.toString() === storeId.toString();
                });
                
                // Return the store object or null
                return store || null;
            } catch (error) {
                console.error('Error in getStore:', error, 'storeId:', storeId);
                return null;
            }
        }

        // Additional utility function to get employee object
        function getEmployee(employeeId) {
            try {
                // Check if employeeId is valid
                if (!employeeId || employeeId === null || employeeId === undefined || employeeId === '') {
                    return null;
                }
                
                // Check if employees array is valid
                if (!employees || !Array.isArray(employees) || employees.length === 0) {
                    return null;
                }
                
                // Find the employee with comprehensive null checking
                const employee = employees.find(e => {
                    return e && 
                           e !== null && 
                           e !== undefined && 
                           e.id && 
                           e.id !== null && 
                           e.id !== undefined && 
                           e.id.toString() === employeeId.toString();
                });
                
                // Return the employee object or null
                return employee || null;
            } catch (error) {
                console.error('Error in getEmployee:', error, 'employeeId:', employeeId);
                return null;
            }
        }

        function getTodayString() {
            return new Date().toISOString().split('T')[0];
        }

        function getCurrentTime() {
            return new Date().toLocaleTimeString('en-US', { 
                hour12: false, 
                hour: '2-digit', 
                minute: '2-digit' 
            });
        }

        function updateCurrentDate(elementId) {
            const now = new Date();
            const dateString = now.toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            document.getElementById(elementId).textContent = dateString;
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96a745810410f9d7',t:'MTc1NDQwNzE1My4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
