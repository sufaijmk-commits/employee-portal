<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eden Perfume - Sales Management System</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🌸</text></svg>">
    
    <!-- Firebase SDK with better error handling -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js" onerror="handleFirebaseLoadError('app')"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js" onerror="handleFirebaseLoadError('firestore')"></script>
    
    <style>
        /* Manual Tailwind CSS Configuration */
        /* Reset and Base Styles */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: #374151;
        }
        
        /* Utility Classes */
        .min-h-screen { min-height: 100vh; }
        .bg-gray-50 { background-color: #f9fafb; }
        .bg-white { background-color: #ffffff; }
        .bg-gray-100 { background-color: #f3f4f6; }
        .bg-gray-600 { background-color: #4b5563; }
        .bg-gray-700 { background-color: #374151; }
        .bg-blue-600 { background: linear-gradient(135deg, #4a5568 0%, #718096 50%, #a0aec0 100%); }
        .bg-blue-700 { background: linear-gradient(135deg, #2d3748 0%, #4a5568 50%, #718096 100%); }
        .bg-green-600 { background: linear-gradient(135deg, #4a5568 0%, #718096 50%, #a0aec0 100%); }
        .bg-green-700 { background: linear-gradient(135deg, #2d3748 0%, #4a5568 50%, #718096 100%); }
        .bg-red-600 { background: linear-gradient(135deg, #4a5568 0%, #718096 50%, #a0aec0 100%); }
        .bg-red-700 { background: linear-gradient(135deg, #2d3748 0%, #4a5568 50%, #718096 100%); }
        .bg-purple-600 { background: linear-gradient(135deg, #4a5568 0%, #718096 50%, #a0aec0 100%); }
        .bg-purple-700 { background: linear-gradient(135deg, #2d3748 0%, #4a5568 50%, #718096 100%); }
        .bg-orange-600 { background: linear-gradient(135deg, #4a5568 0%, #718096 50%, #a0aec0 100%); }
        .bg-orange-700 { background: linear-gradient(135deg, #2d3748 0%, #4a5568 50%, #718096 100%); }
        .bg-yellow-600 { background: linear-gradient(135deg, #4a5568 0%, #718096 50%, #a0aec0 100%); }
        .bg-yellow-700 { background: linear-gradient(135deg, #2d3748 0%, #4a5568 50%, #718096 100%); }
        .bg-yellow-50 { background-color: #fefce8; }
        .bg-green-100 { background-color: #dcfce7; }
        .bg-blue-100 { background-color: #dbeafe; }
        .bg-purple-100 { background-color: #f3e8ff; }
        
        .text-white { color: #f7fafc; }
        .text-gray-500 { color: #6b7280; }
        .text-gray-600 { color: #4b5563; }
        .text-gray-700 { color: #374151; }
        .text-gray-800 { color: #1f2937; }
        .text-blue-600 { color: #2563eb; }
        .text-blue-800 { color: #1e40af; }
        .text-green-600 { color: #16a34a; }
        .text-green-800 { color: #166534; }
        .text-red-600 { color: #dc2626; }
        .text-red-800 { color: #991b1b; }
        .text-purple-600 { color: #9333ea; }
        .text-yellow-600 { color: #ca8a04; }
        .text-yellow-700 { color: #a16207; }
        .text-yellow-800 { color: #92400e; }
        .text-red-500 { color: #ef4444; }
        
        .p-4 { padding: 1rem; }
        .p-6 { padding: 1.5rem; }
        .p-8 { padding: 2rem; }
        .px-3 { padding-left: 0.75rem; padding-right: 0.75rem; }
        .px-4 { padding-left: 1rem; padding-right: 1rem; }
        .px-6 { padding-left: 1.5rem; padding-right: 1.5rem; }
        .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
        .py-3 { padding-top: 0.75rem; padding-bottom: 0.75rem; }
        .py-4 { padding-top: 1rem; padding-bottom: 1rem; }
        .py-8 { padding-top: 2rem; padding-bottom: 2rem; }
        
        .m-4 { margin: 1rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mb-6 { margin-bottom: 1.5rem; }
        .mb-8 { margin-bottom: 2rem; }
        .mt-1 { margin-top: 0.25rem; }
        .mt-2 { margin-top: 0.5rem; }
        .mt-6 { margin-top: 1.5rem; }
        .mt-8 { margin-top: 2rem; }
        .mr-3 { margin-right: 0.75rem; }
        .ml-2 { margin-left: 0.5rem; }
        .mx-auto { margin-left: auto; margin-right: auto; }
        
        .w-full { width: 100%; }
        .w-10 { width: 2.5rem; }
        .w-12 { width: 3rem; }
        .w-20 { width: 5rem; }
        .max-w-md { max-width: 28rem; }
        .max-w-2xl { max-width: 42rem; }
        .max-h-40 { max-height: 10rem; }
        
        .h-10 { height: 2.5rem; }
        .h-12 { height: 3rem; }
        .h-20 { height: 5rem; }
        
        .flex { display: flex; }
        .flex-1 { flex: 1 1 0%; }
        .flex-wrap { flex-wrap: wrap; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .justify-center { justify-content: center; }
        .space-x-2 > * + * { margin-left: 0.5rem; }
        .space-x-3 > * + * { margin-left: 0.75rem; }
        .space-y-1 > * + * { margin-top: 0.25rem; }
        .space-y-4 > * + * { margin-top: 1rem; }
        .space-y-6 > * + * { margin-top: 1.5rem; }
        
        .grid { display: grid; }
        .grid-cols-1 { grid-template-columns: repeat(1, minmax(0, 1fr)); }
        .grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
        .grid-cols-5 { grid-template-columns: repeat(5, minmax(0, 1fr)); }
        .gap-2 { gap: 0.5rem; }
        .gap-4 { gap: 1rem; }
        .gap-6 { gap: 1.5rem; }
        
        .rounded-lg { border-radius: 0.5rem; }
        .rounded-xl { border-radius: 0.75rem; }
        .rounded-2xl { border-radius: 1rem; }
        .rounded-full { border-radius: 9999px; }
        
        .border { border-width: 1px; }
        .border-b { border-bottom-width: 1px; }
        .border-b-2 { border-bottom-width: 2px; }
        .border-t-2 { border-top-width: 2px; }
        .border-gray-300 { border-color: #d1d5db; }
        .border-gray-400 { border-color: #9ca3af; }
        .border-purple-500 { border-color: #a855f7; }
        .border-transparent { border-color: transparent; }
        .border-yellow-200 { border-color: #fde047; }
        
        .font-medium { font-weight: 500; }
        .font-semibold { font-weight: 600; }
        .font-bold { font-weight: 700; }
        
        .text-xs { font-size: 0.75rem; }
        .text-sm { font-size: 0.875rem; }
        .text-lg { font-size: 1.125rem; }
        .text-xl { font-size: 1.25rem; }
        .text-2xl { font-size: 1.5rem; }
        .text-3xl { font-size: 1.875rem; }
        
        .text-left { text-align: left; }
        .text-center { text-align: center; }
        
        .capitalize { text-transform: capitalize; }
        .whitespace-nowrap { white-space: nowrap; }
        
        .overflow-hidden { overflow: hidden; }
        .overflow-x-auto { overflow-x: auto; }
        .overflow-y-auto { overflow-y: auto; }
        
        .fixed { position: fixed; }
        .inset-0 { top: 0; right: 0; bottom: 0; left: 0; }
        
        .z-50 { z-index: 50; }
        
        .hidden { display: none; }
        .block { display: block; }
        
        .opacity-70 { opacity: 0.7; }
        .opacity-80 { opacity: 0.8; }
        .opacity-90 { opacity: 0.9; }
        .bg-opacity-20 { background-color: rgba(255, 255, 255, 0.2); }
        .bg-opacity-30 { background-color: rgba(255, 255, 255, 0.3); }
        
        .transition { transition-property: color, background-color, border-color, text-decoration-color, fill, stroke, opacity, box-shadow, transform, filter, backdrop-filter; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 150ms; }
        
        .hover\:bg-gray-50:hover { background-color: #f9fafb; }
        .hover\:bg-gray-700:hover { background: linear-gradient(135deg, #2d3748 0%, #4a5568 50%, #718096 100%); }
        .hover\:bg-blue-700:hover { background: linear-gradient(135deg, #2d3748 0%, #4a5568 50%, #718096 100%); }
        .hover\:bg-green-700:hover { background: linear-gradient(135deg, #2d3748 0%, #4a5568 50%, #718096 100%); }
        .hover\:bg-red-700:hover { background: linear-gradient(135deg, #2d3748 0%, #4a5568 50%, #718096 100%); }
        .hover\:bg-purple-700:hover { background: linear-gradient(135deg, #2d3748 0%, #4a5568 50%, #718096 100%); }
        .hover\:bg-orange-700:hover { background: linear-gradient(135deg, #2d3748 0%, #4a5568 50%, #718096 100%); }
        .hover\:bg-yellow-700:hover { background: linear-gradient(135deg, #2d3748 0%, #4a5568 50%, #718096 100%); }
        .hover\:bg-red-800:hover { background: linear-gradient(135deg, #2d3748 0%, #4a5568 50%, #718096 100%); }
        .hover\:text-blue-800:hover { color: #1e40af; }
        .hover\:text-red-800:hover { color: #991b1b; }
        .hover\:text-green-800:hover { color: #166534; }
        .hover\:border-purple-500:hover { border-color: #a855f7; }
        .hover\:opacity-90:hover { opacity: 0.9; }
        .hover\:opacity-30:hover { opacity: 0.3; }
        
        .focus\:ring-2:focus { box-shadow: 0 0 0 2px rgba(168, 85, 247, 0.5); }
        .focus\:ring-purple-500:focus { box-shadow: 0 0 0 2px rgba(168, 85, 247, 0.5); }
        .focus\:border-transparent:focus { border-color: transparent; }
        
        /* Form Elements */
        input, select, textarea {
            border: 2px solid #d1d5db;
            border-radius: 0.5rem;
            padding: 0.75rem;
            font-size: 1rem;
            line-height: 1.25rem;
            width: 100%;
            background-color: #ffffff;
            min-height: 44px; /* iOS touch target minimum */
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #a855f7;
            box-shadow: 0 0 0 3px rgba(168, 85, 247, 0.1);
        }
        
        /* Mobile form adjustments */
        @media (max-width: 640px) {
            input, select, textarea {
                font-size: 16px; /* Prevents zoom on iOS */
                padding: 0.875rem;
            }
        }
        
        button {
            border: none;
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }
        
        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Table Styles */
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            text-align: left;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #e5e7eb;
        }
        
        th {
            background-color: #f9fafb;
            font-weight: 500;
            color: #374151;
        }
        
        tr:hover {
            background-color: #f9fafb;
        }
        
        /* Mobile-First Responsive Design */
        
        /* Mobile Base Styles */
        .mobile-container {
            padding: 0.75rem;
        }
        
        .mobile-card {
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 1rem;
        }
        
        .mobile-button {
            min-height: 44px; /* iOS touch target minimum */
            padding: 0.75rem 1rem;
            font-size: 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease;
        }
        
        .mobile-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
        }
        
        .mobile-input {
            min-height: 44px;
            padding: 0.75rem;
            font-size: 1rem;
            border-radius: 0.5rem;
            border: 2px solid #d1d5db;
        }
        
        .mobile-input:focus {
            border-color: #a855f7;
            box-shadow: 0 0 0 3px rgba(168, 85, 247, 0.1);
        }
        
        .mobile-nav {
            position: sticky;
            top: 0;
            z-index: 40;
            background: linear-gradient(135deg, #4a5568 0%, #718096 50%, #a0aec0 100%);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            color: #f7fafc;
        }
        
        .mobile-tab-scroll {
            overflow-x: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        
        .mobile-tab-scroll::-webkit-scrollbar {
            display: none;
        }
        
        .mobile-table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .mobile-table {
            min-width: 600px;
        }
        
        .mobile-stats-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
        }
        
        .mobile-form-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
        }
        
        .mobile-action-buttons {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .mobile-modal {
            margin: 1rem;
            max-height: calc(100vh - 2rem);
            overflow-y: auto;
        }
        
        /* Touch-friendly spacing */
        .touch-target {
            min-height: 44px;
            min-width: 44px;
        }
        
        /* Tablet Styles */
        @media (min-width: 640px) {
            .sm\:grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
            .sm\:grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
            .sm\:flex-row { flex-direction: row; }
            .sm\:space-x-2 > * + * { margin-left: 0.5rem; margin-top: 0; }
            .sm\:space-y-0 > * + * { margin-top: 0; }
            
            .mobile-container {
                padding: 1rem;
            }
            
            .mobile-stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .mobile-form-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .mobile-action-buttons {
                flex-direction: row;
                flex-wrap: wrap;
            }
        }
        
        @media (min-width: 768px) {
            .md\:grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
            .md\:grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
            .md\:grid-cols-4 { grid-template-columns: repeat(4, minmax(0, 1fr)); }
            .md\:grid-cols-5 { grid-template-columns: repeat(5, minmax(0, 1fr)); }
            .md\:flex-row { flex-direction: row; }
            .md\:space-x-3 > * + * { margin-left: 0.75rem; margin-top: 0; }
            .md\:space-y-0 > * + * { margin-top: 0; }
            
            .mobile-container {
                padding: 1.5rem;
            }
            
            .mobile-stats-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .mobile-form-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .mobile-modal {
                margin: 2rem auto;
                max-width: 28rem;
            }
        }
        
        @media (min-width: 1024px) {
            .lg\:grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
            .lg\:grid-cols-4 { grid-template-columns: repeat(4, minmax(0, 1fr)); }
            .lg\:grid-cols-5 { grid-template-columns: repeat(5, minmax(0, 1fr)); }
            
            .mobile-container {
                padding: 2rem;
            }
            
            .mobile-form-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        
        /* Mobile-specific utilities */
        .hide-mobile { display: block; }
        .show-mobile { display: none; }
        
        @media (max-width: 640px) {
            .hide-mobile { display: none; }
            .show-mobile { display: block; }
            
            /* Compact mobile styles */
            .text-xs-mobile { font-size: 0.75rem; }
            .text-sm-mobile { font-size: 0.875rem; }
            .p-2-mobile { padding: 0.5rem; }
            .px-2-mobile { padding-left: 0.5rem; padding-right: 0.5rem; }
            .py-1-mobile { padding-top: 0.25rem; padding-bottom: 0.25rem; }
        }
        
        /* Custom Component Styles */
        .gradient-bg {
            background: linear-gradient(135deg, #4a5568 0%, #718096 50%, #a0aec0 100%);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            color: #f7fafc;
        }
        
        .card-shadow {
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .tab-active {
            background: linear-gradient(135deg, #4a5568 0%, #718096 50%, #a0aec0 100%);
            color: #f7fafc;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen gradient-bg flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl card-shadow p-8 w-full max-w-md fade-in">
            <div class="text-center mb-8">
                <div class="w-20 h-20 mx-auto mb-4 rounded-full flex items-center justify-center shadow-lg" style="background: linear-gradient(135deg, #4a5568 0%, #718096 50%, #a0aec0 100%)">
                    <svg class="w-10 h-10" fill="#f7fafc" viewBox="0 0 24 24">
                        <path d="M12 2C10.9 2 10 2.9 10 4V6H8C6.9 6 6 6.9 6 8V20C6 21.1 6.9 22 8 22H16C17.1 22 18 21.1 18 20V8C18 6.9 17.1 6 16 6H14V4C14 2.9 13.1 2 12 2ZM12 4C12 4 12 4 12 4V6H12V4ZM8 8H16V20H8V8ZM10 10V18H14V10H10Z"/>
                        <circle cx="12" cy="14" r="1"/>
                    </svg>
                </div>
                <h1 class="text-3xl font-bold text-gray-800 mb-2">EDEN PERFUME</h1>
                <p class="text-gray-600">Sales Management System</p>
                <div class="mt-2 text-sm" id="dbStatus">
                    <div id="dbMode" class="text-green-600"></div>
                    <div id="syncStatus" class="text-xs mt-1"></div>
                </div>
            </div>
            
            <form id="loginForm" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                    <input type="text" id="username" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Enter username">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                    <input type="password" id="password" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Enter password">
                </div>
                
                <button type="submit" class="w-full gradient-bg text-white py-3 rounded-lg font-semibold hover:opacity-90 transition">
                    <span id="loginBtnText">Sign In</span>
                </button>
            </form>
            
            <div class="mt-8 p-4 bg-gray-50 rounded-lg text-center">
                <p class="text-xs text-gray-500">Developed by <strong class="text-purple-600">Sufaij</strong></p>
            </div>
        </div>
    </div>

    <!-- Employee Portal -->
    <div id="employeePortal" class="hidden min-h-screen" style="background-color: #e5e7eb;">
        <nav class="mobile-nav gradient-bg text-white">
            <!-- Mobile Header -->
            <div class="mobile-container">
                <div class="flex justify-between items-center mb-3">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z"/>
                            </svg>
                        </div>
                        <div>
                            <h2 class="font-semibold text-lg" id="employeeName">Employee</h2>
                            <p class="text-sm opacity-80" id="employeeStore">Store</p>
                        </div>
                    </div>
                    <button onclick="logout()" class="bg-white bg-opacity-20 mobile-button text-sm touch-target">
                        Logout
                    </button>
                </div>
                
                <!-- Mobile Status Bar -->
                <div class="flex justify-between items-center text-sm mb-3">
                    <div class="opacity-80" id="employeeCurrentDate"></div>
                    <div class="text-xs opacity-70" id="employeeSyncStatus">📱 Local Mode</div>
                </div>
                
                <!-- Simple Status Bar -->
                <div class="text-center text-sm opacity-80">
                    Ready to record sales
                </div>
            </div>
        </nav>

        <div class="mobile-container">
            <!-- Compact Horizontal Stats -->
            <div class="bg-white mobile-card p-3 mb-4">
                <div class="grid grid-cols-3 gap-2 text-center">
                    <!-- Total Sales -->
                    <div class="bg-green-50 rounded-lg p-2">
                        <div class="flex items-center justify-center mb-1">
                            <div class="w-6 h-6 bg-green-100 rounded-full flex items-center justify-center mr-1">
                                <span class="text-green-600 text-xs">💰</span>
                            </div>
                            <span class="text-xs font-medium text-green-800">SALES</span>
                        </div>
                        <div class="text-lg font-bold text-green-600" id="totalSalesToday">0.00 DH</div>
                        <p class="text-xs text-green-600">Revenue</p>
                    </div>

                    <!-- Quantity Sold -->
                    <div class="bg-blue-50 rounded-lg p-2">
                        <div class="flex items-center justify-center mb-1">
                            <div class="w-6 h-6 bg-blue-100 rounded-full flex items-center justify-center mr-1">
                                <span class="text-blue-600 text-xs">🧴</span>
                            </div>
                            <span class="text-xs font-medium text-blue-800">QTY</span>
                        </div>
                        <div class="text-lg font-bold text-blue-600" id="bottlesSold">0</div>
                        <p class="text-xs text-blue-600">Bottles</p>
                    </div>

                    <!-- Today's Salary -->
                    <div class="bg-purple-50 rounded-lg p-2">
                        <div class="flex items-center justify-center mb-1">
                            <div class="w-6 h-6 bg-purple-100 rounded-full flex items-center justify-center mr-1">
                                <span class="text-purple-600 text-xs">💵</span>
                            </div>
                            <span class="text-xs font-medium text-purple-800">SALARY</span>
                        </div>
                        <div class="text-lg font-bold text-purple-600" id="estimatedSalary">0.00 DH</div>
                        <p class="text-xs text-purple-600">Today</p>
                    </div>
                </div>
            </div>

            <!-- Compact Sale Entry -->
            <div class="bg-white mobile-card p-3 mb-4">
                <h3 class="text-lg font-bold text-gray-800 mb-3 text-center">Record New Sale</h3>
                
                <form id="addSaleForm" class="space-y-3">
                    <!-- Store Selection -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Store</label>
                        <select id="saleStore" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-blue-500" required>
                            <option value="">Select store</option>
                        </select>
                    </div>
                    
                    <!-- Product Selection -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Product</label>
                        <select id="saleProduct" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-blue-500" required>
                            <option value="">Choose product</option>
                        </select>
                    </div>
                    
                    <!-- Quantity Input -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Quantity</label>
                        <div class="flex items-center space-x-2">
                            <button type="button" onclick="adjustQuantity(-1)" class="w-8 h-8 bg-red-500 text-white rounded text-lg font-bold hover:bg-red-600">-</button>
                            <input type="number" id="saleQuantity" min="1" value="1" class="flex-1 text-center text-lg font-bold border border-gray-300 rounded py-2" required>
                            <button type="button" onclick="adjustQuantity(1)" class="w-8 h-8 bg-green-500 text-white rounded text-lg font-bold hover:bg-green-600">+</button>
                        </div>
                    </div>
                    
                    <!-- Total Display -->
                    <div class="bg-gray-50 border rounded-lg p-3 text-center">
                        <p class="text-sm text-gray-600">Total Amount</p>
                        <p class="text-2xl font-bold text-blue-600" id="totalAmount">0.00 DH</p>
                    </div>
                    
                    <!-- Save Button -->
                    <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700">
                        Record Sale
                    </button>
                </form>
            </div>

            <!-- Today's Sales -->
            <div class="bg-white mobile-card p-4">
                <h3 class="text-lg font-semibold mb-4 text-center">📊 Today's Sales - <span id="currentDate"></span></h3>
                <div class="mobile-table-container">
                    <table class="mobile-table w-full">
                        <thead>
                            <tr class="border-b">
                                <th class="text-left py-2 px-2 text-sm">Time</th>
                                <th class="text-left py-2 px-2 text-sm hide-mobile">Store</th>
                                <th class="text-left py-2 px-2 text-sm">Product</th>
                                <th class="text-left py-2 px-2 text-sm">Qty</th>
                                <th class="text-left py-2 px-2 text-sm">Amount</th>
                                <th class="text-left py-2 px-2 text-sm">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="todaysSalesTable">
                            <tr>
                                <td colspan="6" class="text-center py-8 text-gray-500 text-sm">No sales recorded today</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="dashboard" class="hidden min-h-screen" style="background-color: #e5e7eb;">
        <nav class="mobile-nav gradient-bg text-white">
            <div class="mobile-container">
                <!-- Mobile Header -->
                <div class="flex justify-between items-center mb-3">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </div>
                        <div>
                            <h2 class="font-semibold text-lg">Eden Perfume Admin</h2>
                            <p class="text-sm opacity-80">Management Dashboard</p>
                        </div>
                    </div>
                    <button onclick="logout()" class="bg-white bg-opacity-20 mobile-button text-sm touch-target">
                        Logout
                    </button>
                </div>
                
                <!-- Mobile Status Bar -->
                <div class="flex justify-between items-center text-sm mb-3">
                    <div class="opacity-80" id="adminCurrentDate"></div>
                    <div class="text-xs opacity-70" id="adminSyncStatus">📱 Local Mode</div>
                </div>
                
                <!-- Mobile Action Buttons - Scrollable -->
                <div class="mobile-tab-scroll">
                    <div class="flex space-x-2 pb-2" style="min-width: max-content;">
                        <button onclick="forceSyncNow()" class="bg-orange-600 mobile-button hover:bg-orange-700 transition text-sm whitespace-nowrap">
                            🔄 Sync
                        </button>
                        <button onclick="resetFirebaseConfig()" class="bg-red-600 mobile-button hover:bg-red-700 transition text-sm whitespace-nowrap">
                            🔥 Firebase
                        </button>
                        <button onclick="viewTodaysSummary()" class="bg-purple-600 mobile-button hover:bg-purple-700 transition text-sm whitespace-nowrap">
                            📊 Summary
                        </button>
                        <button onclick="backupData()" class="bg-yellow-600 mobile-button hover:bg-yellow-700 transition text-sm whitespace-nowrap">
                            💾 Backup
                        </button>
                        <button onclick="downloadAllMasterData()" class="bg-green-600 mobile-button hover:bg-green-700 transition text-sm whitespace-nowrap">
                            📥 Download
                        </button>
                        <button onclick="restoreFromBackup()" class="bg-orange-600 mobile-button hover:bg-orange-700 transition text-sm whitespace-nowrap">
                            📤 Restore
                        </button>
                        <button onclick="clearAllData()" class="bg-red-600 mobile-button hover:bg-red-700 transition text-sm whitespace-nowrap">
                            🗑️ Clear All
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Tab Navigation -->
        <div class="bg-white border-b">
            <div class="mobile-tab-scroll">
                <div class="flex space-x-0" style="min-width: max-content;">
                    <button onclick="switchTab('sales')" class="tab-btn px-4 py-3 font-medium whitespace-nowrap border-b-2 border-transparent hover:border-purple-500 transition text-sm touch-target" data-tab="sales">
                        📊 Sales
                    </button>
                    <button onclick="switchTab('salary')" class="tab-btn px-4 py-3 font-medium whitespace-nowrap border-b-2 border-transparent hover:border-purple-500 transition text-sm touch-target" data-tab="salary">
                        💰 Salary
                    </button>
                    <button onclick="switchTab('employees')" class="tab-btn px-4 py-3 font-medium whitespace-nowrap border-b-2 border-transparent hover:border-purple-500 transition text-sm touch-target" data-tab="employees">
                        👥 Employees
                    </button>
                    <button onclick="switchTab('stores')" class="tab-btn px-4 py-3 font-medium whitespace-nowrap border-b-2 border-transparent hover:border-purple-500 transition text-sm touch-target" data-tab="stores">
                        🏪 Stores
                    </button>
                    <button onclick="switchTab('products')" class="tab-btn px-4 py-3 font-medium whitespace-nowrap border-b-2 border-transparent hover:border-purple-500 transition text-sm touch-target" data-tab="products">
                        🧴 Products
                    </button>
                </div>
            </div>
        </div>

        <!-- Tab Content -->
        <div class="mobile-container">
            <!-- Employees Tab -->
            <div id="employees-tab" class="tab-content">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-3">
                    <h2 class="text-xl font-bold">Employee Management</h2>
                    <div class="mobile-action-buttons sm:flex-row sm:space-x-2 sm:space-y-0 w-full sm:w-auto">
                        <button onclick="openModal('employee')" class="gradient-bg text-white mobile-button hover:opacity-90 transition">
                            ➕ Add Employee
                        </button>
                    </div>
                </div>
                <div class="bg-white mobile-card overflow-hidden">
                    <div class="mobile-table-container">
                        <table class="mobile-table w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="text-left py-3 px-3 text-sm">Name</th>
                                    <th class="text-left py-3 px-3 text-sm hide-mobile">Username</th>
                                    <th class="text-left py-3 px-3 text-sm">Store</th>
                                    <th class="text-left py-3 px-3 text-sm hide-mobile">Salary Type</th>
                                    <th class="text-left py-3 px-3 text-sm">Salary</th>
                                    <th class="text-left py-3 px-3 text-sm">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="employeesTable">
                                <tr>
                                    <td colspan="6" class="text-center py-8 text-gray-500 text-sm">
                                        No employees found. Click "Add Employee" to create your first employee.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Stores Tab -->
            <div id="stores-tab" class="tab-content hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Store Management</h2>
                    <button onclick="openModal('store')" class="gradient-bg text-white px-4 py-2 rounded-lg font-semibold hover:opacity-90 transition">
                        ➕ Add Store
                    </button>
                </div>
                <div class="bg-white rounded-xl card-shadow overflow-hidden">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="text-left py-4 px-6">Store Name</th>
                                <th class="text-left py-4 px-6">Location</th>
                                <th class="text-left py-4 px-6">Manager</th>
                                <th class="text-left py-4 px-6">Phone</th>
                                <th class="text-left py-4 px-6">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="storesTable">
                            <tr>
                                <td colspan="5" class="text-center py-8 text-gray-500">
                                    No stores found. Click "Add Store" to create your first store.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Products Tab -->
            <div id="products-tab" class="tab-content hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Product Management</h2>
                    <button onclick="openModal('product')" class="gradient-bg text-white px-4 py-2 rounded-lg font-semibold hover:opacity-90 transition">
                        ➕ Add Product
                    </button>
                </div>
                <div class="bg-white rounded-xl card-shadow overflow-hidden">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="text-left py-4 px-6">Product Name</th>
                                <th class="text-left py-4 px-6">Price</th>
                                <th class="text-left py-4 px-6">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="productsTable">
                            <tr>
                                <td colspan="3" class="text-center py-8 text-gray-500">
                                    No products found. Click "Add Product" to create your first product.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>



            <!-- Sales Reports Tab -->
            <div id="sales-tab" class="tab-content hidden">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold mb-4">Sales Reports</h2>
                    
                    <!-- Report Controls -->
                    <div class="bg-white rounded-xl card-shadow p-6 mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Start Date</label>
                                <input type="date" id="reportStartDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">End Date</label>
                                <input type="date" id="reportEndDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Report Type</label>
                                <select id="reportType" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                    <option value="all">All Sales</option>
                                    <option value="daily">Daily Report</option>
                                    <option value="monthly">Monthly Report</option>
                                    <option value="store">Store Wise</option>
                                    <option value="staff">Staff Wise</option>
                                    <option value="product">Product Wise</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Filter By</label>
                                <select id="reportFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                    <option value="">All</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="flex flex-wrap gap-2">
                            <button onclick="generateSalesReport()" class="gradient-bg text-white px-4 py-2 rounded-lg font-semibold hover:opacity-90 transition">
                                📊 Generate Report
                            </button>
                            <button onclick="printReport('sales')" class="bg-gray-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-gray-700 transition">
                                🖨️ Print
                            </button>
                            <button onclick="downloadExcel('sales')" class="bg-green-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-700 transition">
                                📊 Excel
                            </button>
                            <button onclick="downloadPDF('sales')" class="bg-red-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-red-700 transition">
                                📄 PDF
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-xl card-shadow overflow-hidden">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr id="salesReportHeader">
                                <th class="text-left py-4 px-6">Date</th>
                                <th class="text-left py-4 px-6">Employee</th>
                                <th class="text-left py-4 px-6">Store</th>
                                <th class="text-left py-4 px-6">Product</th>
                                <th class="text-left py-4 px-6">Quantity</th>
                                <th class="text-left py-4 px-6">Amount</th>
                            </tr>
                        </thead>
                        <tbody id="salesReportTable">
                            <tr>
                                <td colspan="6" class="text-center py-8 text-gray-500">Select date range and report type to generate report</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Salary Reports Tab -->
            <div id="salary-tab" class="tab-content hidden">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold mb-4">Salary Reports</h2>
                    
                    <!-- Salary Report Controls -->
                    <div class="bg-white rounded-xl card-shadow p-6 mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Start Date</label>
                                <input type="date" id="salaryStartDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">End Date</label>
                                <input type="date" id="salaryEndDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Employee</label>
                                <select id="salaryEmployee" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                    <option value="">All Employees</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="flex flex-wrap gap-2">
                            <button onclick="generateSalaryReport()" class="gradient-bg text-white px-4 py-2 rounded-lg font-semibold hover:opacity-90 transition">
                                💰 Generate Report
                            </button>
                            <button onclick="printReport('salary')" class="bg-gray-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-gray-700 transition">
                                🖨️ Print
                            </button>
                            <button onclick="downloadExcel('salary')" class="bg-green-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-700 transition">
                                📊 Excel
                            </button>
                            <button onclick="downloadPDF('salary')" class="bg-red-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-red-700 transition">
                                📄 PDF
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-xl card-shadow overflow-hidden">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="text-left py-4 px-6">Employee</th>
                                <th class="text-left py-4 px-6">Salary Type</th>
                                <th class="text-left py-4 px-6">Base Salary</th>
                                <th class="text-left py-4 px-6">Bonus/Commission</th>
                                <th class="text-left py-4 px-6">Total Sales</th>
                                <th class="text-left py-4 px-6">Days/Qty</th>
                                <th class="text-left py-4 px-6">Total Salary</th>
                            </tr>
                        </thead>
                        <tbody id="salaryReportTable">
                            <tr>
                                <td colspan="7" class="text-center py-8 text-gray-500">Select date range to generate report</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="modal" class="hidden fixed inset-0 modal-backdrop z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl card-shadow mobile-modal w-full fade-in">
            <div class="p-4 border-b">
                <h3 id="modalTitle" class="text-lg font-semibold">Add Item</h3>
            </div>
            <div class="p-4">
                <form id="modalForm">
                    <div id="modalFields" class="space-y-4">
                        <!-- Dynamic fields will be inserted here -->
                    </div>
                    <div class="mobile-action-buttons sm:flex-row sm:space-x-3 sm:space-y-0 mt-6">
                        <button type="button" onclick="closeModal()" class="flex-1 mobile-button border border-gray-300 hover:bg-gray-50 transition bg-white text-gray-700">
                            Cancel
                        </button>
                        <button type="submit" class="flex-1 gradient-bg text-white mobile-button hover:opacity-90 transition">
                            <span id="saveBtnText">Save</span>
                            <div id="saveLoader" class="loading hidden ml-2"></div>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Firebase loading error handler
        function handleFirebaseLoadError(component) {
            console.warn(`Firebase ${component} failed to load - falling back to local mode`);
            window.firebaseLoadError = true;
        }

        // Global Variables
        let db = null;
        let isFirebaseMode = false;
        let currentUser = null;
        let currentUserRole = null;
        let editingItem = null;
        let editingType = null;

        // Local Storage Data (Always used as primary storage)
        let employees = [];
        let stores = [];
        let products = [];
        let collections = [];
        let sales = [];

        // Initialize arrays safely
        function initializeArrays() {
            if (!Array.isArray(employees)) employees = [];
            if (!Array.isArray(stores)) stores = [];
            if (!Array.isArray(products)) products = [];
            if (!Array.isArray(collections)) collections = [];
            if (!Array.isArray(sales)) sales = [];
        }

        // Sync Management
        let syncQueue = [];
        let isSyncing = false;
        let lastSyncTime = null;
        let syncStatus = 'offline';

        // Firebase Configuration - EDIT THESE VALUES WITH YOUR FIREBASE CONFIG
        const FIREBASE_CONFIG = {
            apiKey: "your-api-key-here",
            authDomain: "your-project.firebaseapp.com",
            projectId: "your-project-id",
            storageBucket: "your-project.appspot.com",
            messagingSenderId: "your-sender-id",
            appId: "your-app-id"
        };

        // Firebase Configuration
        async function initializeFirebase(config) {
            try {
                console.log('🔥 Initializing Firebase with config:', {
                    projectId: config.projectId,
                    authDomain: config.authDomain
                });
                
                // Check if Firebase is available and loaded properly
                if (typeof firebase === 'undefined' || window.firebaseLoadError) {
                    console.warn('Firebase SDK not available, falling back to local mode');
                    throw new Error('Firebase SDK not loaded. Please check your internet connection and try again.');
                }
                
                // Validate config object
                if (!config || typeof config !== 'object') {
                    throw new Error('Invalid Firebase configuration');
                }
                
                // Validate required fields
                const requiredFields = ['apiKey', 'authDomain', 'projectId', 'storageBucket', 'messagingSenderId', 'appId'];
                const missingFields = requiredFields.filter(field => !config[field]);
                if (missingFields.length > 0) {
                    throw new Error(`Missing required fields: ${missingFields.join(', ')}`);
                }
                
                // Check if Firebase is already initialized
                if (firebase.apps.length > 0) {
                    console.log('🔄 Reinitializing Firebase app...');
                    await firebase.app().delete();
                }
                
                // Initialize Firebase with new config
                console.log('🚀 Creating Firebase app...');
                const app = firebase.initializeApp(config);
                db = firebase.firestore();
                
                console.log('🔗 Testing Firestore connection...');
                
                // Test the connection by trying to access Firestore
                await db.enableNetwork();
                
                // Create a test document to verify write permissions
                try {
                    const testRef = db.collection('_connection_test').doc('test');
                    await testRef.set({
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        test: true
                    });
                    console.log('✅ Firestore write test successful');
                    
                    // Clean up test document
                    await testRef.delete();
                    console.log('🧹 Test document cleaned up');
                } catch (testError) {
                    console.warn('⚠️ Firestore write test failed:', testError.message);
                    // Continue anyway - read-only access might still work
                }
                
                isFirebaseMode = true;
                syncStatus = 'connected';
                updateSyncStatus();
                
                const dbModeEl = document.getElementById('dbMode');
                if (dbModeEl) {
                    dbModeEl.textContent = '🔥 Firebase Connected';
                }
                
                console.log('🎉 Firebase initialization successful!');
                
                // Start background sync
                startBackgroundSync();
                return true;
            } catch (error) {
                console.error('❌ Firebase initialization error:', error);
                isFirebaseMode = false;
                db = null;
                syncStatus = 'offline';
                updateSyncStatus();
                
                // Provide more specific error messages
                let errorMessage = 'Failed to connect to Firebase: ';
                if (error.code === 'auth/invalid-api-key') {
                    errorMessage += 'Invalid API key. Please check your Firebase configuration.';
                } else if (error.code === 'auth/project-not-found') {
                    errorMessage += 'Project not found. Please check your Project ID.';
                } else if (error.code === 'permission-denied') {
                    errorMessage += 'Permission denied. Please check your Firestore security rules.';
                } else if (error.message.includes('network') || error.message.includes('fetch')) {
                    errorMessage += 'Network error. Please check your internet connection.';
                } else {
                    errorMessage += error.message;
                }
                
                throw new Error(errorMessage);
            }
        }

        // Enhanced Sync Status Management
        function updateSyncStatus() {
            const statusElements = ['syncStatus', 'employeeSyncStatus', 'adminSyncStatus'];
            let statusText = '';
            let statusColor = '';
            
            switch(syncStatus) {
                case 'connected':
                    statusText = '🔄 Syncing...';
                    statusColor = 'text-blue-600';
                    break;
                case 'synced':
                    statusText = '✅ Real-time Sync';
                    statusColor = 'text-green-600';
                    break;
                case 'pending':
                    statusText = '⏳ Pending sync';
                    statusColor = 'text-yellow-600';
                    break;
                case 'error':
                    statusText = '❌ Sync error';
                    statusColor = 'text-red-600';
                    break;
                default: // offline
                    statusText = '📱 Local Mode';
                    statusColor = 'text-gray-600';
            }
            
            statusElements.forEach(elementId => {
                const element = document.getElementById(elementId);
                if (element) {
                    element.textContent = statusText;
                    element.className = `text-xs opacity-70 ${statusColor}`;
                }
            });
            
            // Update last sync time if available and show real-time indicator
            if (lastSyncTime && syncStatus === 'synced' && isFirebaseMode) {
                const timeStr = new Date(lastSyncTime).toLocaleTimeString();
                statusElements.forEach(elementId => {
                    const element = document.getElementById(elementId);
                    if (element) {
                        element.innerHTML = `<span class="text-green-600">🔄 Live</span> <span class="text-xs">${timeStr}</span>`;
                    }
                });
            }
        }
        
        // Show immediate sync feedback
        function showSyncFeedback(type, action) {
            const statusElements = ['syncStatus', 'employeeSyncStatus', 'adminSyncStatus'];
            const feedbackText = `⚡ ${action} ${type}...`;
            
            statusElements.forEach(elementId => {
                const element = document.getElementById(elementId);
                if (element) {
                    const originalContent = element.innerHTML;
                    element.innerHTML = `<span class="text-blue-600">${feedbackText}</span>`;
                    
                    // Restore original status after 2 seconds
                    setTimeout(() => {
                        if (element.innerHTML.includes(feedbackText)) {
                            element.innerHTML = originalContent;
                        }
                    }, 2000);
                }
            });
        }

        // Queue item for sync
        function queueForSync(action, type, data) {
            const syncItem = {
                id: Date.now() + Math.random(),
                action: action, // 'create', 'update', 'delete'
                type: type, // 'employee', 'store', 'product', 'sale'
                data: data,
                timestamp: new Date().toISOString(),
                attempts: 0
            };
            
            console.log('Queuing item for sync:', syncItem);
            
            syncQueue.push(syncItem);
            localStorage.setItem('eden_sync_queue', JSON.stringify(syncQueue));
            
            console.log('Current sync queue length:', syncQueue.length);
            console.log('Firebase mode:', isFirebaseMode);
            
            if (isFirebaseMode) {
                syncStatus = 'pending';
                updateSyncStatus();
                console.log('Triggering sync in 1 second...');
                // Trigger sync after short delay
                setTimeout(processSyncQueue, 1000);
            } else {
                console.log('Firebase mode disabled, item will remain in queue');
            }
        }

        // Process sync queue
        async function processSyncQueue() {
            if (!isFirebaseMode || isSyncing || syncQueue.length === 0) {
                console.log('Sync skipped:', { isFirebaseMode, isSyncing, queueLength: syncQueue.length });
                return;
            }
            
            console.log('🔄 Starting sync process with', syncQueue.length, 'items');
            console.log('Firebase connection status:', db ? 'Connected' : 'Not connected');
            
            isSyncing = true;
            syncStatus = 'connected';
            updateSyncStatus();
            
            const itemsToProcess = [...syncQueue];
            const processedItems = [];
            let successCount = 0;
            let errorCount = 0;
            
            for (const item of itemsToProcess) {
                try {
                    console.log('📤 Processing sync item:', {
                        type: item.type,
                        action: item.action,
                        id: item.data?.id,
                        attempts: item.attempts || 0
                    });
                    
                    await processSyncItem(item);
                    processedItems.push(item);
                    successCount++;
                    
                    console.log('✅ Successfully synced:', item.type, item.action);
                } catch (error) {
                    console.error('❌ Sync error for item:', {
                        type: item.type,
                        action: item.action,
                        error: error.message,
                        attempts: item.attempts || 0
                    });
                    
                    item.attempts = (item.attempts || 0) + 1;
                    errorCount++;
                    
                    // Remove item if too many attempts
                    if (item.attempts >= 3) {
                        processedItems.push(item);
                        console.error('🗑️ Removing item after 3 failed attempts:', item.type, item.action);
                    }
                }
            }
            
            // Remove processed items from queue
            syncQueue = syncQueue.filter(item => !processedItems.includes(item));
            localStorage.setItem('eden_sync_queue', JSON.stringify(syncQueue));
            
            console.log('🏁 Sync completed:', {
                processed: processedItems.length,
                successful: successCount,
                errors: errorCount,
                remaining: syncQueue.length
            });
            
            isSyncing = false;
            syncStatus = syncQueue.length > 0 ? 'pending' : 'synced';
            lastSyncTime = new Date().toISOString();
            updateSyncStatus();
        }

        // Process individual sync item
        async function processSyncItem(item) {
            const { action, type, data } = item;
            
            try {
                switch (action) {
                    case 'create':
                        console.log(`Creating ${type} in Firebase:`, data);
                        
                        // Create document in Firebase with the data
                        const docRef = await db.collection(type + 's').add({
                            ...data,
                            localId: data.id,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        
                        console.log(`${type} created in Firebase with ID:`, docRef.id);
                        
                        // Update local data with Firebase ID
                        const collection = getCollectionByType(type);
                        const localItem = collection.find(item => item.id === data.id);
                        if (localItem) {
                            localItem.firebaseId = docRef.id;
                            saveLocalData();
                        }
                        break;
                        
                    case 'update':
                        console.log(`Updating ${type} in Firebase:`, data);
                        
                        const firebaseId = data.firebaseId;
                        if (firebaseId) {
                            await db.collection(type + 's').doc(firebaseId).update({
                                ...data,
                                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            console.log(`${type} updated in Firebase`);
                        } else {
                            // If no Firebase ID, treat as create
                            console.log(`No Firebase ID found for ${type}, creating new document`);
                            const docRef = await db.collection(type + 's').add({
                                ...data,
                                localId: data.id,
                                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            
                            // Update local data with Firebase ID
                            const collection = getCollectionByType(type);
                            const localItem = collection.find(item => item.id === data.id);
                            if (localItem) {
                                localItem.firebaseId = docRef.id;
                                saveLocalData();
                            }
                        }
                        break;
                        
                    case 'delete':
                        console.log(`Deleting ${type} from Firebase:`, data);
                        
                        const deleteId = data.firebaseId;
                        if (deleteId) {
                            await db.collection(type + 's').doc(deleteId).delete();
                            console.log(`${type} deleted from Firebase`);
                        } else {
                            console.warn(`No Firebase ID found for ${type} deletion:`, data);
                        }
                        break;
                }
            } catch (error) {
                console.error(`Error processing ${action} for ${type}:`, error);
                throw error;
            }
        }

        // Get collection by type
        function getCollectionByType(type) {
            switch (type) {
                case 'employee': return employees;
                case 'store': return stores;
                case 'product': return products;
                case 'sale': return sales;
                default: return [];
            }
        }

        // Background sync with real-time listeners
        function startBackgroundSync() {
            // Load sync queue from localStorage
            const savedQueue = localStorage.getItem('eden_sync_queue');
            if (savedQueue) {
                syncQueue = JSON.parse(savedQueue);
            }
            
            // Process queue immediately
            processSyncQueue();
            
            // Set up periodic sync
            setInterval(() => {
                if (isFirebaseMode && !isSyncing) {
                    processSyncQueue();
                }
            }, 30000); // Sync every 30 seconds
            
            // Set up real-time listeners for Firebase data changes
            if (isFirebaseMode) {
                setupRealtimeListeners();
            }
        }
        
        // Real-time Firebase listeners
        function setupRealtimeListeners() {
            if (!db) return;
            
            try {
                // Listen for employees changes
                db.collection('employees').onSnapshot((snapshot) => {
                    console.log('Employees collection changed');
                    syncFromFirebase('employees', snapshot);
                }, (error) => {
                    console.error('Error listening to employees:', error);
                });
                
                // Listen for stores changes
                db.collection('stores').onSnapshot((snapshot) => {
                    console.log('Stores collection changed');
                    syncFromFirebase('stores', snapshot);
                }, (error) => {
                    console.error('Error listening to stores:', error);
                });
                
                // Listen for products changes
                db.collection('products').onSnapshot((snapshot) => {
                    console.log('Products collection changed');
                    syncFromFirebase('products', snapshot);
                }, (error) => {
                    console.error('Error listening to products:', error);
                });
                
                // Listen for collections changes
                db.collection('collections').onSnapshot((snapshot) => {
                    console.log('Collections collection changed');
                    syncFromFirebase('collections', snapshot);
                }, (error) => {
                    console.error('Error listening to collections:', error);
                });
                
                // Listen for sales changes
                db.collection('sales').onSnapshot((snapshot) => {
                    console.log('Sales collection changed');
                    syncFromFirebase('sales', snapshot);
                }, (error) => {
                    console.error('Error listening to sales:', error);
                });
                
                console.log('Real-time listeners set up successfully');
            } catch (error) {
                console.error('Error setting up real-time listeners:', error);
            }
        }
        
        // Sync data from Firebase to local storage
        function syncFromFirebase(collectionName, snapshot) {
            try {
                const firebaseData = [];
                
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    // Use localId if available, otherwise use Firebase doc ID
                    const localId = data.localId || doc.id;
                    
                    firebaseData.push({
                        ...data,
                        id: localId,
                        firebaseId: doc.id,
                        // Convert Firestore timestamps to ISO strings
                        createdAt: data.createdAt ? data.createdAt.toDate().toISOString() : new Date().toISOString(),
                        updatedAt: data.updatedAt ? data.updatedAt.toDate().toISOString() : new Date().toISOString()
                    });
                });
                
                // Update local data based on collection type
                switch(collectionName) {
                    case 'employees':
                        employees = mergeWithLocal(employees, firebaseData);
                        break;
                    case 'stores':
                        stores = mergeWithLocal(stores, firebaseData);
                        break;
                    case 'products':
                        products = mergeWithLocal(products, firebaseData);
                        break;
                    case 'collections':
                        collections = mergeWithLocal(collections, firebaseData);
                        break;
                    case 'sales':
                        sales = mergeWithLocal(sales, firebaseData);
                        break;
                }
                
                // Save updated data to localStorage
                saveLocalData();
                
                // Update UI if currently viewing the affected data
                updateUIAfterSync(collectionName);
                
                // Update sync status
                syncStatus = 'synced';
                lastSyncTime = new Date().toISOString();
                updateSyncStatus();
                
                console.log(`Synced ${firebaseData.length} items from ${collectionName}`);
                
            } catch (error) {
                console.error(`Error syncing ${collectionName} from Firebase:`, error);
                syncStatus = 'error';
                updateSyncStatus();
            }
        }
        
        // Merge Firebase data with local data, preserving local changes
        function mergeWithLocal(localArray, firebaseArray) {
            const merged = [...localArray];
            
            firebaseArray.forEach(firebaseItem => {
                const localIndex = merged.findIndex(localItem => 
                    localItem.id === firebaseItem.id || 
                    localItem.firebaseId === firebaseItem.firebaseId
                );
                
                if (localIndex >= 0) {
                    // Update existing item, but preserve local changes if they're newer
                    const localItem = merged[localIndex];
                    const localUpdated = new Date(localItem.updatedAt || localItem.createdAt || 0);
                    const firebaseUpdated = new Date(firebaseItem.updatedAt || firebaseItem.createdAt || 0);
                    
                    // Only update if Firebase version is newer
                    if (firebaseUpdated > localUpdated) {
                        merged[localIndex] = { ...localItem, ...firebaseItem };
                    } else {
                        // Keep local version but update Firebase ID if missing
                        if (!localItem.firebaseId && firebaseItem.firebaseId) {
                            merged[localIndex].firebaseId = firebaseItem.firebaseId;
                        }
                    }
                } else {
                    // Add new item from Firebase
                    merged.push(firebaseItem);
                }
            });
            
            return merged;
        }
        
        // Update UI after sync based on current view
        function updateUIAfterSync(collectionName) {
            try {
                // Update tables if currently viewing admin dashboard
                if (currentUserRole === 'admin' && !document.getElementById('dashboard').classList.contains('hidden')) {
                    switch(collectionName) {
                        case 'employees':
                            if (!document.getElementById('employees-tab').classList.contains('hidden')) {
                                loadEmployeesTable();
                            }
                            break;
                        case 'stores':
                            if (!document.getElementById('stores-tab').classList.contains('hidden')) {
                                loadStoresTable();
                            }
                            break;
                        case 'products':
                            if (!document.getElementById('products-tab').classList.contains('hidden')) {
                                loadProductsTable();
                            }
                            break;
                        case 'collections':
                            if (!document.getElementById('collections-tab').classList.contains('hidden')) {
                                loadCollectionsTable();
                            }
                            break;
                        case 'sales':
                            // Refresh sales report if currently viewing
                            if (!document.getElementById('sales-tab').classList.contains('hidden')) {
                                // Auto-refresh current report if one is displayed
                                const reportTable = document.getElementById('salesReportTable');
                                if (reportTable && reportTable.children.length > 0 && 
                                    !reportTable.innerHTML.includes('Select date range')) {
                                    generateSalesReport();
                                }
                            }
                            break;
                    }
                }
                
                // Update employee portal if currently viewing
                if (currentUserRole === 'employee' && !document.getElementById('employeePortal').classList.contains('hidden')) {
                    if (collectionName === 'sales') {
                        updateEmployeeStats();
                        updateTodaysSalesTable();
                    } else if (collectionName === 'products' || collectionName === 'stores') {
                        populateProductDropdown();
                        populateStoreDropdown();
                    }
                }
                
                // Update dropdowns in forms
                if (collectionName === 'stores') {
                    populateStoreDropdown();
                }
                if (collectionName === 'products') {
                    populateProductDropdown();
                }
                if (collectionName === 'employees') {
                    populateEmployeeDropdown();
                }
                
            } catch (error) {
                console.error('Error updating UI after sync:', error);
            }
        }
        
        // Enhanced sync status with real-time indicator
        function updateSyncStatusWithRealtime() {
            updateSyncStatus();
            
            // Add real-time indicator if Firebase is connected
            if (isFirebaseMode && syncStatus === 'synced') {
                const statusElements = ['syncStatus', 'employeeSyncStatus', 'adminSyncStatus'];
                statusElements.forEach(elementId => {
                    const element = document.getElementById(elementId);
                    if (element) {
                        element.innerHTML = '🔄 <span style="color: #10b981;">Real-time Sync</span>';
                    }
                });
            }
        }

        // Force sync now
        async function forceSyncNow() {
            if (!isFirebaseMode) {
                alert('Firebase is not connected. Please check your Firebase configuration in the code.');
                return;
            }
            
            syncStatus = 'connected';
            updateSyncStatus();
            
            try {
                await processSyncQueue();
                alert('Sync completed successfully!');
            } catch (error) {
                syncStatus = 'error';
                updateSyncStatus();
                alert('Sync failed: ' + error.message);
            }
        }

        // Reset Firebase Configuration
        function resetFirebaseConfig() {
            const password = prompt('Enter admin password to access Firebase configuration:');
            
            if (password !== 'eden@123') {
                if (password !== null) {
                    alert('❌ Incorrect password. Access denied.');
                }
                return;
            }
            
            alert('🔥 Firebase Configuration\n\nTo update your Firebase configuration, please edit the FIREBASE_CONFIG object in the HTML code.\n\nLook for the section that starts with:\nconst FIREBASE_CONFIG = {\n\nReplace the values with your actual Firebase project configuration.');
        }

        // Data Loading Functions
        async function loadAllData() {
            // Always load from local storage first
            loadLocalData();
            
            // If Firebase is connected, sync in background
            if (isFirebaseMode) {
                setTimeout(processSyncQueue, 1000);
            }
        }

        function loadLocalData() {
            try {
                employees = JSON.parse(localStorage.getItem('eden_employees') || '[]');
                stores = JSON.parse(localStorage.getItem('eden_stores') || '[]');
                products = JSON.parse(localStorage.getItem('eden_products') || '[]');
                collections = JSON.parse(localStorage.getItem('eden_collections') || '[]');
                sales = JSON.parse(localStorage.getItem('eden_sales') || '[]');
                
                // Ensure arrays are valid
                initializeArrays();
                
                console.log('Local data loaded:', {
                    employees: employees.length,
                    stores: stores.length,
                    products: products.length,
                    collections: collections.length,
                    sales: sales.length
                });
            } catch (error) {
                console.error('Error loading local data:', error);
                // Reset to empty arrays if parsing fails
                employees = [];
                stores = [];
                products = [];
                collections = [];
                sales = [];
            }
        }

        function saveLocalData() {
            try {
                localStorage.setItem('eden_employees', JSON.stringify(employees));
                localStorage.setItem('eden_stores', JSON.stringify(stores));
                localStorage.setItem('eden_products', JSON.stringify(products));
                localStorage.setItem('eden_collections', JSON.stringify(collections));
                localStorage.setItem('eden_sales', JSON.stringify(sales));
                
                console.log('Local data saved:', {
                    employees: employees.length,
                    stores: stores.length,
                    products: products.length,
                    collections: collections.length,
                    sales: sales.length
                });
            } catch (error) {
                console.error('Error saving local data:', error);
            }
        }

        // Modal Form Submission
        document.getElementById('modalForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const saveBtnText = document.getElementById('saveBtnText');
            const saveLoader = document.getElementById('saveLoader');
            const originalText = saveBtnText.textContent;
            
            saveBtnText.textContent = 'Saving...';
            saveLoader.classList.remove('hidden');
            
            try {
                let itemData = {};
                
                switch(editingType) {
                    case 'employee':
                        itemData = {
                            name: document.getElementById('modalName').value.trim(),
                            username: document.getElementById('modalUsername').value.trim(),
                            storeId: document.getElementById('modalStoreId').value,
                            salaryType: document.getElementById('modalSalaryType').value,
                            baseSalary: parseFloat(document.getElementById('modalBaseSalary').value) || 0,
                            commissionRate: document.getElementById('modalCommissionRate') ? parseFloat(document.getElementById('modalCommissionRate').value) || 0.1 : 0.1
                        };
                        
                        // Handle password
                        const password = document.getElementById('modalPassword').value;
                        if (password || !editingItem) {
                            itemData.password = password;
                        }
                        
                        // If editing, preserve existing ID
                        if (editingItem) {
                            itemData.id = editingItem.id;
                            if (!password) {
                                itemData.password = editingItem.password; // Keep existing password
                            }
                        }
                        
                        await saveEmployee(itemData);
                        await loadEmployeesTable();
                        break;
                        
                    case 'store':
                        itemData = {
                            name: document.getElementById('modalName').value.trim(),
                            location: document.getElementById('modalLocation').value.trim(),
                            manager: document.getElementById('modalManager').value.trim(),
                            phone: document.getElementById('modalPhone').value.trim()
                        };
                        
                        if (editingItem) {
                            itemData.id = editingItem.id;
                        }
                        
                        await saveStore(itemData);
                        await loadStoresTable();
                        break;
                        
                    case 'product':
                        itemData = {
                            name: document.getElementById('modalName').value.trim(),
                            price: parseFloat(document.getElementById('modalPrice').value) || 0,
                            description: document.getElementById('modalDescription').value.trim()
                        };
                        
                        if (editingItem) {
                            itemData.id = editingItem.id;
                        }
                        
                        await saveProduct(itemData);
                        await loadProductsTable();
                        break;
                        

                }
                
                closeModal();
                
                // Safe string handling for alert message
                const itemTypeName = editingType ? editingType.charAt(0).toUpperCase() + editingType.slice(1) : 'Item';
                const actionText = editingItem ? 'updated' : 'created';
                alert(`${itemTypeName} ${actionText} successfully!`);
                
                // Update dropdowns if needed
                if (editingType === 'store' || editingType === 'product') {
                    populateStoreDropdown();
                    populateProductDropdown();
                }
                
            } catch (error) {
                console.error('Error saving item:', error);
                alert('Error saving item: ' + error.message);
            }
            
            saveBtnText.textContent = originalText;
            saveLoader.classList.add('hidden');
        });

        // Login Form Handler
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            const loginBtnText = document.getElementById('loginBtnText');
            
            if (!username || !password) {
                alert('Please enter both username and password');
                return;
            }
            
            loginBtnText.textContent = 'Signing in...';
            
            // Check for admin login
            if (username === 'admin' && password === 'eden@123') {
                currentUser = { id: 'admin', name: 'Administrator', role: 'admin' };
                currentUserRole = 'admin';
                
                // Hide login screen and show admin dashboard
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                
                // Load admin data
                loadAdminDashboard();
                
                loginBtnText.textContent = 'Sign In';
                return;
            }
            
            // Check for employee login
            const employee = employees.find(emp => 
                emp && emp.username === username && emp.password === password
            );
            
            if (employee) {
                currentUser = employee;
                currentUserRole = 'employee';
                
                // Hide login screen and show employee portal
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('employeePortal').classList.remove('hidden');
                
                // Load employee data
                loadEmployeePortal(employee);
                
                loginBtnText.textContent = 'Sign In';
                return;
            }
            
            // Login failed
            alert('Invalid username or password. Please try again.');
            loginBtnText.textContent = 'Sign In';
        });

        // Logout function
        function logout() {
            currentUser = null;
            currentUserRole = null;
            
            // Hide all screens
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('employeePortal').classList.add('hidden');
            
            // Show login screen
            document.getElementById('loginScreen').classList.remove('hidden');
            
            // Clear form
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }

        // Load Admin Dashboard
        function loadAdminDashboard() {
            // Update current date
            document.getElementById('adminCurrentDate').textContent = new Date().toLocaleDateString();
            
            // Set default tab
            switchTab('employees');
            
            // Load all tables
            loadEmployeesTable();
            loadStoresTable();
            loadProductsTable();
            
            // Update sync status
            updateSyncStatus();
        }

        // Load Employee Portal
        function loadEmployeePortal(employee) {
            // Update employee info
            document.getElementById('employeeName').textContent = employee.name;
            document.getElementById('employeeStore').textContent = getStoreName(employee.storeId);
            document.getElementById('employeeCurrentDate').textContent = new Date().toLocaleDateString();
            document.getElementById('currentDate').textContent = new Date().toLocaleDateString();
            
            // Populate dropdowns
            populateStoreDropdown();
            populateProductDropdown();
            
            // Update stats and sales table
            updateEmployeeStats();
            updateTodaysSalesTable();
            
            // Update sync status
            updateSyncStatus();
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🌸 Starting Eden Perfume Sales Management System...');
            
            // Load local data first
            loadLocalData();
            
            // Initialize default data if empty
            initializeDefaultData();
            
            // Try to initialize Firebase with the configured settings
            try {
                console.log('🔥 Attempting to connect to Firebase with configured settings...');
                
                if (await initializeFirebase(FIREBASE_CONFIG)) {
                    console.log('✅ Firebase connected successfully');
                } else {
                    throw new Error('Firebase initialization returned false');
                }
            } catch (error) {
                console.warn('❌ Firebase connection failed:', error.message);
                console.log('📱 Running in Local Storage mode');
                
                // Set local mode status
                isFirebaseMode = false;
                syncStatus = 'offline';
                updateSyncStatus();
                
                const dbModeEl = document.getElementById('dbMode');
                if (dbModeEl) {
                    dbModeEl.textContent = '💾 Local Storage Mode';
                }
            }
            
            // Show login screen directly - no setup modal
            document.getElementById('loginScreen').classList.remove('hidden');
            
            console.log('✅ Eden Perfume system initialized!');
        });

        // Initialize default data if empty
        function initializeDefaultData() {
            // Add default admin if no employees exist
            if (employees.length === 0) {
                console.log('Creating default admin employee...');
                employees.push({
                    id: 'emp_admin_' + Date.now(),
                    name: 'System Administrator',
                    username: 'admin',
                    password: 'eden@123',
                    storeId: '',
                    salaryType: 'fixed',
                    baseSalary: 0,
                    commissionRate: 0,
                    createdAt: new Date().toISOString()
                });
                saveLocalData();
            }
            
            // Add default store if none exist
            if (stores.length === 0) {
                console.log('Creating default store...');
                stores.push({
                    id: 'store_main_' + Date.now(),
                    name: 'Main Store',
                    location: 'Downtown',
                    manager: 'Store Manager',
                    phone: '+1234567890',
                    createdAt: new Date().toISOString()
                });
                saveLocalData();
            }
            
            // Add default products if none exist
            if (products.length === 0) {
                console.log('Creating default products...');
                const defaultProducts = [
                    { name: 'Eden Rose', price: 150, description: 'Premium rose fragrance' },
                    { name: 'Eden Oud', price: 200, description: 'Luxury oud perfume' },
                    { name: 'Eden Fresh', price: 120, description: 'Fresh citrus scent' }
                ];
                
                defaultProducts.forEach(product => {
                    products.push({
                        id: 'prod_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                        ...product,
                        createdAt: new Date().toISOString()
                    });
                });
                saveLocalData();
            }
        }

        // Tab switching functionality
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('tab-active', 'border-purple-500');
                btn.classList.add('border-transparent');
            });
            
            // Show selected tab content
            const selectedTab = document.getElementById(tabName + '-tab');
            if (selectedTab) {
                selectedTab.classList.remove('hidden');
            }
            
            // Add active class to selected tab button
            const selectedBtn = document.querySelector(`[data-tab="${tabName}"]`);
            if (selectedBtn) {
                selectedBtn.classList.add('tab-active', 'border-purple-500');
                selectedBtn.classList.remove('border-transparent');
            }
            
            // Load data for the selected tab
            switch(tabName) {
                case 'employees':
                    loadEmployeesTable();
                    break;
                case 'stores':
                    loadStoresTable();
                    break;
                case 'products':
                    loadProductsTable();
                    break;
                case 'sales':
                    setupSalesReport();
                    break;
                case 'salary':
                    setupSalaryReport();
                    break;
            }
        }

        // Load employees table
        function loadEmployeesTable() {
            const tableBody = document.getElementById('employeesTable');
            if (!tableBody) return;
            
            if (employees.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-8 text-gray-500 text-sm">
                            No employees found. Click "Add Employee" to create your first employee.
                        </td>
                    </tr>
                `;
                return;
            }
            
            tableBody.innerHTML = employees.map(employee => {
                const storeName = getStoreName(employee.storeId);
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="py-3 px-3 text-sm">${employee.name}</td>
                        <td class="py-3 px-3 text-sm hide-mobile">${employee.username}</td>
                        <td class="py-3 px-3 text-sm">${storeName}</td>
                        <td class="py-3 px-3 text-sm hide-mobile">${employee.salaryType}</td>
                        <td class="py-3 px-3 text-sm">${employee.baseSalary} DH</td>
                        <td class="py-3 px-3 text-sm">
                            <div class="flex space-x-1">
                                <button onclick="editEmployee('${employee.id}')" class="text-blue-600 hover:text-blue-800 text-xs px-2 py-1 bg-blue-100 rounded">
                                    Edit
                                </button>
                                <button onclick="deleteEmployee('${employee.id}')" class="text-red-600 hover:text-red-800 text-xs px-2 py-1 bg-red-100 rounded">
                                    Delete
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Load stores table
        function loadStoresTable() {
            const tableBody = document.getElementById('storesTable');
            if (!tableBody) return;
            
            if (stores.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center py-8 text-gray-500">
                            No stores found. Click "Add Store" to create your first store.
                        </td>
                    </tr>
                `;
                return;
            }
            
            tableBody.innerHTML = stores.map(store => `
                <tr class="hover:bg-gray-50">
                    <td class="py-4 px-6">${store.name}</td>
                    <td class="py-4 px-6">${store.location}</td>
                    <td class="py-4 px-6">${store.manager}</td>
                    <td class="py-4 px-6">${store.phone}</td>
                    <td class="py-4 px-6">
                        <div class="flex space-x-2">
                            <button onclick="editStore('${store.id}')" class="text-blue-600 hover:text-blue-800 text-sm px-3 py-1 bg-blue-100 rounded">
                                Edit
                            </button>
                            <button onclick="deleteStore('${store.id}')" class="text-red-600 hover:text-red-800 text-sm px-3 py-1 bg-red-100 rounded">
                                Delete
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // Load products table
        function loadProductsTable() {
            const tableBody = document.getElementById('productsTable');
            if (!tableBody) return;
            
            if (products.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="3" class="text-center py-8 text-gray-500">
                            No products found. Click "Add Product" to create your first product.
                        </td>
                    </tr>
                `;
                return;
            }
            
            tableBody.innerHTML = products.map(product => `
                <tr class="hover:bg-gray-50">
                    <td class="py-4 px-6">${product.name}</td>
                    <td class="py-4 px-6">${product.price} DH</td>
                    <td class="py-4 px-6">
                        <div class="flex space-x-2">
                            <button onclick="editProduct('${product.id}')" class="text-blue-600 hover:text-blue-800 text-sm px-3 py-1 bg-blue-100 rounded">
                                Edit
                            </button>
                            <button onclick="deleteProduct('${product.id}')" class="text-red-600 hover:text-red-800 text-sm px-3 py-1 bg-red-100 rounded">
                                Delete
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // Helper functions to get names by ID
        function getStoreName(storeId) {
            if (!storeId) return 'No Store';
            const store = stores.find(s => s && s.id === storeId);
            return store ? store.name : 'Unknown Store';
        }

        function getEmployeeName(employeeId) {
            if (!employeeId) return 'No Employee';
            const employee = employees.find(e => e && e.id === employeeId);
            return employee ? employee.name : 'Unknown Employee';
        }

        function getProductName(productId) {
            if (!productId) return 'No Product';
            const product = products.find(p => p && p.id === productId);
            return product ? product.name : 'Unknown Product';
        }

        // Get today's date string
        function getTodayString() {
            return new Date().toISOString().split('T')[0];
        }

        // Refresh data function
        function refreshData() {
            loadAllData();
            if (currentUserRole === 'employee') {
                updateEmployeeStats();
                updateTodaysSalesTable();
            } else if (currentUserRole === 'admin') {
                loadEmployeesTable();
                loadStoresTable();
                loadProductsTable();
            }
        }

        // Quick add sale function
        function quickAddSale() {
            alert('Quick Add Sale feature coming soon!');
        }

        function viewTodaysSummary() {
            try {
                const today = getTodayString();
                const todaysSales = sales.filter(sale => sale && sale.date === today);
                
                if (todaysSales.length === 0) {
                    alert('No sales recorded today.');
                    return;
                }
                
                // Calculate summary statistics
                const totalRevenue = todaysSales.reduce((sum, sale) => sum + (sale.amount || 0), 0);
                const totalQuantity = todaysSales.reduce((sum, sale) => sum + (sale.quantity || 0), 0);
                const totalTransactions = todaysSales.length;
                const averageTransaction = totalRevenue / totalTransactions;
                
                // Store-wise breakdown
                const storeBreakdown = {};
                todaysSales.forEach(sale => {
                    const storeId = sale.storeId;
                    const storeName = getStoreName(storeId);
                    
                    if (!storeBreakdown[storeId]) {
                        storeBreakdown[storeId] = {
                            name: storeName,
                            revenue: 0,
                            quantity: 0,
                            transactions: 0
                        };
                    }
                    
                    storeBreakdown[storeId].revenue += sale.amount || 0;
                    storeBreakdown[storeId].quantity += sale.quantity || 0;
                    storeBreakdown[storeId].transactions += 1;
                });
                
                // Employee-wise breakdown
                const employeeBreakdown = {};
                todaysSales.forEach(sale => {
                    const employeeId = sale.employeeId;
                    const employeeName = getEmployeeName(employeeId);
                    
                    if (!employeeBreakdown[employeeId]) {
                        employeeBreakdown[employeeId] = {
                            name: employeeName,
                            revenue: 0,
                            quantity: 0,
                            transactions: 0
                        };
                    }
                    
                    employeeBreakdown[employeeId].revenue += sale.amount || 0;
                    employeeBreakdown[employeeId].quantity += sale.quantity || 0;
                    employeeBreakdown[employeeId].transactions += 1;
                });
                
                // Product-wise breakdown
                const productBreakdown = {};
                todaysSales.forEach(sale => {
                    const productId = sale.productId;
                    const productName = getProductName(productId);
                    
                    if (!productBreakdown[productId]) {
                        productBreakdown[productId] = {
                            name: productName,
                            quantity: 0,
                            revenue: 0,
                            transactions: 0
                        };
                    }
                    
                    productBreakdown[productId].quantity += sale.quantity || 0;
                    productBreakdown[productId].revenue += sale.amount || 0;
                    productBreakdown[productId].transactions += 1;
                });
                
                // Create summary modal
                showTodaysSummaryModal({
                    date: new Date(today).toLocaleDateString('en-US', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    }),
                    totalRevenue,
                    totalQuantity,
                    totalTransactions,
                    averageTransaction,
                    storeBreakdown: Object.values(storeBreakdown),
                    employeeBreakdown: Object.values(employeeBreakdown),
                    productBreakdown: Object.values(productBreakdown)
                });
                
            } catch (error) {
                console.error('Error generating today\'s summary:', error);
                alert('Error generating summary: ' + error.message);
            }
        }
        
        function showTodaysSummaryModal(summaryData) {
            // Create modal HTML
            const modalHTML = `
                <div id="summaryModal" class="fixed inset-0 modal-backdrop z-50 flex items-center justify-center p-4">
                    <div class="bg-white rounded-xl card-shadow w-full max-w-4xl max-h-screen overflow-y-auto fade-in">
                        <div class="p-6 border-b rounded-t-xl shadow-lg" style="background: linear-gradient(135deg, #4a5568 0%, #718096 50%, #a0aec0 100%); color: #f7fafc;">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h3 class="text-2xl font-bold">📊 Today's Sales Summary</h3>
                                    <p class="text-purple-100 mt-1">${summaryData.date}</p>
                                </div>
                                <button onclick="closeSummaryModal()" class="text-white hover:text-gray-200 text-2xl">✕</button>
                            </div>
                        </div>
                        
                        <div class="p-6">
                            <!-- Overall Stats -->
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                                <div class="bg-green-50 p-4 rounded-lg text-center">
                                    <div class="text-2xl font-bold text-green-600">$${summaryData.totalRevenue.toFixed(2)}</div>
                                    <div class="text-sm text-green-800">Total Revenue</div>
                                </div>
                                <div class="bg-blue-50 p-4 rounded-lg text-center">
                                    <div class="text-2xl font-bold text-blue-600">${summaryData.totalQuantity}</div>
                                    <div class="text-sm text-blue-800">Items Sold</div>
                                </div>
                                <div class="bg-purple-50 p-4 rounded-lg text-center">
                                    <div class="text-2xl font-bold text-purple-600">${summaryData.totalTransactions}</div>
                                    <div class="text-sm text-purple-800">Transactions</div>
                                </div>
                                <div class="bg-orange-50 p-4 rounded-lg text-center">
                                    <div class="text-2xl font-bold text-orange-600">$${summaryData.averageTransaction.toFixed(2)}</div>
                                    <div class="text-sm text-orange-800">Avg Transaction</div>
                                </div>
                            </div>
                            
                            <!-- Store Breakdown -->
                            <div class="mb-8">
                                <h4 class="text-lg font-semibold mb-4">🏪 Store Performance</h4>
                                <div class="bg-gray-50 rounded-lg overflow-hidden">
                                    <table class="w-full">
                                        <thead class="bg-gray-100">
                                            <tr>
                                                <th class="text-left py-3 px-4 font-medium">Store</th>
                                                <th class="text-left py-3 px-4 font-medium">Revenue</th>
                                                <th class="text-left py-3 px-4 font-medium">Items</th>
                                                <th class="text-left py-3 px-4 font-medium">Transactions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${summaryData.storeBreakdown.map(store => `
                                                <tr class="border-t">
                                                    <td class="py-3 px-4">${store.name}</td>
                                                    <td class="py-3 px-4 font-semibold text-green-600">$${store.revenue.toFixed(2)}</td>
                                                    <td class="py-3 px-4">${store.quantity}</td>
                                                    <td class="py-3 px-4">${store.transactions}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <!-- Employee Breakdown -->
                            <div class="mb-8">
                                <h4 class="text-lg font-semibold mb-4">👥 Employee Performance</h4>
                                <div class="bg-gray-50 rounded-lg overflow-hidden">
                                    <table class="w-full">
                                        <thead class="bg-gray-100">
                                            <tr>
                                                <th class="text-left py-3 px-4 font-medium">Employee</th>
                                                <th class="text-left py-3 px-4 font-medium">Revenue</th>
                                                <th class="text-left py-3 px-4 font-medium">Items</th>
                                                <th class="text-left py-3 px-4 font-medium">Transactions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${summaryData.employeeBreakdown.sort((a, b) => b.revenue - a.revenue).map(emp => `
                                                <tr class="border-t">
                                                    <td class="py-3 px-4">${emp.name}</td>
                                                    <td class="py-3 px-4 font-semibold text-green-600">$${emp.revenue.toFixed(2)}</td>
                                                    <td class="py-3 px-4">${emp.quantity}</td>
                                                    <td class="py-3 px-4">${emp.transactions}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <!-- Product Breakdown -->
                            <div class="mb-6">
                                <h4 class="text-lg font-semibold mb-4">🧴 Top Products</h4>
                                <div class="bg-gray-50 rounded-lg overflow-hidden">
                                    <table class="w-full">
                                        <thead class="bg-gray-100">
                                            <tr>
                                                <th class="text-left py-3 px-4 font-medium">Product</th>
                                                <th class="text-left py-3 px-4 font-medium">Quantity Sold</th>
                                                <th class="text-left py-3 px-4 font-medium">Revenue</th>
                                                <th class="text-left py-3 px-4 font-medium">Transactions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${summaryData.productBreakdown.sort((a, b) => b.quantity - a.quantity).map(product => `
                                                <tr class="border-t">
                                                    <td class="py-3 px-4">${product.name}</td>
                                                    <td class="py-3 px-4 font-semibold text-blue-600">${product.quantity}</td>
                                                    <td class="py-3 px-4 font-semibold text-green-600">$${product.revenue.toFixed(2)}</td>
                                                    <td class="py-3 px-4">${product.transactions}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <!-- Action Buttons -->
                            <div class="flex flex-wrap gap-3 justify-center">
                                <button onclick="printSummary()" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition">
                                    🖨️ Print Summary
                                </button>
                                <button onclick="downloadSummaryCSV()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition">
                                    📊 Download CSV
                                </button>
                                <button onclick="closeSummaryModal()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition">
                                    ✅ Close
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Store summary data for export functions
            window.currentSummaryData = summaryData;
        }
        
        function closeSummaryModal() {
            const modal = document.getElementById('summaryModal');
            if (modal) {
                modal.remove();
            }
        }
        
        function printSummary() {
            try {
                const summaryData = window.currentSummaryData;
                if (!summaryData) {
                    alert('No summary data available');
                    return;
                }
                
                const printWindow = window.open('', '_blank');
                const printContent = generateSummaryPrintContent(summaryData);
                
                printWindow.document.write(printContent);
                printWindow.document.close();
                printWindow.focus();
                printWindow.print();
                printWindow.close();
            } catch (error) {
                console.error('Print summary error:', error);
                alert('Error printing summary: ' + error.message);
            }
        }
        
        function downloadSummaryCSV() {
            try {
                const summaryData = window.currentSummaryData;
                if (!summaryData) {
                    alert('No summary data available');
                    return;
                }
                
                let csvContent = `Eden Perfume - Daily Sales Summary\n`;
                csvContent += `Date: ${summaryData.date}\n\n`;
                
                csvContent += `OVERALL SUMMARY\n`;
                csvContent += `Total Revenue,$${summaryData.totalRevenue.toFixed(2)}\n`;
                csvContent += `Total Items Sold,${summaryData.totalQuantity}\n`;
                csvContent += `Total Transactions,${summaryData.totalTransactions}\n`;
                csvContent += `Average Transaction,$${summaryData.averageTransaction.toFixed(2)}\n\n`;
                
                csvContent += `STORE PERFORMANCE\n`;
                csvContent += `Store,Revenue,Items,Transactions\n`;
                summaryData.storeBreakdown.forEach(store => {
                    csvContent += `"${store.name}",$${store.revenue.toFixed(2)},${store.quantity},${store.transactions}\n`;
                });
                
                csvContent += `\nEMPLOYEE PERFORMANCE\n`;
                csvContent += `Employee,Revenue,Items,Transactions\n`;
                summaryData.employeeBreakdown.sort((a, b) => b.revenue - a.revenue).forEach(emp => {
                    csvContent += `"${emp.name}",$${emp.revenue.toFixed(2)},${emp.quantity},${emp.transactions}\n`;
                });
                
                csvContent += `\nPRODUCT PERFORMANCE\n`;
                csvContent += `Product,Quantity Sold,Revenue,Transactions\n`;
                summaryData.productBreakdown.sort((a, b) => b.quantity - a.quantity).forEach(product => {
                    csvContent += `"${product.name}",${product.quantity},$${product.revenue.toFixed(2)},${product.transactions}\n`;
                });
                
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                link.setAttribute('href', url);
                link.setAttribute('download', `daily_summary_${getTodayString()}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
            } catch (error) {
                console.error('Download summary CSV error:', error);
                alert('Error downloading CSV: ' + error.message);
            }
        }
        
        function generateSummaryPrintContent(summaryData) {
            return `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Daily Sales Summary</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .header { text-align: center; margin-bottom: 30px; }
                        .header h1 { color: #333; margin-bottom: 5px; }
                        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
                        .stat-card { background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center; }
                        .stat-value { font-size: 24px; font-weight: bold; color: #333; }
                        .stat-label { font-size: 12px; color: #666; margin-top: 5px; }
                        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; font-weight: bold; }
                        .section-title { font-size: 18px; font-weight: bold; margin: 30px 0 10px 0; color: #333; }
                        @media print { body { margin: 0; } }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>Eden Perfume - Daily Sales Summary</h1>
                        <p>${summaryData.date}</p>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">$${summaryData.totalRevenue.toFixed(2)}</div>
                            <div class="stat-label">Total Revenue</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${summaryData.totalQuantity}</div>
                            <div class="stat-label">Items Sold</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${summaryData.totalTransactions}</div>
                            <div class="stat-label">Transactions</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">$${summaryData.averageTransaction.toFixed(2)}</div>
                            <div class="stat-label">Avg Transaction</div>
                        </div>
                    </div>
                    
                    <div class="section-title">Store Performance</div>
                    <table>
                        <thead>
                            <tr><th>Store</th><th>Revenue</th><th>Items</th><th>Transactions</th></tr>
                        </thead>
                        <tbody>
                            ${summaryData.storeBreakdown.map(store => `
                                <tr>
                                    <td>${store.name}</td>
                                    <td>$${store.revenue.toFixed(2)}</td>
                                    <td>${store.quantity}</td>
                                    <td>${store.transactions}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    <div class="section-title">Employee Performance</div>
                    <table>
                        <thead>
                            <tr><th>Employee</th><th>Revenue</th><th>Items</th><th>Transactions</th></tr>
                        </thead>
                        <tbody>
                            ${summaryData.employeeBreakdown.sort((a, b) => b.revenue - a.revenue).map(emp => `
                                <tr>
                                    <td>${emp.name}</td>
                                    <td>$${emp.revenue.toFixed(2)}</td>
                                    <td>${emp.quantity}</td>
                                    <td>${emp.transactions}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    <div class="section-title">Product Performance</div>
                    <table>
                        <thead>
                            <tr><th>Product</th><th>Quantity</th><th>Revenue</th><th>Transactions</th></tr>
                        </thead>
                        <tbody>
                            ${summaryData.productBreakdown.sort((a, b) => b.quantity - a.quantity).map(product => `
                                <tr>
                                    <td>${product.name}</td>
                                    <td>${product.quantity}</td>
                                    <td>$${product.revenue.toFixed(2)}</td>
                                    <td>${product.transactions}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </body>
                </html>
            `;
        }

        function backupData() {
            try {
                const backupData = {
                    timestamp: new Date().toISOString(),
                    version: '1.0',
                    data: {
                        employees: employees,
                        stores: stores,
                        products: products,
                        collections: collections,
                        sales: sales
                    },
                    metadata: {
                        totalEmployees: employees.length,
                        totalStores: stores.length,
                        totalProducts: products.length,
                        totalCollections: collections.length,
                        totalSales: sales.length,
                        syncMode: isFirebaseMode ? 'Firebase' : 'Local',
                        lastSyncTime: lastSyncTime
                    }
                };
                
                const backupJson = JSON.stringify(backupData, null, 2);
                const blob = new Blob([backupJson], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `eden_perfume_backup_${new Date().toISOString().split('T')[0]}.json`;
                link.style.display = 'none';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                URL.revokeObjectURL(url);
                
                alert(`Backup created successfully!\n\nBackup includes:\n- ${employees.length} employees\n- ${stores.length} stores\n- ${products.length} products\n- ${collections.length} collections\n- ${sales.length} sales records`);
                
            } catch (error) {
                console.error('Backup error:', error);
                alert('Error creating backup: ' + error.message);
            }
        }

        // Modal functions
        function openModal(type, item = null) {
            editingType = type;
            editingItem = item;
            
            const modal = document.getElementById('modal');
            const modalTitle = document.getElementById('modalTitle');
            const modalFields = document.getElementById('modalFields');
            
            // Set modal title
            const titles = {
                employee: item ? 'Edit Employee' : 'Add Employee',
                store: item ? 'Edit Store' : 'Add Store',
                product: item ? 'Edit Product' : 'Add Product'
            };
            modalTitle.textContent = titles[type] || 'Add Item';
            
            // Generate form fields based on type
            let fieldsHTML = '';
            
            switch(type) {
                case 'employee':
                    fieldsHTML = `
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Full Name</label>
                            <input type="text" id="modalName" value="${item ? item.name : ''}" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                            <input type="text" id="modalUsername" value="${item ? item.username : ''}" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Password ${item ? '(leave blank to keep current)' : ''}</label>
                            <input type="password" id="modalPassword" class="w-full px-3 py-2 border border-gray-300 rounded-lg" ${!item ? 'required' : ''}>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Store</label>
                            <select id="modalStoreId" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required>
                                <option value="">Select Store</option>
                                ${stores.map(store => `
                                    <option value="${store.id}" ${item && item.storeId === store.id ? 'selected' : ''}>
                                        ${store.name}
                                    </option>
                                `).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Salary Type</label>
                            <select id="modalSalaryType" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required>
                                <option value="fixed" ${item && item.salaryType === 'fixed' ? 'selected' : ''}>Fixed Salary</option>
                                <option value="commission" ${item && item.salaryType === 'commission' ? 'selected' : ''}>Commission Only</option>
                                <option value="mixed" ${item && item.salaryType === 'mixed' ? 'selected' : ''}>Fixed + Commission</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Base Salary (DH)</label>
                            <input type="number" id="modalBaseSalary" value="${item ? item.baseSalary : 0}" min="0" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Commission Rate (0.1 = 10%)</label>
                            <input type="number" id="modalCommissionRate" value="${item ? item.commissionRate : 0.1}" min="0" max="1" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        </div>
                    `;
                    break;
                    
                case 'store':
                    fieldsHTML = `
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Store Name</label>
                            <input type="text" id="modalName" value="${item ? item.name : ''}" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Location</label>
                            <input type="text" id="modalLocation" value="${item ? item.location : ''}" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Manager</label>
                            <input type="text" id="modalManager" value="${item ? item.manager : ''}" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Phone</label>
                            <input type="tel" id="modalPhone" value="${item ? item.phone : ''}" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required>
                        </div>
                    `;
                    break;
                    
                case 'product':
                    fieldsHTML = `
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Product Name</label>
                            <input type="text" id="modalName" value="${item ? item.name : ''}" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Price (DH)</label>
                            <input type="number" id="modalPrice" value="${item ? item.price : ''}" min="0" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                            <textarea id="modalDescription" class="w-full px-3 py-2 border border-gray-300 rounded-lg" rows="3">${item ? item.description : ''}</textarea>
                        </div>
                    `;
                    break;
            }
            
            modalFields.innerHTML = fieldsHTML;
            modal.classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('modal').classList.add('hidden');
            editingItem = null;
            editingType = null;
        }

        // CRUD Functions for Employee
        async function saveEmployee(employeeData) {
            try {
                if (editingItem) {
                    // Update existing employee
                    const index = employees.findIndex(emp => emp.id === editingItem.id);
                    if (index !== -1) {
                        employees[index] = {
                            ...employees[index],
                            ...employeeData,
                            updatedAt: new Date().toISOString()
                        };
                        
                        // Queue for sync
                        queueForSync('update', 'employee', employees[index]);
                    }
                } else {
                    // Create new employee
                    const newEmployee = {
                        id: 'emp_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                        ...employeeData,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    };
                    
                    employees.push(newEmployee);
                    
                    // Queue for sync
                    queueForSync('create', 'employee', newEmployee);
                }
                
                saveLocalData();
                
            } catch (error) {
                console.error('Error saving employee:', error);
                throw error;
            }
        }

        function editEmployee(employeeId) {
            const employee = employees.find(emp => emp.id === employeeId);
            if (employee) {
                openModal('employee', employee);
            }
        }

        function deleteEmployee(employeeId) {
            if (confirm('Are you sure you want to delete this employee?')) {
                const employeeIndex = employees.findIndex(emp => emp.id === employeeId);
                if (employeeIndex !== -1) {
                    const employee = employees[employeeIndex];
                    employees.splice(employeeIndex, 1);
                    saveLocalData();
                    
                    // Queue for sync
                    queueForSync('delete', 'employee', employee);
                    
                    loadEmployeesTable();
                    alert('Employee deleted successfully!');
                }
            }
        }

        // CRUD Functions for Store
        async function saveStore(storeData) {
            try {
                if (editingItem) {
                    // Update existing store
                    const index = stores.findIndex(store => store.id === editingItem.id);
                    if (index !== -1) {
                        stores[index] = {
                            ...stores[index],
                            ...storeData,
                            updatedAt: new Date().toISOString()
                        };
                        
                        // Queue for sync
                        queueForSync('update', 'store', stores[index]);
                    }
                } else {
                    // Create new store
                    const newStore = {
                        id: 'store_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                        ...storeData,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    };
                    
                    stores.push(newStore);
                    
                    // Queue for sync
                    queueForSync('create', 'store', newStore);
                }
                
                saveLocalData();
                
            } catch (error) {
                console.error('Error saving store:', error);
                throw error;
            }
        }

        function editStore(storeId) {
            const store = stores.find(s => s.id === storeId);
            if (store) {
                openModal('store', store);
            }
        }

        function deleteStore(storeId) {
            if (confirm('Are you sure you want to delete this store?')) {
                const storeIndex = stores.findIndex(s => s.id === storeId);
                if (storeIndex !== -1) {
                    const store = stores[storeIndex];
                    stores.splice(storeIndex, 1);
                    saveLocalData();
                    
                    // Queue for sync
                    queueForSync('delete', 'store', store);
                    
                    loadStoresTable();
                    alert('Store deleted successfully!');
                }
            }
        }

        // CRUD Functions for Product
        async function saveProduct(productData) {
            try {
                if (editingItem) {
                    // Update existing product
                    const index = products.findIndex(product => product.id === editingItem.id);
                    if (index !== -1) {
                        products[index] = {
                            ...products[index],
                            ...productData,
                            updatedAt: new Date().toISOString()
                        };
                        
                        // Queue for sync
                        queueForSync('update', 'product', products[index]);
                    }
                } else {
                    // Create new product
                    const newProduct = {
                        id: 'prod_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                        ...productData,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    };
                    
                    products.push(newProduct);
                    
                    // Queue for sync
                    queueForSync('create', 'product', newProduct);
                }
                
                saveLocalData();
                
            } catch (error) {
                console.error('Error saving product:', error);
                throw error;
            }
        }

        function editProduct(productId) {
            const product = products.find(p => p.id === productId);
            if (product) {
                openModal('product', product);
            }
        }

        function deleteProduct(productId) {
            if (confirm('Are you sure you want to delete this product?')) {
                const productIndex = products.findIndex(p => p.id === productId);
                if (productIndex !== -1) {
                    const product = products[productIndex];
                    products.splice(productIndex, 1);
                    saveLocalData();
                    
                    // Queue for sync
                    queueForSync('delete', 'product', product);
                    
                    loadProductsTable();
                    alert('Product deleted successfully!');
                }
            }
        }

        function downloadAllMasterData() {
            try {
                // Create comprehensive Excel-like CSV with multiple sheets
                let csvContent = '';
                
                // Employees sheet
                csvContent += 'EMPLOYEES\n';
                csvContent += 'Name,Username,Password,Store,Salary Type,Base Salary (DH),Commission Rate\n';
                employees.forEach(emp => {
                    const storeName = emp && emp.storeId ? (stores.find(s => s && s.id === emp.storeId)?.name || 'Unknown Store') : 'No Store';
                    csvContent += `"${emp.name || ''}","${emp.username || ''}","${emp.password || ''}","${storeName}","${emp.salaryType || ''}","${emp.baseSalary || 0}","${emp.commissionRate || 0}"\n`;
                });
                
                csvContent += '\n\nSTORES\n';
                csvContent += 'Name,Location,Manager,Phone\n';
                stores.forEach(store => {
                    csvContent += `"${store.name || ''}","${store.location || ''}","${store.manager || ''}","${store.phone || ''}"\n`;
                });
                
                csvContent += '\n\nPRODUCTS\n';
                csvContent += 'Name,Price (DH),Description\n';
                products.forEach(product => {
                    csvContent += `"${product.name || ''}","${product.price || 0}","${product.description || ''}"\n`;
                });
                
                csvContent += '\n\nCOLLECTIONS\n';
                csvContent += 'Name,Description,Status,Product Count\n';
                collections.forEach(collection => {
                    const productCount = collection.productIds ? collection.productIds.length : 0;
                    csvContent += `"${collection.name || ''}","${collection.description || ''}","${collection.status || ''}","${productCount}"\n`;
                });
                
                csvContent += '\n\nSALES\n';
                csvContent += 'Date,Time,Employee,Store,Product,Quantity,Amount (DH)\n';
                sales.forEach(sale => {
                    const employeeName = sale && sale.employeeId ? (employees.find(e => e && e.id === sale.employeeId)?.name || 'Unknown Employee') : 'No Employee';
                    const storeName = sale && sale.storeId ? (stores.find(s => s && s.id === sale.storeId)?.name || 'Unknown Store') : 'No Store';
                    const productName = sale && sale.productId ? (products.find(p => p && p.id === sale.productId)?.name || 'Unknown Product') : 'No Product';
                    const saleDate = sale.date || '';
                    const saleTime = sale.time || '';
                    csvContent += `"${saleDate}","${saleTime}","${employeeName}","${storeName}","${productName}","${sale.quantity || 0}","${sale.amount || 0}"\n`;
                });
                
                // Create and download the file
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                link.setAttribute('href', url);
                link.setAttribute('download', `eden_perfume_master_data_${getTodayString()}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                alert(`Master data exported successfully!\n\nExported:\n- ${employees.length} employees\n- ${stores.length} stores\n- ${products.length} products\n- ${collections.length} collections\n- ${sales.length} sales records`);
                
            } catch (error) {
                console.error('Download master data error:', error);
                alert('Error downloading master data: ' + error.message);
            }
        }

        function restoreFromBackup() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const backupData = JSON.parse(e.target.result);
                        
                        if (!backupData.data) {
                            throw new Error('Invalid backup file format');
                        }
                        
                        // Confirm restore
                        const confirmRestore = confirm(
                            `Restore data from backup?\n\n` +
                            `Backup Date: ${new Date(backupData.timestamp).toLocaleString()}\n` +
                            `Employees: ${backupData.metadata.totalEmployees}\n` +
                            `Stores: ${backupData.metadata.totalStores}\n` +
                            `Products: ${backupData.metadata.totalProducts}\n` +
                            `Sales: ${backupData.metadata.totalSales}\n\n` +
                            `This will replace all current data!`
                        );
                        
                        if (!confirmRestore) return;
                        
                        // Restore data
                        employees = backupData.data.employees || [];
                        stores = backupData.data.stores || [];
                        products = backupData.data.products || [];
                        collections = backupData.data.collections || [];
                        sales = backupData.data.sales || [];
                        
                        // Save to local storage
                        saveLocalData();
                        
                        // Refresh UI
                        if (currentUserRole === 'admin') {
                            loadEmployeesTable();
                            loadStoresTable();
                            loadProductsTable();
                        } else if (currentUserRole === 'employee') {
                            updateEmployeeStats();
                            updateTodaysSalesTable();
                        }
                        
                        alert('Data restored successfully from backup!');
                        
                    } catch (error) {
                        console.error('Restore error:', error);
                        alert('Error restoring backup: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }

        function clearAllData() {
            const password = prompt('Enter admin password to clear all data:');
            
            if (password !== 'eden@123') {
                if (password !== null) {
                    alert('❌ Incorrect password. Access denied.');
                }
                return;
            }
            
            const confirmClear = confirm(
                '⚠️ WARNING: This will permanently delete ALL data!\n\n' +
                'This includes:\n' +
                '- All employees\n' +
                '- All stores\n' +
                '- All products\n' +
                '- All sales records\n' +
                '- All collections\n\n' +
                'This action cannot be undone!\n\n' +
                'Are you absolutely sure?'
            );
            
            if (!confirmClear) return;
            
            const finalConfirm = confirm('Last chance! This will delete EVERYTHING. Continue?');
            
            if (!finalConfirm) return;
            
            try {
                // Clear all data
                employees = [];
                stores = [];
                products = [];
                collections = [];
                sales = [];
                
                // Clear local storage
                localStorage.removeItem('eden_employees');
                localStorage.removeItem('eden_stores');
                localStorage.removeItem('eden_products');
                localStorage.removeItem('eden_collections');
                localStorage.removeItem('eden_sales');
                localStorage.removeItem('eden_sync_queue');
                
                // Clear sync queue
                syncQueue = [];
                
                // Reinitialize default data
                initializeDefaultData();
                
                // Refresh UI
                if (currentUserRole === 'admin') {
                    loadEmployeesTable();
                    loadStoresTable();
                    loadProductsTable();
                }
                
                alert('✅ All data has been cleared and reset to defaults.');
                
            } catch (error) {
                console.error('Clear data error:', error);
                alert('Error clearing data: ' + error.message);
            }
        }

        // Employee Portal Functions
        function populateStoreDropdown() {
            const storeSelect = document.getElementById('saleStore');
            if (!storeSelect) return;
            
            storeSelect.innerHTML = '<option value="">Select store</option>';
            stores.forEach(store => {
                storeSelect.innerHTML += `<option value="${store.id}">${store.name}</option>`;
            });
        }

        function populateProductDropdown() {
            const productSelect = document.getElementById('saleProduct');
            if (!productSelect) return;
            
            productSelect.innerHTML = '<option value="">Choose product</option>';
            products.forEach(product => {
                productSelect.innerHTML += `<option value="${product.id}">${product.name} - ${product.price} DH</option>`;
            });
            
            // Add event listener for product selection
            productSelect.addEventListener('change', updateTotalAmount);
        }

        function populateEmployeeDropdown() {
            const employeeSelects = document.querySelectorAll('#salaryEmployee');
            employeeSelects.forEach(select => {
                select.innerHTML = '<option value="">All Employees</option>';
                employees.forEach(employee => {
                    select.innerHTML += `<option value="${employee.id}">${employee.name}</option>`;
                });
            });
        }

        function adjustQuantity(change) {
            const quantityInput = document.getElementById('saleQuantity');
            if (!quantityInput) return;
            
            let currentValue = parseInt(quantityInput.value) || 1;
            currentValue += change;
            
            if (currentValue < 1) currentValue = 1;
            
            quantityInput.value = currentValue;
            updateTotalAmount();
        }

        function updateTotalAmount() {
            const productSelect = document.getElementById('saleProduct');
            const quantityInput = document.getElementById('saleQuantity');
            const totalAmountDisplay = document.getElementById('totalAmount');
            
            if (!productSelect || !quantityInput || !totalAmountDisplay) return;
            
            const selectedProductId = productSelect.value;
            const quantity = parseInt(quantityInput.value) || 1;
            
            if (!selectedProductId) {
                totalAmountDisplay.textContent = '0.00 DH';
                return;
            }
            
            const product = products.find(p => p.id === selectedProductId);
            if (!product) {
                totalAmountDisplay.textContent = '0.00 DH';
                return;
            }
            
            const total = product.price * quantity;
            totalAmountDisplay.textContent = `${total.toFixed(2)} DH`;
        }

        // Add sale form handler
        document.getElementById('addSaleForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const storeId = document.getElementById('saleStore').value;
            const productId = document.getElementById('saleProduct').value;
            const quantity = parseInt(document.getElementById('saleQuantity').value) || 1;
            
            if (!storeId || !productId) {
                alert('Please select both store and product');
                return;
            }
            
            const product = products.find(p => p.id === productId);
            if (!product) {
                alert('Selected product not found');
                return;
            }
            
            const amount = product.price * quantity;
            const now = new Date();
            
            const newSale = {
                id: 'sale_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                employeeId: currentUser.id,
                storeId: storeId,
                productId: productId,
                quantity: quantity,
                amount: amount,
                date: getTodayString(),
                time: now.toLocaleTimeString(),
                createdAt: now.toISOString()
            };
            
            sales.push(newSale);
            saveLocalData();
            
            // Queue for sync
            queueForSync('create', 'sale', newSale);
            
            // Reset form
            document.getElementById('addSaleForm').reset();
            document.getElementById('saleQuantity').value = 1;
            document.getElementById('totalAmount').textContent = '0.00 DH';
            
            // Update UI
            updateEmployeeStats();
            updateTodaysSalesTable();
            
            alert('Sale recorded successfully!');
        });

        function updateEmployeeStats() {
            const today = getTodayString();
            const todaysSales = sales.filter(sale => 
                sale && sale.employeeId === currentUser.id && sale.date === today
            );
            
            const totalSales = todaysSales.reduce((sum, sale) => sum + (sale.amount || 0), 0);
            const totalQuantity = todaysSales.reduce((sum, sale) => sum + (sale.quantity || 0), 0);
            
            // Calculate estimated salary
            let estimatedSalary = 0;
            if (currentUser.salaryType === 'fixed') {
                estimatedSalary = currentUser.baseSalary / 30; // Daily rate
            } else if (currentUser.salaryType === 'commission') {
                estimatedSalary = totalSales * (currentUser.commissionRate || 0.1);
            } else if (currentUser.salaryType === 'mixed') {
                estimatedSalary = (currentUser.baseSalary / 30) + (totalSales * (currentUser.commissionRate || 0.1));
            }
            
            // Update display
            document.getElementById('totalSalesToday').textContent = `${totalSales.toFixed(2)} DH`;
            document.getElementById('bottlesSold').textContent = totalQuantity;
            document.getElementById('estimatedSalary').textContent = `${estimatedSalary.toFixed(2)} DH`;
        }

        function updateTodaysSalesTable() {
            const tableBody = document.getElementById('todaysSalesTable');
            if (!tableBody) return;
            
            const today = getTodayString();
            const todaysSales = sales.filter(sale => 
                sale && sale.employeeId === currentUser.id && sale.date === today
            ).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            if (todaysSales.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-8 text-gray-500 text-sm">No sales recorded today</td>
                    </tr>
                `;
                return;
            }
            
            tableBody.innerHTML = todaysSales.map(sale => {
                const storeName = getStoreName(sale.storeId);
                const productName = getProductName(sale.productId);
                
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="py-2 px-2 text-sm">${sale.time}</td>
                        <td class="py-2 px-2 text-sm hide-mobile">${storeName}</td>
                        <td class="py-2 px-2 text-sm">${productName}</td>
                        <td class="py-2 px-2 text-sm">${sale.quantity}</td>
                        <td class="py-2 px-2 text-sm">${sale.amount.toFixed(2)} DH</td>
                        <td class="py-2 px-2 text-sm">
                            <button onclick="deleteSale('${sale.id}')" class="text-red-600 hover:text-red-800 text-xs px-2 py-1 bg-red-100 rounded">
                                Delete
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function deleteSale(saleId) {
            if (confirm('Are you sure you want to delete this sale?')) {
                const saleIndex = sales.findIndex(sale => sale.id === saleId);
                if (saleIndex !== -1) {
                    const sale = sales[saleIndex];
                    sales.splice(saleIndex, 1);
                    saveLocalData();
                    
                    // Queue for sync
                    queueForSync('delete', 'sale', sale);
                    
                    updateEmployeeStats();
                    updateTodaysSalesTable();
                    alert('Sale deleted successfully!');
                }
            }
        }

        // Placeholder functions for reports
        function setupSalesReport() {
            // Set default dates
            const today = new Date();
            const startDate = new Date(today.getFullYear(), today.getMonth(), 1);
            
            document.getElementById('reportStartDate').value = startDate.toISOString().split('T')[0];
            document.getElementById('reportEndDate').value = today.toISOString().split('T')[0];
        }

        function setupSalaryReport() {
            // Set default dates
            const today = new Date();
            const startDate = new Date(today.getFullYear(), today.getMonth(), 1);
            
            document.getElementById('salaryStartDate').value = startDate.toISOString().split('T')[0];
            document.getElementById('salaryEndDate').value = today.toISOString().split('T')[0];
            
            // Populate employee dropdown
            populateEmployeeDropdown();
        }

        function generateSalesReport() {
            alert('Sales report generation coming soon!');
        }

        function generateSalaryReport() {
            alert('Salary report generation coming soon!');
        }

        function printReport(type) {
            alert(`Print ${type} report coming soon!`);
        }

        function downloadExcel(type) {
            alert(`Download ${type} Excel coming soon!`);
        }

        function downloadPDF(type) {
            alert(`Download ${type} PDF coming soon!`);
        }
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96ae4fe8f19ef9fb',t:'MTc1NDQ4MDk4MC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>